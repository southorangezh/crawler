{
  "metadata": {
    "source_file": "Cesium-1.116.0-fix-26\\Cesium.js",
    "chunk_index": 141,
    "total_chunks": 194,
    "chunk_size": 42216,
    "word_count": 800,
    "model_kwargs": {
      "model": "text-embedding-3-large",
      "dimensions": 3072,
      "encoding_format": "float"
    },
    "text_splitter": {
      "split_by": "word",
      "chunk_size": 800,
      "chunk_overlap": 200
    },
    "created_at": "2025-12-17T23:57:49.736Z"
  },
  "content": "Ue({sources:[eF]}),this._translucentMRTSupport&&m.defines.push(\"MRT\"),p={u_opaque:function(){return u._opaqueTexture},u_accumulation:function(){return u._accumulationTexture},u_revealage:function(){return u._revealageTexture}},this._compositeCommand=e.createViewportQuadCommand(m,{uniformMap:p,owner:this})),l(this._adjustTranslucentCommand)||(this._translucentMRTSupport?(m=new Ue({defines:[\"MRT\"],sources:[YV]}),p={u_bgColor:function(){return u._translucentMRTClearCommand.color},u_depthTexture:function(){return u._depthStencilTexture}},this._adjustTranslucentCommand=e.createViewportQuadCommand(m,{uniformMap:p,owner:this})):this._translucentMultipassSupport&&(m=new Ue({sources:[YV]}),p={u_bgColor:function(){return u._translucentMultipassClearCommand.color},u_depthTexture:function(){return u._depthStencilTexture}},this._adjustTranslucentCommand=e.createViewportQuadCommand(m,{uniformMap:p,owner:this}),p={u_bgColor:function(){return u._alphaClearCommand.color},u_depthTexture:function(){return u._depthStencilTexture}},this._adjustAlphaCommand=e.createViewportQuadCommand(m,{uniformMap:p,owner:this}))),this._viewport.width=r,this._viewport.height=s;let b=!ze.equals(this._viewport,t.viewport),f=b!==this._useScissorTest;this._useScissorTest=b,ze.equals(this._scissorRectangle,t.viewport)||(this._scissorRectangle=ze.clone(t.viewport,this._scissorRectangle),f=!0),(!l(this._rs)||!ze.equals(this._viewport,this._rs.viewport)||f)&&(this._rs=Ne.fromCache({viewport:this._viewport,scissorTest:{enabled:this._useScissorTest,rectangle:this._scissorRectangle}})),l(this._compositeCommand)&&(this._compositeCommand.renderState=this._rs),this._adjustTranslucentCommand&&(this._adjustTranslucentCommand.renderState=this._rs),l(this._adjustAlphaCommand)&&(this._adjustAlphaCommand.renderState=this._rs)};var Cut={enabled:!0,color:new O(0,0,0,0),equationRgb:La.ADD,equationAlpha:La.ADD,functionSourceRgb:xo.ONE,functionDestinationRgb:xo.ONE,functionSourceAlpha:xo.ZERO,functionDestinationAlpha:xo.ONE_MINUS_SOURCE_ALPHA},Vut={enabled:!0,color:new O(0,0,0,0),equationRgb:La.ADD,equationAlpha:La.ADD,functionSourceRgb:xo.ONE,functionDestinationRgb:xo.ONE,functionSourceAlpha:xo.ONE,functionDestinationAlpha:xo.ONE},Lut={enabled:!0,color:new O(0,0,0,0),equationRgb:La.ADD,equationAlpha:La.ADD,functionSourceRgb:xo.ZERO,functionDestinationRgb:xo.ONE_MINUS_SOURCE_ALPHA,functionSourceAlpha:xo.ZERO,functionDestinationAlpha:xo.ONE_MINUS_SOURCE_ALPHA};function pj(e,t,n,i){let o=n[i.id];if(!l(o)){let r=Ne.getState(i);r.depthMask=!1,r.blending=t,o=Ne.fromCache(r),n[i.id]=o}return o}function Zut(e,t,n){return pj(t,Cut,e._translucentRenderStateCache,n)}function Rut(e,t,n){return pj(t,Vut,e._translucentRenderStateCache,n)}function Gut(e,t,n){return pj(t,Lut,e._alphaRenderStateCache,n)}var Eut=` vec3 Ci = czm_out_FragColor.rgb * czm_out_FragColor.a; float ai = czm_out_FragColor.a; float wzi = czm_alphaWeight(ai); out_FragData_0 = vec4(Ci * wzi, ai); out_FragData_1 = vec4(ai * wzi); `,Xut=` vec3 Ci = czm_out_FragColor.rgb * czm_out_FragColor.a; float ai = czm_out_FragColor.a; float wzi = czm_alphaWeight(ai); out_FragColor = vec4(Ci, ai) * wzi; `,Iut=` float ai = czm_out_FragColor.a; out_FragColor = vec4(ai); `;function bj(e,t,n,i){let{shaderCache:o}=e,r=o.getDerivedShaderProgram(t,n);if(l(r))return r;let s=t._attributeLocations,a=t.fragmentShaderSource.clone();a.sources=a.sources.map(function(u){return Ue.replaceMain(u,\"czm_translucent_main\").replace(/out_FragColor/g,\"czm_out_FragColor\").replace(/layout\\s*\\(location\\s*=\\s*0\\)\\s*out\\s+vec4\\s+out_FragColor;/g,\"\").replace(/\\bdiscard\\b/g,\"czm_discard = true\").replace(/czm_phong/g,\"czm_translucentPhong\")}),a.sources.splice(0,0,`vec4 czm_out_FragColor; bool czm_discard = false; `);let c=[...i.matchAll(/out_FragData_(\\d+)/g)],d=\"\";for(let u=0;u<c.length;u++){let m=c[u];d=`layout (location = ${m[1]}) out vec4 ${m[0]}; ${d}`}return a.sources.push(d),a.sources.push(`void main() { czm_translucent_main(); if (czm_discard) { discard; } ${i}} `),o.createDerivedShaderProgram(t,n,{vertexShaderSource:t.vertexShaderSource,fragmentShaderSource:a,attributeLocations:s})}function Wut(e,t){return bj(e,t,\"translucentMRT\",Eut)}function Put(e,t){return bj(e,t,\"translucentMultipass\",Xut)}function vut(e,t){return bj(e,t,\"alphaMultipass\",Iut)}nb.prototype.createDerivedCommands=function(e,t,n){if(l(n)||(n={}),this._translucentMRTSupport){let a,c;return l(n.translucentCommand)&&(a=n.translucentCommand.shaderProgram,c=n.translucentCommand.renderState),n.translucentCommand=je.shallowClone(e,n.translucentCommand),!l(a)||n.shaderProgramId!==e.shaderProgram.id?(n.translucentCommand.shaderProgram=Wut(t,e.shaderProgram),n.translucentCommand.renderState=Zut(this,t,e.renderState),n.shaderProgramId=e.shaderProgram.id):(n.translucentCommand.shaderProgram=a,n.translucentCommand.renderState=c),n}let i,o,r,s;return l(n.translucentCommand)&&(i=n.translucentCommand.shaderProgram,o=n.translucentCommand.renderState,r=n.alphaCommand.shaderProgram,s=n.alphaCommand.renderState),n.translucentCommand=je.shallowClone(e,n.translucentCommand),n.alphaCommand=je.shallowClone(e,n.alphaCommand),!l(i)||n.shaderProgramId!==e.shaderProgram.id?(n.translucentCommand.shaderProgram=Put(t,e.shaderProgram),n.translucentCommand.renderState=Rut(this,t,e.renderState),n.alphaCommand.shaderProgram=vut(t,e.shaderProgram),n.alphaCommand.renderState=Gut(this,t,e.renderState),n.shaderProgramId=e.shaderProgram.id):(n.translucentCommand.shaderProgram=i,n.translucentCommand.renderState=o,n.alphaCommand.shaderProgram=r,n.alphaCommand.renderState=s),n};function wut(e,t,n,i,o,r){let s,a,c,{context:d,frameState:u}=t,{useLogDepth:m,shadowState:p}=u,b=t._hdr,f=i.framebuffer,x=p.lightShadowsEnabled;i.framebuffer=e._adjustTranslucentFBO.framebuffer,e._adjustTranslucentCommand.execute(d,i),i.framebuffer=e._adjustAlphaFBO.framebuffer,e._adjustAlphaCommand.execute(d,i);let _=e._opaqueFBO.framebuffer;for(i.framebuffer=e._translucentFBO.framebuffer,c=0;c<o.length;++c)s=o[c],s=m?s.derivedCommands.logDepth.command:s,s=b?s.derivedCommands.hdr.command:s,a=x&&s.receiveShadows?s.derivedCommands.oit.shadows.translucentCommand:s.derivedCommands.oit.translucentCommand,n(a,t,d,i,_);for(l(r)&&(s=r.unclassifiedCommand,a=x&&s.receiveShadows?s.derivedCommands.oit.shadows.translucentCommand:s.derivedCommands.oit.translucentCommand,n(a,t,d,i,_)),i.framebuffer=e._alphaFBO.framebuffer,c=0;c<o.length;++c)s=o[c],s=m?s.derivedCommands.logDepth.command:s,s=b?s.derivedCommands.hdr.command:s,a=x&&s.receiveShadows?s.derivedCommands.oit.shadows.alphaCommand:s.derivedCommands.oit.alphaCommand,n(a,t,d,i,_);l(r)&&(s=r.unclassifiedCommand,a=x&&s.receiveShadows?s.derivedCommands.oit.shadows.alphaCommand:s.derivedCommands.oit.alphaCommand,n(a,t,d,i,_)),i.framebuffer=f}function Fut(e,t,n,i,o,r){let{context:s,frameState:a}=t,{useLogDepth:c,shadowState:d}=a,u=t._hdr,m=i.framebuffer,p=d.lightShadowsEnabled;i.framebuffer=e._adjustTranslucentFBO.framebuffer,e._adjustTranslucentCommand.execute(s,i);let b=e._opaqueFBO.framebuffer;i.framebuffer=e._translucentFBO.framebuffer;let f,x;for(let _=0;_<o.length;++_)f=o[_],f=c?f.derivedCommands.logDepth.command:f,f=u?f.derivedCommands.hdr.command:f,x=p&&f.receiveShadows?f.derivedCommands.oit.shadows.translucentCommand:f.derivedCommands.oit.translucentCommand,n(x,t,s,i,b);l(r)&&(f=r.unclassifiedCommand,x=p&&f.receiveShadows?f.derivedCommands.oit.shadows.translucentCommand:f.derivedCommands.oit.translucentCommand,n(x,t,s,i,b)),i.framebuffer=m}nb.prototype.executeCommands=function(e,t,n,i,o){if(this._translucentMRTSupport){Fut(this,e,t,n,i,o);return}wut(this,e,t,n,i,o)};nb.prototype.execute=function(e,t){this._compositeCommand.execute(e,t)};nb.prototype.clear=function(e,t,n){let i=t.framebuffer;t.framebuffer=this._opaqueFBO.framebuffer,O.clone(n,this._opaqueClearCommand.color),this._opaqueClearCommand.execute(e,t),t.framebuffer=this._translucentFBO.framebuffer,(this._translucentMRTSupport?this._translucentMRTClearCommand:this._translucentMultipassClearCommand).execute(e,t),this._translucentMultipassSupport&&(t.framebuffer=this._alphaFBO.framebuffer,this._alphaClearCommand.execute(e,t)),t.framebuffer=i};nb.prototype.isSupported=function(){return this._translucentMRTSupport||this._translucentMultipassSupport};nb.prototype.isDestroyed=function(){return!1};nb.prototype.destroy=function(){return txe(this),l(this._compositeCommand)&&(this._compositeCommand.shaderProgram=this._compositeCommand.shaderProgram&&this._compositeCommand.shaderProgram.destroy()),l(this._adjustTranslucentCommand)&&(this._adjustTranslucentCommand.shaderProgram=this._adjustTranslucentCommand.shaderProgram&&this._adjustTranslucentCommand.shaderProgram.destroy()),l(this._adjustAlphaCommand)&&(this._adjustAlphaCommand.shaderProgram=this._adjustAlphaCommand.shaderProgram&&this._adjustAlphaCommand.shaderProgram.destroy()),me(this)};var tF=nb;var AWi=T(S(),1);function nF(){this._framebuffer=new li({color:!1,depthStencil:!0,supportsDepthTexture:!0}),this._passState=void 0}Object.defineProperties(nF.prototype,{framebuffer:{get:function(){return this._framebuffer.framebuffer}}});function Aut(e){e._framebuffer.destroy()}function Mut(e,t){let n=t.drawingBufferWidth,i=t.drawingBufferHeight;e._framebuffer.update(t,n,i);let o=new $a(t);o.blendingEnabled=!1,o.scissorTest={enabled:!0,rectangle:new ze},o.viewport=new ze,e._passState=o}nF.prototype.update=function(e,t,n){let i=n.width,o=n.height;this._framebuffer.isDirty(i,o)&&Mut(this,e);let r=this.framebuffer,s=this._passState;return s.framebuffer=r,s.viewport.width=i,s.viewport.height=o,s.scissorTest.rectangle.x=t.x,s.scissorTest.rectangle.y=o-t.y,s.scissorTest.rectangle.width=1,s.scissorTest.rectangle.height=1,s};nF.prototype.isDestroyed=function(){return!1};nF.prototype.destroy=function(){return Aut(this),me(this)};var iF=nF;var zWi=T(S(),1);function OV(e){let t=new $a(e);t.blendingEnabled=!1,t.scissorTest={enabled:!0,rectangle:new ze},t.viewport=new ze,this._context=e,this._fb=new li({depthStencil:!0}),this._passState=t,this._width=0,this._height=0}OV.prototype.begin=function(e,t){let n=this._context,{width:i,height:o}=t;return ze.clone(e,this._passState.scissorTest.rectangle),this._width=i,this._height=o,this._fb.update(n,i,o),this._passState.framebuffer=this._fb.framebuffer,this._passState.viewport.width=i,this._passState.viewport.height=o,this._passState};var oF=new O;OV.prototype.end=function(e){let t=g(e.width,1),n=g(e.height,1),i=this._context,o=i.readPixels({x:e.x,y:e.y,width:t,height:n,framebuffer:this._fb.framebuffer}),r=Math.max(t,n),s=r*r,a=Math.floor(t*.5),c=Math.floor(n*.5),d=0,u=0,m=0,p=-1;for(let b=0;b<s;++b){if(-a<=d&&d<=a&&-c<=u&&u<=c){let f=4*((c-u)*t+d+a);oF.red=O.byteToFloat(o[f]),oF.green=O.byteToFloat(o[f+1]),oF.blue=O.byteToFloat(o[f+2]),oF.alpha=O.byteToFloat(o[f+3]);let x=i.getObjectByPickColor(oF);if(l(x))return x}if(d===u||d<0&&-d===u||d>0&&d===1-u){let f=m;m=-p,p=f}d+=m,u+=p}};OV.prototype.readVoxelInfo=function(e){let t=g(e.width,1),n=g(e.height,1),o=this._context.readPixels({x:e.x,y:e.y,width:t,height:n,framebuffer:this._fb.framebuffer}),r=Math.floor(t*.5),a=4*(Math.floor(n*.5)*t+r);return o.slice(a,a+4)};OV.prototype.isDestroyed=function(){return!1};OV.prototype.destroy=function(){return this._fb.destroy(),me(this)};var rF=OV;var $Wi=T(S(),1);function ib(){this._numSamples=1,this._colorFramebuffer=new li({depthStencil:!0,supportsDepthTexture:!0}),this._idFramebuffer=new li({depthStencil:!0,supportsDepthTexture:!0}),this._idClearColor=new O(0,0,0,0),this._clearCommand=new ei({color:new O(0,0,0,0),depth:1,owner:this})}function Nut(e){e._colorFramebuffer.destroy(),e._idFramebuffer.destroy()}Object.defineProperties(ib.prototype,{framebuffer:{get:function(){return this._colorFramebuffer.framebuffer}},idFramebuffer:{get:function(){return this._idFramebuffer.framebuffer}},depthStencilTexture:{get:function(){return this._colorFramebuffer.getDepthStencilTexture()}}});ib.prototype.update=function(e,t,n,i){let o=t.width,r=t.height,s=n?e.halfFloatingPointTexture?Qe.HALF_FLOAT:Qe.FLOAT:Qe.UNSIGNED_BYTE;this._numSamples=i,this._colorFramebuffer.update(e,o,r,i,s),this._idFramebuffer.update(e,o,r)};ib.prototype.clear=function(e,t,n){O.clone(n,this._clearCommand.color),O.clone(this._idClearColor,this._clearCommand.color),this._colorFramebuffer.clear(e,this._clearCommand,t),this._idFramebuffer.clear(e,this._clearCommand,t)};ib.prototype.getFramebuffer=function(){return this._colorFramebuffer.framebuffer};ib.prototype.getIdFramebuffer=function(){return this._idFramebuffer.framebuffer};ib.prototype.prepareColorTextures=function(e){this._numSamples>1&&this._colorFramebuffer.prepareTextures(e)};ib.prototype.isDestroyed=function(){return!1};ib.prototype.destroy=function(){return Nut(this),me(this)};var RT=ib;var V2i=T(S(),1);var t2i=T(S(),1),sF=`uniform sampler2D u_opaqueDepthTexture; uniform sampler2D u_translucentDepthTexture; in vec2 v_textureCoordinates; void main() { float opaqueDepth = texture(u_opaqueDepthTexture, v_textureCoordinates).r; float translucentDepth = texture(u_translucentDepthTexture, v_textureCoordinates).r; translucentDepth = czm_branchFreeTernary(translucentDepth > opaqueDepth, 1.0, translucentDepth); out_FragColor = czm_packDepth(translucentDepth); } `;var i2i=T(S(),1),GT=`uniform sampler2D colorTexture; #ifdef DEBUG_SHOW_DEPTH uniform sampler2D u_packedTranslucentDepth; #endif in vec2 v_textureCoordinates; void main() { #ifdef DEBUG_SHOW_DEPTH if (v_textureCoordinates.x < 0.5) { out_FragColor.rgb = vec3(czm_unpackDepth(texture(u_packedTranslucentDepth, v_textureCoordinates))); out_FragColor.a = 1.0; } #else vec4 color = texture(colorTexture, v_textureCoordinates); #ifdef PICK if (color == vec4(0.0)) { discard; } #else // Reverse premultiplication process to get the correct composited result of the classification primitives color.rgb /= color.a; #endif out_FragColor = color; #endif } `;var kut=!1;function Sg(e){this._drawClassificationFBO=new li({createDepthAttachments:!1}),this._accumulationFBO=new li({createDepthAttachments:!1}),this._packFBO=new li,this._opaqueDepthStencilTexture=void 0,this._textureToComposite=void 0,this._translucentDepthStencilTexture=void 0,this._packDepthCommand=void 0,this._accumulateCommand=void 0,this._compositeCommand=void 0,this._copyCommand=void 0,this._clearColorCommand=new ei({color:new O(0,0,0,0),owner:this}),this._clearDepthStencilCommand=new ei({depth:1,stencil:0,owner:this}),this._supported=e.depthTexture,this._viewport=new ze,this._rsDepth=void 0,this._rsAccumulate=void 0,this._rsComp=void 0,this._useScissorTest=void 0,this._scissorRectangle=void 0,this._hasTranslucentDepth=!1,this._frustumsDrawn=0}Object.defineProperties(Sg.prototype,{hasTranslucentDepth:{get:function(){return this._hasTranslucentDepth}}});function nxe(e){e._textureToComposite=void 0,e._translucentDepthStencilTexture=e._translucentDepthStencilTexture&&!e._translucentDepthStencilTexture.isDestroyed()&&e._translucentDepthStencilTexture.destroy()}function ixe(e){e._drawClassificationFBO.destroy(),e._accumulationFBO.destroy(),e._packFBO.destroy()}function Uut(e,t,n,i){nxe(e),e._translucentDepthStencilTexture=new Ft({context:t,width:n,height:i,pixelFormat:at.DEPTH_STENCIL,pixelDatatype:Qe.UNSIGNED_INT_24_8,sampler:mn.NEAREST})}function Dut(e,t,n,i){ixe(e),e._drawClassificationFBO.setDepthStencilTexture(e._translucentDepthStencilTexture),e._drawClassificationFBO.update(t,n,i),e._accumulationFBO.setDepthStencilTexture(e._translucentDepthStencilTexture),e._accumulationFBO.update(t,n,i),e._packFBO.update(t,n,i)}function But(e,t,n,i){if(!e.isSupported())return;e._opaqueDepthStencilTexture=i;let o=e._opaqueDepthStencilTexture.width,r=e._opaqueDepthStencilTexture.height;e._drawClassificationFBO.isDirty(o,r)&&(Uut(e,t,o,r),Dut(e,t,o,r));let s,a;if(l(e._packDepthCommand)||(s=new Ue({sources:[sF]}),a={u_opaqueDepthTexture:function(){return e._opaqueDepthStencilTexture},u_translucentDepthTexture:function(){return e._translucentDepthStencilTexture}},e._packDepthCommand=t.createViewportQuadCommand(s,{uniformMap:a,owner:e})),!l(e._compositeCommand)){s=new Ue({sources:[GT]}),a={colorTexture:function(){return e._textureToComposite}},kut&&(s.defines=[\"DEBUG_SHOW_DEPTH\"],a.u_packedTranslucentDepth=function(){return e._packFBO.getColorTexture()}),e._compositeCommand=t.createViewportQuadCommand(s,{uniformMap:a,owner:e});let u=e._compositeCommand,m=u.shaderProgram,p=t.shaderCache.createDerivedShaderProgram(m,\"pick\",{vertexShaderSource:m.vertexShaderSource,fragmentShaderSource:new Ue({sources:s.sources,defines:[\"PICK\"]}),attributeLocations:m._attributeLocations}),b=je.shallowClone(u);b.shaderProgram=p,u.derivedCommands.pick=b}l(e._copyCommand)||(s=new Ue({sources:[GT]}),a={colorTexture:function(){return e._drawClassificationFBO.getColorTexture()}},e._copyCommand=t.createViewportQuadCommand(s,{uniformMap:a,owner:e})),l(e._accumulateCommand)||(s=new Ue({sources:[GT]}),a={colorTexture:function(){return e._drawClassificationFBO.getColorTexture()}},e._accumulateCommand=t.createViewportQuadCommand(s,{uniformMap:a,owner:e})),e._viewport.width=o,e._viewport.height=r;let c=!ze.equals(e._viewport,n.viewport),d=c!==e._useScissorTest;e._useScissorTest=c,ze.equals(e._scissorRectangle,n.viewport)||(e._scissorRectangle=ze.clone(n.viewport,e._scissorRectangle),d=!0),(!l(e._rsDepth)||!ze.equals(e._viewport,e._rsDepth.viewport)||d)&&(e._rsDepth=Ne.fromCache({viewport:e._viewport,scissorTest:{enabled:e._useScissorTest,rectangle:e._scissorRectangle}})),l(e._packDepthCommand)&&(e._packDepthCommand.renderState=e._rsDepth),(!l(e._rsAccumulate)||!ze.equals(e._viewport,e._rsAccumulate.viewport)||d)&&(e._rsAccumulate=Ne.fromCache({viewport:e._viewport,scissorTest:{enabled:e._useScissorTest,rectangle:e._scissorRectangle},stencilTest:{enabled:!0,frontFunction:vn.EQUAL,reference:Mt.CESIUM_3D_TILE_MASK}})),l(e._accumulateCommand)&&(e._accumulateCommand.renderState=e._rsAccumulate),(!l(e._rsComp)||!ze.equals(e._viewport,e._rsComp.viewport)||d)&&(e._rsComp=Ne.fromCache({viewport:e._viewport,scissorTest:{enabled:e._useScissorTest,rectangle:e._scissorRectangle},blending:un.ALPHA_BLEND})),l(e._compositeCommand)&&(e._compositeCommand.renderState=e._rsComp,e._compositeCommand.derivedCommands.pick.renderState=e._rsComp)}Sg.prototype.executeTranslucentCommands=function(e,t,n,i,o){let r=i.length,s,a,c=e.frameState.useLogDepth,d=e.context,u=n.framebuffer;for(a=0;a<r;++a)if(s=i[a],s=c?s.derivedCommands.logDepth.command:s,s.depthForTranslucentClassification){this._hasTranslucentDepth=!0;break}if(this._hasTranslucentDepth){for(But(this,d,n,o),n.framebuffer=this._drawClassificationFBO.framebuffer,this._clearDepthStencilCommand.execute(d,n),a=0;a<r;++a){if(s=i[a],s=c?s.derivedCommands.logDepth.command:s,!s.depthForTranslucentClassification)continue;let m=s.derivedCommands.depth.depthOnlyCommand;t(m,e,d,n)}this._frustumsDrawn+=this._hasTranslucentDepth?1:0,this._hasTranslucentDepth&&(n.framebuffer=this._packFBO.framebuffer,this._packDepthCommand.execute(d,n)),n.framebuffer=u}};Sg.prototype.executeClassificationCommands=function(e,t,n,i){if(!this._hasTranslucentDepth)return;let o=e.context,r=o.uniformState,s=n.framebuffer;this._frustumsDrawn===2&&(n.framebuffer=this._accumulationFBO.framebuffer,this._copyCommand.execute(o,n)),n.framebuffer=this._drawClassificationFBO.framebuffer,this._frustumsDrawn>1&&this._clearColorCommand.execute(o,n),r.updatePass(Ze.CESIUM_3D_TILE_CLASSIFICATION);let a=r.globeDepthTexture;r.globeDepthTexture=this._packFBO.getColorTexture();let c=i.commands[Ze.CESIUM_3D_TILE_CLASSIFICATION],d=i.indices[Ze.CESIUM_3D_TILE_CLASSIFICATION];for(let u=0;u<d;++u)t(c[u],e,o,n);r.globeDepthTexture=a,n.framebuffer=s,this._frustumsDrawn!==1&&(n.framebuffer=this._accumulationFBO.framebuffer,this._accumulateCommand.execute(o,n),n.framebuffer=s)};Sg.prototype.execute=function(e,t){if(!this._hasTranslucentDepth)return;this._frustumsDrawn===1?this._textureToComposite=this._drawClassificationFBO.getColorTexture():this._textureToComposite=this._accumulationFBO.getColorTexture(),(e.frameState.passes.pick?this._compositeCommand.derivedCommands.pick:this._compositeCommand).execute(e.context,t),Yut(this,e,t)};function Yut(e,t,n){if(!e._hasTranslucentDepth)return;let i=n.framebuffer;n.framebuffer=e._drawClassificationFBO.framebuffer,e._clearColorCommand.execute(t._context,n),n.framebuffer=i,e._frustumsDrawn>1&&(n.framebuffer=e._accumulationFBO.framebuffer,e._clearColorCommand.execute(t._context,n)),e._hasTranslucentDepth=!1,e._frustumsDrawn=0}Sg.prototype.isSupported=function(){return this._supported};Sg.prototype.isDestroyed=function(){return!1};Sg.prototype.destroy=function(){return nxe(this),ixe(this),l(this._compositeCommand)&&(this._compositeCommand.shaderProgram=this._compositeCommand.shaderProgram&&this._compositeCommand.shaderProgram.destroy()),l(this._packDepthCommand)&&(this._packDepthCommand.shaderProgram=this._packDepthCommand.shaderProgram&&this._packDepthCommand.shaderProgram.destroy()),me(this)};var aF=Sg;function Out(){this.command=void 0,this.near=void 0,this.far=void 0}function zD(e,t,n){let i=e.context,o;i.depthTexture&&(o=new qw);let r;e._useOIT&&i.depthTexture&&(r=new tF(i));let s=new $a(i);s.viewport=ze.clone(n),this.camera=t,this._cameraClone=lo.clone(t),this._cameraStartFired=!1,this._cameraMovedTime=void 0,this.viewport=n,this.passState=s,this.pickFramebuffer=new rF(i),this.pickDepthFramebuffer=new iF,this.sceneFramebuffer=new RT,this.globeDepth=o,this.globeTranslucencyFramebuffer=new $w,this.oit=r,this.translucentTileClassification=new aF(i),this.pickDepths=[],this.frustumCommandsList=[],this.debugFrustumStatistics=void 0,this._commandExtents=[]}var oxe=new h,rxe=new h;function zut(e,t){let n=Math.max(Math.abs(e.x),Math.abs(t.x)),i=Math.max(Math.abs(e.y),Math.abs(t.y)),o=Math.max(Math.abs(e.z),Math.abs(t.z));return Math.max(Math.max(n,i),o)}function Hut(e,t,n){let i=1/Math.max(1,zut(e.position,t.position));return h.multiplyByScalar(e.position,i,oxe),h.multiplyByScalar(t.position,i,rxe),h.equalsEpsilon(oxe,rxe,n)&&h.equalsEpsilon(e.direction,t.direction,n)&&h.equalsEpsilon(e.up,t.up,n)&&h.equalsEpsilon(e.right,t.right,n)&&M.equalsEpsilon(e.transform,t.transform,n)&&e.frustum.equalsEpsilon(t.frustum,n)}zD.prototype.checkForCameraUpdates=function(e){let t=this.camera,n=this._cameraClone;return Hut(t,n,P.EPSILON15)?(this._cameraStartFired&&fi()-this._cameraMovedTime>e.cameraEventWaitTime&&(t.moveEnd.raiseEvent(),this._cameraStartFired=!1),!1):(this._cameraStartFired||(t.moveStart.raiseEvent(),this._cameraStartFired=!0),this._cameraMovedTime=fi(),lo.clone(t,n),!0)};function Kut(e,t,n,i){let o=t.frameState,r=o.camera,s=o.useLogDepth?t.logarithmicDepthFarToNearRatio:t.farToNearRatio,a=t.mode===ie.SCENE2D,c=t.nearToFarDistance2D;i*=1+P.EPSILON2,n=Math.min(Math.max(n,r.frustum.near),r.frustum.far),i=Math.max(Math.min(i,r.frustum.far),n);let d;a?(i=Math.min(i,r.position.z+t.nearToFarDistance2D),n=Math.min(n,i),d=Math.ceil(Math.max(1,i-n)/t.nearToFarDistance2D)):d=Math.ceil(Math.log(i/n)/Math.log(s)),d>=0||(console.log(\"numFrustums =\",d),console.log(\"far =\",i),console.log(\"near =\",n),console.error(\"Num Frustums Error\"));let u=e.frustumCommandsList;u.length=d;for(let m=0;m<d;++m){let p,b;a?(p=Math.min(i-c,n+m*c),b=Math.min(i,p+c)):(p=Math.max(n,Math.pow(s,m)*n),b=Math.min(i,s*p));let f=u[m];l(f)?(f.near=p,f.far=b):f=u[m]=new jw(p,b)}}function Jut(e,t,n,i,o){t.debugShowFrustums&&(n.debugOverlappingFrustums=0);let r=e.frustumCommandsList,s=r.length;for(let a=0;a<s;++a){let c=r[a],d=c.near,u=c.far;if(i>u)continue;if(o<d)break;let m=n.pass,p=c.indices[m]++;if(c.commands[m][p]=n,t.debugShowFrustums&&(n.debugOverlappingFrustums|=1<<a),n.executeInClosestFrustum)break}if(t.debugShowFrustums){let a=e.debugFrustumStatistics.commandsInFrustums;a[n.debugOverlappingFrustums]=l(a[n.debugOverlappingFrustums])?a[n.debugOverlappingFrustums]+1:1,++e.debugFrustumStatistics.totalCommands}t.updateDerivedCommands(n)}var sxe=new os,Qut=new Va;zD.prototype.createPotentiallyVisibleSet=function(e){let t=e.frameState,n=t.camera,i=n.directionWC,o=n.positionWC,r=e._computeCommandList,s=e._overlayCommandList,a=t.commandList;e.debugShowFrustums&&(this.debugFrustumStatistics={totalCommands:0,commandsInFrustums:{}});let c=this.frustumCommandsList,d=c.length,u=Ze.NUMBER_OF_PASSES;for(let Z=0;Z<d;++Z)for(let E=0;E<u;++E)c[Z].indices[E]=0;r.length=0,s.length=0;let m=this._commandExtents,p=m.length,b=0,f=+Number.MAX_VALUE,x=-Number.MAX_VALUE,_=t.shadowState.shadowsEnabled,C=+Number.MAX_VALUE,V=-Number.MAX_VALUE,L=Number.MAX_VALUE,R=t.mode===ie.SCENE3D?t.occluder:void 0,G=t.cullingVolume,X=sxe.planes;for(let Z=0;Z<5;++Z)X[Z]=G.planes[Z];G=sxe;let v=a.length;for(let Z=0;Z<v;++Z){let E=a[Z],I=E.pass;if(I===Ze.COMPUTE)r.push(E);else if(I===Ze.OVERLAY)s.push(E);else{let w,k,B=E.boundingVolume;if(l(B)){if(!e.isVisible(E,G,R))continue;let Y=B.computePlaneDistances(o,i,Qut);if(w=Y.start,k=Y.stop,f=Math.min(f,w),x=Math.max(x,k),_&&E.receiveShadows&&w<Lh.MAXIMUM_DISTANCE&&!(I===Ze.GLOBE&&w<-100&&k>100)){let N=k-w;I!==Ze.GLOBE&&w<100&&(L=Math.min(L,N)),C=Math.min(C,w),V=Math.max(V,k)}}else E instanceof ei?(w=n.frustum.near,k=n.frustum.far):(w=n.frustum.near,k=n.frustum.far,f=Math.min(f,w),x=Math.max(x,k));let U=m[b];l(U)||(U=m[b]=new Out),U.command=E,U.near=w,U.far=k,b++}}_&&(C=Math.min(Math.max(C,n.frustum.near),n.frustum.far),V=Math.max(Math.min(V,n.frustum.far),C)),_&&(t.shadowState.nearPlane=C,t.shadowState.farPlane=V,t.shadowState.closestObjectSize=L),Kut(this,e,f,x);let W,F;for(W=0;W<b;W++)F=m[W],Jut(this,e,F.command,F.near,F.far);if(b<p)for(W=b;W<p&&(F=m[W],!!l(F.command));W++)F.command=void 0;let A=c.length,y=t.frustumSplits;y.length=A+1;for(let Z=0;Z<A;++Z)y[Z]=c[Z].near,Z===A-1&&(y[Z+1]=c[Z].far)};zD.prototype.destroy=function(){this.pickFramebuffer=this.pickFramebuffer&&this.pickFramebuffer.destroy(),this.pickDepthFramebuffer=this.pickDepthFramebuffer&&this.pickDepthFramebuffer.destroy(),this.sceneFramebuffer=this.sceneFramebuffer&&this.sceneFramebuffer.destroy(),this.globeDepth=this.globeDepth&&this.globeDepth.destroy(),this.oit=this.oit&&this.oit.destroy(),this.translucentTileClassification=this.translucentTileClassification&&this.translucentTileClassification.destroy(),this.globeTranslucencyFramebuffer=this.globeTranslucencyFramebuffer&&this.globeTranslucencyFramebuffer.destroy();let e,t=this.pickDepths,n=t.length;for(e=0;e<n;++e)t[e].destroy()};var ET=zD;var cxe=.1,jut=new em({pass:Io.MOST_DETAILED_PRELOAD}),qut=new em({pass:Io.MOST_DETAILED_PICK}),KD=new em({pass:Io.PICK});function Js(e){this._mostDetailedRayPicks=[],this.pickRenderStateCache={},this._pickPositionCache={},this._pickPositionCacheDirty=!1;let t=new ze(0,0,1,1),n=new lo(e);n.frustum=new rn({width:cxe,aspectRatio:1,near:.1}),this._pickOffscreenView=new ET(e,n,t)}Js.prototype.update=function(){this._pickPositionCacheDirty=!0};Js.prototype.getPickDepth=function(e,t){let n=e.view.pickDepths,i=n[t];return l(i)||(i=new Qw,n[t]=i),i};var $ut=new Vr,emt=new h,HD=new h,tmt=new D,nmt=new M;function imt(e,t,n,i,o){let r=e.camera,s=r.frustum,a=s.offCenterFrustum;l(a)&&(s=a);let c=2*(t.x-o.x)/o.width-1;c*=(s.right-s.left)*.5;let d=2*(o.height-t.y-o.y)/o.height-1;d*=(s.top-s.bottom)*.5;let u=M.clone(r.transform,nmt);r._setTransform(M.IDENTITY);let m=h.clone(r.position,emt);h.multiplyByScalar(r.right,c,HD),h.add(HD,m,m),h.multiplyByScalar(r.up,d,HD),h.add(HD,m,m),r._setTransform(u),e.mode===ie.SCENE2D&&h.fromElements(m.z,m.x,m.y,m);let p=s.getPixelDimensions(o.width,o.height,1,1,tmt),b=$ut;return b.right=p.x*.5,b.left=-b.right,b.top=p.y*.5,b.bottom=-b.top,b.near=s.near,b.far=s.far,b.computeCullingVolume(m,r.directionWC,r.upWC)}var omt=new ol,rmt=new D;function smt(e,t,n,i,o){let r=e.camera,s=r.frustum,a=s.near,c=Math.tan(s.fovy*.5),d=s.aspectRatio*c,u=2*(t.x-o.x)/o.width-1,m=2*(o.height-t.y-o.y)/o.height-1,p=u*a*d,b=m*a*c,f=s.getPixelDimensions(o.width,o.height,1,1,rmt),x=f.x*n*.5,_=f.y*i*.5,C=omt;return C.top=b+_,C.bottom=b-_,C.right=p+x,C.left=p-x,C.near=a,C.far=s.far,C.computeCullingVolume(r.positionWC,r.directionWC,r.upWC)}function yj(e,t,n,i,o){let r=e.camera.frustum;return r instanceof rn||r instanceof Vr?imt(e,t,n,i,o):smt(e,t,n,i,o)}var Zh=3,ob=3,Vc=new ze(0,0,Zh,ob),JD=new D,QD=new O(0,0,0,0);function amt(e,t,n,i,o){let r=t._frameState;if(l(t.debugCommandFilter)&&!t.debugCommandFilter(e))return;r.useLogDepth&&l(e.derivedCommands.logDepth)&&(e=e.derivedCommands.logDepth.command);let s=r.passes;if(!s.pick&&!s.depth&&t._hdr&&l(e.derivedCommands)&&l(e.derivedCommands.hdr)&&(e=e.derivedCommands.hdr.command),s.pick||s.depth){if(s.pick&&!s.depth&&l(e.derivedCommands.picking)){e=e.derivedCommands.picking.pickCommand,e.execute(n,i);return}else if(l(e.derivedCommands.depth)){e=e.derivedCommands.depth.depthOnlyCommand,e.execute(n,i);return}}if(t.debugShowCommands||t.debugShowFrustums){t._debugInspector.executeDebugShowFrustumsCommand(t,e,i);return}r.shadowState.lightShadowsEnabled&&e.receiveShadows&&l(e.derivedCommands.shadows)?e.derivedCommands.shadows.receiveCommand.execute(n,i):e.execute(n,i)}function cmt(e,t,n){let i=e._frameState,o=e._context,r=e._view.oit,s=i.shadowState.lightShadowMaps,a=i.shadowState.lightShadowsEnabled,c=t.derivedCommands;l(t.pickId)&&(c.picking=Dd.createPickDerivedCommand(e,t,o,c.picking)),t.pickOnly||(c.depth=Dd.createDepthOnlyDerivedCommand(e,t,o,c.depth)),c.originalCommand=t,e._hdr&&(c.hdr=Dd.createHdrCommand(t,o,c.hdr),t=c.hdr.command,c=t.derivedCommands),a&&t.receiveShadows&&(c.shadows=Lh.createReceiveDerivedCommand(s,t,n,o,c.shadows)),t.pass===Ze.TRANSLUCENT&&l(r)&&r.isSupported()&&(a&&t.receiveShadows?(c.oit=l(c.oit)?c.oit:{},c.oit.shadows=r.createDerivedCommands(c.shadows.receiveCommand,o,c.oit.shadows)):c.oit=r.createDerivedCommands(t,o,c.oit))}function lmt(e,t){e._depthClearCommand.execute(e.context,t);let i=e.camera,o;l(i.frustum.fov)?o=i.frustum.clone(gj):l(i.frustum.infiniteProjectionMatrix)?o=i.frustum.clone(xj):l(i.frustum.width)?o=i.frustum.clone(_j):o=i.frustum.clone(Tj),o.near=i.frustum.near,o.far=i.frustum.far;let r=e.context.uniformState;r.updateFrustum(o),r.updatePass(Ze.OVERLAY);let s=e.context,a=e._overlayCommandList,c=a.length;for(let d=0;d<c;++d)cmt(e,a[d],!1),amt(a[d],e,s,t)}Js.prototype.pick=function(e,t,n,i){Zh=g(n,3),ob=g(i,Zh);let{context:o,frameState:r,defaultView:s}=e,{viewport:a,pickFramebuffer:c}=s;e.view=s,a.x=0,a.y=0,a.width=o.drawingBufferWidth,a.height=o.drawingBufferHeight;let d=s.passState;d.viewport=ze.clone(a,d.viewport);let u=Zi.transformWindowToDrawingBuffer(e,t,JD);e.jobScheduler.disableThisFrame(),e.updateFrameState(),r.cullingVolume=yj(e,u,Zh,ob,a),r.invertClassification=!1,r.passes.pick=!0,r.tilesetPassState=KD,o.uniformState.update(r),e.updateEnvironment(),Vc.x=u.x-(Zh-1)*.5,Vc.y=e.drawingBufferHeight-u.y-(ob-1)*.5,Vc.width=Zh,Vc.height=ob,d=c.begin(Vc,a),e.updateAndExecuteCommands(d,QD),e.resolveFramebuffers(d,()=>{e.enablePickOverlay&&lmt(e,d)});let m=c.end(Vc);return o.endFrame(),m};Js.prototype.pickVoxelCoordinate=function(e,t,n,i){Zh=g(n,3),ob=g(i,Zh);let{context:o,frameState:r,defaultView:s}=e,{viewport:a,pickFramebuffer:c}=s;e.view=s,a.x=0,a.y=0,a.width=o.drawingBufferWidth,a.height=o.drawingBufferHeight;let d=s.passState;d.viewport=ze.clone(a,d.viewport);let u=Zi.transformWindowToDrawingBuffer(e,t,JD);e.jobScheduler.disableThisFrame(),e.updateFrameState(),r.cullingVolume=yj(e,u,Zh,ob,a),r.invertClassification=!1,r.passes.pickVoxel=!0,r.tilesetPassState=KD,o.uniformState.update(r),e.updateEnvironment(),Vc.x=u.x-(Zh-1)*.5,Vc.y=e.drawingBufferHeight-u.y-(ob-1)*.5,Vc.width=Zh,Vc.height=ob,d=c.begin(Vc,a),e.updateAndExecuteCommands(d,QD),e.resolveFramebuffers(d);let m=c.readVoxelInfo(Vc);return o.endFrame(),m};function lxe(e,t){let{defaultView:n,context:i,frameState:o,environmentState:r}=e,{viewport:s,pickDepthFramebuffer:a}=n;e.view=n,s.x=0,s.y=0,s.width=i.drawingBufferWidth,s.height=i.drawingBufferHeight;let c=n.passState;c.viewport=ze.clone(s,c.viewport),e.clearPasses(o.passes),o.passes.pick=!0,o.passes.depth=!0,o.cullingVolume=yj(e,t,1,1,s),o.tilesetPassState=KD,e.updateEnvironment(),r.renderTranslucentDepthForPick=!0,c=a.update(i,t,s),e.updateAndExecuteCommands(c,QD),e.resolveFramebuffers(c),i.endFrame()}var gj=new _i,xj=new ol,_j=new rn,Tj=new Vr;Js.prototype.pickPositionWorldCoordinates=function(e,t,n){if(!e.useDepthPicking)return;let i=t.toString();if(this._pickPositionCacheDirty)this._pickPositionCache={},this._pickPositionCacheDirty=!1;else if(this._pickPositionCache.hasOwnProperty(i))return h.clone(this._pickPositionCache[i],n);let{context:o,frameState:r,camera:s,defaultView:a}=e,{uniformState:c}=o;e.view=a;let d=Zi.transformWindowToDrawingBuffer(e,t,JD);e.pickTranslucentDepth?lxe(e,d):(e.updateFrameState(),c.update(r),e.updateEnvironment()),d.y=e.drawingBufferHeight-d.y;let u;l(s.frustum.fov)?u=s.frustum.clone(gj):l(s.frustum.infiniteProjectionMatrix)?u=s.frustum.clone(xj):l(s.frustum.width)?u=s.frustum.clone(_j):u=s.frustum.clone(Tj);let m=a.frustumCommandsList,p=m.length;for(let b=0;b<p;++b){let x=this.getPickDepth(e,b).getDepth(o,d.x,d.y);if(l(x)&&x>0&&x<1){let _=m[b],C;return e.mode===ie.SCENE2D?(C=s.position.z,s.position.z=C-_.near+1,u.far=Math.max(1,_.far-_.near),u.near=1,c.update(r),c.updateFrustum(u)):(u.near=_.near*(b!==0?e.opaqueFrustumNearOffset:1),u.far=_.far,c.updateFrustum(u)),n=Zi.drawingBufferToWgs84Coordinates(e,d,x,n),e.mode===ie.SCENE2D&&(s.position.z=C,c.update(r)),this._pickPositionCache[i]=h.clone(n),n}}this._pickPositionCache[i]=void 0};var dmt=new he;Js.prototype.pickPosition=function(e,t,n){if(n=this.pickPositionWorldCoordinates(e,t,n),l(n)&&e.mode!==ie.SCENE3D){h.fromElements(n.y,n.z,n.x,n);let i=e.mapProjection,o=i.ellipsoid,r=i.unproject(n,dmt);o.cartographicToCartesian(r,n)}return n};Js.prototype.pickPositionNearest=function(e,t,n=10,i=10,o){if(!e.useDepthPicking)return;if(bi.defined(\"windowPosition\",t),!e.context.depthTexture)throw new fe(\"Picking from the depth buffer is not supported. Check pickPositionSupported.\");let r=t.toString();if(this._pickPositionCacheDirty)this._pickPositionCache={},this._pickPositionCacheDirty=!1;else if(this._pickPositionCache.hasOwnProperty(r))return h.clone(this._pickPositionCache[r],o);let{context:s,frameState:a,camera:c,defaultView:d}=e,{uniformState:u}=s;e.view=d;let m=Zi.transformWindowToDrawingBuffer(e,t,JD);e.pickTranslucentDepth?lxe(e,m):(e.updateFrameState(),u.update(a),e.updateEnvironment()),m.y=e.drawingBufferHeight-m.y;let p;l(c.frustum.fov)?p=c.frustum.clone(gj):l(c.frustum.infiniteProjectionMatrix)?p=c.frustum.clone(xj):l(c.frustum.width)?p=c.frustum.clone(_j):p=c.frustum.clone(Tj);let b=d.frustumCommandsList,f=b.length;for(let x=0;x<f;++x){let C=this.getPickDepth(e,x).getDepthArray(s,m.x,m.y,n,i);if(!Array.isArray(C))continue;let V=C.filter(R=>R!==0);V.sort((R,G)=>R-G);let L=V[0];if(L>0&&L<1){let R=b[x],G;return e.mode===ie.SCENE2D?(G=c.position.z,c.position.z=G-R.near+1,p.far=Math.max(1,R.far-R.near),p.near=1,u.update(a),u.updateFrustum(p)):(p.near=R.near*(x!==0?e.opaqueFrustumNearOffset:1),p.far=R.far,u.updateCamera(c),u.updateFrustum(p)),o=Zi.drawingBufferToWgs84Coordinates(e,m,L,o),e.mode===ie.SCENE2D&&(c.position.z=G,u.update(a)),this._pickPositionCache[r]=h.clone(o),o}}this._pickPositionCache[r]=void 0};function dxe(e,t){let n,i,o=[],r=[],s=[],a=[];l(e)||(e=Number.MAX_VALUE);let c=t();for(;l(c);){let d=c.object,u=c.position,m=c.exclude;if(l(u)&&!l(d)){o.push(c);break}if(!l(d)||!l(d.primitive)||!m&&(o.push(c),0>=--e))break;let p=d.primitive,b=!1;typeof p.getGeometryInstanceAttributes==\"function\"&&l(d.id)&&(i=p.getGeometryInstanceAttributes(d.id),l(i)&&l(i.show)&&(b=!0,i.show=xn.toValue(!1,i.show),s.push(i))),d instanceof Fs&&(b=!0,d.show=!1,a.push(d)),b||(p.show=!1,r.push(p)),c=t()}for(n=0;n<r.length;++n)r[n].show=!0;for(n=0;n<s.length;++n)i=s[n],i.show=xn.toValue(!0,i.show);for(n=0;n<a.length;++n)a[n].show=!0;return o}Js.prototype.drillPick=function(e,t,n,i,o){let r=this;return dxe(n,function(){let c=r.pick(e,t,i,o);if(l(c))return{object:c,position:void 0,exclude:!1}}).map(function(c){return c.object})};var axe=new h,umt=new h;function mmt(e,t,n){this.ray=e,this.width=t,this.tilesets=n,this.ready=!1;let i=this;this.promise=new Promise(o=>{i._completePick=()=>{o()}})}function uxe(e,t,n,i){let o=t.direction,r=h.mostOrthogonalAxis(o,axe),s=h.cross(o,r,axe),a=h.cross(o,s,umt);return i.position=t.origin,i.direction=o,i.up=a,i.right=s,i.frustum.width=g(n,cxe),i.frustum.computeCullingVolume(i.positionWC,i.directionWC,i.upWC)}function hmt(e,t,n){let i=t.frameState,{ray:o,width:r,tilesets:s}=n,a=e._pickOffscreenView.camera,c=uxe(e,o,r,a),d=jut;d.camera=a,d.cullingVolume=c;let u=!0,m=s.length;for(let p=0;p<m;++p){let b=s[p];b.show&&t.primitives.contains(b)&&(b.updateForPass(i,d),u=u&&d.ready)}return u&&n._completePick(),u}Js.prototype.updateMostDetailedRayPicks=function(e){let t=this._mostDetailedRayPicks;for(let n=0;n<t.length;++n)hmt(this,e,t[n])&&t.splice(n--,1)};function mxe(e,t,n){for(let i=0;i<e.length;++i){let o=e.get(i);o.show&&(l(o.isCesium3DTileset)?(!l(t)||t.indexOf(o)===-1)&&n.push(o):o instanceof Ml&&mxe(o,t,n))}}function jD(e,t,n,i,o,r){let s=[];if(mxe(t.primitives,i,s),s.length===0)return Promise.resolve(r());let a=new mmt(n,o,s);return e._mostDetailedRayPicks.push(a),a.promise.then(function(){return r()})}function fmt(e,t){return!l(e)||!l(t)||t.length===0?!1:t.indexOf(e)>-1||t.indexOf(e.primitive)>-1||t.indexOf(e.id)>-1}function pmt(e,t,n,i,o,r,s){let{context:a,frameState:c}=t,d=a.uniformState,u=e._pickOffscreenView;t.view=u,uxe(e,n,o,u.camera),Vc=ze.clone(u.viewport,Vc);let m=u.pickFramebuffer.begin(Vc,u.viewport);t.jobScheduler.disableThisFrame(),t.updateFrameState(),c.invertClassification=!1,c.passes.pick=!0,c.passes.offscreen=!0,s?c.tilesetPassState=qut:c.tilesetPassState=KD,d.update(c),t.updateEnvironment(),t.updateAndExecuteCommands(m,QD),t.resolveFramebuffers(m);let p,b=u.pickFramebuffer.end(Vc);if(t.context.depthTexture){let f=u.frustumCommandsList.length;for(let x=0;x<f;++x){let C=e.getPickDepth(t,x).getDepth(a,0,0);if(l(C)&&C>0&&C<1){let V=u.frustumCommandsList[x],L=V.near*(x!==0?t.opaqueFrustumNearOffset:1),R=V.far,G=L+C*(R-L);p=bn.getPoint(n,G);break}}}if(t.view=t.defaultView,a.endFrame(),l(b)||l(p))return{object:b,position:p,exclude:!l(p)&&r||fmt(b,i)}}function hxe(e,t,n,i,o,r,s,a){return dxe(i,function(){return pmt(e,t,n,o,r,s,a)})}function zV(e,t,n,i,o,r,s){let a=hxe(e,t,n,1,i,o,r,s);if(a.length>0)return a[0]}function fxe(e,t,n,i,o,r,s,a){return hxe(e,t,n,i,o,r,s,a)}function qD(e,t){return new Promise((n,i)=>{t.then(function(o){let r=e.postRender.addEventListener(function(){r(),n(o)});e.requestRender()}).catch(function(o){i(o)})})}Js.prototype.pickFromRay=function(e,t,n,i){return zV(this,e,t,n,i,!1,!1)};Js.prototype.drillPickFromRay=function(e,t,n,i,o){return fxe(this,e,t,n,i,o,!1,!1)};Js.prototype.pickFromRayMostDetailed=function(e,t,n,i){let o=this;return t=bn.clone(t),n=l(n)?n.slice():n,qD(e,jD(o,e,t,n,i,function(){return zV(o,e,t,n,i,!1,!0)}))};Js.prototype.drillPickFromRayMostDetailed=function(e,t,n,i,o){let r=this;return t=bn.clone(t),i=l(i)?i.slice():i,qD(e,jD(r,e,t,i,o,function(){return fxe(r,e,t,n,i,o,!1,!0)}))};var bmt=new h,ymt=new h,gmt=new bn,pxe=new he;function Sj(e,t){let n=e.globe,i=l(n)?n.ellipsoid:e.mapProjection.ellipsoid,o=ai._defaultMaxTerrainHeight,r=i.geodeticSurfaceNormalCartographic(t,ymt),s=he.toCartesian(t,i,bmt),a=gmt;a.origin=s,a.direction=r;let c=new bn;return bn.getPoint(a,o,c.origin),h.negate(r,c.direction),c}function bxe(e,t){let n=e.globe,i=l(n)?n.ellipsoid:e.mapProjection.ellipsoid,o=he.fromCartesian(t,i,pxe);return Sj(e,o)}function yxe(e,t){let n=e.globe,i=l(n)?n.ellipsoid:e.mapProjection.ellipsoid;return he.fromCartesian(t,i,pxe).height}function xmt(e,t,n,i,o){let r=Sj(t,n);return jD(e,t,r,i,o,function(){let s=zV(e,t,r,i,o,!0,!0);if(l(s))return yxe(t,s.position)})}function _mt(e,t,n,i,o,r){let s=bxe(t,n);return jD(e,t,s,i,o,function(){let a=zV(e,t,s,i,o,!0,!0);if(l(a))return h.clone(a.position,r)})}Js.prototype.sampleHeight=function(e,t,n,i){let o=Sj(e,t),r=zV(this,e,o,n,i,!0,!1);if(l(r))return yxe(e,r.position)};Js.prototype.clampToHeight=function(e,t,n,i,o){let r=bxe(e,t),s=zV(this,e,r,n,i,!0,!1);if(l(s))return h.clone(s.position,o)};Js.prototype.sampleHeightMostDetailed=function(e,t,n,i){n=l(n)?n.slice():n;let o=t.length,r=new Array(o);for(let s=0;s<o;++s)r[s]=xmt(this,e,t[s],n,i);return qD(e,Promise.all(r).then(function(s){let a=s.length;for(let c=0;c<a;++c)t[c].height=s[c];return t}))};Js.prototype.clampToHeightMostDetailed=function(e,t,n,i){n=l(n)?n.slice():n;let o=t.length,r=new Array(o);for(let s=0;s<o;++s)r[s]=_mt(this,e,t[s],n,i,t[s]);return qD(e,Promise.all(r).then(function(s){let a=s.length;for(let c=0;c<a;++c)t[c]=s[c];return t}))};Js.prototype.destroy=function(){this._pickOffscreenView=this._pickOffscreenView&&this._pickOffscreenView.destroy()};var cF=Js;var Kwi=T(S(),1);var Cwi=T(S(),1);var RPi=T(S(),1),lF=`uniform sampler2D colorTexture; in vec2 v_textureCoordinates; #ifdef AUTO_EXPOSURE uniform sampler2D autoExposure; #endif void main() { vec4 fragmentColor = texture(colorTexture, v_textureCoordinates); vec3 color = fragmentColor.rgb; #ifdef AUTO_EXPOSURE color /= texture(autoExposure, vec2(0.5)).r; #endif color = czm_acesTonemapping(color); color = czm_inverseGamma(color); out_FragColor = vec4(color, fragmentColor.a); } `;var EPi=T(S(),1),dF=`uniform sampler2D randomTexture; uniform sampler2D depthTexture; uniform float intensity; uniform float bias; uniform float lengthCap; uniform float stepSize; uniform float frustumLength; in vec2 v_textureCoordinates; vec4 clipToEye(vec2 uv, float depth) { vec2 xy = vec2((uv.x * 2.0 - 1.0), ((1.0 - uv.y) * 2.0 - 1.0)); vec4 posEC = czm_inverseProjection * vec4(xy, depth, 1.0); posEC = posEC / posEC.w; return posEC; } //Reconstruct Normal Without Edge Removation vec3 getNormalXEdge(vec3 posInCamera, float depthU, float depthD, float depthL, float depthR, vec2 pixelSize) { vec4 posInCameraUp = clipToEye(v_textureCoordinates - vec2(0.0, pixelSize.y), depthU); vec4 posInCameraDown = clipToEye(v_textureCoordinates + vec2(0.0, pixelSize.y), depthD); vec4 posInCameraLeft = clipToEye(v_textureCoordinates - vec2(pixelSize.x, 0.0),"
}