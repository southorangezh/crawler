{
  "metadata": {
    "source_file": "map-app\\static\\js\\index.5da8ba4c.js",
    "chunk_index": 9,
    "total_chunks": 918,
    "chunk_size": 70611,
    "word_count": 800,
    "model_kwargs": {
      "model": "text-embedding-3-large",
      "dimensions": 3072,
      "encoding_format": "float"
    },
    "text_splitter": {
      "split_by": "word",
      "chunk_size": 800,
      "chunk_overlap": 200
    },
    "created_at": "2025-12-17T23:57:50.144Z"
  },
  "content": "{\\n d1 = abs(st.s - base);\\n }\\n float d2 = abs(st.t - ptOnUpperLineRight);\\n float d3 = abs(st.t - ptOnLowerLineRight);\\n float dist = min(min(d1, d2), d3);\\n\\n float dtUpper = abs(st.t - ptOnUpperLineRight);\\n dtUpper = step(dtUpper, outlineWidth);\\n\\n float dtLower = abs(st.t - ptOnLowerLineRight);\\n dtLower = step(dtLower, outlineWidth);\\n\\n vec4 contentColor;\\n if(outlineShow) {\\n contentColor = mix(color, outlineColor, clamp(dtUpper + dtLower, 0.0, 1.0));\\n } else {\\n contentColor = color;\\n }\\n\\n vec4 outsideColor = vec4(contentColor.r, contentColor.g, contentColor.b, 0.0);\\n vec4 currentColor = mix(outsideColor, contentColor, clamp(s + t, 0.0, 1.0));\\n\\n vec4 outColor = czm_antialias(outlineColor, color, currentColor, dist, 0.05);\\n\\n outColor = czm_gammaCorrect(outColor);\\n material.diffuse = outColor.rgb;\\n material.alpha = outColor.a;\\n return material;\\n }\\n}\\n\"},translucent:!0});class h6{constructor(e){this.color=e.color||uf.Color.WHITE,this.startType=e.startType,this.endType=e.endType,this.outlineShow=e.outlineShow||!1,this.lineWidth=e.lineWidth,e.outlineShow?this.outlineColor=uf.Color.WHITE:this.outlineColor=this.color}color;startType;endType;outlineShow;outlineColor;lineWidth;definitionChanged=new uf.Event;isConstant=!0;equals(e){return this===e||e instanceof h6&&uf.Color.equals(this.color,e.color)&&this.startType===e.startType&&this.endType===e.endType&&this.outlineShow===e.outlineShow&&uf.Color.equals(this.outlineColor,e.outlineColor)&&this.lineWidth===e.lineWidth}getType(e){return h5}getValue(e,a){return!(0,uf.defined)(a)&&(a={}),a.color=this.color,a.startType=this.startType,a.endType=this.endType,a.outlineShow=this.outlineShow,a.outlineColor=this.outlineColor,a.lineWidth=this.lineWidth,a}}function h9(){return{label:{distanceVisible:!0,labelingVisible:!0},all:{visible:!0}}}class h8 extends(0,uX.AF)(pv,ph,pz){managers;constructor(e,a,r){super(),this.managers=a,this.entities=py({}),this.primitives=py({}),this.interactLevel=sc.Line,this._drawingPositions=[],this.label=py({}),this.colorProperty=void 0,this.activeState={selected:!1,recenter:!1,hover:!1},this.runtimeStates={},this.isIntersect=!1,this.isAreaExceed=!1,this.clampWatchers={},this.dynamic=!1,this.namePosition=null,this.nameClampWatcher=null,this.cacheNamePositionHeight=0,this._dynamicPositions=[],this.cacheViewModes={},this.cacheLabelingWindowPosition={},this.cacheScreenSpaceBoundingBox={},this.properties=Object.assign({id:(0,uW.k)(),fontSize:16},e),this.options=Object.assign({},r),this.init(),this.setCollectionMap()}properties;options;entities;primitives;interactLevel;_drawingPositions;label;get usePrimitive(){return(this.options.drawing||this.dynamic)&&!1===this.properties.clampToGround}get firstEntity(){return this.entities._values()[0]}get id(){return this.properties.id}get type(){return\"polyline\"}get typedElement(){return{type:this.type,element:this}}get positions(){return this.properties.positions||[]}set positions(e){if(this.properties.positions=e,!this.dynamic){let e=this.getPositionsCartesian3();this.dynamicPositions?e&&(this._dynamicPositions=e):(this.entities.polyline?.positionsSetter(new uf.ConstantProperty(e)),this.toggleClampWithoutHeight(),this.label.positionSetter(this.getNamePositionCartesian()||new uf.Cartesian3),this.managers.render?.())}this.usePrimitive&&e&&(this.drawingPositions=e)}get drawingPositions(){return this._drawingPositions}set drawingPositions(e){this._drawingPositions=e,this.updatePrimitive(),this.managers._keys().forEach(e=>{this.managers._get(e).editor.updatePositionsFor(this,!1,\"endpoint\")}),this.properties.needCheckIntersect&&this.emitIntersect(e),this.properties.needCheckArea&&this.emitAreaExceed(e)}setPositions(e,a=!1){if(a&&this.properties.needCheckArea&&this.emitAreaExceed(e),a&&this.properties.needCheckIntersect&&this.emitIntersect(e),this.drawingPositions=e,this.active(\"selected\")&&this.dynamic){let a=this.managers._get(f3).editor;if(a.activeElement===this)a.activeShapePoints.value=[e.map(e=>hV((0,pg.jL)(e)))]}else this.positions=e}get name(){return this.properties.name}set name(e){this.properties.name=e,this.label.textSetter(e||\"\"),this.managers.render?.()}get width(){return this.properties.width||3}set width(e){if(this.properties.width!==e){this.properties.width=e;let a=this.useCustomEndPoint&&this.properties.width?5.2*this.properties.width:this.properties.width;this.entities.polyline?.widthSetter(new uf.ConstantProperty(a)),this.managers.render?.()}}get clampToGround(){return this.properties.clampToGround||!1}set clampToGround(e){this.properties.clampToGround=e,this.entities.polyline?.clampToGroundSetter(new uf.ConstantProperty(e)),this.toggleClampWithoutHeight()}get clampWithoutHeight(){return this.properties.clampWithoutHeight||!1}set clampWithoutHeight(e){this.properties.clampWithoutHeight=e,this.toggleClampWithoutHeight()}get useCustomEndPoint(){let e=!!this.properties.customEndpoints,a=this.properties.customEndpoints?.start!==sw.normal||this.properties.customEndpoints?.end!==sw.normal;return e&&a}colorProperty;setColorProperty(e){this.colorProperty=e}get cssColor(){return this.properties.cssColor||\"#FFFFFF\"}set cssColor(e){this.properties.cssColor!==e&&(this.properties.cssColor=e,this.setColorProperty(new uf.ConstantProperty(uf.Color.fromCssColorString(this.properties.cssColor))),this.updateMaterial())}get errorCssColor(){return this.properties.errorCssColor||\"#FFFFFF\"}activeState;runtimeStates;getLabelRuntimeVisible(e=f3){let a=this.runtimeStates[e];!a&&(a=h9());let r=a.label,t=this.active();return!1!==this.properties.show&&r.distanceVisible&&r.labelingVisible||t}getTotalRuntimeVisible(e=f3){let a=this.runtimeStates[e];return!a&&(a=h9()),a.all.visible}updateShowByRuntimeState(e=f3){let a=this.entities._get(e);if(!a)return;let r=this.active();if(a.show=!1!==this.properties.show&&(this.getTotalRuntimeVisible()||r),!this.dynamic){let a=this.label._get(e);if(!a)return;a.show=this.getLabelRuntimeVisible(e)}}isIntersect;isAreaExceed;active(e=\"\",a){if(!this.properties.fromDraw)return!1;if((0,pg.ri)(a)&&e&&this.activeState[e]!==a){let{selected:r,recenter:t,hover:n}=this.activeState;this.activeState[e]=a,this.toggleActive(r||t||n)}if(e)return this.activeState[e];{let{selected:e,recenter:a,hover:r}=this.activeState;return e||a||r}}get boundingSphere(){let e=this.firstEntity?.polyline?.positions?.getValue(uf.JulianDate.now())||this.properties.positions?.map(e=>pg.jL(e));if(e)return uf.BoundingSphere.fromPoints(e)}get fontSize(){return this.properties.fontSize||16}set fontSize(e){this.properties.fontSize=e,this.label.fontSetter(this.getFont())}getFont(){return`600 ${this.fontSize}px ${pC}`}emitIntersect(e){let a=mP(e);a!==this.isIntersect&&(this.isIntersect=a,this.managers._get(f3).emit(\"elementSelfIntersection\",this,a,this.origin))}emitAreaExceed(e){let a=this.managers._get(f3).measurer.getHorizontalArea(e.map(pg.i9)),r=!!this.properties.maxArea&&a>this.properties.maxArea;r!==this.isAreaExceed&&(this.isAreaExceed=r,this.managers._get(f3).emit(\"elementAreaOversize\",this,{exceed:r,changeMode:sb.none,origin:this.origin}))}updatePrimitive(){let e=this.drawingPositions.map(e=>(0,pg.jL)(e,!1));this.managers._keys().forEach(a=>{this.removePrimitive(a),this.addPrimitive(a,e)})}applyWidth(){let e=this.width+(this.properties.outlineWidth||2);this.useCustomEndPoint&&(e=5.2*this.width),this.entities.polyline?.widthSetter(new uf.ConstantProperty(e)),this.managers.render?.()}update(e){if(this.isDestroyed)return;let a=this.properties;if((0,pg.ri)(e.name)&&(this.name=e.name),(0,pg.ri)(e.cssColor)&&(this.cssColor=e.cssColor),(0,pg.ri)(e.dash)&&(a.dash=e.dash),(0,pg.ri)(e.isFence)&&(a.isFence=e.isFence),(0,pg.ri)(e.dashMaskLength)&&(a.dashMaskLength=e.dashMaskLength),(0,pg.ri)(e.direction)&&(a.direction=e.direction),(0,pg.ri)(e.depthFailAlpha)&&(a.depthFailAlpha=e.depthFailAlpha),(0,pg.ri)(e.positions)&&(this.positions=e.positions),(0,pg.ri)(e.width)&&(this.width=e.width),(0,pg.ri)(e.outlineWidth)&&(a.outlineWidth=e.outlineWidth),(0,pg.ri)(e.show)&&(this.properties.show=e.show,this.entities.showSetter(e.show)),(0,pg.ri)(e.depthFailCssColor)&&(a.depthFailCssColor=e.depthFailCssColor),(0,pg.ri)(e.customEndpoints)&&(this.properties.customEndpoints=e.customEndpoints,this.applyWidth()),(0,pg.ri)(e.fontSize)&&(this.fontSize=e.fontSize),e.labelDistanceDisplayCondition&&(a.labelDistanceDisplayCondition=e.labelDistanceDisplayCondition,this.label.distanceDisplayConditionSetter(new uf.DistanceDisplayCondition(...e.labelDistanceDisplayCondition)),this.entities.polyline?.distanceDisplayConditionSetter(new uf.ConstantProperty(new uf.DistanceDisplayCondition(...e.labelDistanceDisplayCondition)))),e.labelScaleByDistance){a.labelScaleByDistance=e.labelScaleByDistance;let r=new uf.NearFarScalar(...e.labelScaleByDistance);this.label.scaleByDistanceSetter(r),this.label.pixelOffsetScaleByDistanceSetter(r)}e.placeable&&(a.placeable=e.placeable);let r=e.labelOccludedAlpha;(0,pg.ri)(r)&&(a.labelOccludedAlpha=0===r?void 0:r),(0,pg.ri)(e.labelEnableOccludeIn2dView)&&(a.labelEnableOccludeIn2dView=e.labelEnableOccludeIn2dView),pg.Pg.call(this,this.properties,{fromDraw:e.fromDraw}),this.updateRuntimeOccludeStyle(),this.updateMaterial(),(0,pg.ri)(e.contextmenu)&&(a.contextmenu=e.contextmenu),(0,pg.ri)(e.removable)&&(a.removable=e.removable),this.usePrimitive&&this.updatePrimitive()}edit(e){this.managers._get(f3).editor.enterEdit(\"line\",this,e)}getEntityOptions(){let e={id:this.id,show:this.properties.show,polyline:{positions:this.getPositionsCartesian3(),width:this.useCustomEndPoint&&this.properties.width?5.2*this.properties.width:this.properties.width,clampToGround:this.properties.clampToGround,zIndex:this.properties.zIndex}},a=this.properties.labelDistanceDisplayCondition?new uf.DistanceDisplayCondition(...this.properties.labelDistanceDisplayCondition):void 0,r=this.properties.labelScaleByDistance?new uf.NearFarScalar(...this.properties.labelScaleByDistance):void 0,t=this.getFont(),n={id:`${this.id}-label`,show:!1!==this.properties.show,position:this.getNamePositionCartesian()||new uf.Cartesian3,text:this.properties.name,...px,font:t,distanceDisplayCondition:a,scaleByDistance:r,pixelOffsetScaleByDistance:r,depthFailTranslucency:this.properties.labelOccludedAlpha,verticalOrigin:uf.VerticalOrigin.BOTTOM,pixelOffset:new uf.Cartesian2(0,-5)};return this.options.drawing&&(this.dynamic=!0,this.options.positionsCallback&&e.polyline&&(e.polyline.positions=new uf.CallbackProperty(this.options.positionsCallback,!1))),this.properties.dynamicPositions&&e.polyline&&(e.polyline.positions=this.getDynamicPositions(!0)),{options:e,labelOptions:n}}init(){this.setColorProperty(new uf.ConstantProperty(uf.Color.fromCssColorString(this.cssColor))),super.init(),this.toggleClampWithoutHeight()}toggleActive(e){let a=this.active();if(a!==e){if(a){let e=uf.Color.fromCssColorString(this.active(\"recenter\")?pI:pD),a=this.colorProperty;this.properties.customEndpoints&&this.useCustomEndPoint?this.entities.polyline?.widthSetter(new uf.ConstantProperty(((5.2*this.width)??3)+2)):this.properties.direction?this.entities.polyline?.widthSetter(new uf.ConstantProperty((this.width??3)+2/2)):this.properties.isFence?this.entities.polyline?.widthSetter(new uf.ConstantProperty(16)):this.entities.polyline?.widthSetter(new uf.ConstantProperty((this.width??3)+2)),this.entities.polyline?.materialSetter(this.getActiveMaterial());let r=this.getDepthFailMaterial();r&&!this.dynamic&&this.entities.polyline?.depthFailMaterialSetter(r),this.label.fillColorSetter(a?.getValue(uf.JulianDate.now())),this.label.outlineColorSetter(e),!this.active(\"selected\")&&this.active(\"hover\")&&(this.entities.polyline?.showSetter(new uf.ConstantProperty(!0)),this.label.showSetter(!0))}else{this.entities.polyline?.materialSetter(this.getMaterial());let e=this.useCustomEndPoint?5.2*this.width:this.width;this.entities.polyline?.widthSetter(new uf.ConstantProperty(e)),this.label.fillColorSetter(px.fillColor),this.label.outlineColorSetter(px.outlineColor),this.managers._keys().forEach(e=>{this.updateShowByRuntimeState(e)})}this.updatePrimitive(),this.updateRuntimeOccludeStyle(),this.managers.render?.()}}clampWatchers;updatePositionCallback(e,a){let r=this.firstEntity;if(a&&r?.polyline){let t=r.polyline.positions?.getValue(uf.JulianDate.now());t?.[e]&&(this.entities.polyline?.positionsSetter(t.map((r,t)=>t===e?a:r)),this.managers.render?.())}}removeWatcher(e){this.clampWatchers[e]&&(this.clampWatchers[e].unclamp(),delete this.clampWatchers[e])}toggleClampWithoutHeight(){if(this.properties.clampToGround||!this.properties.clampWithoutHeight||this.dynamic)Object.keys(this.clampWatchers).forEach(e=>this.removeWatcher(Number(e)));else{let e=this.positions;e&&e.forEach((e,a)=>{if((0,pg.ri)(e.height))this.removeWatcher(a);else{let r=uf.Cartographic.fromDegrees(e.longitude,e.latitude);this.clampWatchers[a]?this.clampWatchers[a].update(r):this.clampWatchers[a]=this.managers._get(f3)?.picker.clampWithWatcher(r,e=>this.updatePositionCallback(a,e))}})}}setCollectionMap(){this.managers._options.elements.add(\"polyline\",this,[this.id])}dynamic;stabilize(e){if(this.dynamic=!1,this.options.drawing&&(this.options.drawing=!1),this.options.positionsCallback=void 0,this.toggleClampWithoutHeight(),this.firstEntity?.polyline){let a=e||this.firstEntity.polyline.positions?.getValue(uf.JulianDate.now());a&&(this.properties.positions=a.map(e=>(0,pg.KO)(e,!0)),this.entities.polyline?.positionsSetter(a))}this.label.positionSetter(this.getNamePositionCartesian()||new uf.Cartesian3),this.label.showSetter(!0),this.managers.render?.()}dynamize(e){this.dynamic=!0,this.options=Object.assign(this.options,e),this.usePrimitive?(this.entities.polyline?.showSetter(new uf.ConstantProperty(!1)),this.drawingPositions=this.positions):(this.toggleClampWithoutHeight(),this.entities.polyline?.positionsSetter(this.options.positionsCallback&&new uf.CallbackProperty(this.options.positionsCallback,!1))),this.updateShowByRuntimeState(),this.label.showSetter(!1)}getPositionsCartesian3(){if(this.properties.positions)return this.properties.positions.map(e=>(0,pg.jL)(e))}updateMaterial(){if(this.usePrimitive)return;this.active()?this.entities.polyline?.materialSetter(this.getActiveMaterial()):this.entities.polyline?.materialSetter(this.getMaterial());let e=this.getDepthFailMaterial();e&&this.entities.polyline?.depthFailMaterialSetter(e)}getMaterial(){let e=uf.Color.WHITE;this.properties.cssColor&&(e=uf.Color.fromCssColorString(this.properties.cssColor));let{outlineCssColor:a,outlineWidth:r}=this.properties,t=uf.Color.fromCssColorString(a||\"#fff\");if(this.useCustomEndPoint&&this.properties.customEndpoints)return new h6({color:e,startType:this.properties.customEndpoints.start,endType:this.properties.customEndpoints.end,lineWidth:this.width});if(this.properties.direction)return new h4(e,r,t);if(this.properties.dash){let a={color:e};return(0,pg.ri)(this.properties.dashLength)&&(a.dashLength=this.properties.dashLength),(0,pg.ri)(this.properties.dashMaskLength)&&(a.dashPattern=2**this.properties.dashMaskLength-1),new uf.PolylineDashMaterialProperty(a)}else if(this.properties.isFence)return new mZ(e);else return new uf.ColorMaterialProperty(e)}getDepthFailMaterial(){if((0,pg.ri)(this.properties.depthFailAlpha)){let e=uf.Color.WHITE;return this.properties.cssColor&&(e=uf.Color.fromCssColorString(this.properties.cssColor)),this.properties.depthFailCssColor&&(e=uf.Color.fromCssColorString(this.properties.depthFailCssColor)),new uf.PolylineDashMaterialProperty({color:uf.Color.fromAlpha(e,this.properties.depthFailAlpha)})}}getActiveMaterial(){let e=uf.Color.fromCssColorString(this.active(\"recenter\")?pI:pD),a=this.colorProperty;if(this.properties.customEndpoints&&this.useCustomEndPoint)return new h6({color:a?.getValue(uf.JulianDate.now()),startType:this.properties.customEndpoints.start,endType:this.properties.customEndpoints.end,outlineShow:!0,lineWidth:this.width});if(this.properties.direction)return new h4(a?.getValue(uf.JulianDate.now()),2);if(this.properties.isFence)return new mZ(a?.getValue(uf.JulianDate.now()),uf.Color.fromCssColorString(\"#ffffff\"),10);else return new uf.PolylineOutlineMaterialProperty({color:a,outlineColor:e,outlineWidth:2})}getNamePositionCartesian(){let e=this.properties.positions||[];if(!this.dynamic&&e.length>0)return this.namePosition=e[Math.floor(e.length/2)],window.setTimeout(()=>{this.toggleNameClampWithoutHeight()}),uf.Cartesian3.fromDegrees(this.namePosition.longitude,this.namePosition.latitude,this.namePosition.height)}namePosition;nameClampWatcher;cacheNamePositionHeight;updateNamePositionCallback(e){if(!!this.clampToGround)e&&(this.label.positionSetter(e),this.cacheNamePositionHeight=uf.Cartographic.fromCartesian(e).height,this.managers.render?.())}toggleNameClampWithoutHeight(){let e=this.namePosition;if(e){let a=uf.Cartographic.fromDegrees(e.longitude,e.latitude);this.nameClampWatcher?this.nameClampWatcher.update(a):this.nameClampWatcher=this.managers._get(f3).picker.clampWithWatcher(a,e=>this.updateNamePositionCallback(e))}}removeNameWatcher(){this.nameClampWatcher&&(this.nameClampWatcher?.unclamp(),this.nameClampWatcher=null)}_dynamicPositions;get dynamicPositions(){return this.properties.dynamicPositions||!1}set dynamicPositions(e){e!==this.properties.dynamicPositions&&(this.entities.polyline?.positionsSetter(this.getDynamicPositions(e)),this.properties.dynamicPositions=e)}getDynamicPositions(e){let a=this.getPositionsCartesian3();return e?(a&&(this._dynamicPositions=a),new uf.CallbackProperty(()=>this._dynamicPositions,!1)):(this._dynamicPositions=[],new uf.ConstantProperty(a))}cacheViewModes;onSceneChange(e,a){this.updateVisibleByDistance(e),this.updateShowByRuntimeState(e.id);let{is3D:r,id:t}=e;if(r&&\"3D\"===this.cacheViewModes[t]||!r&&\"2D\"===this.cacheViewModes[t])return;if(this.cacheViewModes[t]=r?\"3D\":\"2D\",!this.active())this.updateRuntimeOccludeStyle([e.id])}updateRuntimeOccludeStyle(e){let a=this.active(),r=!!this.properties.labelEnableOccludeIn2dView;(!Array.isArray(e)||0===e.length)&&(e=Object.keys(this.cacheViewModes)),e.forEach(e=>{let t=this.cacheViewModes[e];if(void 0===t)return;let{occludedAlpha:n,disableDepthTestDistance:i}=mb(t,a,r,this.properties.labelOccludedAlpha,void 0);this.label.depthFailTranslucencySetter(n),this.label.disableDepthTestDistanceSetter(i)})}updateVisibleByDistance(e){let a=this.anchor;if(!a)return;let r=e.viewer.camera.positionWC,t=this.properties.labelDistanceDisplayCondition,n=this.runtimeStates[e.id];if(t){let e=uf.Cartesian3.distance(r,a),i=e<t[1];n&&(n.label.distanceVisible=i||e>t[0],n.all.visible=i)}}get placeable(){return!!this.properties.placeable}set placeable(e){this.properties.placeable=e}get anchor(){if(!this.namePosition)return null;let e={longitude:this.namePosition.longitude,latitude:this.namePosition.latitude,height:this.cacheNamePositionHeight};return(0,pg.jL)(e)}cacheLabelingWindowPosition;getLabelingWindowPosition(e){let a=this.managers._get(e).viewer.scene;if(!a)return null;let r=a.frameState.frameNumber;if(this.cacheLabelingWindowPosition[e]?.frameNumber===r)return this.cacheLabelingWindowPosition[e].labelingWindowPosition||null;let t=null;if(this.namePosition){let e=(0,pg.jL)(this.namePosition);if(e){let r=uf.SceneTransforms.wgs84ToWindowCoordinates(a,e);r&&(t=r)}}return this.cacheLabelingWindowPosition[e]={frameNumber:r,labelingWindowPosition:t},t}cacheScreenSpaceBoundingBox;getScreenSpaceBoundingBox(e,a){let r=this.managers._get(e)?.viewer?.scene;if(!r)return null;let t=r.frameState.frameNumber;if(this.cacheScreenSpaceBoundingBox[e]?.frameNumber===t)return this.cacheScreenSpaceBoundingBox[e].screenSpaceBoundingBox||null;let n=null;if(!a&&(a=this.getCurrentPlacement(e)),\"UnSet\"!==a){let a=this.label._get(e),t=this.getLabelingWindowPosition(e);if(r&&a&&t){let e=uf.Label.getScreenSpaceBoundingBox(a,t,new uf.BoundingRectangle);n=p2.fromCesiumBoundingRect(e)}}return this.cacheScreenSpaceBoundingBox[e]={frameNumber:t,screenSpaceBoundingBox:n},n}resetPlacement(e){}getCurrentPlacement(e){return\"Center\"}nextPlacement(e){return\"UnSet\"}updateLabelingVisible(e){this.entities.label?.showSetter(new uf.ConstantProperty(e))}updateLabeling(e,{visible:a}){let r=this.runtimeStates[e];void 0!==a&&r&&(r.label.labelingVisible=a,this.updateShowByRuntimeState(e))}getLabelVisible(e=f3){let a=this.entities.label?.show?._get(e);return!!a&&a.getValue(uf.JulianDate.now())}canPlaceable(e){if(!this.placeable)return!1;if(!1===this.properties.show)return this.properties.show;let{screenRect:a,manager:r,managerId:t}=e,n=this.getScreenSpaceBoundingBox(t);if(!n||!p2.intersect(a,n,0))return!1;let i=this.properties.labelDistanceDisplayCondition;if(i&&this.anchor){let e=r.viewer.camera.positionWC,a=uf.Cartesian3.distance(e,this.anchor);return a>i[0]||a<i[1]}return!0}onManagerAdd(e){let a=this.managers._get(e);if(this.runtimeStates[e]=h9(),a){this.addPrimitive(e,this.getPositionsCartesian3()||[]);let{options:r,labelOptions:t}=this.getEntityOptions();this.entities._add(e,a.viewer.entities.add(r)),this.label._add(e,a.labelVisualizer.add(t)),this.options.drawing&&this.active(\"selected\",!0),this.updateMaterial()}}addPrimitive(e,a){if(!this.usePrimitive||a.length<2)return;let r=this.managers._get(e);if(!r)return;let{width:t,outlineWidth:n}=this.properties,{drawing:i}=this.options,o=this.active()||i,s=new uf.GeometryInstance({geometry:new uf.PolylineGeometry({positions:a,width:o?6:t||4,vertexFormat:uf.PolylineMaterialAppearance.VERTEX_FORMAT}),id:\"linePrimitive\"}),l=new uf.PolylineMaterialAppearance({material:new uf.Material({fabric:{type:o?uf.Material.PolylineOutlineType:uf.Material.ColorType,uniforms:{color:uf.Color.fromCssColorString(this.properties.cssColor||\"#fff\"),outlineColor:uf.Color.fromCssColorString(pI),outlineWidth:o?n||3:0}}})}),d=new uf.PolylineMaterialAppearance({material:new uf.Material({fabric:{type:uf.Material.PolylineDashType,uniforms:{color:uf.Color.fromCssColorString(this.properties.cssColor||\"#fff\"),gapColor:new uf.Color(0,0,0,0),dashLength:16,dashPattern:255}}})}),c=new uf.Primitive({geometryInstances:s,asynchronous:!1,appearance:l,depthFailAppearance:d});r.viewer.scene.primitives.add(c),this.primitives._add(e,c)}removePrimitive(e){let a=this.managers._get(e),r=this.primitives._get(e);a&&r&&(a.viewer.scene.primitives.remove(r),this.primitives._remove(e))}onManagerRemove(e){let a=this.entities._get(e);a?.entityCollection.remove(a),this.entities._remove(e),this.removePrimitive(e);let r=this.managers._get(e),t=this.label._get(e);r?.labelVisualizer.remove(t),this.label._remove(e)}onManagerUpdate(e){let a=this.entities._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}destroy(){super.destroy(),this.removeNameWatcher(),this.managers._keys().forEach(e=>{this.onManagerRemove(e)})}hasPrimitive(e){return this.primitives._values().includes(e)||this.label._values().includes(e)}}let h7=Object.freeze({type:\"normal\",outlineCssColor:pT.NormalOutlineColor,outlineWidth:pT.NormalOutlineWidth});function ge(e){let a=e.occludedCssColor,r=e.occludedAlpha;return new uf.PolylineMaterialAppearance({material:uf.Material.fromType(uf.Material.PolylineDashType,{color:uf.Color.fromCssColorString(a).withAlpha(r)})})}function ga(e){let a;let r=e.active(),t=e.lineStyle||h7,n=e.cssColor;if(\"normal\"===t.type){if(r){let e=t.outlineCssColor||pT.ActiveColor,r=t.outlineWidth||pT.ActiveOutlineWidth;a=uf.Material.fromType(uf.Material.PolylineOutlineType,{color:uf.Color.fromCssColorString(n),outlineColor:uf.Color.fromCssColorString(e),outlineWidth:r})}else a=uf.Material.fromType(uf.Material.ColorType,{color:uf.Color.fromCssColorString(n)})}else{let e=t.dashMaskLength||pT.DashMaskLength;a=uf.Material.fromType(uf.Material.PolylineDashType,{color:uf.Color.fromCssColorString(n),dashLength:t.dashLength||pT.DashLength,dashPattern:2**e-1})}return new uf.PolylineMaterialAppearance({material:a})}class gr extends(0,uX.AF)(pv,ph,pz){managers;interactLevel;terrainHeightsPromise;readyForGroundGeometry;properties;options;primitives;locatingLines;namePositionLngLat;namePositionHeight;namePositionClampWatcher;constructor(e,a,r){super(),this.managers=a,this.interactLevel=sc.Line,this.terrainHeightsPromise=uf.GroundPolylinePrimitive.initializeTerrainHeights(),this.readyForGroundGeometry=!1,this.primitives=py({}),this.locatingLines=[],this.namePositionLngLat=null,this.namePositionHeight=0,this.namePositionClampWatcher=null,this.activeState={selected:!1,recenter:!1,hover:!1},this.copyCount=0,this.cacheStatus={},this.terrainHeightsPromise.then(()=>{this.readyForGroundGeometry=!0}),this.properties=Object.assign({id:(0,uW.k)(),show:!0,type:\"polyline3d\",cssColor:hZ},e),this.options=Object.assign({},r),this.updateNamePosition(),this.init(),this.setCollectionMap()}get id(){return String(this.properties.id)}get type(){return\"polyline3d\"}get typedElement(){return{type:this.type,element:this}}get grounded(){return!1!==this.properties.clampToGround}get positions(){return this.properties.positions||[]}get cssColor(){return this.properties.cssColor||hZ}get occludedCssColor(){return this.properties.occludedCssColor||this.cssColor}get occludedAlpha(){return this.properties.occludedAlpha||pT.OccludedAlpha}get lineStyle(){return this.properties.lineStyle||h7}get boundingSphere(){let e=this.properties.positions?.map(e=>pg.jL(e));if(e)return uf.BoundingSphere.fromPoints(e)}get enableGroundShadow(){return this.properties.enableGroundShadow||pT.GroundShadow}shouldCreateGroundShadow(){return!this.grounded&&this.enableGroundShadow}get useAsyncGeometry(){return!this.readyForGroundGeometry}updateNamePosition(){let e=this.positions;if(!(e.length>1))return;this.namePositionLngLat=e[Math.floor(e.length/2)],this.namePositionHeight=this.namePositionLngLat.height||0;let a=this.namePositionLngLat;if(this.grounded&&a){let e=this.namePositionClampWatcher,r=(0,pg.i9)(a);e?e.update(r):this.namePositionClampWatcher=this.managers._get(f3).picker.clampWithWatcher(r,e=>{if(!!e)this.namePositionLngLat=hu.fromCartesian(e),this.namePositionHeight=this.namePositionLngLat.height||0})}}getWidthByStatus(){let e=this.properties.width||pT.LineWidth;return\"normal\"!==this.lineStyle.type?e:this.active()?e+(this.lineStyle.outlineWidth||pT.ActiveOutlineWidth):e}activeState;toggleActive(e){if(e!==this.active())this.primitives._keys().forEach(e=>{this.updatePolylinePrimitive(e),this.updateNameLabel(e),this.managers._get(e).render()})}active(e=\"\",a){if(!this.properties.fromDraw)return!1;if((0,pg.ri)(a)&&e&&this.activeState[e]!==a){let{selected:r,recenter:t,hover:n}=this.activeState;this.activeState[e]=a,this.toggleActive(r||t||n)}if(e)return this.activeState[e];{let{selected:e,recenter:a,hover:r}=this.activeState;return e||a||r}}getGroundShadowGeometryOptions(){return{positions:this.positions.map(e=>(0,pg.jL)(e)),width:pT.GroundShadowWidth}}getPolylineGeometryOptions(){return this.grounded?{positions:this.positions.map(e=>(0,pg.jL)(e)),width:this.getWidthByStatus()}:{arcType:uf.ArcType.NONE,positions:this.positions.map(e=>(0,pg.jL)(e)),width:this.getWidthByStatus()}}copyCount;convertToGroundEl(){let e=this.properties;if(!e.positions||e.positions.length<2)return null;let a=this.positions.map(e=>hu.clone(e));return new h8({category:e.category,clampToGround:!0,name:`${e.name}_${++this.copyCount}`,positions:a,width:e.width,cssColor:e.cssColor,fromDraw:!0,placeable:!0,removable:this.properties.removable,labelDistanceDisplayCondition:e.labelDistanceDisplayCondition,labelScaleByDistance:e.labelScaleByDistance,labelOccludedAlpha:e.labelOccludedAlpha},this.managers)}edit(e){this.managers._get(f3)?.editor?.enterEdit?.(\"polyline3d\",this,e)}stabilize(){}exitEdit(){}cacheStatus;onSceneChange(e){this.updateVisibleByDistance(e);let{is3D:a,id:r}=e;this.updateShowByRuntimeState(e.id);let t=this.cacheStatus[r];if(!t&&(t=gr.createDefaultCacheStatus(r)),a&&\"3D\"===t.sceneMode||!a&&\"2D\"===t.sceneMode)return;if(t.sceneMode=a?\"3D\":\"2D\",!this.active())this.updateRuntimeOccludedStyle([r])}getRuntimeLabelVisible({label:e}){let a=this.active();return!1!==this.properties.show&&e.distanceVisible&&e.labelingVisible||a}getRuntimeLineVisible(e){let a=this.active();return!1!==this.properties.show&&e.line.distanceVisible||a}updateShowByRuntimeState(e){let a=this.primitives._get(e),r=this.cacheStatus[e];if(!!a&&!!r)a.nameLabel&&(a.nameLabel.show=this.getRuntimeLabelVisible(r)),a.line&&(a.line.show=this.getRuntimeLineVisible(r))}updateVisibleByDistance(e){let a=this.namePositionLngLat;if(!a)return;let r=e.viewer.camera.positionWC,t=this.properties.labelDistanceDisplayCondition,n=this.cacheStatus[e.id];if(t){let e=uf.Cartesian3.distance(r,(0,pg.jL)(a)),i=e<t[1];n&&(n.label.distanceVisible=i&&e>t[0],n.line.distanceVisible=i&&e>t[0])}}updateRuntimeOccludedStyle(e){let a=this.active(),r=!!this.properties.labelEnableOccludeIn2dView;(!Array.isArray(e)||0===e.length)&&(e=Object.keys(this.cacheStatus)),e.forEach(e=>{let t=this.cacheStatus[e]?.sceneMode;if(void 0===t)return;let{occludedAlpha:n,disableDepthTestDistance:i}=mb(t,a,r,this.properties.labelOccludedAlpha,void 0),o=this.primitives.nameLabel?._get(e);if(!!o)o.depthFailTranslucency=n,o.disableDepthTestDistance=i})}get placeable(){return!!this.properties.placeable}set placeable(e){this.properties.placeable=e}get anchor(){return this.namePositionLngLat?(0,pg.jL)(this.namePositionLngLat):null}getScreenSpaceBoundingBox(e,a){let r=this.managers._get(e)?.viewer.scene,t=this.primitives._get(e);if(!a&&(a=this.getCurrentPlacement()),\"UnSet\"===a||!r||!t)return null;let n=t.nameLabel;if(!this.anchor||!n)return null;let i=n.computeScreenSpacePosition(r);if(!i)return null;let o=uf.Label.getScreenSpaceBoundingBox(n,i);return p2.fromCesiumBoundingRect(o)}getLabelingWindowPosition(e){let a=this.primitives._get(e),r=this.managers._get(e)?.viewer.scene;return a&&a.nameLabel?a.nameLabel.computeScreenSpacePosition(r):null}getCurrentPlacement(){return\"Center\"}nextPlacement(){return\"UnSet\"}resetPlacement(){}updateLabeling(e,a){let r=this.cacheStatus[e];void 0!==a.visible&&r&&(r.label.labelingVisible=a.visible,this.updateShowByRuntimeState(e))}canPlaceable(e){if(!this.placeable)return!1;if(!1===this.properties.show)return this.properties.show;let{screenRect:a,manager:r,managerId:t}=e,n=this.getScreenSpaceBoundingBox(t);if(!n||!p2.intersect(a,n,0))return!1;let i=this.properties.labelDistanceDisplayCondition;if(i&&this.anchor){let e=r.viewer.camera.positionWC,a=uf.Cartesian3.distance(e,this.anchor);return a>i[0]||a<i[1]}return!0}setCollectionMap(){this.managers._options.elements.add(\"polyline3d\",this,[this.properties.id])}updatePolylineStyle(e){let a=this.primitives._get(e).line;if(!a)return;let r=ga(this);a.appearance=r}updatePolylineOccludedStyle(e){let a=this.primitives._get(e).line;if(!a||a instanceof uf.GroundPolylinePrimitive&&this.grounded)return;let r=ge(this);a.depthFailAppearance=r}updatePolylinePrimitive(e){let a=this.managers._get(e);if(!a)return;let r=a.primitiveContainers.polyline3d,t=this.primitives._get(e);!t&&(this.primitives._add(e,{}),t=this.primitives._get(e));let n=t.line;if(n&&r.contains(n)&&r.remove(n),t.line=void 0,!1===this.properties.show)return;let i=function(e){let a=e.positions,r=e.grounded,t=[];if(a.length>=2){let a=e.getPolylineGeometryOptions(),n=r?new uf.GroundPolylineGeometry(a):new uf.PolylineGeometry(a);t.push(new uf.GeometryInstance({id:`polyline-${e.id}`,geometry:n}))}let n=ga(e);if(r)return new uf.GroundPolylinePrimitive({geometryInstances:t,asynchronous:e.useAsyncGeometry,appearance:n,classificationType:uf.ClassificationType.BOTH});{let a=ge(e);return new uf.Primitive({geometryInstances:t,asynchronous:!1,appearance:n,depthFailAppearance:a})}}(this);t.line=i,r.add(i),this.shouldCreateGroundShadow()&&this.updateGroundShadow(e)}setCesiumLabelParams(e){let{labelScaleByDistance:a,labelOccludedAlpha:r,labelDistanceDisplayCondition:t}=this.properties,n=a?new uf.NearFarScalar(...a):void 0;e.scaleByDistance=n,e.pixelOffsetScaleByDistance=n,e.depthFailTranslucency=r,e.distanceDisplayCondition=t?new uf.DistanceDisplayCondition(...t):void 0}updateNameLabel(e){let a=this.primitives._get(e),r=this.managers._get(e),t=r.nameLabelCollection,n=this.active();if(!r||!a||!t)return;let i=a.nameLabel;if(i)i.fillColor=n?uf.Color.fromCssColorString(this.cssColor):pT.LabelOptions.fillColor,i.text=String(this.properties.name),this.namePositionLngLat&&(i.position=(0,pg.jL)(this.namePositionLngLat)),i.disableDepthTestDistance=n?Number.POSITIVE_INFINITY:0,this.setCesiumLabelParams(i);else{let e=this.namePositionLngLat;if(!1===this.properties.show||!e)return;let r={position:(0,pg.jL)(e),text:this.properties.name,depthFailTranslucency:this.properties.labelOccludedAlpha,disableDepthTestDistance:n?Number.POSITIVE_INFINITY:0,pixelOffset:new uf.Cartesian2(0,-5)};n&&(r.fillColor=uf.Color.fromCssColorString(this.cssColor));let i=Object.assign({},pT.LabelOptions,r),o=t.add(i);this.setCesiumLabelParams(o),a.nameLabel=o}}updateGroundShadow(e){let a=this.managers._get(e);if(!a)return;let r=a.primitiveContainers.polyline3d,t=this.primitives._get(e);!t&&(this.primitives._add(e,{}),t=this.primitives._get(e));let n=t.shadow;n&&r.contains(n)&&r.remove(n),t.shadow=void 0;let i=this.active();if(!1===this.properties.show||!i)return;let o=function(e){let a=e.positions,r=[];if(a.length>=2){let a=e.getGroundShadowGeometryOptions(),t=new uf.GroundPolylineGeometry(a);r.push(new uf.GeometryInstance({id:`polyline-shadow-${e.id}`,geometry:t}))}let t=new uf.PolylineMaterialAppearance({material:uf.Material.fromType(uf.Material.ColorType,{color:uf.Color.fromCssColorString(pT.GroundShadowColor).withAlpha(pT.GroundShadowAlpha)})});return new uf.GroundPolylinePrimitive({geometryInstances:r,asynchronous:e.useAsyncGeometry,appearance:t})}(this);t.shadow=o,r.add(o)}updatePolylineStyleAllManagers(){this.managers._keys().forEach(e=>{this.updatePolylineStyle(e)})}updatePolylineOccludedStyleAllManagers(){this.managers._keys().forEach(e=>{this.updatePolylineOccludedStyle(e)})}updateAllManagers(){this.managers._keys().forEach(e=>{this.updatePolylinePrimitive(e),this.updateNameLabel(e),this.managers._get(e).render()})}updateNameLabelAllManagers(){this.managers._keys().forEach(e=>{this.updateNameLabel(e)})}updateShow(){let e=!1!==this.properties.show,a=this.primitives;a.line&&a.line.showSetter(e),a.nameLabel&&a.nameLabel.showSetter(e),a.shadow&&a.shadow.showSetter(e)}addPrimitives(e){this.updatePolylinePrimitive(e),this.updateNameLabel(e),this.managers._get(e).render()}removePrimitives(e){let a=this.primitives._get(e),r=this.managers._get(e);if(!r||!a)return;let t=r.primitiveContainers.polyline3d,n=r.nameLabelCollection,i=a.line,o=a.nameLabel,s=a.shadow;i&&(t.remove(i),a.line=void 0),o&&n&&(n.remove(o),a.nameLabel=void 0),s&&(t.remove(s),a.shadow=void 0),this.locatingLines.forEach(e=>{e.destroy()})}update(e){let a=this.properties;(0,pg.ri)(e.show)&&(a.show=e.show,this.updateShow(),this.managers.render?.());let r=!1,t=!1,n=!1,i=!1;(0,pg.ri)(e.name)&&(a.name=e.name,i=!0),(0,pg.ri)(e.positions)&&(a.positions=e.positions,r=!0),(0,pg.ri)(e.width)&&(a.width=e.width,r=!0),(0,pg.ri)(e.cssColor)&&a.cssColor!==e.cssColor&&(a.cssColor=e.cssColor,t=!0,i=!0),(0,pg.ri)(e.lineStyle)&&(a.lineStyle=e.lineStyle,t=!0),e.labelScaleByDistance&&(a.labelScaleByDistance=e.labelScaleByDistance,i=!0),e.labelDistanceDisplayCondition&&(a.labelDistanceDisplayCondition=e.labelDistanceDisplayCondition,i=!0),e.labelOccludedAlpha&&(a.labelOccludedAlpha=e.labelOccludedAlpha,i=!0),e.labelEnableOccludeIn2dView&&(a.labelEnableOccludeIn2dView=e.labelEnableOccludeIn2dView,i=!0),(0,pg.ri)(e.enableGroundShadow)&&(a.enableGroundShadow=e.enableGroundShadow),r&&(this.updateNamePosition(),this.updateAllManagers(),t=!1,n=!1,i=!1),t&&this.updatePolylineStyleAllManagers(),n&&this.updatePolylineOccludedStyleAllManagers(),i&&this.updateNameLabelAllManagers(),e.placeable&&(a.placeable=e.placeable)}static createDefaultCacheStatus(e){return{ownerId:e,line:{},label:{}}}onManagerAdd(e){this.cacheStatus[e]=gr.createDefaultCacheStatus(e),this.addPrimitives(e)}onManagerRemove(e){this.removePrimitives(e),this.cacheStatus[e]=void 0}onManagerUpdate(e){let a=this.primitives._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}hasPrimitive(e){return this.primitives._keys().some(a=>{let r=this.primitives._get(a);return r.line===e||r.nameLabel===e||r.shadow===e})}destroy(){this.primitives._keys().forEach(e=>{this.removePrimitives(e)}),this.removeCollectionMap()}}class gt{constructor(e,a){this.manager=a,this.properties=Object.assign({},e),this.init()}manager;interactLevel=sc.Thing;properties;cameraDistance;canvasPosition={x:0,y:0};positionCartesian3;get origin(){return this.properties.origin||c2.tT.map}get position(){return this.properties.position}set position(e){e&&(this.properties.position=e,this.updatePosition())}updatePosition(){let e=this.properties.position;e&&(this.positionCartesian3=uf.Cartesian3.fromDegrees(e.longitude,e.latitude,e.height),this.manager.executePopPlacementThrottled(),this.toggleClamp(),this.renderListener())}removeListener;init(){this.updatePosition();let e=this.renderListener.bind(this);this.manager.addListener(\"cameraChanged\",e),this.removeListener=()=>{this.manager.removeListener(\"cameraChanged\",e)},this.manager.placer.addTsaPop(this)}update(e){(0,pg.ri)(e.position)&&(this.position=e.position),e.el&&(this.properties.el=e.el),e.onChange&&(this.properties.onChange=e.onChange,this.renderListener())}renderListener(){this.positionCartesian3&&(this.canvasPosition=this.manager.worldToCanvas(this.positionCartesian3),this.cameraDistance=this.manager.getCameraDistance(this.positionCartesian3));let e=this.properties.el;e&&(this.canvasPosition?(e.style.top=`${this.canvasPosition.y}px`,e.style.left=`${this.canvasPosition.x}px`):(e.style.top=\"0px\",e.style.left=\"0px\")),this.properties.onChange&&this.properties.onChange(this.canvasPosition,this.cameraDistance)}clampWatcher;toggleClamp(){let e=this.properties.position;if(e){if((0,pg.ri)(e.height))this.removerClampWatcher();else{let a=uf.Cartographic.fromDegrees(e.longitude,e.latitude);this.clampWatcher?this.clampWatcher.update(a):this.clampWatcher=this.manager.picker.clampWithWatcher(a,e=>{e&&(this.positionCartesian3=uf.Cartesian3.clone(e),this.renderListener())})}}}removerClampWatcher(){this.clampWatcher&&(this.clampWatcher.unclamp(),this.clampWatcher=void 0)}get anchor(){return this.positionCartesian3||null}labelingPlacement=\"Top\";labelingIter=[\"Top\",\"Right\",\"Bottom\",\"Left\"];getCurrentPlacement(e){return this.manager.id===e||this.properties.onPlacementChange?this.labelingPlacement:\"UnSet\"}getLabelingWindowPosition(e){return this.manager.id===e&&this.canvasPosition?new uf.Cartesian2(this.canvasPosition.x,this.canvasPosition.y):null}getScreenSpaceBoundingBox(e,a){return this.manager.id===e&&this.properties.getScreenSpaceBoundingBox?new p2(...this.properties.getScreenSpaceBoundingBox(a)):null}nextPlacement(e){if(this.manager.id!==e||!this.properties.onPlacementChange)return\"UnSet\";let a=this.labelingIter.indexOf(this.labelingPlacement)+1;return this.labelingPlacement=this.labelingIter[a],!this.labelingPlacement&&(this.labelingPlacement=\"UnSet\"),this.labelingPlacement}get placeable(){return!!this.properties.placeable}set placeable(e){this.properties.placeable=e}updateLabeling(e,{visible:a,placement:r}){if(this.manager.id===e){if(void 0===a||(this.properties.onVisibleChange?.(a),!!a))r&&this.properties.onPlacementChange?.(r)}}resetPlacement(e){this.manager.id===e&&(this.labelingPlacement=this.labelingIter[0],this.properties.onPlacementChange?.())}canPlaceable(e){if(!this.placeable)return!1;let{screenRect:a,managerId:r}=e,t=this.getScreenSpaceBoundingBox(r);return!!t&&p2.intersect(a,t,0)}comparePlaceable(e){return e instanceof gt?(e.properties.placeableLevel||0)-(this.properties.placeableLevel||0):0}destroy(){this.manager.placer.removeTsaPop(this),this.removerClampWatcher(),this.removeListener?.(),this.removeListener=void 0}}let gn=\"prism\";function gi(e,a){let r=new uf.PolygonGeometry(e.getPolygonGeometryOptions(a)),t=new uf.GeometryInstance({geometry:r,id:`${gn}_${e.id}_${a}`}),n=hd(e.getPolygonMaterialOptions(a)),i=new uf.MaterialAppearance({material:n,faceForward:!1});return new uf.Primitive({geometryInstances:[t],appearance:i,asynchronous:!1,modelMatrix:e.modelMatrix})}function go(e,a){let r=e.positions,t=e.height??pF.Height,n=e.extrudedHeight??pF.ExtrudedHeight,i=e.active(),o=[];if(Array.isArray(r)&&r.length>=3){if(\"side\"===a){let a=gs.getPolylineSidePoints(r,t,n);o.push(...a.map((a,r)=>new uf.GeometryInstance({id:ho(gn,e.id,\"side\",r),geometry:new uf.PolylineGeometry({positions:a.map(e=>(0,pg.jL)(e)),width:i?2*(0,pg.LS)(e.outlineWidth,pF.BorderLineWidthActive):e.outlineWidth||2,vertexFormat:uf.PolylineMaterialAppearance.VERTEX_FORMAT})})))}else{let s=\"bottom\"===a?gs.getPolylineBottomPoints(r,t):gs.getPolylineTopPoints(r,t,n);o.push(new uf.GeometryInstance({id:ho(gn,e.id,a),geometry:new uf.PolylineGeometry({positions:s.map(e=>(0,pg.jL)(e)),width:i?2*(0,pg.LS)(e.outlineWidth,pF.BorderLineWidthActive):e.outlineWidth||2,vertexFormat:uf.PolylineMaterialAppearance.VERTEX_FORMAT})}))}}let s=e.getBorderlineColor(a),l=uf.Color.fromCssColorString(s),d=i?l:l.withAlpha(.5),c=new uf.PolylineMaterialAppearance({material:uf.Material.fromType(uf.Material.PolylineOutlineType,{color:d,outlineColor:uf.Color.fromCssColorString(pI),outlineWidth:i?e.outlineWidth||pF.BorderLineWidthActive:0})}),u=new uf.PolylineMaterialAppearance({material:uf.Material.fromType(uf.Material.PolylineDashType,{color:d,gapColor:new uf.Color(0,0,0,0),dashLength:16,dashPattern:255})});return new uf.Primitive({geometryInstances:o,asynchronous:!1,appearance:c,depthFailAppearance:u,modelMatrix:e.modelMatrix})}class gs extends(0,uX.AF)(pv,ph,pz,hl,pw){managers;properties;interactLevel;primitives;transformer;heightConstrollerUp;heightConstrollerDown;localMatrix;isIntersect;isAreaExceed;dragging;beforeDraggingPositions;beforeDraggingExtrudedHeight;beforeDraggingArea;constructor(e,a){super(),this.managers=a,this.interactLevel=sc.Area,this.primitives=py({}),this.localMatrix=uf.Matrix4.IDENTITY,this.isIntersect=!1,this.isAreaExceed=!1,this.dragging=!1,this.beforeDraggingPositions=[],this.beforeDraggingExtrudedHeight=0,this.beforeDraggingArea=0,this.activeState={selected:!1,recenter:!1,hover:!1},this.properties=Object.assign({id:(0,uW.k)(),show:!0,type:\"prism\",transformerMode:\"enu\"},e),this.transformer=new hn({show:!1,headingPitchRoll:hn.EnuOrientationHpr,doubleSideAxis:this.doubleSideAxisEnable,disableRotate:(0,pg.LS)(!this.properties.enableRotate,!0),directionUsed:function(e){if(!e)return[\"blue\"];let a=[];return e.has(\"Z\")&&a.push(\"blue\"),e.has(\"X\")&&a.push(\"green\"),e.has(\"Y\")&&a.push(\"red\"),a}(this.properties.translateAxisUsed),customAxisColors:function(e){if(!e||1!==e.size)return;let a=[...e][0],r=hn.YColor.toCssHexString();return{red:\"Y\"===a?r:void 0,green:\"X\"===a?r:void 0,blue:\"Z\"===a?r:void 0}}(this.properties.translateAxisUsed),transformMode:(0,pg.LS)(this.properties.transformerMode,\"follow\"),distanceDisplayCondition:pF.TransformerDistanceDisplayCondition,onDragStart:this.onTransformerDragStart.bind(this),onDragMove:this.onTransformerDragMove.bind(this),onDragEnd:this.onTransformerDragEnd.bind(this)},a);let r={show:!1,cssColor:\"#FFCC00\",category:this.properties.category,ownerId:this.id,referencePosition:this.averageCenter,hpr:this.properties.hpr,distanceDisplayCondition:pF.HeightControllerDistanceDisplayCondition,onDragStart:this.onHeightControllerDragStart.bind(this),onDragEnd:this.onHeightControllerDragEnd.bind(this)};this.heightConstrollerUp=new gg({...r,onMouseEnter:this.onHeightControllerMouseEnter.bind(this,\"up\"),onMouseLeave:this.onHeightControllerMouseLeave.bind(this,\"up\"),usage:\"up\"},a),this.heightConstrollerDown=new gg({...r,onMouseEnter:this.onHeightControllerMouseEnter.bind(this,\"down\"),onMouseLeave:this.onHeightControllerMouseLeave.bind(this,\"down\"),usage:\"down\"},a),this.init(),this.setCollectionMap()}get id(){return this.properties.id}get type(){return\"prism\"}get typedElement(){return{type:this.type,element:this}}get positions(){return this.properties.positions||[]}get doubleSideAxisEnable(){return!this.properties.translateAxisUsed||1===this.properties.translateAxisUsed.size}get modelMatrix(){return this.properties.hpr?uf.Matrix4.multiply(this.localMatrix,this.hprMatrixWC,new uf.Matrix4):this.localMatrix}get height(){return Number(this.properties.height)}get extrudedHeight(){return Number(this.properties.extrudedHeight)}get absoluteHeight(){return Number(this.height)+Number(this.extrudedHeight)}get cssColor(){return this.properties.cssColor||pF.FaceColor}get innerCssColor(){return this.properties.innerCssColor||pF.FaceColor}get errorCssColor(){return this.properties.errorCssColor||\"#FFFFFF\"}get areaAlpha(){return this.properties.areaAlpha||pF.OutFaceAlpha}get innerAreaAlpha(){return this.properties.innerAreaAlpha||pF.InnerFaceAlpha}get outlineWidth(){return this.properties.outlineWidth}get averageCenter(){let e={longitude:0,latitude:0,height:this.height+this.extrudedHeight/2};return Array.isArray(this.positions)?(this.positions.reduce((e,a)=>(e.longitude+=a.longitude,e.latitude+=a.latitude,e),e),e.longitude/=this.positions.length,e.latitude/=this.positions.length,e):e}get averageCenterWC(){return(0,pg.jL)(this.averageCenter)}get hpr(){return this.properties.hpr||{heading:0,pitch:0,roll:0}}get hprMatrix(){let e=this.properties.hpr;if(!e)return uf.Matrix3.IDENTITY;let a=uf.HeadingPitchRoll.fromDegrees(e.heading,e.pitch,e.roll);return uf.Matrix3.fromHeadingPitchRoll(a)}get hprMatrixWC(){if(this.hprMatrix.equals(uf.Matrix3.IDENTITY))return uf.Matrix4.IDENTITY;let e=new uf.Matrix4;return uf.Matrix4.multiplyByMatrix3(this.enuMatrix,this.hprMatrix,e),uf.Matrix4.multiply(e,this.enuMatrixInverse,e),e}get enuMatrix(){return uf.Transforms.eastNorthUpToFixedFrame(this.averageCenterWC)}get enuMatrixInverse(){return uf.Matrix4.inverse(this.enuMatrix,new uf.Matrix4)}get closeTop(){return!!this.properties.closeTop}get closeBottom(){return!!this.properties.closeBottom}get projectSurfaceEditColor(){return this.properties.projectSurfaceEditColor||this.cssColor}static SurfaceMembers=[\"surface\",\"topSurface\",\"bottomSurface\"];static LineMembers=[\"sideLine\",\"topLine\",\"bottomLine\"];setCollectionMap(){this.managers._options.elements.add(\"prism\",this,[this.id])}activeState;toggleActive(){this.primitives._keys().forEach(e=>{this.updatePolylinePrimitive(e)})}active(e=\"\",a){if(!this.properties.fromDraw||\"hover\"===e&&this.disableHover)return!1;if((0,pg.ri)(a)&&e&&this.activeState[e]!==a&&(this.activeState[e]=a,this.toggleActive()),e)return this.activeState[e];{let{selected:e,recenter:a,hover:r}=this.activeState;return e||a||r}}update(e){let a=!1;Object.keys(e).forEach(r=>{let t=e[r];(0,pg.ri)(t)&&(this.properties[r]=t,[\"positions\",\"height\",\"extrudedHeight\"].includes(r)&&(a=!0))}),this.render(),a&&(this.emitIntersectAndAreaExceed(),this.active()&&this.managers.editor?.updatePositionsFor?.(this))}render(){this.primitives._keys().forEach(e=>{this.positions&&(this.updateTransformer(),this.updatePolygonPrimitive(e),this.updatePolylinePrimitive(e))})}getTopArea(){let e=this.positions||[];return this.managers._get(f3).measurer.getHorizontalArea(e.map(pg.i9))}getAllArea(){let e=this.getTopArea();return e+function(e,a=!0){let r=0,t=e.length;for(let a=0;a<t-1;a++)r+=mL(e[a],e[a+1]);return a&&(r+=mL(e[t-1],e[0])),r}(this.positions||[])*(this.properties.extrudedHeight||0)}resetPositions(){this.update({positions:this.beforeDraggingPositions,extrudedHeight:this.beforeDraggingExtrudedHeight}),this.managers.editor?.updatePositionsFor?.(this)}cleanDragging(){this.beforeDraggingPositions=[],this.beforeDraggingExtrudedHeight=0,this.beforeDraggingArea=0}startDrag(e,a,r){return this.setDragging(!0),super.startDrag(e,a,r)}setDragging(e){if(this.dragging!==e){if(this.dragging=e,e)this.beforeDraggingPositions=(0,lL.cloneDeep)(this.positions),this.beforeDraggingExtrudedHeight=this.properties.extrudedHeight||0,this.beforeDraggingArea=this.getAllArea();else{let{isIntersect:e,isAreaExceed:a,areaChangeMode:r}=this.checkIntersectAndAreaExceed();e&&this.beforeDraggingPositions&&(0,pg.ri)(this.beforeDraggingExtrudedHeight)&&this.resetPositions(),a&&r===sb.grow&&this.beforeDraggingPositions&&(0,pg.ri)(this.beforeDraggingExtrudedHeight)&&this.resetPositions(),this.cleanDragging()}}}checkIntersectAndAreaExceed(){let e={isIntersect:!1,isAreaExceed:!1,areaChangeMode:sb.none},a=mP(this.positions||[]);e.isIntersect=a;let r=this.getTopArea(),t=this.getAllArea();if(this.properties.maxTopArea&&this.properties.maxAllArea){let a=r>this.properties.maxTopArea||t>this.properties.maxAllArea;e.isAreaExceed=a;let n=t>this.beforeDraggingArea?sb.grow:sb.shrink;e.areaChangeMode=n}return e}emitIntersectAndAreaExceed(){let{isIntersect:e,isAreaExceed:a,areaChangeMode:r}=this.checkIntersectAndAreaExceed();this.isIntersect!==e&&this.properties.needCheckIntersect&&(this.isIntersect=e,this.managers._get(f3).emit(\"elementSelfIntersection\",this,e,this.origin)),this.isAreaExceed!==a&&this.properties.needCheckArea&&(this.isAreaExceed=a,this.managers._get(f3).emit(\"elementAreaOversize\",this,{exceed:a,changeMode:r,origin:this.origin}))}onManagerAdd(e){this.addPrimitives(e),this.emitIntersectAndAreaExceed()}onManagerRemove(e){this.removePrimitives(e)}onManagerUpdate(e){let a=this.primitives._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}hasPrimitive(e){return this.primitives._keys().some(a=>{let r=this.primitives._get(a);return!!r&&(r.surface===e||r.topSurface===e||r.bottomSurface===e||r.bottomLine===e||r.topLine===e||r.sideLine===e)})}updateModelMatrix(e){this.localMatrix=e,this.render()}onTransformerDragStart(e){this.transformType=e,this.transformState=\"changing\"}onTransformerDragMove(e){this.updateModelMatrix(e),this.managers.render?.()}onTransformerDragEnd(){if(!Array.isArray(this.positions))return;if(\"rotate\"===this.transformType){let e=uf.Matrix4.multiply(this.enuMatrixInverse,this.localMatrix,new uf.Matrix4),a=uf.Matrix4.getMatrix3(e,new uf.Matrix3),r=uf.HeadingPitchRoll.fromQuaternion(uf.Quaternion.fromRotationMatrix(a));this.localMatrix=uf.Matrix4.IDENTITY,this.update({hpr:{heading:uf.Math.toDegrees(r.heading),pitch:uf.Math.toDegrees(r.pitch),roll:uf.Math.toDegrees(r.roll)}})}else{let e=this.positions.map(e=>(0,pg.KO)(uf.Matrix4.multiplyByPoint(this.localMatrix,(0,pg.jL)(e),new uf.Cartesian3),!0));this.localMatrix=uf.Matrix4.IDENTITY,this.update({positions:e,height:e[0].height})}let e=\"rotate\"===this.transformType?\"rotate\":\"translate\";this.managers.editor?.updatePositionsFor?.(this,!0,e),this.transformType=\"\",this.transformState=\"static\"}onHeightControllerMouseEnter(e){let a=this.primitives._get(f3);if(!a)return;let r=this.projectSurfaceEditColor;\"up\"===e?(a.topLine&&(a.topLine.appearance.material.uniforms.color=uf.Color.fromCssColorString(r)),a.topSurface&&(a.topSurface.appearance.material.uniforms.outColor=uf.Color.fromCssColorString(r),a.topSurface.appearance.material.uniforms.innerColor=uf.Color.fromCssColorString(r))):(a.bottomLine&&(a.bottomLine.appearance.material.uniforms.color=uf.Color.fromCssColorString(r)),a.bottomSurface&&(a.bottomSurface.appearance.material.uniforms.outColor=uf.Color.fromCssColorString(r),a.bottomSurface.appearance.material.uniforms.innerColor=uf.Color.fromCssColorString(r))),this.managers._get(f3).render()}onHeightControllerMouseLeave(e){let a=this.primitives._get(f3);if(!!a)\"up\"===e?(a.topLine&&(a.topLine.appearance.material.uniforms.color=uf.Color.fromCssColorString(this.cssColor)),a.topSurface&&(a.topSurface.appearance.material.uniforms.outColor=uf.Color.fromCssColorString(this.cssColor),a.topSurface.appearance.material.uniforms.innerColor=uf.Color.fromCssColorString(this.innerCssColor))):(a.bottomLine&&(a.bottomLine.appearance.material.uniforms.color=uf.Color.fromCssColorString(this.cssColor)),a.bottomSurface&&(a.bottomSurface.appearance.material.uniforms.outColor=uf.Color.fromCssColorString(this.cssColor),a.bottomSurface.appearance.material.uniforms.innerColor=uf.Color.fromCssColorString(this.innerCssColor))),this.managers._get(f3).render()}onHeightControllerDragStart(){this.transformer.update({show:!1})}onHeightControllerDragEnd(){this.transformer.update({show:!0})}updateTransformer(){this.transformer.update({position:this.averageCenter})}addPrimitives(e){!this.primitives._get(e)&&this.primitives._add(e,{}),this.positions&&(this.updatePolygonPrimitive(e),this.updatePolylinePrimitive(e))}updatePolygonPrimitive(e){let a=this.primitives._get(e),r=this.managers._get(e);if(!r||!a)return;let t=r.primitiveContainers.prism;if(Object.entries(a).forEach(([e,r])=>{if(!gs.LineMembers.includes(e))r&&t.contains(r)&&t.remove(r),a[e]=void 0}),this.properties.show){let e=gi(this,\"surface\");if(t.add(e),a.surface=e,this.closeTop){let e=gi(this,\"topSurface\");t.add(e),a.topSurface=e}if(this.closeBottom){let e=gi(this,\"bottomSurface\");t.add(e),a.bottomSurface=e}}}updatePolylinePrimitive(e){let a=this.primitives._get(e),r=this.managers._get(e);if(!r||!a)return;let t=r.primitiveContainers.prism;if(Object.entries(a).forEach(([e,r])=>{if(!gs.SurfaceMembers.includes(e))r&&t.contains(r)&&t.remove(r),a[e]=void 0}),this.properties.show&&!1!==this.properties.outlined){var n;let{bottomLine:e,topLine:r,sideLine:i}=(n=this,{bottomLine:go(n,\"bottom\"),topLine:go(n,\"top\"),sideLine:go(n,\"side\")});a.bottomLine=e,a.topLine=r,a.sideLine=i,t.add(e),t.add(r),t.add(i)}}static getPolylineBottomPoints(e,a){let r=e.map(e=>({longitude:e.longitude,latitude:e.latitude,height:a}));return r.push(r[0]),r}static getPolylineTopPoints(e,a,r){let t=e.map(e=>({longitude:e.longitude,latitude:e.latitude,height:a+r}));return t.push(t[0]),t}static getPolylineSidePoints(e,a,r){let t=[],n=e.length;for(let i=0;i<n;i++){let n=e[i].longitude,o=e[i].latitude;t.push([{longitude:n,latitude:o,height:a},{longitude:n,latitude:o,height:a+r}])}return t}static getPolylinePointsArray(e,a,r){return{bottom:gs.getPolylineBottomPoints(e,a),top:gs.getPolylineTopPoints(e,a,r),side:gs.getPolylineSidePoints(e,a,r)}}static getPickResultByOrder(e){if(1===e.length)return e[0];let a=0;for(let r=0;r<e.length;++r){a=r;let t=e[r].id;if(\"string\"==typeof t&&(t.includes(\"side\")||t.includes(\"top\")||t.includes(\"bottom\")))break}return e[a]}removePrimitives(e){let a=this.managers._get(e);if(!a)return;let r=this.primitives._get(e);if(!r)return;let t=a.primitiveContainers.prism;Object.values(r).forEach(e=>{e&&t.remove(e)}),this.primitives._remove(e)}stabilize(){}destroy(){this.transformer.destroy(),this.primitives._keys().forEach(e=>{this.removePrimitives(e)}),this.removeCollectionMap()}getBorderlineColor(e){let a=this.isIntersect||this.isAreaExceed,r=this.dragStatus&&this.dragging&&this.dragStatus.type===e&&\"side\"!==e,t=this.errorCssColor,n=this.projectSurfaceEditColor;return a?t:r?n:this.cssColor}getPolygonMaterialOptions(e){let a=this.isIntersect||this.isAreaExceed,r=this.cssColor,t=this.innerCssColor;return this.dragStatus&&this.dragging&&(\"bottom\"===this.dragStatus.type&&\"bottomSurface\"===e||\"top\"===this.dragStatus.type&&\"topSurface\"===e)&&(r=this.projectSurfaceEditColor,t=this.projectSurfaceEditColor),{outColorCssString:a?this.properties.errorCssColor:r,innerColorCssString:a?this.properties.errorCssColor:t,outAlpha:this.areaAlpha,innerAlpha:this.innerAreaAlpha}}getPolygonGeometryOptions(e){let a={closeBottom:!1,closeTop:!1,perPositionHeight:!1,polygonHierarchy:new uf.PolygonHierarchy(this.positions.map(e=>(0,pg.jL)(e,!0)))};return\"surface\"===e&&(a.height=this.height,a.extrudedHeight=this.height+this.extrudedHeight),\"topSurface\"===e&&(a.height=this.height+this.extrudedHeight),\"bottomSurface\"===e&&(a.height=this.height),a}getPickingPlane(e){let a=this.positions??[],r=hu.clone(a[0]);\"bottom\"===e?r.height=this.height:r.height=this.absoluteHeight;let t=(0,pg.jL)(r),n=uf.Cartesian3.normalize(t,new uf.Cartesian3);return uf.Plane.fromPointNormal(t,n)}static EditingCursor=\"default\";edit(e){if(this.managers._get(f3)?.editor?.enterEdit?.(\"prism\",this,e),this.managers._get(f3).hover.setCursor(gs.EditingCursor,\"hover\"),this.transformer.update({show:!0,position:this.averageCenter}),this.properties.enableHeightControl){let e={show:!0,referencePosition:this.averageCenter},a=this.extrudedHeight/3,r=this.extrudedHeight/2;this.heightConstrollerUp.update({...e,offsetHeight:a+r}),this.heightConstrollerDown.update({...e,offsetHeight:-(a+r)})}let a=this.managers._get(f3).viewer.camera;this.transformer.onCameraChanged(a),this.edgeDraggable=!0}exitEdit(){this.managers._get(f3).hover.setCursor(\"pointer\",\"hover\"),this.setDragging(!1);let e={show:!1};this.transformer.update(e),this.heightConstrollerUp.update(e),this.heightConstrollerDown.update(e),this.transformer.onDragging&&(this.localMatrix=uf.Matrix4.IDENTITY,this.transformer.endDrag()),this.edgeDraggable=!1}getEditActivePoints(){let e=this.positions,a=e.map(e=>{let a=hu.clone(e);a.height=Number(this.height);let r=hV((0,pg.jL)(a));return uf.Matrix4.multiplyByPoint(this.hprMatrixWC,r,r),r});return[a,e.map(e=>{let a=hu.clone(e);a.height=Number(this.absoluteHeight);let r=hV((0,pg.jL)(a));return uf.Matrix4.multiplyByPoint(this.hprMatrixWC,r,r),r})]}startDragSide(e,a){this.setDragging(!0);let r=this.managers._get(f3).viewer;if(r){let t=this.positions?.[e];if(t){let n=me((0,pg.jL)(t),r);if(a){let r=uf.IntersectionTests.rayPlane(a,n);if(r)return this.dragStatus={type:\"side\",index:e},{position:r,clampToGround:!1}}}}return!1}endDrag(){return this.setDragging(!1),this.managers._get(f3).emit(\"finishEdit\",{type:\"prism\",origin:this,shape:this.positions||[],changeType:\"edge\"}),null}updateSide(e){this.update({positions:this.positions?.map((a,r)=>r===this.dragStatus?.index?e:a)})}onMouseEnter(e){let a=hs(String(e.id),this.id);if(!1===a)return;let[r]=a,t=this.managers._get(f3).hover;this.activeState.selected&&(\"side\"===r?t.setCursor(\"ew-resize\",\"hover\"):t.setCursor(\"ns-resize\",\"hover\")),t.isPrismHovering.value=!0}onMouseLeave(e){if(!1!==hs(String(e.id),this.id))this.managers._get(f3).hover.setCursor(\"\",\"hover\"),this.managers._get(f3).hover.isPrismHovering.value=!1}}function gl(...e){let a=new uf.PolylineGeometry({vertexFormat:uf.PolylineMaterialAppearance.VERTEX_FORMAT,positions:e,width:1,arcType:uf.ArcType.NONE});return new uf.GeometryInstance({geometry:a})}class gd extends(0,uX.AF)(pv,ph,pz){managers;primitives;activeChanged;properties;uid;interactLevel;dirty;shouldUpdateGeometry;shouldUpdateAppearance;geometryInstanceCache;constructor(e,a){super(),this.managers=a,this.primitives=py({}),this.activeChanged=!1,this.uid=(0,uW.k)(),this.interactLevel=sc.Thing,this.dirty=!1,this.shouldUpdateGeometry=!1,this.shouldUpdateAppearance=!1,this.geometryInstanceCache={leadline:void 0,bottom:void 0,bottomOutline:void 0},this.properties=e,this.withDefaults(e),this.init(),this.setCollectionMap(\"pyramid\")}get shapeMode(){return this.properties.shapeMode??\"ANLGE\"}get coords(){return this.properties.coords&&5===this.properties.coords.length?this.properties.coords:null}comparePrimitiveProp(e,a){return void 0===e&&!!a||(!e||void 0!==a)&&e!==a}compareHprProp(e,a){if(e)return!!a&&(e.heading!==a.heading||e.pitch!==a.pitch);return!!a||!1}setIfHasValue(e){let a=this.properties;e.aspect&&(a.aspect=e.aspect),e.fov&&(a.fov=e.fov),e.far&&(a.far=e.far),e.hpr&&(a.hpr=e.hpr),void 0!==e.enableDepthFailedAppearance&&(a.enableDepthFailedAppearance=e.enableDepthFailedAppearance),e.mainColor&&(a.mainColor=e.mainColor),e.highlightColor&&(a.highlightColor=e.highlightColor),void 0!==e.active&&(a.active=e.active)}update(e){let a=this.properties,r=this.geometryInstanceCache;if(void 0!==e.show&&(this.dirty=a.show!==e.show,a.show=e.show),\"ANLGE\"===this.shapeMode?this.shouldUpdateGeometry=this.comparePrimitiveProp(a.aspect,e.aspect)||this.comparePrimitiveProp(a.far,e.far)||this.comparePrimitiveProp(a.fov,e.fov)||this.compareHprProp(a.hpr,e.hpr):this.shouldUpdateGeometry=!a.coords||!e.coords||function(e,a){if(e.length!==a.length||5!==e.length||5!==a.length)return!1;for(let r=0;r<e.length;r++){let t=e[r],n=a[r];if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e]!==n[e])return!1}return!0}(a.coords,e.coords),this.activeChanged=this.comparePrimitiveProp(a.active,e.active),this.shouldUpdateAppearance=this.comparePrimitiveProp(a.enableDepthFailedAppearance,e.enableDepthFailedAppearance)||this.comparePrimitiveProp(a.mainColor,e.mainColor)||this.comparePrimitiveProp(a.highlightColor,e.highlightColor)||this.comparePrimitiveProp(a.active,e.active),this.setIfHasValue(e),\"ANLGE\"===this.shapeMode&&(e.position?a.position?(this.shouldUpdateGeometry=a.position.longitude!==e.position.longitude||a.position.latitude!==e.position.latitude||a.position.height!==e.position.height,a.position.longitude=e.position.longitude,a.position.latitude=e.position.latitude,a.position.height=e.position.height):(this.shouldUpdateGeometry=!0,a.position=e.position):a.position&&(this.properties.show=!1,this.dirty=!0)),this.shouldUpdateGeometry=this.shouldUpdateGeometry||void 0===r.bottom||void 0===r.bottomOutline||void 0===r.leadline,this.dirty=this.dirty||this.shouldUpdateGeometry||this.shouldUpdateAppearance,\"ANLGE\"===this.shapeMode){if(!function(e){let{position:a={latitude:0,longitude:0,height:0},fov:r=36,far:t=14,aspect:n=1}=e,{latitude:i,longitude:o,height:s=0}=a;return o>180||o<-180?(console.warn(`: ${o} `),!1):i>90||i<-90?(console.warn(`: ${i} `),!1):s<0?(console.warn(`: ${s}  0`),!1):r<=0||r>=180?(console.warn(`: ${r} (0, 180)`),!1):t<=1?(console.warn(`: ${t}  1`),!1):!(n<=0)||(console.warn(`: ${n} `),!1)}(this.properties))return;if(this.shouldUpdateGeometry){let e=function(e){let{fov:a=36,far:r=15,aspect:t=1}=e,n=e.hpr;!n&&(n={heading:0,pitch:0,roll:0});let{heading:i=0,pitch:o=0}=n,s=2*r*Math.tan(uf.Math.toRadians(a)/2),l=s*t,d=new uf.Cartesian3(0,0,.01),c=new uf.Cartesian3(s/2,l/2,-r),u=new uf.Cartesian3(-s/2,l/2,-r),p=new uf.Cartesian3(-s/2,-l/2,-r),m=new uf.Cartesian3(s/2,-l/2,-r),h=uf.Matrix3.fromHeadingPitchRoll(new uf.HeadingPitchRoll(uf.Math.toRadians(i-90),uf.Math.toRadians(90+o))),g=uf.Matrix4.fromRotationTranslation(h),f=uf.Matrix4.multiplyByPoint(g,d,new uf.Cartesian3),_=uf.Matrix4.multiplyByPoint(g,c,new uf.Cartesian3),b=uf.Matrix4.multiplyByPoint(g,u,new uf.Cartesian3),k=uf.Matrix4.multiplyByPoint(g,p,new uf.Cartesian3);return[f,_,b,k,uf.Matrix4.multiplyByPoint(g,m,new uf.Cartesian3)]}(this.properties),{position:a}=this.properties;if(a){let{longitude:r,latitude:t,height:n=0}=a,i=uf.Cartesian3.fromDegrees(r,t,n),o=uf.Transforms.eastNorthUpToFixedFrame(i);this.updateGeometryInstance(e,o)}else this.geometryInstanceCache.leadline=void 0,this.geometryInstanceCache.bottom=void 0,this.geometryInstanceCache.bottomOutline=void 0}}else{if(!this.coords)return;this.updateGeometryInstanceRawCoord(this.coords)}this.render()}updateGeometryInstanceRawCoord(e){let a=e.map(e=>uf.Cartesian3.fromArray(e));this.updateGeometryInstance(a,uf.Matrix4.IDENTITY)}updateGeometryInstance([e,a,r,t,n],i){let o=this.geometryInstanceCache,s=gl(uf.Cartesian3.clone(e),uf.Cartesian3.clone(a)),l=gl(uf.Cartesian3.clone(e),uf.Cartesian3.clone(r)),d=gl(uf.Cartesian3.clone(e),uf.Cartesian3.clone(t)),c=gl(uf.Cartesian3.clone(e),uf.Cartesian3.clone(n));s.modelMatrix=i,s.id=this.uid,l.modelMatrix=i,l.id=this.uid,d.modelMatrix=i,d.id=this.uid,c.modelMatrix=i,c.id=this.uid;let u=function(...e){let a=[new uf.Cartesian2(1,0),new uf.Cartesian2(0,0),new uf.Cartesian2(0,1),new uf.Cartesian2(1,1)],r=uf.CoplanarPolygonGeometry.fromPositions({vertexFormat:uf.VertexFormat.DEFAULT,positions:e,textureCoordinates:{positions:a}});return new uf.GeometryInstance({geometry:r})}(uf.Cartesian3.clone(a),uf.Cartesian3.clone(r),uf.Cartesian3.clone(t),uf.Cartesian3.clone(n));u.modelMatrix=i,u.id=this.uid;let p=gl(uf.Cartesian3.clone(a),uf.Cartesian3.clone(r),uf.Cartesian3.clone(t),uf.Cartesian3.clone(n),uf.Cartesian3.clone(a));p.modelMatrix=i,p.id=this.uid,o.leadline=[s,l,d,c],o.bottom=u,o.bottomOutline=p}render(){if(!!this.dirty)this.managers._values().forEach(e=>{e.elements.pyramidVisualizer.dirty=!0,e.render()})}withDefaults(e){this.properties.show=(0,uf.defaultValue)(e.show,!0),this.properties.aspect=(0,uf.defaultValue)(e.aspect,1),this.properties.fov=(0,uf.defaultValue)(e.fov,36),this.properties.far=(0,uf.defaultValue)(e.far,14),this.properties.mainColor=(0,uf.defaultValue)(e.mainColor,\"#DCDCDCE5\"),this.properties.highlightColor=(0,uf.defaultValue)(e.highlightColor,\"#2D8CF0E5\"),this.properties.hpr=(0,uf.defaultValue)(e.hpr,{heading:0,pitch:0,roll:0}),this.properties.enableDepthFailedAppearance=(0,uf.defaultValue)(e.enableDepthFailedAppearance,!1),this.properties.active=(0,uf.defaultValue)(e.active,!1)}getUpdateInfo(){let e=this.properties,a=e.mainColor,r=e.highlightColor,t=this.geometryInstanceCache;return!t.leadline&&!t.bottom&&!t.bottomOutline&&this.update(this.properties),{color:uf.Color.fromCssColorString(String(a)),activeColor:e.active?uf.Color.fromCssColorString(String(r)):void 0,useDepthFailedAppearance:!!e.enableDepthFailedAppearance,geometryInstance:t}}onManagerAdd(e){this.primitives._add(e,{}),this.dirty=!0,this.managers._get(e).render()}onManagerRemove(e){this.managers._get(e).elements.pyramidVisualizer.destroy()}onManagerUpdate(e){let a=this.primitives._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}bindPrimitive(e,a){this.primitives._values().forEach(r=>r[e]=a)}hasPrimitive(e){return this.primitives._keys().some(a=>{let r=this.primitives._get(a);return r.leadline===e||r.bottom===e||r.bottomOutline===e})}destroy(){this.geometryInstanceCache.leadline=void 0,this.geometryInstanceCache.bottom=void 0,this.geometryInstanceCache.bottomOutline=void 0,this.dirty=!0,this.removeCollectionMap(),this.managers._values().forEach(e=>{e.elements.pyramidVisualizer.removeElement(this)})}}let gc=\"3dModel\";class gu extends(0,uX.AF)(ph){managers;constructor(e,a){super(),this.managers=a,this.type=gc,this.primitives=py({}),this.readyPromise=new Promise(e=>this.resolveCallback=e),this.extrasParsed=!1,this.intensityInfo=null,this.echoInfo=null,this.cartoMap={},this.forceLoading=!1,this.properties=Object.assign({show:!0,url:\"\",contentType:\"mesh\",category:se.none,pointCloudStyle:\"rgb\",heightInfo:null,coordinates:null,maximumScreenSpaceError:uE(),pointSize:3},e),this.init(),this._id=(0,uW.k)(),this.setCollectionMap(gc)}_id;type;properties;primitives;resolveCallback;readyPromise;get mainPrimitive(){return this.primitives._get(f3)}get contentType(){return this.properties.contentType}get show(){return this.properties.show}set show(e){e!==this.properties.show&&(this.properties.show=e,this.primitives.showSetter(e),this.managers.emit(\"tilesetShowChanged\",this))}get lockMaximumScreenSpaceError(){return!!this.properties.lockMaximumScreenSpaceError}get maximumScreenSpaceError(){return this.properties.maximumScreenSpaceError}set maximumScreenSpaceError(e){!this.lockMaximumScreenSpaceError&&(this.properties.maximumScreenSpaceError=e,e&&(this.primitives._keys().forEach(a=>{let r=this.primitives._get(a);r&&(r.maximumScreenSpaceError=e)}),this.managers.render?.()))}get id(){return this._id}get boundingSphere(){return this.mainPrimitive?.boundingSphere}get ready(){return(0,pg.ri)(this.mainPrimitive)}get loadProgress(){return this.mainPrimitive?.loadProgress}get tilesLoaded(){return this.mainPrimitive?.initialTilesLoaded}get statistics(){return this.mainPrimitive?._statistics||{}}get authToken(){let e=this.properties.authToken;return\"object\"==typeof e&&\"name\"in e&&\"value\"in e?e:null}get pointSize(){return this.properties.pointSize||3}set pointSize(e){e!==this.properties.pointSize&&(this.properties.pointSize=e,this.mainPrimitive._pointCloudShading&&(this.mainPrimitive._pointCloudShading.maximumAttenuation=e,this.managers.render?.()))}getCesium3DTilesetOptions(){return{show:this.properties.show,url:this.properties.url,pointCloudShading:new uf.PointCloudShading({attenuation:!0,maximumAttenuation:this.properties.pointSize||3,eyeDomeLighting:!0,eyeDomeLightingRadius:2,eyeDomeLightingStrength:.8}),maximumScreenSpaceError:this.properties.maximumScreenSpaceError,skipLevelOfDetail:!0,preferLeaves:!0,enableCollision:!0}}async addPrimitive(e){let a=this.managers._get(e);if(a){let r=this.getCesium3DTilesetOptions(),t={};this.authToken&&(t[this.authToken.name]=this.authToken.value);let n=this.properties.url;\"string\"==typeof n&&(n=new uf.Resource({url:n,headers:t}));let i=await uf.Cesium3DTileset.fromUrl(n,r);if(this.isDestroyed)return;this.primitives._add(e,a.viewer.scene.primitives.add(i)),this.resolveCallback?.(this),this.updatePrimitiveStyle(i)}}removePrimitive(e){let a=this.managers._get(e),r=this.primitives._get(e);a&&r&&(a.viewer.scene.primitives.remove(r),this.primitives._remove(e))}updatePrimitiveStyle(e){if(e){let a=this.getStyle();a&&(e.style=a)}}init(){super.init(),this.cleanPointCloudInfo(),this.updateStyle()}async isPositionIncludedWhenReady(e){return!!this.ready&&this.isPositionIncluded(e)}isPositionIncluded(e){let a=this.boundingSphere;return!!a&&function(e,a){let r=uf.Cartographic.fromCartesian(a.center),t=uf.Cartesian3.fromRadians(e.longitude,e.latitude,r.height);return uf.Cartesian3.distance(t,a.center)<=a.radius}(e,a)}removePrimitives(){this.primitives._keys().forEach(e=>{this.removePrimitive(e)})}async updateStyle(){!this.extrasParsed&&await this.parseExtras();let e=this.getStyle();e&&this.primitives.styleSetter(e)}async parseExtras(){if(this.mainPrimitive&&!this.extrasParsed){if(!!this.ready){if(this.mainPrimitive){if(this.mainPrimitive.extras){let e=this.mainPrimitive.extras;e.maxIntensity&&(this.intensityInfo={min:e.minIntensity,max:e.maxIntensity}),e.maxReturnNumber&&(this.echoInfo={maxReturnNumber:e.maxReturnNumber})}this.extrasParsed=!0}}}}extrasParsed;intensityInfo;echoInfo;async getIntensityInfo(){return this.ready?this.intensityInfo:null}async getEchoInfo(){return this.ready?this.echoInfo:null}cleanPointCloudInfo(){this.intensityInfo=null,this.echoInfo=null}getStyle(){if(this.properties.customStyle)return new uf.Cesium3DTileStyle(this.properties.customStyle);if(\"rgb\"===this.properties.pointCloudStyle)return new uf.Cesium3DTileStyle;if(\"intensity\"===this.properties.pointCloudStyle&&this.intensityInfo){let e=this.intensityInfo.max-this.intensityInfo.min;return new uf.Cesium3DTileStyle({defines:{range:e,min_value:this.intensityInfo.min},color:\"vec4((${INTENSITY}-${min_value})/${range}*4-2, 2-4*distance((${INTENSITY}-${min_value})/${range},0.5), 2-(${INTENSITY}-${min_value})/${range}*4, 1.0)\"})}if(\"echo\"===this.properties.pointCloudStyle&&this.echoInfo){let e=this.echoInfo.maxReturnNumber-1;return new"
}