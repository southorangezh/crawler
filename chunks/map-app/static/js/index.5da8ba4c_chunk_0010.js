{
  "metadata": {
    "source_file": "map-app\\static\\js\\index.5da8ba4c.js",
    "chunk_index": 10,
    "total_chunks": 918,
    "chunk_size": 54329,
    "word_count": 800,
    "model_kwargs": {
      "model": "text-embedding-3-large",
      "dimensions": 3072,
      "encoding_format": "float"
    },
    "text_splitter": {
      "split_by": "word",
      "chunk_size": 800,
      "chunk_overlap": 200
    },
    "created_at": "2025-12-17T23:57:50.145Z"
  },
  "content": "r=e.map(e=>({longitude:e.longitude,latitude:e.latitude,height:a}));return r.push(r[0]),r}static getPolylineTopPoints(e,a,r){let t=e.map(e=>({longitude:e.longitude,latitude:e.latitude,height:a+r}));return t.push(t[0]),t}static getPolylineSidePoints(e,a,r){let t=[],n=e.length;for(let i=0;i<n;i++){let n=e[i].longitude,o=e[i].latitude;t.push([{longitude:n,latitude:o,height:a},{longitude:n,latitude:o,height:a+r}])}return t}static getPolylinePointsArray(e,a,r){return{bottom:gs.getPolylineBottomPoints(e,a),top:gs.getPolylineTopPoints(e,a,r),side:gs.getPolylineSidePoints(e,a,r)}}static getPickResultByOrder(e){if(1===e.length)return e[0];let a=0;for(let r=0;r<e.length;++r){a=r;let t=e[r].id;if(\"string\"==typeof t&&(t.includes(\"side\")||t.includes(\"top\")||t.includes(\"bottom\")))break}return e[a]}removePrimitives(e){let a=this.managers._get(e);if(!a)return;let r=this.primitives._get(e);if(!r)return;let t=a.primitiveContainers.prism;Object.values(r).forEach(e=>{e&&t.remove(e)}),this.primitives._remove(e)}stabilize(){}destroy(){this.transformer.destroy(),this.primitives._keys().forEach(e=>{this.removePrimitives(e)}),this.removeCollectionMap()}getBorderlineColor(e){let a=this.isIntersect||this.isAreaExceed,r=this.dragStatus&&this.dragging&&this.dragStatus.type===e&&\"side\"!==e,t=this.errorCssColor,n=this.projectSurfaceEditColor;return a?t:r?n:this.cssColor}getPolygonMaterialOptions(e){let a=this.isIntersect||this.isAreaExceed,r=this.cssColor,t=this.innerCssColor;return this.dragStatus&&this.dragging&&(\"bottom\"===this.dragStatus.type&&\"bottomSurface\"===e||\"top\"===this.dragStatus.type&&\"topSurface\"===e)&&(r=this.projectSurfaceEditColor,t=this.projectSurfaceEditColor),{outColorCssString:a?this.properties.errorCssColor:r,innerColorCssString:a?this.properties.errorCssColor:t,outAlpha:this.areaAlpha,innerAlpha:this.innerAreaAlpha}}getPolygonGeometryOptions(e){let a={closeBottom:!1,closeTop:!1,perPositionHeight:!1,polygonHierarchy:new uf.PolygonHierarchy(this.positions.map(e=>(0,pg.jL)(e,!0)))};return\"surface\"===e&&(a.height=this.height,a.extrudedHeight=this.height+this.extrudedHeight),\"topSurface\"===e&&(a.height=this.height+this.extrudedHeight),\"bottomSurface\"===e&&(a.height=this.height),a}getPickingPlane(e){let a=this.positions??[],r=hu.clone(a[0]);\"bottom\"===e?r.height=this.height:r.height=this.absoluteHeight;let t=(0,pg.jL)(r),n=uf.Cartesian3.normalize(t,new uf.Cartesian3);return uf.Plane.fromPointNormal(t,n)}static EditingCursor=\"default\";edit(e){if(this.managers._get(f3)?.editor?.enterEdit?.(\"prism\",this,e),this.managers._get(f3).hover.setCursor(gs.EditingCursor,\"hover\"),this.transformer.update({show:!0,position:this.averageCenter}),this.properties.enableHeightControl){let e={show:!0,referencePosition:this.averageCenter},a=this.extrudedHeight/3,r=this.extrudedHeight/2;this.heightConstrollerUp.update({...e,offsetHeight:a+r}),this.heightConstrollerDown.update({...e,offsetHeight:-(a+r)})}let a=this.managers._get(f3).viewer.camera;this.transformer.onCameraChanged(a),this.edgeDraggable=!0}exitEdit(){this.managers._get(f3).hover.setCursor(\"pointer\",\"hover\"),this.setDragging(!1);let e={show:!1};this.transformer.update(e),this.heightConstrollerUp.update(e),this.heightConstrollerDown.update(e),this.transformer.onDragging&&(this.localMatrix=uf.Matrix4.IDENTITY,this.transformer.endDrag()),this.edgeDraggable=!1}getEditActivePoints(){let e=this.positions,a=e.map(e=>{let a=hu.clone(e);a.height=Number(this.height);let r=hV((0,pg.jL)(a));return uf.Matrix4.multiplyByPoint(this.hprMatrixWC,r,r),r});return[a,e.map(e=>{let a=hu.clone(e);a.height=Number(this.absoluteHeight);let r=hV((0,pg.jL)(a));return uf.Matrix4.multiplyByPoint(this.hprMatrixWC,r,r),r})]}startDragSide(e,a){this.setDragging(!0);let r=this.managers._get(f3).viewer;if(r){let t=this.positions?.[e];if(t){let n=me((0,pg.jL)(t),r);if(a){let r=uf.IntersectionTests.rayPlane(a,n);if(r)return this.dragStatus={type:\"side\",index:e},{position:r,clampToGround:!1}}}}return!1}endDrag(){return this.setDragging(!1),this.managers._get(f3).emit(\"finishEdit\",{type:\"prism\",origin:this,shape:this.positions||[],changeType:\"edge\"}),null}updateSide(e){this.update({positions:this.positions?.map((a,r)=>r===this.dragStatus?.index?e:a)})}onMouseEnter(e){let a=hs(String(e.id),this.id);if(!1===a)return;let[r]=a,t=this.managers._get(f3).hover;this.activeState.selected&&(\"side\"===r?t.setCursor(\"ew-resize\",\"hover\"):t.setCursor(\"ns-resize\",\"hover\")),t.isPrismHovering.value=!0}onMouseLeave(e){if(!1!==hs(String(e.id),this.id))this.managers._get(f3).hover.setCursor(\"\",\"hover\"),this.managers._get(f3).hover.isPrismHovering.value=!1}}function gl(...e){let a=new uf.PolylineGeometry({vertexFormat:uf.PolylineMaterialAppearance.VERTEX_FORMAT,positions:e,width:1,arcType:uf.ArcType.NONE});return new uf.GeometryInstance({geometry:a})}class gd extends(0,uX.AF)(pv,ph,pz){managers;primitives;activeChanged;properties;uid;interactLevel;dirty;shouldUpdateGeometry;shouldUpdateAppearance;geometryInstanceCache;constructor(e,a){super(),this.managers=a,this.primitives=py({}),this.activeChanged=!1,this.uid=(0,uW.k)(),this.interactLevel=sc.Thing,this.dirty=!1,this.shouldUpdateGeometry=!1,this.shouldUpdateAppearance=!1,this.geometryInstanceCache={leadline:void 0,bottom:void 0,bottomOutline:void 0},this.properties=e,this.withDefaults(e),this.init(),this.setCollectionMap(\"pyramid\")}get shapeMode(){return this.properties.shapeMode??\"ANLGE\"}get coords(){return this.properties.coords&&5===this.properties.coords.length?this.properties.coords:null}comparePrimitiveProp(e,a){return void 0===e&&!!a||(!e||void 0!==a)&&e!==a}compareHprProp(e,a){if(e)return!!a&&(e.heading!==a.heading||e.pitch!==a.pitch);return!!a||!1}setIfHasValue(e){let a=this.properties;e.aspect&&(a.aspect=e.aspect),e.fov&&(a.fov=e.fov),e.far&&(a.far=e.far),e.hpr&&(a.hpr=e.hpr),void 0!==e.enableDepthFailedAppearance&&(a.enableDepthFailedAppearance=e.enableDepthFailedAppearance),e.mainColor&&(a.mainColor=e.mainColor),e.highlightColor&&(a.highlightColor=e.highlightColor),void 0!==e.active&&(a.active=e.active)}update(e){let a=this.properties,r=this.geometryInstanceCache;if(void 0!==e.show&&(this.dirty=a.show!==e.show,a.show=e.show),\"ANLGE\"===this.shapeMode?this.shouldUpdateGeometry=this.comparePrimitiveProp(a.aspect,e.aspect)||this.comparePrimitiveProp(a.far,e.far)||this.comparePrimitiveProp(a.fov,e.fov)||this.compareHprProp(a.hpr,e.hpr):this.shouldUpdateGeometry=!a.coords||!e.coords||function(e,a){if(e.length!==a.length||5!==e.length||5!==a.length)return!1;for(let r=0;r<e.length;r++){let t=e[r],n=a[r];if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e]!==n[e])return!1}return!0}(a.coords,e.coords),this.activeChanged=this.comparePrimitiveProp(a.active,e.active),this.shouldUpdateAppearance=this.comparePrimitiveProp(a.enableDepthFailedAppearance,e.enableDepthFailedAppearance)||this.comparePrimitiveProp(a.mainColor,e.mainColor)||this.comparePrimitiveProp(a.highlightColor,e.highlightColor)||this.comparePrimitiveProp(a.active,e.active),this.setIfHasValue(e),\"ANLGE\"===this.shapeMode&&(e.position?a.position?(this.shouldUpdateGeometry=a.position.longitude!==e.position.longitude||a.position.latitude!==e.position.latitude||a.position.height!==e.position.height,a.position.longitude=e.position.longitude,a.position.latitude=e.position.latitude,a.position.height=e.position.height):(this.shouldUpdateGeometry=!0,a.position=e.position):a.position&&(this.properties.show=!1,this.dirty=!0)),this.shouldUpdateGeometry=this.shouldUpdateGeometry||void 0===r.bottom||void 0===r.bottomOutline||void 0===r.leadline,this.dirty=this.dirty||this.shouldUpdateGeometry||this.shouldUpdateAppearance,\"ANLGE\"===this.shapeMode){if(!function(e){let{position:a={latitude:0,longitude:0,height:0},fov:r=36,far:t=14,aspect:n=1}=e,{latitude:i,longitude:o,height:s=0}=a;return o>180||o<-180?(console.warn(`经度: ${o} 范围不对`),!1):i>90||i<-90?(console.warn(`纬度: ${i} 范围不对`),!1):s<0?(console.warn(`高度: ${s} 不建议小于 0`),!1):r<=0||r>=180?(console.warn(`视角范围: ${r} 数值不对，取值范围：(0, 180)`),!1):t<=1?(console.warn(`远值: ${t} 过小，建议大于 1`),!1):!(n<=0)||(console.warn(`远平面长宽比: ${n} 必须是正数`),!1)}(this.properties))return;if(this.shouldUpdateGeometry){let e=function(e){let{fov:a=36,far:r=15,aspect:t=1}=e,n=e.hpr;!n&&(n={heading:0,pitch:0,roll:0});let{heading:i=0,pitch:o=0}=n,s=2*r*Math.tan(uf.Math.toRadians(a)/2),l=s*t,d=new uf.Cartesian3(0,0,.01),c=new uf.Cartesian3(s/2,l/2,-r),u=new uf.Cartesian3(-s/2,l/2,-r),p=new uf.Cartesian3(-s/2,-l/2,-r),m=new uf.Cartesian3(s/2,-l/2,-r),h=uf.Matrix3.fromHeadingPitchRoll(new uf.HeadingPitchRoll(uf.Math.toRadians(i-90),uf.Math.toRadians(90+o))),g=uf.Matrix4.fromRotationTranslation(h),f=uf.Matrix4.multiplyByPoint(g,d,new uf.Cartesian3),_=uf.Matrix4.multiplyByPoint(g,c,new uf.Cartesian3),b=uf.Matrix4.multiplyByPoint(g,u,new uf.Cartesian3),k=uf.Matrix4.multiplyByPoint(g,p,new uf.Cartesian3);return[f,_,b,k,uf.Matrix4.multiplyByPoint(g,m,new uf.Cartesian3)]}(this.properties),{position:a}=this.properties;if(a){let{longitude:r,latitude:t,height:n=0}=a,i=uf.Cartesian3.fromDegrees(r,t,n),o=uf.Transforms.eastNorthUpToFixedFrame(i);this.updateGeometryInstance(e,o)}else this.geometryInstanceCache.leadline=void 0,this.geometryInstanceCache.bottom=void 0,this.geometryInstanceCache.bottomOutline=void 0}}else{if(!this.coords)return;this.updateGeometryInstanceRawCoord(this.coords)}this.render()}updateGeometryInstanceRawCoord(e){let a=e.map(e=>uf.Cartesian3.fromArray(e));this.updateGeometryInstance(a,uf.Matrix4.IDENTITY)}updateGeometryInstance([e,a,r,t,n],i){let o=this.geometryInstanceCache,s=gl(uf.Cartesian3.clone(e),uf.Cartesian3.clone(a)),l=gl(uf.Cartesian3.clone(e),uf.Cartesian3.clone(r)),d=gl(uf.Cartesian3.clone(e),uf.Cartesian3.clone(t)),c=gl(uf.Cartesian3.clone(e),uf.Cartesian3.clone(n));s.modelMatrix=i,s.id=this.uid,l.modelMatrix=i,l.id=this.uid,d.modelMatrix=i,d.id=this.uid,c.modelMatrix=i,c.id=this.uid;let u=function(...e){let a=[new uf.Cartesian2(1,0),new uf.Cartesian2(0,0),new uf.Cartesian2(0,1),new uf.Cartesian2(1,1)],r=uf.CoplanarPolygonGeometry.fromPositions({vertexFormat:uf.VertexFormat.DEFAULT,positions:e,textureCoordinates:{positions:a}});return new uf.GeometryInstance({geometry:r})}(uf.Cartesian3.clone(a),uf.Cartesian3.clone(r),uf.Cartesian3.clone(t),uf.Cartesian3.clone(n));u.modelMatrix=i,u.id=this.uid;let p=gl(uf.Cartesian3.clone(a),uf.Cartesian3.clone(r),uf.Cartesian3.clone(t),uf.Cartesian3.clone(n),uf.Cartesian3.clone(a));p.modelMatrix=i,p.id=this.uid,o.leadline=[s,l,d,c],o.bottom=u,o.bottomOutline=p}render(){if(!!this.dirty)this.managers._values().forEach(e=>{e.elements.pyramidVisualizer.dirty=!0,e.render()})}withDefaults(e){this.properties.show=(0,uf.defaultValue)(e.show,!0),this.properties.aspect=(0,uf.defaultValue)(e.aspect,1),this.properties.fov=(0,uf.defaultValue)(e.fov,36),this.properties.far=(0,uf.defaultValue)(e.far,14),this.properties.mainColor=(0,uf.defaultValue)(e.mainColor,\"#DCDCDCE5\"),this.properties.highlightColor=(0,uf.defaultValue)(e.highlightColor,\"#2D8CF0E5\"),this.properties.hpr=(0,uf.defaultValue)(e.hpr,{heading:0,pitch:0,roll:0}),this.properties.enableDepthFailedAppearance=(0,uf.defaultValue)(e.enableDepthFailedAppearance,!1),this.properties.active=(0,uf.defaultValue)(e.active,!1)}getUpdateInfo(){let e=this.properties,a=e.mainColor,r=e.highlightColor,t=this.geometryInstanceCache;return!t.leadline&&!t.bottom&&!t.bottomOutline&&this.update(this.properties),{color:uf.Color.fromCssColorString(String(a)),activeColor:e.active?uf.Color.fromCssColorString(String(r)):void 0,useDepthFailedAppearance:!!e.enableDepthFailedAppearance,geometryInstance:t}}onManagerAdd(e){this.primitives._add(e,{}),this.dirty=!0,this.managers._get(e).render()}onManagerRemove(e){this.managers._get(e).elements.pyramidVisualizer.destroy()}onManagerUpdate(e){let a=this.primitives._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}bindPrimitive(e,a){this.primitives._values().forEach(r=>r[e]=a)}hasPrimitive(e){return this.primitives._keys().some(a=>{let r=this.primitives._get(a);return r.leadline===e||r.bottom===e||r.bottomOutline===e})}destroy(){this.geometryInstanceCache.leadline=void 0,this.geometryInstanceCache.bottom=void 0,this.geometryInstanceCache.bottomOutline=void 0,this.dirty=!0,this.removeCollectionMap(),this.managers._values().forEach(e=>{e.elements.pyramidVisualizer.removeElement(this)})}}let gc=\"3dModel\";class gu extends(0,uX.AF)(ph){managers;constructor(e,a){super(),this.managers=a,this.type=gc,this.primitives=py({}),this.readyPromise=new Promise(e=>this.resolveCallback=e),this.extrasParsed=!1,this.intensityInfo=null,this.echoInfo=null,this.cartoMap={},this.forceLoading=!1,this.properties=Object.assign({show:!0,url:\"\",contentType:\"mesh\",category:se.none,pointCloudStyle:\"rgb\",heightInfo:null,coordinates:null,maximumScreenSpaceError:uE(),pointSize:3},e),this.init(),this._id=(0,uW.k)(),this.setCollectionMap(gc)}_id;type;properties;primitives;resolveCallback;readyPromise;get mainPrimitive(){return this.primitives._get(f3)}get contentType(){return this.properties.contentType}get show(){return this.properties.show}set show(e){e!==this.properties.show&&(this.properties.show=e,this.primitives.showSetter(e),this.managers.emit(\"tilesetShowChanged\",this))}get lockMaximumScreenSpaceError(){return!!this.properties.lockMaximumScreenSpaceError}get maximumScreenSpaceError(){return this.properties.maximumScreenSpaceError}set maximumScreenSpaceError(e){!this.lockMaximumScreenSpaceError&&(this.properties.maximumScreenSpaceError=e,e&&(this.primitives._keys().forEach(a=>{let r=this.primitives._get(a);r&&(r.maximumScreenSpaceError=e)}),this.managers.render?.()))}get id(){return this._id}get boundingSphere(){return this.mainPrimitive?.boundingSphere}get ready(){return(0,pg.ri)(this.mainPrimitive)}get loadProgress(){return this.mainPrimitive?.loadProgress}get tilesLoaded(){return this.mainPrimitive?.initialTilesLoaded}get statistics(){return this.mainPrimitive?._statistics||{}}get authToken(){let e=this.properties.authToken;return\"object\"==typeof e&&\"name\"in e&&\"value\"in e?e:null}get pointSize(){return this.properties.pointSize||3}set pointSize(e){e!==this.properties.pointSize&&(this.properties.pointSize=e,this.mainPrimitive._pointCloudShading&&(this.mainPrimitive._pointCloudShading.maximumAttenuation=e,this.managers.render?.()))}getCesium3DTilesetOptions(){return{show:this.properties.show,url:this.properties.url,pointCloudShading:new uf.PointCloudShading({attenuation:!0,maximumAttenuation:this.properties.pointSize||3,eyeDomeLighting:!0,eyeDomeLightingRadius:2,eyeDomeLightingStrength:.8}),maximumScreenSpaceError:this.properties.maximumScreenSpaceError,skipLevelOfDetail:!0,preferLeaves:!0,enableCollision:!0}}async addPrimitive(e){let a=this.managers._get(e);if(a){let r=this.getCesium3DTilesetOptions(),t={};this.authToken&&(t[this.authToken.name]=this.authToken.value);let n=this.properties.url;\"string\"==typeof n&&(n=new uf.Resource({url:n,headers:t}));let i=await uf.Cesium3DTileset.fromUrl(n,r);if(this.isDestroyed)return;this.primitives._add(e,a.viewer.scene.primitives.add(i)),this.resolveCallback?.(this),this.updatePrimitiveStyle(i)}}removePrimitive(e){let a=this.managers._get(e),r=this.primitives._get(e);a&&r&&(a.viewer.scene.primitives.remove(r),this.primitives._remove(e))}updatePrimitiveStyle(e){if(e){let a=this.getStyle();a&&(e.style=a)}}init(){super.init(),this.cleanPointCloudInfo(),this.updateStyle()}async isPositionIncludedWhenReady(e){return!!this.ready&&this.isPositionIncluded(e)}isPositionIncluded(e){let a=this.boundingSphere;return!!a&&function(e,a){let r=uf.Cartographic.fromCartesian(a.center),t=uf.Cartesian3.fromRadians(e.longitude,e.latitude,r.height);return uf.Cartesian3.distance(t,a.center)<=a.radius}(e,a)}removePrimitives(){this.primitives._keys().forEach(e=>{this.removePrimitive(e)})}async updateStyle(){!this.extrasParsed&&await this.parseExtras();let e=this.getStyle();e&&this.primitives.styleSetter(e)}async parseExtras(){if(this.mainPrimitive&&!this.extrasParsed){if(!!this.ready){if(this.mainPrimitive){if(this.mainPrimitive.extras){let e=this.mainPrimitive.extras;e.maxIntensity&&(this.intensityInfo={min:e.minIntensity,max:e.maxIntensity}),e.maxReturnNumber&&(this.echoInfo={maxReturnNumber:e.maxReturnNumber})}this.extrasParsed=!0}}}}extrasParsed;intensityInfo;echoInfo;async getIntensityInfo(){return this.ready?this.intensityInfo:null}async getEchoInfo(){return this.ready?this.echoInfo:null}cleanPointCloudInfo(){this.intensityInfo=null,this.echoInfo=null}getStyle(){if(this.properties.customStyle)return new uf.Cesium3DTileStyle(this.properties.customStyle);if(\"rgb\"===this.properties.pointCloudStyle)return new uf.Cesium3DTileStyle;if(\"intensity\"===this.properties.pointCloudStyle&&this.intensityInfo){let e=this.intensityInfo.max-this.intensityInfo.min;return new uf.Cesium3DTileStyle({defines:{range:e,min_value:this.intensityInfo.min},color:\"vec4((${INTENSITY}-${min_value})/${range}*4-2, 2-4*distance((${INTENSITY}-${min_value})/${range},0.5), 2-(${INTENSITY}-${min_value})/${range}*4, 1.0)\"})}if(\"echo\"===this.properties.pointCloudStyle&&this.echoInfo){let e=this.echoInfo.maxReturnNumber-1;return new uf.Cesium3DTileStyle({defines:{range:e,min_value:1},color:\"vec4((${ECHO}-${min_value})/${range}*4-2, 2-4*distance((${ECHO}-${min_value})/${range},0.5), 2-(${ECHO}-${min_value})/${range}*4, 1.0)\"})}let e=this.getHeightRangeAtCoordinates();if(\"height\"===this.properties.pointCloudStyle&&e){let a=e.max-e.min;return new uf.Cesium3DTileStyle({defines:{range:a,min_value:e.min},color:\"vec4((${POSITION}.z-${min_value})/${range}*4-2, 2-4*distance((${POSITION}.z-${min_value})/${range},0.5), 2-(${POSITION}.z-${min_value})/${range}*4, 1.0)\"})}}getHeightRangeAtCoordinates(){let e=this.properties.coordinates,a=this.properties.heightInfo;if(e&&a){let r=uf.Cartesian3.fromDegrees(e.center.longitude,e.center.latitude,e.center.height),t=new uf.Matrix4(...e.transform),n=uf.Matrix4.inverseTranspose(t,new uf.Matrix4),i=uf.Matrix4.multiplyByPoint(n,r,new uf.Cartesian3).z,o=e.center.height||0,{min:s,max:l}=a;return{min:s-o+i,max:l-o+i}}}update(e){let a=!1;if((0,pg.ri)(e.pointCloudStyle)&&e.pointCloudStyle!==this.properties.pointCloudStyle&&(this.properties.pointCloudStyle=e.pointCloudStyle,a=!0),(0,pg.ri)(e.authToken)&&(this.properties.authToken=e.authToken),(0,pg.ri)(e.url)&&e.url!==this.properties.url)throw Error(\"Cannot Change Tileset's url\");(0,pg.ri)(e.show)&&e.show!==this.properties.show&&(this.show=e.show),(0,pg.ri)(e.pointSize)&&e.pointSize>0&&(this.pointSize=e.pointSize),void 0!==e.heightInfo&&(this.properties.heightInfo=e.heightInfo,\"height\"===this.properties.pointCloudStyle&&(a=!0)),e.maximumScreenSpaceError&&(this.maximumScreenSpaceError=e.maximumScreenSpaceError),a&&(this.updateStyle(),this.managers.render?.())}cartoMap;removeUpdateHeight(e,a){let r=this.cartoMap[e];if(r){if(r.callbacks.length>1){let e=r.callbacks.findIndex(e=>e===a);r.callbacks.splice(e,1)}else r.removeFunc(),delete this.cartoMap[e]}}getAllPositionWhenTileUpdate(e){let a=this.managers._get(f3)?.viewer.scene.frameState;if(a.tilesetPassState?.pass===uf.Cesium3DTilePass.RENDER){let r=e.content?._model;if(!r)return!1;let t=e.contentBoundingVolume.boundingSphere,n=e._getHeightCache;!n&&(n={},e._getHeightCache=n);let i=Object.keys(this.cartoMap).filter(e=>{if(!n[e]&&this.cartoMap[e]){let a=this.cartoMap[e].ray,r=uf.IntersectionTests.raySphere(a,t);return(0,pg.ri)(r)}return!1});if(i.length>0){let e=i.map(()=>Number.MAX_VALUE);uf.ModelUtility.getModelTriangles(r,a.mode,a.mapProjection,a.context.webgl2,e=>i.some(a=>{if(this.cartoMap[a]){let r=this.cartoMap[a].ray,t=uf.IntersectionTests.raySphere(r,e);return(0,pg.ri)(t)}return!1}),(a,t,n)=>{i.forEach((i,o)=>{if(this.cartoMap[i]){let s=this.cartoMap[i].ray,l=uf.IntersectionTests.rayTriangleParametric(s,a,t,n,(0,uf.defaultValue)(r.backFaceCulling,!0));(0,pg.ri)(l)&&l<e[o]&&l>=0&&(e[o]=l)}})},void 0,void 0,void 0,a=>{i.forEach((r,t)=>{if(this.cartoMap[r]){let n=this.cartoMap[r].ray,i=uf.Cartesian3.subtract(a,n.origin,new uf.Cartesian3),o=uf.Cartesian3.cross(i,n.direction,new uf.Cartesian3);if(1>=uf.Cartesian3.magnitude(o)){let a=uf.Cartesian3.dot(i,n.direction);a<e[t]&&a>=0&&(e[t]=a)}}})}),i.forEach((a,r)=>{n[a]=e[r],this.cartoMap[a].dirty=!0}),this.callbackPositions()}}return!0}callbackPositions(){let e=this.mainPrimitive;if(e){let a=e._selectedTiles;Object.keys(this.cartoMap).forEach(e=>{let r=this.cartoMap[e];if(r?.dirty){let t=Number.MAX_VALUE;if(a.forEach(a=>{let r=a._getHeightCache?.[e];(0,pg.ri)(r)&&r<t&&r>=0&&(t=r)}),t!==Number.MAX_VALUE){let e=uf.Ray.getPoint(r.ray,t),a=uf.Cartographic.fromCartesian(e);r.callbacks.forEach(e=>e(a.height)),r.dirty=!1}}})}}updateHeight(e,a){let r=function(e){let a=uv(e.longitude,9),r=uv(e.latitude,9);return`${a},${r}`}(e),t=this.cartoMap[r];if(t)t.callbacks.push(a),t.dirty=!0;else{let n=this.mainPrimitive;n&&(t={ray:mn(e),removeFunc:n.updateHeight(e,(e,a,r)=>{(a.content||r===uf.Cesium3DTilePass.RENDER)&&this.getAllPositionWhenTileUpdate(a)}),callbacks:[a],dirty:!0},this.cartoMap[r]=t)}return this.forceUpdateHeight(),()=>{this.removeUpdateHeight(r,a)}}forceLoading;forceUpdateHeight(){let e=this.managers._get(f3);e&&!this.forceLoading&&(this.forceLoading=!0,e.once(\"prependPostRender\",()=>{this.forceLoading=!1,(this.mainPrimitive?._selectedTiles||[]).forEach(e=>this.getAllPositionWhenTileUpdate(e)),this.callbackPositions()}))}getHeightRange(e){let a=this.managers._get(f3)?.viewer.scene.frameState;return a.tilesetPassState&&a.tilesetPassState.pass===uf.Cesium3DTilePass.RENDER&&this.mainPrimitive?function(e,a,r){let t=a._selectedTiles;if(Array.isArray(t)&&0===t.length)return[0,0];let n=1e4,i=-1e4,o=uf.Cartographic.ZERO.clone(),s=uf.Cartographic.ZERO.clone(),l=uf.Cartographic.ZERO.clone(),d=uf.Cartographic.ZERO.clone(),c=a=>{if(!function(e,a){let r=(0,uQ.yu)([a.map(e=>[e.longitude,e.latitude])]);return(0,p$.Z)([e.longitude,e.latitude],r)}(a,e))return;let{height:r}=a;n=Math.min(r,n),i=Math.max(r,i)};return t.forEach(a=>{if(a.content&&a.content.ready){if(!function(e,a){let{contentBoundingVolume:r}=a;return r instanceof uf.TileOrientedBoundingBox||r instanceof uf.TileBoundingRegion?function(e,a){let r=a.computeCorners().map(e=>{let a=uf.Cartographic.fromCartesian(e);return a.height=0,a});return r.push(r[0]),function(e,a){let r=(0,uQ.yu)([e.map(e=>[e.longitude,e.latitude])]),t=(0,uQ.yu)([a.map(e=>[e.longitude,e.latitude])]);return(0,pX.Z)(r,t)}(e,r)}(e,r.boundingVolume):r instanceof uf.TileBoundingSphere&&function(e,a,r=\"3D\"){let{radius:t,center:n}=a,i=uf.Cartographic.fromCartesian(n),o=i.height,s=function(e,a,r=64,t=!0){let{longitude:n,latitude:i,height:o}=e,s=[];for(let e=0;e<r;e++){let l=360/r*e,d=uf.Math.toRadians(l),c=Math.asin(Math.sin(i)*Math.cos(a/6378137)+Math.cos(i)*Math.sin(a/6378137)*Math.cos(d)),u=n+Math.atan2(Math.sin(d)*Math.sin(a/6378137)*Math.cos(i),Math.cos(a/6378137)-Math.sin(i)*Math.sin(c));s.push(uf.Cartographic.fromRadians(u,c,t?o:0))}return s.push(s[0]),s}(i,t,64,!1),l=(0,uQ.yu)([e.map(e=>[e.longitude,e.latitude])]),d=(0,uQ.yu)([s.map(e=>[e.longitude,e.latitude])]),c=(0,pX.Z)(l,d);return\"2D\"===r?c:c&&o+t>0&&o-t<0}(e,r.boundingSphere)}(e,a))return;let t=a.content._model;if(!!t)uf.ModelUtility.getModelTriangles(t,r.mode,r.mapProjection,r.context.webgl2,()=>!0,(e,a,r)=>{uf.Cartographic.fromCartesian(e,void 0,o),uf.Cartographic.fromCartesian(a,void 0,s),uf.Cartographic.fromCartesian(r,void 0,l),c(o),c(s),c(l)},void 0,void 0,void 0,e=>{uf.Cartographic.fromCartesian(e,void 0,d),c(d)})}}),[n,i]}(e.map(e=>(0,pg.i9)(e)),this.mainPrimitive,a):[0,0]}async getRectangle(){await this.readyPromise;let e=this.boundingSphere.center,a=this.boundingSphere.radius,r=uf.Cartographic.fromCartesian(e),t=180*r.longitude/Math.PI,n=180*r.latitude/Math.PI,i=a/111e3,o=a/(111e3*Math.cos(r.latitude));return{south:n-i,north:n+i,west:t-o,east:t+o}}async changeView(e=\"tilt\",a=f3){let r=this.managers._get(a);if(await this.readyPromise,r){let a;let t=this.boundingSphere.center,n=this.boundingSphere.radius;a=\"tilt\"===e?-45:-90,r.viewer.scene.camera.lookAt(t,new uf.HeadingPitchRange(0,uf.Math.toRadians(a),2.5*n)),r.viewer.camera.lookAtTransform(uf.Matrix4.IDENTITY),setTimeout(()=>{r.render()},2e3)}}async setCollectionMap(e){await this.readyPromise,super.setCollectionMap(e)}onManagerAdd(e){this.addPrimitive(e),this.updatePrimitiveStyle(this.primitives._get(e))}onManagerRemove(e){this.removePrimitive(e)}onManagerUpdate(e){let a=this.primitives._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}destroy(){super.destroy(),this.removePrimitives()}}class gp extends(0,uX.AF)(pv,ph){managers;constructor(e,a,r){super(),this.managers=a,this.entities=py({}),this.interactLevel=sc.Area,this.properties=Object.assign({id:(0,uW.k)(),type:\"wall\"},e),this.options=Object.assign({},r),this.init(),this.setCollectionMap(),this.managers.render?.()}properties;options;entities;interactLevel;get id(){return this.properties.id}get positions(){return this.properties.positions}set positions(e){this.properties.positions=e;let a=this.getPositionsCartesian3();this.entities.wall?.positionsSetter(new uf.ConstantProperty(a))}get name(){return this.properties.name}set name(e){this.properties.name=e,this.entities.label?.textSetter(new uf.ConstantProperty(e)),this.managers.render?.()}update(e){(0,pg.ri)(e.name)&&(this.name=e.name),(0,pg.ri)(e.positions)&&(this.positions=e.positions),(0,pg.ri)(e.show)&&this.entities.showSetter(e.show),(0,pg.ri)(e.maximumHeights)&&(this.properties.maximumHeights=e.maximumHeights),(0,pg.ri)(e.minimumHeights)&&(this.properties.minimumHeights=e.minimumHeights),(0,pg.ri)(e.imageUrl)&&(this.properties.imageUrl=e.imageUrl),this.updateMaterial(),(0,pg.ri)(e.removable)&&(this.properties.removable=e.removable)}getEntityOptions(){return{id:this.id,show:this.properties.show,wall:{material:new uf.ImageMaterialProperty({image:this.properties.imageUrl,transparent:!0}),positions:this.getPositionsCartesian3(),maximumHeights:this.properties.maximumHeights,minimumHeights:this.properties.minimumHeights}}}getPositionsCartesian3(){if(this.properties.positions)return this.properties.positions.map(e=>(0,pg.jL)(e))}init(){super.init()}setCollectionMap(){this.managers._options.elements.add(\"wall\",this,[this.id])}updateMaterial(){this.properties.imageUrl&&this.entities.wall?.materialSetter(new uf.ImageMaterialProperty({image:this.properties.imageUrl,transparent:!0}))}updateHeightsArray(){this.entities.wall?.maximumHeightsSetter(new uf.ConstantProperty(this.properties.maximumHeights)),this.entities.wall?.minimumHeightsSetter(new uf.ConstantProperty(this.properties.minimumHeights))}onManagerAdd(e){let a=this.managers._get(e);a&&(this.entities._add(e,a.viewer.entities.add(this.getEntityOptions())),this.updateMaterial(),this.updateHeightsArray())}onManagerRemove(e){let a=this.entities._get(e);a?.entityCollection.remove(a),this.entities._remove(e)}onManagerUpdate(e){let a=this.entities._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}destroy(){super.destroy(),this.entities._keys().forEach(e=>{let a=this.entities._get(e);a&&a.entityCollection.remove(a),this.entities._remove(e)})}}let gm=r.p+\"f9d6891f0d695546.glb\";class gh{}class gg extends(0,uX.AF)(ph,pz,pv,gh){managers;properties;modelProxy;localMatrix;readyPromise;interactLevel;constructor(e,a){super(),this.managers=a,this.modelProxy=py({}),this.localMatrix=uf.Matrix4.IDENTITY,this.readyPromise=null,this.interactLevel=sc.Thing,this.draggingStatus=null,this.properties=Object.assign({id:(0,uW.k)(),show:!0,type:\"height-controller\"},e),this.init(),this.setCollectionMap()}get referencePositionWC(){return this.properties.referencePosition?(0,pg.jL)(this.properties.referencePosition):null}get cssColor(){return this.properties.cssColor||\"#EEEEEE\"}get ownerId(){return this.properties.ownerId||\"\"}get usage(){return this.properties.usage||\"up\"}get show(){return!1!==this.properties.show}get hprMatrix(){let e=this.properties.hpr;if(!e)return uf.Matrix3.IDENTITY;let a=uf.HeadingPitchRoll.fromDegrees(e.heading,e.roll,e.pitch);return uf.Matrix3.fromHeadingPitchRoll(a)}get enuMatrix(){return this.referencePositionWC?uf.Transforms.eastNorthUpToFixedFrame(this.referencePositionWC):uf.Matrix4.IDENTITY}get offsetHeight(){return this.properties.offsetHeight||0}calculateProps(){if(!this.referencePositionWC||!this.modelProxy)return;let e=uf.Matrix4.fromTranslation(new uf.Cartesian3(0,0,this.offsetHeight)),a=uf.Matrix4.multiply(uf.Matrix4.fromRotation(this.hprMatrix),e,new uf.Matrix4),r=uf.Matrix4.multiply(this.enuMatrix,a,new uf.Matrix4);this.localMatrix=r,this.modelProxy.modelMatrixSetter(this.localMatrix)}updateStyle(e){let a=this.modelProxy._get(e);if(!a||a&&a.isDestroyed())return;let r=this.properties;if(r.distanceDisplayCondition){let[e,t]=r.distanceDisplayCondition;a.distanceDisplayCondition=new uf.DistanceDisplayCondition(e,t)}r.cssColor&&(a.color=uf.Color.fromCssColorString(r.cssColor))}updateStyleAllManagers(){this.modelProxy._keys().forEach(e=>{this.updateStyle(e)})}update(e){let a=this.properties;(0,pg.ri)(e.show)&&(a.show=e.show,this.modelProxy.showSetter(e.show));let r=!1,t=!1;(0,pg.ri)(e.ownerId)&&(a.ownerId=e.ownerId),(0,pg.ri)(e.cssColor)&&(a.cssColor=e.cssColor,t=!0),(0,pg.ri)(e.referencePosition)&&(a.referencePosition=e.referencePosition,r=!0),(0,pg.ri)(e.offsetHeight)&&(a.offsetHeight=e.offsetHeight,r=!0),(0,pg.ri)(e.hpr)&&(a.hpr=e.hpr,r=!0),(0,pg.ri)(e.distanceDisplayCondition)&&(a.distanceDisplayCondition=e.distanceDisplayCondition,t=!0),r&&(this.calculateProps(),this.managers.viewer?.render?.()),t&&this.updateStyleAllManagers()}setCollectionMap(){this.managers._options.elements.add(\"height-controller\",this,[this.properties.id])}removeModel(e){let a=this.modelProxy._get(e),r=this.managers._get(e)?.primitiveContainers.heightController;if(!!r)r.remove(a)}addModel(e){let a=this.managers._get(e);if(!a)return;let r=uf.Color.fromCssColorString(this.cssColor),t=uf.Matrix4.multiply(this.localMatrix,uf.Matrix4.IDENTITY,new uf.Matrix4),n=new uf.DistanceDisplayCondition;(0,pg.ri)(this.properties.distanceDisplayCondition)&&(n.near=this.properties.distanceDisplayCondition[0],n.far=this.properties.distanceDisplayCondition[1]);let i={id:`${this.ownerId}-${this.usage}`,url:gm,show:this.show,opaquePass:uf.Pass.OVERLAY,shadows:uf.ShadowMode.DISABLED,scale:.01,minimumPixelSize:19.2,color:r,modelMatrix:t,distanceDisplayCondition:n};this.readyPromise=uf.Model.fromGltfAsync(i).then(r=>{this.modelProxy._add(e,r),a.primitiveContainers.heightController.add(r)}).finally(()=>{a.render()})}destroy(){this.modelProxy._keys().forEach(e=>{this.removeModel(e)}),this.removeCollectionMap()}onManagerAdd(e){this.addModel(e)}onManagerRemove(e){this.removeModel(e)}onManagerUpdate(e){let a=this.modelProxy._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}hasPrimitive(e){return this.modelProxy._keys().some(a=>{let r=this.modelProxy._get(a);return!!r&&r===e})}draggingStatus;generateDragStatus(e){let a=this.managers._get(f3)?.viewer.camera;if(!a)return null;let r=this.referencePositionWC;if(!r)return null;let t=uf.Plane.fromPointNormal(r,uf.Cartesian3.normalize(a.directionWC,new uf.Cartesian3)),n=uf.Cartesian3.add(r,new uf.Cartesian3,new uf.Cartesian3),i=uf.Plane.projectPointOntoPlane(t,n),o=uf.Cartesian3.subtract(i,r,new uf.Cartesian3);uf.Cartesian3.normalize(o,o);let s=1/uf.Cartesian3.magnitude(o),l=a.getPickRay(e);if(!l)return null;let d=uf.IntersectionTests.rayPlane(l,t);if(!d)return null;let c=uf.Cartesian3.subtract(d,r,new uf.Cartesian3),u=uf.Cartesian3.dot(c,o)*s;return{origin:r,plane:t,directionOnPlane:o,startOffset:u,rate:s}}canDrag(e){let a=!(0,pg.ri)(e)&&\"height-controller\";return a&&this.managers._get(f3)?.hover.setCursor(\"grabbing\",\"temporary\"),a}startDrag(e,a,r){return!!(\"height-controller\"===a&&r?.primitive)&&(this.draggingStatus=this.generateDragStatus(e.position),!0)}onDrag(e){if(!this.draggingStatus)return;let{plane:a,origin:r,directionOnPlane:t,rate:n}=this.draggingStatus,i=(this.managers._get(f3)?.viewer.camera).getPickRay(e.endPosition);if(!i)return;let o=uf.IntersectionTests.rayPlane(i,a);if(!o)return;let s=this.referencePositionWC;if(!s)return;let l=uf.Cartesian3.subtract(o,r,new uf.Cartesian3),d=uf.Cartesian3.dot(l,t)*n,c=uf.Cartesian3.multiplyByScalar(s,d-this.draggingStatus.startOffset,new uf.Cartesian3);this.translate(c),this.properties.onDragMove?.()}endDrag(){this.managers._get(f3)?.hover.setCursor(\"\",\"temporary\"),this.draggingStatus=null,this.properties.onDragEnd?.()}updateModelMatrix(e){this.localMatrix=e}translate(e){this.updateModelMatrix(uf.Matrix4.multiply(this.localMatrix,uf.Matrix4.fromTranslation(e),new uf.Matrix4))}setHoverStyle(e){let a=this.modelProxy,r=uf.Color.fromCssColorString(this.cssColor),t=r.brighten(.4,new uf.Color);e?a.colorSetter(t):a.colorSetter(r),this.managers._get(f3)?.render()}onMouseEnter(e){!this.properties.hoverCursor&&this.managers._get(f3)?.hover.setCursor(\"grab\",\"hover\"),this.setHoverStyle(!0),super.onMouseEnter(e)}onMouseLeave(e){this.setHoverStyle(!1),super.onMouseLeave(e)}}let gf={modelURI:r.p+\"4e270752cd1ac487.glb\",scale:2,minimumPixelSize:16,lightIntensity:1.5,displayOnTop:!0};class g_ extends(0,uX.AF)(pv,ph){managers;constructor(e,a){super(),this.managers=a,this.polygons=[],this.models=[],this.interactLevel=sc.Area,this.properties=Object.assign({id:(0,uW.k)(),show:!0,type:\"scanArea\"},e),this.init()}properties;polygons;models;interactLevel;init(){super.init(),this.setCollectionMap(\"scanArea\"),this.addChildren()}get polygonsPositions(){return this.properties.polygons}get cssColor(){return this.properties.cssColor}active(e=\"\",a){let r=!1;return this.polygons.forEach(t=>{let n=t.active(e,a);r=r&&n}),r}addChildren(){this.updatePolygons(),this.updateModels()}updatePolygons(){let e=this.properties.polygons?.length||0,a=this.polygons.splice(e);a.length>0&&a.forEach(e=>{e?.destroy()}),this.properties.polygons?.forEach((e,a)=>{let r=this.polygons[a],t={positions:e,cssColor:this.properties.cssColor,areaAlpha:this.properties.areaAlpha,show:this.properties.show};0===a&&(t.name=this.properties.name,t.labelDistanceDisplayCondition=h$,t.labelScaleByDistance=hX,t.labelOccludedAlpha=.4),r?r.update(t):this.polygons[a]=new hW({withPolyOutline:!0,fromDraw:!0,...t},this.managers,{parent:this})})}updateModels(){let e=this.properties.hotspots?.length||0,a=this.models.splice(e);a.length>0&&a.forEach(e=>{e?.destroy()}),this.properties.hotspots?.forEach((e,a)=>{let r=this.models[a],t={position:e.position,headingPitchRoll:{heading:e.heading+90,pitch:0,roll:0},show:this.properties.show};r?r.update(t):this.models[a]=new hM({...gf,...t},this.managers,{parent:this})})}update(e){let a=!1,r=!1;Object.keys(e).forEach(t=>{let n=e[t];(0,pg.ri)(n)&&(this.properties[t]=n,[\"polygons\",\"cssColor\",\"areaAlpha\",\"name\"].includes(t)&&(a=!0),[\"hotspots\"].includes(t)&&(r=!0),\"show\"===t&&(r=!0,a=!0))}),a&&this.updatePolygons(),r&&this.updateModels()}edit(){this.managers._get(f3)?.editor?.enterEdit?.(\"polygon\",this,!0)}onSceneChange(e,a){this.polygons.forEach(r=>r.onSceneChange(e,a))}onManagerAdd(e){}onManagerRemove(e){}onManagerUpdate(e){}destroy(){this.removeCollectionMap(),this.polygons.forEach(e=>e.destroy()),this.models.forEach(e=>e.destroy())}}var gb=r(\"98410\");function gk(e,a){let r=[],t=[];for(let n=0;n<e.length;n+=2){let i=e[n],o=e[n+1],s=a[n],l=a[n+1];if((0,lL.isNil)(s)||(0,lL.isNil)(l))break;r.push([i,o,1,0,0,0]),r.push([0,0,0,i,o,1]),t.push(s),t.push(l)}let n=(0,gb.mvk)(r),i=(0,gb.JpY)(n,t);return[i[0],i[1],i[2],i[3],i[4],i[5],0,0,1]}let gv=[[0,0],[1,0],[1,1],[0,1]];class gz extends(0,uX.AF)(ph,pz,pv){managers;constructor(e,a){super(),this.managers=a,this.primitives=py({}),this.interactLevel=sc.Area,this.geometryChanged=!1,this.material=null,this.properties=Object.assign({id:(0,uW.k)(),show:!0,type:\"groundImage\"},e),this.init(),this.setCollectionMap()}properties;primitives;interactLevel;geometryChanged;get boundingSphere(){return uf.BoundingSphere.fromPoints(this.positionsWC)}get id(){return this.properties.id}update(e){Object.keys(e).forEach(a=>{this.properties[a]=e[a]}),this.render()}positionsWC;imageCorrection;material;updateSelf(){var e,a,r;if(this.positionsWC=void 0,this.imageCorrection=void 0,this.properties.anchorPoints){let e=this.properties.anchorPoints;if(e.length>=3)try{let a=[],r=[],t=1,n=1,i=0,o=0;e.forEach(([e,s])=>{a.push(e.x,e.y),t=Math.min(t,e.x),i=Math.max(i,e.x),n=Math.min(n,e.y),o=Math.max(o,e.y),r.push(uf.Cartographic.fromDegrees(s.longitude,s.latitude))});let s=(0,pg.E8)(uf.Rectangle.fromCartographicArray(r),Math.max(1/(o-n),1/(i-t))),l=uf.Matrix3.fromRowMajorArray(gk(a,r.flatMap(e=>[(e.longitude-s.west)/s.width,(e.latitude-s.south)/s.height]))),d=gv;if(this.properties.crop){let[e,a,r,t]=this.properties.crop;d=[[e,a],[r,a],[r,t],[e,t]]}let c=d.map(([e,a])=>{let r=uf.Matrix3.multiplyByVector(l,new uf.Cartesian3(e,a,1),new uf.Cartesian3);return uf.Cartesian3.divideByScalar(r,r.z,r),uf.Cartographic.fromRadians(r.x*s.width+s.west,r.y*s.height+s.south)});this.positionsWC=c.map(e=>uf.Cartographic.toCartesian(e));let u=uf.Rectangle.fromCartesianArray(this.positionsWC);this.imageCorrection=uf.Matrix3.fromRowMajorArray(gk(c.flatMap(e=>[(e.longitude-u.west)/u.width,(e.latitude-u.south)/u.height]),d.flat()))}catch(e){console.error(e)}}let t={image:this.properties.image||\"\",correction:this.imageCorrection,color:this.properties.cssColor?uf.Color.fromCssColorString(this.properties.cssColor):void 0,alpha:this.properties.alpha,revertY:!this.properties.image?.endsWith(\"ktx2\")};if(this.material){;e=this.material,uK(a=t,\"image\")&&e.uniforms.image!==a.image&&(e.uniforms.image=a.image),uK(a,\"correction\")&&(e.uniforms.correction=uf.Matrix3.pack(a.correction||uf.Matrix3.IDENTITY,[])),uK(a,\"color\")&&(e.uniforms.color=(0,pg.LS)(a.color,new uf.Color(1,1,1,0))),uK(a,\"alpha\")&&(e.uniforms.alpha=(0,pg.LS)(a.alpha,1)),uK(a,\"revertY\")&&(e.uniforms.revertY=a.revertY?1:0)}else{;this.material=(r=t,new uf.Material({fabric:{type:\"ImageCorrectionMaterial\",uniforms:{image:r.image,correction:uf.Matrix3.pack(r.correction||uf.Matrix3.IDENTITY,[]),color:(0,pg.LS)(r.color,new uf.Color(1,1,1,0)),alpha:(0,pg.LS)(r.alpha,1),revertY:r.revertY?1:0},source:\"czm_material czm_getMaterial(czm_materialInput materialInput) {\\n czm_material m = czm_getDefaultMaterial(materialInput);\\n\\n vec3 stHomo = vec3(materialInput.st, 1.0);\\n stHomo = correction * stHomo;\\n vec2 st = stHomo.xy / stHomo.z;\\n st = fract(st);\\n if (revertY == 1.0) {\\n // 把 t 反过来，如果是非 GPU 使用的图像格式需要\\n st.t = 1.0 - st.t;\\n }\\n\\n vec4 outColor = texture(image, st);\\n\\n if (color.a > 0.0) {\\n m.diffuse = color.rgb;\\n } else {\\n m.diffuse = outColor.rgb;\\n }\\n m.alpha = outColor.a * alpha;\\n\\n return m;\\n}\\n\"},translucent:!0}))}}render(){this.updateSelf(),this.primitives._keys().forEach(e=>{this.updatePrimitive(e)})}addPrimitives(e){!this.primitives._get(e)&&this.primitives._add(e,{}),this.updatePrimitive(e)}async updatePrimitive(e){let a=this.primitives._get(e),r=this.managers._get(e),t=this.id;r&&a&&(a.main&&r.viewer.scene.primitives.remove(a.main),a.main=void 0,this.properties.show&&this.material&&(await uf.GroundPrimitive.initializeTerrainHeights(),a.main=r.viewer.scene.primitives.add(new uf.GroundPrimitive({geometryInstances:new uf.GeometryInstance({geometry:new uf.PolygonGeometry({polygonHierarchy:new uf.PolygonHierarchy(this.positionsWC)}),id:t}),appearance:new uf.MaterialAppearance({material:this.material,faceForward:!0,flat:!0}),asynchronous:!1}))))}setCollectionMap(){this.managers._options.elements.add(\"groundImage\",this,[this.id]),this.uid=this.id||\"\"}onManagerAdd(e){this.updateSelf(),this.addPrimitives(e)}onManagerRemove(e){this.removePrimitives(e)}onManagerUpdate(e){let a=this.primitives._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}hasPrimitive(e){return this.primitives._keys().some(a=>this.primitives._get(a).main===e)}removePrimitives(e){let a=this.primitives._get(e),r=this.managers._get(e);r&&a&&a.main&&r.viewer.scene.primitives.remove(a.main),this.primitives._remove(e)}destroy(){this.primitives._keys().forEach(e=>{this.removePrimitives(e)}),this.removeCollectionMap()}}function gw(e){let a=uf.Material.fromType(uf.Material.ColorType,{color:uf.Color.fromCssColorString(e.cssColor).withAlpha(e.alpha)});return new uf.MaterialAppearance({material:a})}function gy(e){let a=uf.Color.fromCssColorString(e.cssColor),r=uf.Material.fromType(uf.Material.ColorType,{color:a.withAlpha(e.occludedAlpha)});return new uf.MaterialAppearance({material:r})}class gS extends(0,uX.AF)(pv,ph,pz){managers;interactLevel;properties;terrainHeightsPromise;readyForGroundGeometry;members;constructor(e,a){super(),this.managers=a,this.interactLevel=sc.Area,this.terrainHeightsPromise=uf.GroundPrimitive.initializeTerrainHeights(),this.readyForGroundGeometry=!1,this.members=py({}),this.terrainHeightsPromise.then(()=>{this.readyForGroundGeometry=!0}),this.properties=Object.assign({id:(0,uW.k)(),type:\"polygon-group\"},e),this.init(),this.setCollectionMap()}get id(){return this.properties.id}get cssColor(){return this.properties.cssColor||pN.Color}get alpha(){return this.properties.alpha||pN.Alpha}get datas(){return this.properties.datas||[]}get useAsyncGeometry(){return!this.readyForGroundGeometry}get ground(){return!!this.properties.ground}get occludedAlpha(){return this.properties.occludedAlpha||1}get enableOccludedStyle(){return!0===this.properties.enableOccludedStyle}get useOutline(){return this.properties.useOutline||pN.UseOutline}toggleDimension(){this.properties.ground=!this.ground,this.updatePrimitiveAllManagers()}updateShow(){let e=!1!==this.properties.show,a=this.members;a.polygons&&a.polygons.showSetter(e)}update(e){let a=this.properties,r=!1,t=!1;(0,pg.ri)(e.show)&&a.show!==e.show&&(a.show=e.show,this.updateShow()),(0,pg.ri)(e.datas)&&(a.datas=e.datas,r=!0),(0,pg.ri)(e.cssColor)&&(a.cssColor=e.cssColor,t=!0),(0,pg.ri)(e.ground)&&(r=e.ground!==a.ground,a.ground=e.ground),(0,pg.ri)(e.occludedAlpha)&&(a.occludedAlpha=e.occludedAlpha,t=!0),(0,pg.ri)(e.enableOccludedStyle)&&(t=e.enableOccludedStyle!==a.enableOccludedStyle,a.enableOccludedStyle=e.enableOccludedStyle),r&&(this.updatePrimitiveAllManagers(),t=!1),t&&this.updateStyleAllManagers()}updatePolygonPrimitive(e){let a=this.managers._get(e);if(!a)return;let r=a.viewer.scene.primitives,t=this.members._get(e);!t&&(this.members._add(e,{}),t=this.members._get(e));let n=t.polygons;n&&r.contains(n)&&r.remove(n),t.polygons=void 0;let i=function(e){let a=e.ground,r=e.datas,t=e.enableOccludedStyle,n=r.map((r,t)=>{let n=r.positions.map(e=>(0,pg.jL)(e)),i=r.holes?r.holes.map(e=>new uf.PolygonHierarchy(e.map(e=>(0,pg.jL)(e)))):[],o=new uf.PolygonGeometry({polygonHierarchy:new uf.PolygonHierarchy(n,i),perPositionHeight:!a});return new uf.GeometryInstance({id:`${e.id}-${t}`,geometry:o})}),i=gw(e),o=gy(e),s={geometryInstances:n,appearance:i,asynchronous:e.useAsyncGeometry};return a?new uf.GroundPrimitive(s):new uf.Primitive({...s,depthFailAppearance:t?o:void 0})}(this);i.show=!1!==this.properties.show,t.polygons=i,r.add(i)}updatePolygonStyle(e){let a=this.members._get(e).polygons;if(!a)return;let r=gw(this);a.appearance=r;let t=gy(this);a instanceof uf.Primitive&&this.enableOccludedStyle&&(a.depthFailAppearance=t)}updateOutlinePrimitive(e){let a=this.managers._get(e);if(!a)return;let r=a.viewer.scene.primitives,t=this.members._get(e);!t&&(this.members._add(e,{}),t=this.members._get(e));let n=t.border;n&&r.contains(n)&&r.remove(n),t.border=void 0;let i=function(e){let a=e.ground,r=e.datas,t=[],n=(e,a)=>{let r;return r=a?new uf.GroundPolylineGeometry({positions:e.map(e=>(0,pg.jL)(e)),width:1}):new uf.PolylineGeometry({positions:e.map(e=>(0,pg.jL)(e)),width:1}),new uf.GeometryInstance({geometry:r})};r.forEach(e=>{let r=n(e.positions,a);t.push(r);let i=e.holes;if(!!i)i.forEach(e=>{let r=n(e,a);t.push(r)})});let i={geometryInstances:t,appearance:function(e){let a=uf.Material.fromType(uf.Material.ColorType,{color:uf.Color.fromCssColorString(e.cssColor)});return new uf.PolylineMaterialAppearance({material:a})}(e),asynchronous:e.useAsyncGeometry};return a?new uf.GroundPolylinePrimitive(i):new uf.Primitive({...i})}(this);i.show=!1!==this.properties.show,t.border=i,r.add(i)}updateOutlineStyle(e){}appendPolygon(e){this.datas.push(e),this.updatePrimitiveAllManagers()}addPrimitives(e){this.updatePolygonPrimitive(e),this.updateOutlinePrimitive(e),this.managers._get(e).render()}removePrimitives(e){let a=this.members._get(e),r=this.managers._get(e);if(!r||!a)return;let t=r.viewer.scene.primitives;Object.values(a).forEach(e=>t.remove(e))}updateStyleAllManagers(){this.managers._keys().forEach(e=>{this.updatePolygonStyle(e),this.updateOutlineStyle(e)})}updatePrimitiveAllManagers(){this.managers._keys().forEach(e=>{this.updatePolygonPrimitive(e),this.updateOutlinePrimitive(e)})}onManagerAdd(e){this.addPrimitives(e)}onManagerRemove(e){this.removePrimitives(e)}onManagerUpdate(e){let a=this.members._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}setCollectionMap(){this.managers._options.elements.add(\"polygon-group\",this,[this.id])}hasPrimitive(e){return this.members._keys().some(a=>{let r=this.members._get(a);return r.polygons===e||r.border===e})}destroy(){this.removeCollectionMap(),this.members._keys().forEach(e=>{this.removePrimitives(e)})}}var gj=r(\"22358\");(rW=sy||(sy={}))[rW.VolumeAll=1]=\"VolumeAll\",rW[rW.Volume2D=2]=\"Volume2D\",rW[rW.Volume3D=3]=\"Volume3D\",rW[rW.VolumeAllHidden=4]=\"VolumeAllHidden\";class gD extends(0,uX.AF)(ph,pz){managers;minHeight;maxHeight;_type;properties;volume3d;volume2d;showVolume2d;showVolume3d;contours;polygonData;resultPolygonData;counterResult;counterPrimitiveCollection;isShowCounter;canvas;normalScratch;normalScale;tScratch;constructor(e,a){super(),this.managers=a,this.minHeight=0,this.maxHeight=0,this._type=\"volume\",this.counterResult=!1,this.isShowCounter=!1,this.normalScratch=new uf.Cartesian3,this.normalScale=new uf.Cartesian3,this.tScratch=new uf.Cartesian3,this.primitives=py({}),this.creatingId=\"\",this.minHeight=Number.MAX_VALUE,this.maxHeight=Number.MIN_VALUE,this.showVolume2d=!1,this.showVolume3d=!0,this.properties=Object.assign({id:(0,uW.k)(),show:!0,type:this._type},e),!this.properties.cssColorRedAbove&&(this.properties.cssColorRedAbove=pO.CssColorRedAbove),!this.properties.cssColorBlueAbove&&(this.properties.cssColorBlueAbove=pO.CssColorBlueAbove),!this.properties.cssColorRedBelow&&(this.properties.cssColorRedBelow=pO.CssColorRedBelow),!this.properties.cssColorBlueBelow&&(this.properties.cssColorBlueBelow=pO.CssColorBlueBelow),!this.properties.volumeAlphaBelow&&(this.properties.volumeAlphaBelow=pO.VolumeAlphaBelow),!this.properties.volumeAlphaAbove&&(this.properties.volumeAlphaAbove=pO.VolumeAlphaAbove),void 0===this.properties.delta&&(this.properties.delta=pO.delta),!this.properties.cssLineRed&&(this.properties.cssLineRed=pO.CssLineRed),!this.properties.cssLineBlue&&(this.properties.cssLineBlue=pO.CssLineBlue),!this.properties.specular&&(this.properties.specular=pO.Specular),!this.properties.shininess&&(this.properties.shininess=pO.Shininess),!this.properties.counterLength&&(this.properties.counterLength=pq.CounterLength),this.init()}primitives;get id(){return this.properties.id}setCollectionMap(){this.managers._options.elements.add(\"volume\",this,[this.id]),this.uid=this.id||\"\"}onManagerAdd(e){this.addPrimitives(e)}addPrimitives(e){!this.primitives._get(e)&&this.primitives._add(e,{}),this.updatePrimitive(e,this.properties)}async updatePrimitive(e,a){let r=this.primitives._get(e),t=this.managers._get(e);if(a&&t&&r){if(r.volume3d&&r.volume2d){if(a.showType)this.toggleShow(a.showType);else{t.viewer.scene.primitives.remove(r.volume3d),t.viewer.scene.primitives.remove(r.volume2d);let e=await this.createVolume();if(this.isDestroyed)return;e&&e.volume3dResult&&(this.volume3d=e.volume3dResult,r.volume3d=t.viewer.scene.primitives.add(e.volume3dResult)),e&&e.volume2dResult&&(this.volume2d=e.volume2dResult,r.volume2d=t.viewer.scene.primitives.add(e.volume2dResult))}}else{let e=await this.createVolume();if(this.isDestroyed)return;e&&e.volume3dResult&&(this.volume3d=e.volume3dResult,r.volume3d=t.viewer.scene.primitives.add(e.volume3dResult)),e&&e.volume2dResult&&(this.volume2d=e.volume2dResult,r.volume2d=t.viewer.scene.primitives.add(e.volume2dResult))}}t.render()}async createVolume3d(e,a){let r=new uf.PrimitiveCollection;return r.show=this.showVolume3d,this.createPrimitive(a,r),this.createEdgeLines(e.referLines,r,e.transform),this.createEdgeLines(e.targetLines,r,e.transform),this.createLinePrimitive(e.lineVerticesUp,r,e.transform,pO.CssLineBlue),this.createLinePrimitive(e.lineVerticesDown,r,e.transform,pO.CssLineRed),this.createColumnPrimitive(e.polygon,e.polygonUpper,r),r}createEdgeLines(e,a,r){if(e&&e.length>0){let r=new uf.PolylineGeometry({positions:uf.Cartesian3.fromDegreesArrayHeights(e),width:2,vertexFormat:uf.PolylineMaterialAppearance.VERTEX_FORMAT}),t=new uf.GeometryInstance({geometry:r}),n=new uf.Primitive({geometryInstances:t,appearance:new uf.PolylineMaterialAppearance({material:uf.Material.fromType(\"Color\",{color:uf.Color.WHITE})}),asynchronous:!1});a.add(n)}}createPrimitive(e,a){if(this.canvas){let r=this.canvas.getContext(\"2d\");if(r){let t=new Uint8Array(r.getImageData(0,0,this.canvas.width,this.canvas.height).data.buffer),n=new uf.CustomShader({mode:uf.CustomShaderMode.MODIFY_MATERIAL,lightingModel:uf.LightingModel.UNLIT,uniforms:{myTexture:{type:uf.UniformType.SAMPLER_2D,value:{typedArray:t,width:this.canvas.width,height:this.canvas.height,sampler:{minificationFilter:uf.TextureMinificationFilter.LINEAR,magnificationFilter:uf.TextureMagnificationFilter.LINEAR,pixelFormat:uf.PixelFormat.RGBA,pixelDatatype:uf.PixelDatatype.UNSIGNED_BYTE}}}},translucencyMode:uf.CustomShaderTranslucencyMode.TRANSLUCENT,fragmentShaderText:\"void fragmentMain(FragmentInput fsInput, inout czm_modelMaterial material)\\n {\\n // material.diffuse = vec3(img);\\n vec2 uv = fsInput.attributes.texCoord_0;\\n \\n vec4 texColor = texture(myTexture, uv);\\n vec3 img = texture(myTexture, vec2(uv.x, uv.y)).rgb;\\n material.diffuse = vec3(img);\\n material.alpha = texColor.a;\\n // vec4 texColor = vec4(1.0,0.,0.,1.0);\\n if(material.diffuse.r>0.8&&material.diffuse.g>0.8&&material.diffuse.b>0.8){\\n float brightness = max(material.diffuse.r, max(material.diffuse.g, material.diffuse.b));\\n \\n // 白色部分（brightness >= 0.95）逐渐透明消失\\n material.alpha = clamp(1.0 - smoothstep(0.72, 0.98, brightness), 0.1, 0.8);\\n }\\n else {\\n material.alpha = 0.8; \\n }\\n \\n \\n vec3 positionToEyeEC = - fsInput.attributes.positionEC; // 从片段指向眼睛的向量\\n vec3 normalEC = normalize(fsInput.attributes.normalEC); // 归一化的法向量（眼睛坐标系）\\n \\n // faceforward使法向量始终朝向摄像机，防止背面法向异常\\n normalEC = faceforward(normalEC, vec3(0.0, 0.0, 1.0), -normalEC);\\n \\n // 计算视线和法向夹角的余弦值，决定泛光程度\\n float d = dot(normalEC, normalize(positionToEyeEC));\\n \\n // smoothstep使边缘平滑，增强泛光效果\\n float s = smoothstep(0.0, 1.0, abs(d));\\n \\n // 泛光颜色 (白色)\\n vec4 rimColor = vec4(1.0, 1.0, 1.0, 1.0);\\n // vec4 meshVertexColor =vec4(1.0, 0.0, 0.0, 1.0);\\n vec4 meshVertexColor =texColor;\\n \\n // 根据s值混合泛光颜色和顶点颜色（meshVertexColor）\\n vec4 blendedColor = mix(rimColor, meshVertexColor, pow(s, 0.5));\\n \\n // 输出到材质的漫反射颜色（最终颜色）\\n material.diffuse = vec3(blendedColor);\\n // material.alpha =0.6;\\n \\n \\n \\n \\n }\"});e.customShader=n,a.add(e)}}}showType(e){switch(e){case sy.Volume2D:this.showVolume3d=!1,this.showVolume2d=!0;break;case sy.Volume3D:this.showVolume3d=!0,this.showVolume2d=!1;break;case sy.VolumeAll:this.showVolume3d=!0,this.showVolume2d=!0;break;case sy.VolumeAllHidden:this.showVolume3d=!1,this.showVolume2d=!1}this.volume3d&&this.volume2d&&this.primitives._keys().forEach(a=>{this.updatePrimitive(a,{showType:e})})}toggleShow(e){switch(e){case sy.Volume2D:this.volume3d&&(this.volume3d.show=!1),this.volume2d&&(this.volume2d.show=!0);break;case sy.Volume3D:this.volume3d&&(this.volume3d.show=!0),this.volume2d&&(this.volume2d.show=!1);break;case sy.VolumeAll:this.volume3d&&(this.volume3d.show=!0),this.volume2d&&(this.volume2d.show=!0);break;case sy.VolumeAllHidden:this.volume3d&&(this.volume3d.show=!1),this.volume2d&&(this.volume2d.show=!1)}}update(e){Object.keys(e).forEach(a=>{let r=e[a];(0,pg.ri)(r)&&(this.properties[a]=r)}),this.render()}createLinePrimitive(e,a,r,t){if(this.isDestroyed||!e.length)return;let n=uf.BoundingSphere.fromVertices(Array.from(e));if(0===n.radius)return;let i=new Float64Array(e),o=new uf.Geometry({attributes:{position:new uf.GeometryAttribute({componentDatatype:uf.ComponentDatatype.DOUBLE,componentsPerAttribute:3,values:i})},primitiveType:uf.PrimitiveType.LINES,boundingSphere:n,vertexFormat:uf.VertexFormat.POSITION_AND_COLOR}),s=new uf.GeometryInstance({geometry:o,modelMatrix:r,attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(uf.Color.fromCssColorString(t).withAlpha(1))}}),l=new uf.Primitive({geometryInstances:s,appearance:new uf.PerInstanceColorAppearance({flat:!0,translucent:!1}),compressVertices:!0,asynchronous:!1,releaseGeometryInstances:!0,cull:!0});a.add(l)}creatingId;async createVolume(){let e;let a=(0,uW.k)();this.creatingId=a;let r=this.properties.url;if(r)try{let a=await this.loadCustomModel(r),t=a._loader._gltfJsonLoader._bufferLoaders[0]._typedArray,n=t.buffer,i=t.byteLength,o=t.byteOffset,s=a._loader._gltfJsonLoader.gltf.extensions.CESIUM_RTC.center,l=new uf.Cartesian3,d=uf.Cartesian3.fromArray(s,0,l),c=uf.Matrix4.fromTranslation(d,new uf.Matrix4),u=n.slice(o,o+i),p=a._loader.gltfJson.scenes[0].extras,m=p.pixelDataLength,h=p.pixelDataOffset,g=p.imageSize,f=p.lineData.colorsLength,_=p.lineData.colorsOffset,b=p.lineData.verticesLength,k=p.lineData.verticesOffset,v=p.maxAltitude,z=p.minAltitude,w=p.polygon,y=p.offsetUp,S=p.referLines,j=p.targetLines,D=new Float32Array(u,h,m/Float32Array.BYTES_PER_ELEMENT),I=new Float32Array(u,k,b/Float32Array.BYTES_PER_ELEMENT),A=new Float32Array(u,_,f/Float32Array.BYTES_PER_ELEMENT);D&&await this.preCreateTexture(D,v,z,g);let C=[];for(let e=0;e<w.length;e++){let a=w[e],r=a.Height+y;C.push([a.Longitude,a.Latitude,r])}let[x,M]=await Promise.all([this.createVolume3d({lineVerticesUp:I,lineVerticesDown:A,polygon:w,polygonUpper:C,transform:c,referLines:S,targetLines:j},a),this.createVolume2d(w)]);e={volume3dResult:x,volume2dResult:M}}catch(e){}return e}async"
}