{
  "metadata": {
    "source_file": "map-app\\static\\js\\index.5da8ba4c.js",
    "chunk_index": 14,
    "total_chunks": 918,
    "chunk_size": 49960,
    "word_count": 800,
    "model_kwargs": {
      "model": "text-embedding-3-large",
      "dimensions": 3072,
      "encoding_format": "float"
    },
    "text_splitter": {
      "split_by": "word",
      "chunk_size": 800,
      "chunk_overlap": 200
    },
    "created_at": "2025-12-17T23:57:50.148Z"
  },
  "content": "a=uf.Cartesian3.subtract(this.state.center,this.camera.position,new uf.Cartesian3),r=uf.Cartesian3.magnitude(a),t=uf.Cartesian3.normalize(a,new uf.Cartesian3),n=this.controller.minimumZoomDistance,i=this.controller.maximumZoomDistance,o=7*(r-n);o=uf.Math.clamp(o,20,5906376272e3);let s=e/this.viewer.canvas.clientHeight,l=o*(s=Math.min(s,.1));if(!(l>0&&1>Math.abs(r-n)||l<0&&1>Math.abs(r-i)))r-l<n?l=r-n-1:r-l>i&&(l=r-i),this.camera.move(t,l)}};this.setInputAction(({position1:e,position2:a})=>{this.initState(uf.Cartesian2.lerp(e,a,.5,new uf.Cartesian2))},uf.ScreenSpaceEventType.PINCH_START),this.setInputAction(()=>{this.clearState()},uf.ScreenSpaceEventType.PINCH_END),this.setInputAction(a=>{let r=a.distance.endPosition.y-a.distance.startPosition.y;this.firstMove(),e(r)},uf.ScreenSpaceEventType.PINCH_MOVE,\"all\")}onOrbitStart(e,a=!1){return!!uf.Matrix4.equals(this.camera.transform,uf.Matrix4.IDENTITY)&&(this.initState(e,a,!1,!a),!0)}onOrbitMove(e,a){return!!this.canOrbit()&&(this.firstMove(),this.pan3D(e,a),!0)}bindOrbit(){this.controller.enableRotate=!1;let e=0,a=0,r={startPosition:new uf.Cartesian2,endPosition:new uf.Cartesian2},t={start:0,end:0};this.setInputAction(a=>{!this.keyboardLooping&&(this.isOrbiting=this.onOrbitStart(a.position),this.isOrbiting&&(e=new Date().getTime(),t.start=e,t.end=e,this.state.center&&uf.Cartographic.fromCartesian(this.state.center).height>this.camera.positionCartographic.height&&(this.isOrbiting=!1,this.isTranslating=!0)))},uf.ScreenSpaceEventType.LEFT_DOWN),this.setInputAction(()=>{this.isOrbiting=!1,this.manager.hover.setCursor(\"\",\"temporary\"),a=new Date().getTime(),this.startInertiaLoop(.9,this.pan3D.bind(this),e,a,{startPosition:uf.Cartesian2.clone(r.startPosition),endPosition:uf.Cartesian2.clone(r.endPosition)},t,this.clearState.bind(this)),r.startPosition=new uf.Cartesian2,r.endPosition=new uf.Cartesian2},uf.ScreenSpaceEventType.LEFT_UP,\"all\"),this.setInputAction(e=>{if(!!this.isOrbiting)this.onOrbitMove(e.startPosition,e.endPosition)&&(t.start=t.end,t.end=new Date().getTime(),t.end-t.start>1500&&(t.start=t.end),uf.Cartesian2.clone(e.startPosition,r.startPosition),uf.Cartesian2.clone(e.endPosition,r.endPosition))},uf.ScreenSpaceEventType.MOUSE_MOVE,\"all\")}canOrbit(){if(!this.state.center)return!1;let e=this.enableOrbit,a=this.state.center&&this.state.startPosition&&this.state.transform,r=180*this.camera.pitch/Math.PI,t=this.camera.positionCartographic.height,n=15*t;n=n>9e3?n:9e3;let i=r<-10||t>1e4||uf.Cartesian3.distance(this.state.center,this.camera.position)<n;return e&&!!a&&i}enableTranslate=!0;isTranslating=!1;onTranslateStart(e,a=!1){return!!uf.Matrix4.equals(this.camera.transform,uf.Matrix4.IDENTITY)&&(this.firstMove(),this.initState(e,a,!1,!a),!0)}bindTranslate(){this.controller.enableLook=!1;let e=0,a=0,r={startPosition:new uf.Cartesian2,endPosition:new uf.Cartesian2},t={start:0,end:0};this.setInputAction(a=>{!this.keyboardLooping&&(this.isTranslating=this.onTranslateStart(a.position),this.isTranslating&&(e=new Date().getTime(),t.start=e,t.end=e))},uf.ScreenSpaceEventType.LEFT_DOWN,uf.KeyboardEventModifier.SHIFT),this.setInputAction(()=>{this.isTranslating&&(this.isTranslating=!1,a=new Date().getTime(),this.startInertiaLoop(.9,this.translate3D.bind(this),e,a,{startPosition:uf.Cartesian2.clone(r.startPosition),endPosition:uf.Cartesian2.clone(r.endPosition)},t,this.clearState.bind(this)),r.startPosition=new uf.Cartesian2,r.endPosition=new uf.Cartesian2)},uf.ScreenSpaceEventType.LEFT_UP,\"all\"),this.setInputAction(e=>{if(!this.keyboardLooping&&!!this.isTranslating&&!!this.enableTranslate)this.firstMove(),this.translate3D(e.startPosition,e.endPosition),t.start=t.end,t.end=new Date().getTime(),t.end-t.start>1500&&(t.start=t.end),uf.Cartesian2.clone(e.startPosition,r.startPosition),uf.Cartesian2.clone(e.endPosition,r.endPosition)},uf.ScreenSpaceEventType.MOUSE_MOVE,\"all\")}enableLook;isLooking=!1;bindLook(){let e=0,a=0,r={startPosition:new uf.Cartesian2,endPosition:new uf.Cartesian2},t={start:0,end:0};this.setInputAction(a=>{this.enableLook&&!this.keyboardLooping&&(this.inertiaState.enableMovement=\"\",this.isLooking=!0,e=new Date().getTime(),t.start=e,t.end=e)},uf.ScreenSpaceEventType.LEFT_DOWN,uf.KeyboardEventModifier.ALT),this.setInputAction(()=>{this.isLooking&&(this.isLooking=!1,a=new Date().getTime(),this.startInertiaLoop(.9,(e,a)=>this.look3D(e,a,!0),e,a,{startPosition:uf.Cartesian2.clone(r.startPosition),endPosition:uf.Cartesian2.clone(r.endPosition)},t,()=>void 0),r.startPosition=new uf.Cartesian2,r.endPosition=new uf.Cartesian2)},uf.ScreenSpaceEventType.LEFT_UP,\"all\"),this.setInputAction(e=>{this.enableLook&&this.isLooking&&(this.look3D(e.startPosition,e.endPosition,!0),t.start=t.end,t.end=new Date().getTime(),t.end-t.start>1500&&(t.start=t.end),uf.Cartesian2.clone(e.startPosition,r.startPosition),uf.Cartesian2.clone(e.endPosition,r.endPosition))},uf.ScreenSpaceEventType.MOUSE_MOVE,\"all\")}stopMouse(e){e?e===uf.KeyboardEventModifier.ALT&&(this.enableLook=!1):(this.enableOrbit=!1,this.enableTranslate=!1)}startMouse(){this.enableOrbit=!0,this.enableTranslate=!0,this.enableLook=!0}keyboardEnable=!1;keyboardMoving={};keyboardMoveStep=10;keyboardLooping=\"\";bindKeyboard(){this.keyboardEnable=!0,this.clearActionSideEffect.push(()=>{this.keyboardEnable=!1,this.keyboardLooping=\"\"})}handleKeyDown(e,a){this.keyboardEnable&&(e===su.up||e===su.down||e===su.left||e===su.right?(this.keyboardMoving[e]=!0,!this.keyboardLooping&&(a.shiftKey?this.keyboardLooping=\"translate\":a.ctrlKey?this.keyboardLooping=\"tilt\":a.altKey?this.keyboardLooping=\"look\":a.metaKey&&ff()?this.keyboardLooping=\"tilt\":this.keyboardLooping=\"orbit\",this.startKeyboardMoveLoop())):(e===su.minus||e===su.equal)&&(this.keyboardMoving[e]=!0,!this.keyboardLooping&&(this.keyboardLooping=\"zoom\",this.startKeyboardMoveLoop())))}handleKeyUp(e){if(this.keyboardEnable)switch(e){case su.up:case su.down:case su.left:case su.right:case su.minus:case su.equal:this.keyboardMoving[e]=!1}}startKeyboardMoveLoop(){let e;let a=r=>{let t=1;void 0!==e&&(t=(r-e)/33.33333),e=r,this.keyboardLooping&&(this.moveCamera(this.keyboardMoveStep*t),window.requestAnimationFrame(a))},r=new uf.Cartesian2(this.viewer.canvas.clientWidth/2,this.viewer.canvas.clientHeight/2);switch(this.keyboardLooping){case\"translate\":this.onTranslateStart(r,!0);break;case\"orbit\":this.onOrbitStart(r,!0);break;case\"tilt\":this.onTiltStart(r,!0);break;case\"zoom\":this.onZoomStart(r,!0)}window.requestAnimationFrame(a)}moveCamera(e){let a=new uf.Cartesian2(0,0),r=!1;if(\"zoom\"===this.keyboardLooping?(this.keyboardMoving[su.equal]&&(a.y+=e,r=!0),this.keyboardMoving[su.minus]&&(a.y+=-e,r=!0)):(this.keyboardMoving[su.up]&&(a.y+=e,r=!0),this.keyboardMoving[su.down]&&(a.y+=-e,r=!0),this.keyboardMoving[su.left]&&(a.x+=e,r=!0),this.keyboardMoving[su.right]&&(a.x+=-e,r=!0)),!r){this.keyboardLooping=\"\",this.clearState();return}let t=new uf.Cartesian2(this.viewer.canvas.clientWidth/2,this.viewer.canvas.clientHeight/2),n=uf.Cartesian2.add(t,a,new uf.Cartesian2);switch(this.keyboardLooping){case\"translate\":this.translate3D(t,n);break;case\"orbit\":this.onOrbitMove(t,n);break;case\"look\":this.look3D(t,n,!0);break;case\"tilt\":this.onTiltMove(t,n);break;case\"zoom\":this.onZoomMove(t,n)}}bindMobile(){let e,a,r;let t=\"\",n=(t,n,i)=>{if(void 0!==e&&void 0!==a&&void 0!==r){if(Math.abs(i-r)>12)return\"zoom\";if(Math.abs(n-a)>10)return\"tilt\";let o=uf.Math.toDegrees(t-e)%360;if(o>180&&(o-=360),o<-180&&(o+=360),(o=Math.abs(o))>10&&r>20&&i>30)return\"tilt\"}return\"\"},i=0;this.setInputAction(()=>{i&&window.clearTimeout(i),this.controller.enableTilt=!1},uf.ScreenSpaceEventType.PINCH_START),this.setInputAction(i=>{void 0===e&&(e=i.angleAndHeight.startPosition.x),void 0===a&&(a=i.angleAndHeight.startPosition.y),void 0===r&&(r=i.distance.startPosition.y),!t&&\"tilt\"===(t=n(i.angleAndHeight.endPosition.x,i.angleAndHeight.endPosition.y,i.distance.endPosition.y))&&(this.controller.enableTilt=!0)},uf.ScreenSpaceEventType.PINCH_MOVE,\"all\"),this.setInputAction(()=>{e=void 0,a=void 0,r=void 0,t=\"\",i=window.setTimeout(()=>{this.controller.enableTilt=!0},300)},uf.ScreenSpaceEventType.PINCH_END)}isFirstViewMoving=!1;bindFirstView(){this.controller.enableRotate=!1,this.controller.enableTilt=!1,this.controller.enableZoom=!1,this.controller.enableLook=!1,this.controller.enableTranslate=!1;let e=e=>{this.isFirstViewMoving&&this.look3D(e.startPosition,e.endPosition)};this.setInputAction(e=>{this.isFirstViewMoving=!0},uf.ScreenSpaceEventType.LEFT_DOWN),this.setInputAction(()=>{this.isFirstViewMoving=!1},uf.ScreenSpaceEventType.LEFT_UP),this.setInputAction(e,uf.ScreenSpaceEventType.MOUSE_MOVE),this.addDocumentAction(\"mousemove\",a=>{if(this.ignoreFpsFirstMove){this.ignoreFpsFirstMove=!1;return}if(this.isFps){let r=new uf.Cartesian2(this.viewer.canvas.clientWidth/2,this.viewer.canvas.clientHeight/2),t=new uf.Cartesian2(r.x+a.movementX/2,r.y+a.movementY/2);this.isFirstViewMoving=!0,e({startPosition:r,endPosition:t}),this.isFirstViewMoving=!1}},!1),this.addDocumentAction(\"pointerlockchange\",()=>{document.pointerLockElement!==this.manager.viewer.canvas&&\"first-view\"===this.mode&&this.isFps&&(this.isFps=!1,this.ignoreFpsFirstMove=!1)}),this.clearActionSideEffect.push(()=>{document.pointerLockElement===this.manager.viewer.canvas&&(document.exitPointerLock(),this.isFps=!1,this.ignoreFpsFirstMove=!0)}),this.setInputAction(e=>{this.manager.emit(\"zoomDelta\",e/this.viewer.canvas.clientHeight)},uf.ScreenSpaceEventType.WHEEL,\"all\")}_isFps=!1;get isFps(){return this._isFps}set isFps(e){this._isFps!==e&&(this._isFps=e,this.manager.emit(\"fpsChange\",e))}ignoreFpsFirstMove=!1;toggleFpsMode(e=!this.isFps){let a=this.manager.viewer.canvas;\"first-view\"===this.mode&&this.isFps!==e&&a&&(e?(a.requestPointerLock(),this.isFps=!0):(document.exitPointerLock(),this.isFps=!1,this.ignoreFpsFirstMove=!0))}bindInteractive(e=!0){!e&&this.refreshHandler(),\"first-view\"===this._mode?this.bindFirstView():pS()?(this.controller._zoomFactor=10,this.bindMobile()):(this.bindTilt(),this.bindZoom(),this.bindOrbit(),this.bindTranslate(),this.bindLook(),this.bindKeyboard()),this.applyInputActions()}inputActionMap={};setInputAction(e,a,r=\"no\"){let t=this.inputActionMap[a];!t&&(t=this.inputActionMap[a]={});let n=t[r];!n&&(n=t[r]=[]),n.push(e)}applyInputActions(){Object.keys(this.inputActionMap).forEach(e=>{let a=this.inputActionMap[e];a&&f_.forEach(r=>{let t=this.getActions(a,r);t&&this.handler.setInputAction((...e)=>{t.forEach(a=>a(...e))},e,\"no\"===r?void 0:r)})})}getActions(e,a=\"no\"){let r=e[a]||[];if(e.all&&(r=r.concat(e.all)),r.length>0)return r}clearActionSideEffect=[];removeDocumentActions=[];addDocumentAction(e,a,r){window.document.addEventListener(e,a,r);let t=()=>{window.document.removeEventListener(e,a,r)};return this.removeDocumentActions.push(t),t}clearActions(){this.inputActionMap={},this.handler.destroy(),this.removeDocumentActions.forEach(e=>e()),this.removeDocumentActions=[],this.clearActionSideEffect.forEach(e=>e()),this.clearActionSideEffect=[]}destroy(){this.clearActions()}}class fk{constructor(e){this.manager=e}mode=\"\";manager;verticalStatus={start:uf.Cartesian3.ZERO,plane:uf.Plane.ORIGIN_XY_PLANE};cleanVertical(){this.verticalStatus.start=uf.Cartesian3.ZERO,this.verticalStatus.plane=uf.Plane.ORIGIN_XY_PLANE}horizontalStatus={clampToGround:!1,ellipsoid:uf.Ellipsoid.WGS84};cleanHorizontal(){this.horizontalStatus.clampToGround=!1,this.horizontalStatus.ellipsoid=uf.Ellipsoid.WGS84}dragStartStatus={moved:!1};cleanDragStart(){this.dragStartStatus={moved:!1}}draggingPosition=uf.Cartesian3.ZERO;draggingElement=null;leftDown(e,a){let r=p5(this.manager.viewer,e.position);if(0===r.length)return!1;let t=this.manager.getElements(r);if(0===t.length)return!1;let[n,i]=t[0];if(i){let r=i.canDrag?.(a,n);if(r)return this.mode=r,this.draggingElement=i,this.dragStartStatus.mouse=e,this.dragStartStatus.moved=!1,this.dragStartStatus.primitive=n,this.manager.screenSpaceCameraController.stopMouse(a),!0}return!1}firstMove(){let e=this.manager.viewer;if(this.dragStartStatus.moved=!0,this.draggingElement&&this.dragStartStatus.mouse&&this.mode){let a=this.draggingElement.startDrag?.(this.dragStartStatus.mouse,this.mode,this.dragStartStatus.primitive);if(\"boolean\"!=typeof a&&a.position){let r=a.position;if(\"vertical\"===this.mode)this.verticalStatus.start=r,this.verticalStatus.plane=me(r,e);else if(\"horizontal\"===this.mode){if(!a.clampToGround){let e=uf.Cartographic.fromCartesian(r);this.horizontalStatus.ellipsoid=p8(e.height)}this.horizontalStatus.clampToGround=!!a.clampToGround}this.draggingPosition=r,this.draggingElement.dynamicDrag?.(()=>this.draggingPosition)}}}mouseMove(e){if(this.mode){let a;if(!this.dragStartStatus.moved){if(this.dragStartStatus.mouse?.position){let{x:a,y:r}=this.dragStartStatus.mouse.position,{x:t,y:n}=e.endPosition;if(1>Math.abs(a-t)&&1>Math.abs(r-n))return}this.firstMove()}if(this.draggingElement&&\"transformer\"===this.mode)return this.draggingElement.onDrag(e,new uf.Cartesian3),this.manager.editor.activeShapePoints.value=[],!0;let r=this.manager.viewer.scene.camera.getPickRay(e.endPosition);if(!!r){if(\"vertical\"===this.mode){let e=uf.IntersectionTests.rayPlane(r,this.verticalStatus.plane);if(e){let{height:r}=uf.Cartographic.fromCartesian(e),{longitude:t,latitude:n}=uf.Cartographic.fromCartesian(this.verticalStatus.start);a=uf.Cartesian3.fromRadians(t,n,r)}}else if(\"horizontal\"===this.mode){let{clampToGround:t,ellipsoid:n}=this.horizontalStatus;if(t)a=this.manager.picker.pickPosition(e.endPosition);else{let e=uf.IntersectionTests.rayEllipsoid(r,n);e&&(a=uf.Ray.getPoint(r,e.start))}}return a&&(this.draggingPosition=a,this.draggingElement?.onDrag(e,a),this.manager.render()),!0}}}leftUp(e){if(this.mode){let e=this.dragStartStatus.moved;return this.cleanDragStart(),\"vertical\"===this.mode?this.cleanVertical():\"horizontal\"===this.mode?this.cleanHorizontal():\"transformer\"===this.mode&&this.draggingElement?.endDrag(),this.manager.screenSpaceCameraController.startMouse(),e&&this.draggingElement?.endDrag?.(),this.draggingElement=null,this.draggingPosition=uf.Cartesian3.ZERO,this.mode=\"\",!0}return!1}}class fv{constructor(e){this.manager=e}manager;isPrismHovering=(0,uh.iH)(!1);isCylinderHovering=(0,uh.iH)(!1);_cursor={origin:{modifiers:{ctrl:`rotate:${uP(\"web.map.mouse_tips_rotate_map\")}`,meta:`rotate:${uP(\"web.map.mouse_tips_rotate_map\")}`,shift:`move:${uP(\"web.map.mouse_tips_translate_map\")}`,alt:`look:${uP(\"web.map.mouse_tips_look_map\")}`}},default:\"\",hover:\"\",temporary:\"\"};getCursorWithModifier(e=\"default\"){let a=this._cursor[e],r=\"\";return\"string\"==typeof a?r=a:(a.normal&&(r=a.normal),(0,pg.ri)(this.modifier)&&(r=a.modifiers?.[this.modifier]??r)),r}get cursor(){return this.getCursorWithModifier(\"temporary\")||this.getCursorWithModifier(\"hover\")||this.getCursorWithModifier(\"default\")||this.getCursorWithModifier(\"origin\")}setCursor(e,a=\"default\"){this._cursor[a]=e,this.manager.emit(\"cursorChange\")}mousePosition;get currentMousePosition(){return this.mousePosition}_modifier;disabled=!1;get modifier(){return this._modifier}set modifier(e){this._modifier!==e&&(this._modifier=e,this.manager.emit(\"cursorChange\"))}_hoverElementTuples=[];get hoverElements(){return this._hoverElementTuples.map(([,e])=>e)}clearHoverElements(){this._hoverElementTuples.forEach(e=>this.changeHovering(e,!1)),this._hoverElementTuples.length=0,this.hoveringElementMapping=void 0}pick=(0,lL.throttle)(()=>{if(this.manager.viewer.isDestroyed()||this.manager.screenSpaceCameraController.onMotion||!this.mousePosition)return;let e=p5(this.manager.viewer,this.mousePosition),a=this.manager.getElements(e),r=this.manager.operationActive.value;this.manager.operationActive.value&&(a=a.filter(([,e])=>!(e instanceof hW||e instanceof h8||e instanceof mX||e instanceof hY||e instanceof gr||e instanceof pZ)),![\"prism\",\"cylinder\"].includes(r)&&(a=a.filter(([,e])=>!(e instanceof gs||e instanceof hp)))),this.manager.mode.draw&&(a=a.filter(([,e])=>!(e instanceof hW||e instanceof h8))),this._hoverElementTuples=a},100);handle(){if(this.disabled)return;let e=this._hoverElementTuples[0],a=e?e[0].id:void 0;this.mousePosition&&this.manager.emit(\"hover\",this.hoverElements,{mousePosition:{position:this.mousePosition},partId:a}),this.hoveringElementMapping=e}mouseMove(e,a,r){this.mousePosition=e.endPosition,this.modifier=(0,pg.ri)(r)?pE[r]:r,this.disabled=a,!pS()&&(!this.disabled&&this.pick(),this.handle())}getCesiumPickResultId(e){return e.id instanceof uf.Entity?e.id.id:e.id}isSameElement(e){let a=this._hoveringElementMapping;if(e&&a){let r=this.getCesiumPickResultId(e[0]),t=this.getCesiumPickResultId(a[0]);return e[1]===a[1]&&r&&t&&r===t}return!1}_hoveringElementMapping;get hoveringElementMapping(){return this._hoveringElementMapping}set hoveringElementMapping(e){if(this.isSameElement(e))return;if(this.setCursor(e?\"pointer\":\"\",\"hover\"),!this.manager.contextmenu.state.show||!this.hoveringElement)this.changeHovering(this._hoveringElementMapping,!1),this.changeHovering(e,!0),this._hoveringElementMapping=e,this.manager.render()}get hoveringElement(){return this._hoveringElementMapping?.[1]}changeHovering(e,a){if(!e)return;let[r,t]=e;if(t instanceof hG||t instanceof h8||t instanceof hW||t instanceof mX||t instanceof hY||t instanceof gs||t instanceof hp||t instanceof gr||t instanceof g_){if(this.manager.screenSpaceCameraController.onMotion)return;t.active(\"hover\",a)}if(\"string\"==typeof r.id&&t instanceof pZ){if(this.manager.screenSpaceCameraController.onMotion)return;t.hover(r.id,a)}a?t.onMouseEnter?.(r):t.onMouseLeave?.(r)}}class fz{constructor(e){this.manager=e}manager;state=(0,uh.qj)({show:!1,left:0,top:0});commonGroups=[];groups=(0,uh.iH)([]);element=null;mouse={position:uf.Cartesian2.ZERO};setCommonGroup(e,a){let r=this.commonGroups,t=!1,n=r.reduce((r,n)=>(n.key===e?(t=!0,a&&r.push(a)):r.push(n),r),[]);!t&&a&&n.push(a),this.commonGroups=n}open(e,a){let r;let t=this.manager.getElements(e).map(([,e])=>e);this.element=t[0]||null,this.mouse=a;let n=this.element;e.forEach(({id:e,primitive:a})=>{n instanceof pZ&&(a instanceof uf.Primitive||a instanceof uf.GroundPrimitive)&&n.hasPrimitive(a),r=e});let i=this.commonGroups.slice();if(n){let e=this.element;!(this.manager.operationActive.value&&(e instanceof hW||e instanceof h8||e instanceof mX))&&e?.getContextmenu&&\"function\"==typeof e.getContextmenu&&(i=e.getContextmenu(i))}this.manager.emit(\"rightClick\",t,a,i,r),this.groups.value=i,this.groups.value.length>0&&(this.state.left=a.position.x,this.state.top=a.position.y,window.setTimeout(()=>{this.state.show=!0}))}onItemClick(e,a){this.manager.emit(\"contextmenuClick\",a,e,this.element,this.mouse)}}async function fw(e,a,r,t,n,i,o){var s,l,d;let c=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);return e.flush(),await (s=e,l=c,d=0,new Promise((e,a)=>{!function r(){let t=s.clientWaitSync(l,0,0);if(t===s.WAIT_FAILED){a(Error(\"gl-error\"));return}if(t===s.TIMEOUT_EXPIRED){setTimeout(r,10);return}e()}()})),e.deleteSync(c),e.bindBuffer(a,r),e.getBufferSubData(a,t,n,i,o),e.bindBuffer(a,null),n}async function fy(e,a,r,t,n,i,o,s){let l=e.createBuffer();return e.bindBuffer(e.PIXEL_PACK_BUFFER,l),e.bufferData(e.PIXEL_PACK_BUFFER,s.byteLength,e.STREAM_READ),e.readPixels(a,r,t,n,i,o,0),e.bindBuffer(e.PIXEL_PACK_BUFFER,null),await fw(e,e.PIXEL_PACK_BUFFER,l,0,s),e.deleteBuffer(l),s}async function fS(e,a){let r=e._gl;a=(0,uf.defaultValue)(a,{});let t=Math.max((0,uf.defaultValue)(a.x,0),0),n=Math.max((0,uf.defaultValue)(a.y,0),0),o=(0,uf.defaultValue)(a.width,r.drawingBufferWidth),s=(0,uf.defaultValue)(a.height,r.drawingBufferHeight),l=a.framebuffer,d=uf.PixelDatatype.UNSIGNED_BYTE;(0,uf.defined)(l)&&l.numberOfColorAttachments>0&&(d=l.getColorTexture(0).pixelDatatype);let c=uf.PixelFormat.createTypedArray(uf.PixelFormat.RGBA,d,o,s);(function(e,a){if(a!==e._currentFramebuffer){e._currentFramebuffer=a;let r=i;if((0,uf.defined)(a))a._bind(),!function(e){if(e.validateFramebuffer){let a=e._gl,r=a.checkFramebufferStatus(a.FRAMEBUFFER);if(r!==a.FRAMEBUFFER_COMPLETE){let e;switch(r){case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:e=\"Framebuffer is not complete. Incomplete attachment: at least one attachment point with a renderbuffer or texture attached has its attached object no longer in existence or has an attached image with a width or height of zero, or the color attachment point has a non-color-renderable image attached, or the depth attachment point has a non-depth-renderable image attached, or the stencil attachment point has a non-stencil-renderable image attached. Color-renderable formats include GL_RGBA4, GL_RGB5_A1, and GL_RGB565. GL_DEPTH_COMPONENT16 is the only depth-renderable format. GL_STENCIL_INDEX8 is the only stencil-renderable format.\";break;case a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:e=\"Framebuffer is not complete. Incomplete dimensions: not all attached images have the same width and height.\";break;case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:e=\"Framebuffer is not complete. Missing attachment: no images are attached to the framebuffer.\";break;case a.FRAMEBUFFER_UNSUPPORTED:e=\"Framebuffer is not complete. Unsupported: the combination of internal formats of the attached images violates an implementation-dependent set of restrictions.\"}throw new uf.DeveloperError(e)}}}(e),r=a._getActiveColorAttachments();else{let a=e._gl;a.bindFramebuffer(a.FRAMEBUFFER,null)}e.drawBuffers&&e.glDrawBuffers(r)}})(e,l);let u=uf.PixelDatatype.toWebGLConstant(d,e);return e.webgl2?await fy(r,t,n,o,s,uf.PixelFormat.RGBA,u,c):r.readPixels(t,n,o,s,uf.PixelFormat.RGBA,u,c),c}\"undefined\"!=typeof WebGLRenderingContext&&(i=[uf.WebGLConstants.BACK]);let fj=new uf.Color;async function fD(e,a){let r=(0,uf.defaultValue)(a.width,1),t=(0,uf.defaultValue)(a.height,1),n=e._context,i=await fS(n,{x:a.x,y:a.y,width:r,height:t,framebuffer:e._fb.framebuffer}),o=Math.max(r,t),s=o*o,l=Math.floor(.5*r),d=Math.floor(.5*t),c=0,u=0,p=0,m=-1;for(let e=0;e<s;++e){if(-l<=c&&c<=l&&-d<=u&&u<=d){let e=4*((d-u)*r+c+l);fj.red=uf.Color.byteToFloat(i[e]),fj.green=uf.Color.byteToFloat(i[e+1]),fj.blue=uf.Color.byteToFloat(i[e+2]),fj.alpha=uf.Color.byteToFloat(i[e+3]);let a=n.getObjectByPickColor(fj);if((0,uf.defined)(a))return a}if(c===u||c<0&&-c===u||c>0&&c===1-u){let e=p;p=-m,m=e}c+=p,u+=m}}let fI=new uf.Cartesian4,fA=new uf.Cartesian4(1,1/255,1/65025,1/16581375);async function fC(e,a,r,t){if(!(0,uf.defined)(e.framebuffer))return;let n=await fS(a,{x:r,y:t,width:1,height:1,framebuffer:e.framebuffer}),i=uf.Cartesian4.unpack(n,0,fI);return uf.Cartesian4.divideByScalar(i,255,i),uf.Cartesian4.dot(i,fA)}let fx=new uf.Cesium3DTilePassState({pass:uf.Cesium3DTilePass.MOST_DETAILED_PICK}),fM=new uf.Cesium3DTilePassState({pass:uf.Cesium3DTilePass.PICK}),fE=new uf.Color(0,0,0,0);class fP{constructor(e){this.manager=e,this.clampWatcherManager=new fR(this)}manager;pickPositionMode=\"single\";pickPosition(e){let a,r;let t=this.manager.viewer.scene,n=this.pickPositionMode,i=!1;if(e instanceof uf.Cartesian2?a=e:(a=e.windowPosition,(0,pg.ri)(e.pickMode)&&(n=e.pickMode),(0,pg.ri)(e.strictlyVerifyTerrain)&&(i=e.strictlyVerifyTerrain)),\"only-nearest\"===n||\"nearest\"===n){let e=t.pickPositionNearest(a);if(e)return e;if(\"only-nearest\"===n)return}let o=t.camera.getPickRay(a);if(!!o)return this.manager.elements.getTilesets().length>0&&(r=this.pickForTileset(o,.1,!1)),!r&&(r=this.manager.viewer.scene.globe.pick(o,t,new uf.Cartesian3)),!r&&!i&&(r=this.manager.viewer.camera.pickEllipsoid(a)),r}pickPositionByRay(e,a){let r;let t=this.manager.viewer.scene;if(!!e){if(this.manager.elements.getTilesets().length>0&&(r=this.pickForTileset(e,.1,!1)),!r&&(r=this.manager.viewer.scene.globe.pick(e,t,new uf.Cartesian3)),!r){let t=uf.IntersectionTests.rayEllipsoid(e,uf.Ellipsoid.WGS84);t&&t.start<a&&(r=uf.Ray.getPoint(e,t.start))}return r}}async pickPositionAsync(e,a=!1){let r;let t=this.manager.viewer.scene;if(\"only-nearest\"===this.pickPositionMode||\"nearest\"===this.pickPositionMode){let a=t.pickPositionNearest(e);if(a)return a;if(\"only-nearest\"===this.pickPositionMode)return}let n=t.camera.getPickRay(e);if(!n)return;if(this.manager.elements.getTilesets().length>0&&(r=await this.pickForTilesetAsync(n,.1)),!this.manager.viewer.isDestroyed())return!r&&(r=this.manager.viewer.scene.globe.pick(n,t,new uf.Cartesian3)),!r&&!a&&(r=this.manager.viewer.camera.pickEllipsoid(e)),r}sampleHeight(e){let a;if(this.manager.elements.getTilesets().length>0){let r=mn(e);a=this.pickForTileset(r,.1,!1)}if(this.manager.useModelPostStage){if(a)return uf.Cartographic.fromCartesian(a).height}else if(a){let r=uf.Cartographic.fromCartesian(a).height,t=this.manager.viewer.scene.globe.getHeight(e);return t?r>t?r:t:r}return this.manager.viewer.scene.globe.getHeight(e)}async sampleHeightAsync(e){let a;if(this.manager.elements.getTilesets().length>0){let r=mn(e);a=await this.pickForTilesetAsync(r,.1)}if(!this.manager.viewer.isDestroyed()){if(this.manager.useModelPostStage){if(a)return uf.Cartographic.fromCartesian(a).height}else if(a){let r=uf.Cartographic.fromCartesian(a).height,t=this.manager.viewer.scene.globe.getHeight(e);return t?r>t?r:t:r}return this.manager.viewer.scene.globe.getHeight(e)}}sampleHeightsMostDetailed(e){let a=this.manager.elements.getTilesets();return Promise.all(e.map(e=>this.sampleHeightMostDetailedForTilesets(e,a)))}clamp(e){let a=uf.Cartographic.fromCartesian(e),r=this.sampleHeight(a)||0;return uf.Cartesian3.fromRadians(a.longitude,a.latitude,r)}clampWatcherManager;clampWithWatcher(e,a){return this.clampWatcherManager.addWatcher(e,a)}sampleHeightMostDetailedForTilesets(e,a){let r=mn(e);return this.launchMostDetailedRayPick(r,a,()=>{let e=this.pickForTileset(r,.1,!0);if((0,pg.ri)(e))return uf.Cartographic.fromCartesian(e).height})}launchMostDetailedRayPick(e,a,r){let t=this.manager.viewer.scene._picking;if(0===a.length)return Promise.resolve(void 0);let n=new fT(e,.1,a.map(e=>e.mainPrimitive).filter(e=>!!e));return t._mostDetailedRayPicks.push(n),n.promise.then(()=>r())}pickForTileset(e,a,r){return this.pickFirstTileset(()=>this.getRayIntersection(e,a,r))?.position}async pickForTilesetAsync(e,a){return(await this.pickFirstTilesetAsync(e,a))?.position}pickFirstTileset(e){let a,r,t;let n=this.manager.useModelPostStage;n&&(r=(a=this.manager.viewer.scene.globe).show,a.show=!1);let i=[],o=[],s=[];try{let a=e();for(;(0,pg.ri)(a);){let r=a.object,l=a.position;if((0,pg.ri)(l)&&!(0,pg.ri)(r)){!n&&(t=a);break}if(!(0,pg.ri)(r)||!(0,pg.ri)(r.primitive))break;if((0,pg.ri)(r)&&(0,pg.ri)(r.primitive)&&r.primitive instanceof uf.Cesium3DTileset){t=a;break}let d=r.primitive,c=!1;if(\"function\"==typeof d.getGeometryInstanceAttributes&&(0,pg.ri)(r.id)){let e=d.getGeometryInstanceAttributes(r.id);(0,pg.ri)(e)&&(0,pg.ri)(e.show)&&(c=!0,e.show=uf.ShowGeometryInstanceAttribute.toValue(!1,e.show),o.push(e))}r instanceof uf.Cesium3DTileFeature&&(c=!0,r.show=!1,s.push(r)),!c&&(d.show=!1,i.push(d)),a=e()}}catch(e){console.error(e)}return i.forEach(e=>{e.show=!0}),o.forEach(e=>{e.show=uf.ShowGeometryInstanceAttribute.toValue(!0,e.show)}),s.forEach(e=>{e.show=!0}),n&&a&&r&&(a.show=r),t}async pickFirstTilesetAsync(e,a){let r;let t=this.manager.useModelPostStage,n=[],i=[],o=[];for(let e=0;e<this.manager.viewer?.scene.primitives.length;e++){let a=this.manager.viewer.scene.primitives.get(e);!(a instanceof uf.Cesium3DTileset)&&a.show&&n.push(a)}for(let e=0;e<this.manager.viewer.scene.groundPrimitives.length;e++){let a=this.manager.viewer.scene.groundPrimitives.get(e);!(a instanceof uf.Cesium3DTileset)&&a.show&&n.push(a)}let s=()=>{n.forEach(e=>{e.show=!0}),i.forEach(e=>{e.show=uf.ShowGeometryInstanceAttribute.toValue(!0,e.show)}),o.forEach(e=>{e.show=!0})};n.forEach(e=>{e.show=!1});let l=await this.getRayIntersectionAsync(e,a,t,s);for(;(0,pg.ri)(l);){let d=l.object,c=l.position;if((0,pg.ri)(c)&&!(0,pg.ri)(d)){!t&&(r=l);break}if(!(0,pg.ri)(d)||!(0,pg.ri)(d.primitive))break;if((0,pg.ri)(d)&&(0,pg.ri)(d.primitive)&&d.primitive instanceof uf.Cesium3DTileset){r=l;break}let u=d.primitive,p=!1;if(\"function\"==typeof u.getGeometryInstanceAttributes&&(0,pg.ri)(d.id))try{let e=u.getGeometryInstanceAttributes(d.id);(0,pg.ri)(e)&&(0,pg.ri)(e.show)&&(p=!0,i.push(e))}catch(e){}d instanceof uf.Cesium3DTileFeature&&(p=!0,o.push(d)),!p&&n.push(u),n.forEach(e=>{e.show=!1}),i.forEach(e=>{e.show=uf.ShowGeometryInstanceAttribute.toValue(!1,e.show)}),o.forEach(e=>{e.show=!1}),l=await this.getRayIntersectionAsync(e,a,t,s)}return r}getRayIntersection(e,a,r){let t=this.manager.viewer.scene,n=t._picking,i=t.context,o=i.uniformState,s=t.frameState;try{let l;let d=n._pickOffscreenView;t.view=d,this.updateOffscreenCameraFromRay(e,a,d.camera);let c=new uf.BoundingRectangle;c=uf.BoundingRectangle.clone(d.viewport,c);let u=d.pickFramebuffer.begin(c,d.viewport);t.jobScheduler.disableThisFrame(),t.updateFrameState(),s.invertClassification=!1,s.passes.pick=!0,s.passes.uranusDepth=!0,s.passes.offscreen=!0,r?s.tilesetPassState=fx:s.tilesetPassState=fM,o.update(s),t.updateEnvironment(),t.updateAndExecuteCommands(u,fE),t.resolveFramebuffers(u);let p=d.pickFramebuffer.end(c);if(i.depthTexture){let a=d.frustumCommandsList.length;for(let r=0;r<a;++r){let a=n.getPickDepth(t,r).getDepth(i,0,0);if(!!(0,pg.ri)(a)){if(a>0&&a<1){let n=d.frustumCommandsList[r],i=n.near*(0!==r?t.opaqueFrustumNearOffset:1),o=n.far,s=i+a*(o-i);l=uf.Ray.getPoint(e,s);break}}}}if((0,pg.ri)(p)||(0,pg.ri)(l))return{object:p,position:l}}finally{t.view=t.defaultView,i.endFrame()}}async getRayIntersectionAsync(e,a,r,t){let n,i,o,s;if(r&&(i=(n=this.manager.viewer.scene.globe).show,n.show=!1),this.manager.viewer.isDestroyed())return;let l=this.manager.viewer.scene,d=l._picking,c=l.context,u=c.uniformState,p=l.frameState,m=d._pickOffscreenView;l.view=m,this.updateOffscreenCameraFromRay(e,a,m.camera);let h=new uf.BoundingRectangle;h=uf.BoundingRectangle.clone(m.viewport,h);let g=m.pickFramebuffer.begin(h,m.viewport);l.jobScheduler.disableThisFrame(),l.updateFrameState(),p.invertClassification=!1,p.passes.pick=!0,p.passes.uranusDepth=!0,p.passes.offscreen=!0,p.tilesetPassState=fM,u.update(p),l.updateEnvironment(),l.updateAndExecuteCommands(g,fE),l.resolveFramebuffers(g);let f=fD(m.pickFramebuffer,h),_=[];if(c.depthTexture){let e=m.frustumCommandsList.length;for(let a=0;a<e;++a){let e=d.getPickDepth(l,a),r=m.frustumCommandsList[a],t=r.near*(0!==a?l.opaqueFrustumNearOffset:1),n=r.far;_.push(fC(e,c,0,0).then(e=>{if((0,pg.ri)(e)&&e>0&&e<1)return t+e*(n-t)}))}}l.view=l.defaultView,c.endFrame(),r&&n&&i&&(n.show=i),t?.();let[b,...k]=await Promise.allSettled([f,..._]);\"fulfilled\"===b.status&&(s=b.value);for(let a=0;a<k.length;++a){let r=k[a];if(\"fulfilled\"===r.status&&(0,pg.ri)(r.value)){let a=r.value;o=uf.Ray.getPoint(e,a);break}}if((0,pg.ri)(s)||(0,pg.ri)(o))return{object:s,position:o}}updateOffscreenCameraFromRay(e,a,r){let t=e.direction,n=uf.Cartesian3.mostOrthogonalAxis(t,new uf.Cartesian3),i=uf.Cartesian3.cross(t,n,new uf.Cartesian3),o=uf.Cartesian3.cross(t,i,new uf.Cartesian3);return r.position=e.origin,r.direction=t,r.up=o,r.right=i,r.frustum.width=(0,pg.LS)(a,.1),r.frustum.computeCullingVolume(r.positionWC,r.directionWC,r.upWC)}destroy(){this.clampWatcherManager.destroy()}}class fT{constructor(e,a,r){this.ray=e,this.width=a,this.tilesets=r,this.ready=!1,this.promise=new Promise(e=>{this._completePick=()=>{e()}})}ray;width;tilesets;ready;promise;_completePick=()=>{}}class fR{constructor(e){this.picker=e,this.toggleEventListener()}picker;get tilesets(){return this.picker.manager.elements.getTilesets().filter(e=>e.show)}watchers=[];removeEventListener;toggleEventListener(){let e=this.picker.manager,a=e=>{this.watchers.forEach(a=>{e.isPositionIncluded(a.position)&&(a.relativeTilesets.push(e),this.bindTilesetHeightUpdate(a,e))})},r=e=>{this.watchers.forEach(a=>{let r=a.relativeTilesets.indexOf(e);r>-1&&(a.relativeTilesets.splice(r,1),a.removeHeightUpdate[e.id]?.(),a.onHeightUpdate(e.id,void 0))})};function t(e,t){\"add\"===t&&e.show&&a(e),\"delete\"===t&&r(e)}function n(e){e.show?a(e):r(e)}e.elements.addListener(\"tilesetUpdate\",t),e.addListener(\"tilesetShowChanged\",n);let i=e.viewer.scene.globe.terrainProviderChanged.addEventListener(()=>{this.watchers.forEach(e=>{this.bindTerrainUpdateHeight(e)})});this.removeEventListener=()=>{e.elements.removeListener(\"tilesetUpdate\",t),e.removeListener(\"tilesetShowChanged\",n),i()}}addWatcher(e,a){let r={position:uf.Cartographic.clone(e),onHeightUpdate:(e,t)=>{(0,pg.ri)(t)&&t>=-2e3?r.heights[e]=t:r.heights[e]=void 0;let n=r.heights.globe,i=Object.keys(r.heights).reduce((e,a)=>{if(\"globe\"!==a){let t=r.heights[a];if((0,pg.ri)(t)&&(!(0,pg.ri)(e)||t>e))return t}return e},void 0);(0,pg.ri)(i)&&(n=i),(0,pg.ri)(n)&&a(uf.Cartesian3.fromRadians(r.position.longitude,r.position.latitude,n))},update:e=>{r.position=uf.Cartographic.clone(e),this.updateWatcher(r)},unclamp:()=>{this.removeWatcher(r)},relativeTilesets:[],heights:{},removeHeightUpdate:{}};return this.watchers.push(r),this.updateWatcher(r),r}getRelativeTilesets(e){return this.tilesets.filter(a=>a.isPositionIncluded(e))}updateWatcher(e){this.bindTerrainUpdateHeight(e),e.relativeTilesets.forEach(a=>e.removeHeightUpdate[a.id]?.()),e.relativeTilesets=this.getRelativeTilesets(e.position),e.relativeTilesets.forEach(a=>this.bindTilesetHeightUpdate(e,a))}bindTerrainUpdateHeight(e){let a=this.picker.manager.viewer?.scene.globe,r=\"globe\";e.removeHeightUpdate[r]?.(),this.bindUpdateHeight(e,r,()=>a._surface.updateHeight(e.position,a=>{a&&e.onHeightUpdate(r,uf.Cartographic.fromCartesian(a).height)}),()=>{if(!this.picker.manager.viewer.isDestroyed())return a.getHeight(e.position)})}bindTilesetHeightUpdate(e,a){let r=a.id;this.bindUpdateHeight(e,r,()=>a.updateHeight(e.position,a=>{e.onHeightUpdate(r,a)}))}toGetHeights=[];executing=!1;executeGetHeights(){if(this.executing)return;let e=this.toGetHeights.splice(0,100);e.length>0&&e.forEach(e=>{e()}),this.toGetHeights.length>0&&(this.executing=!0,window.setTimeout(()=>{this.executing=!1,this.executeGetHeights()},500))}batchGetHeight(e){this.toGetHeights.push(e),!this.executing&&(this.executing=!0,window.setTimeout(()=>{this.executing=!1,this.executeGetHeights()}))}bindUpdateHeight(e,a,r,t){let n=r();e.removeHeightUpdate[a]=()=>{n(),delete e.heights[a],delete e.removeHeightUpdate[a]},t&&this.batchGetHeight(()=>{let r=t?.();void 0!==r&&e.onHeightUpdate(a,r)})}removeWatcher(e){Object.values(e.removeHeightUpdate).forEach(e=>e?.()),this.watchers=this.watchers.filter(a=>a!==e)}destroy(){this.removeEventListener?.(),this.watchers.forEach(e=>{Object.values(e.removeHeightUpdate).forEach(e=>e?.())}),this.watchers=[]}}let fF=new Set;class fL{colCount=0;rowCount=0;width=0;height=0;cells=[];_reverseY=!0;parameterValid=!1;margin=0;intersectOverlayIgnorePercent=0;get reverseY(){return this._reverseY}set reverseY(e){this._reverseY=e;let a=this.rowCount;this.cells.forEach(e=>{e.forEach(e=>{if(!!e)e.row=a-e.row-1,e.id=`${e.row}-${e.col}`})})}get cellWidth(){return this.width/this.colCount}get cellHeight(){return this.height/this.rowCount}constructor(e){e&&this.setGrid(e)}setGrid(e){if(e){this.colCount=e.colCount,this.rowCount=e.rowCount,this.width=e.width,this.height=e.height;let a=e.margin,r=this.width,t=this.height;a&&a>=0&&a<Math.min(r,t)/2&&(this.margin=a)}this.clearCells(),this.parameterValid=!1;let{rowCount:a}=this;if(!(a<=0)&&!(this.colCount<=0)&&!(this.width<=0)&&!(this.height<=0)){for(let e=0;e<a;e++)this.cells.push([]);this.parameterValid=!0}}clearCells(){this.cells.forEach(e=>{e.length=0}),this.cells.length=0}limitRegion(e){return e.leftTop[0]<0&&(e.leftTop[0]=0),e.leftTop[1]<0&&(e.leftTop[1]=0),e.rightBottom[0]>=this.colCount&&(e.rightBottom[0]=this.colCount-1),e.rightBottom[1]>=this.rowCount&&(e.rightBottom[1]=this.rowCount-1),e}limitByEdge(e,a){let{leftTop:r,rightBottom:t}=e,{xMax:n,yMax:i}=this.convertCellToRect(r),{xMin:o,yMin:s}=this.convertCellToRect(t),l=this.margin,d=t[0]-r[0]==1,c=t[1]-r[1]==1,u=!1,p=!1;if(d&&0!==l&&(u=i-a.yMin<=l&&a.yMax-s<=l),c&&0!==l&&(p=n-a.xMin<=l&&a.xMax-o<=l),u||p)return;let m=n>a.xMin&&n-a.xMin<=l,h=a.xMax>=o&&a.xMax-o<=l,g=i>a.yMin&&i-a.yMin<=l,f=a.yMax>=s&&a.yMax-s<=l;m&&(r[1]+=1),g&&(r[0]+=1),h&&(t[1]-=1),f&&(t[0]-=1)}insert(e){if(!this.parameterValid)return;let a=function(e,a){let r=e.xMax-e.xMin,t=e.yMax-e.yMin;if(a<=0)return e;let n=r*a/100,i=t*a/100;return e.xMin-=n,e.xMax+=n,e.yMin-=i,e.yMax+=i,e}(e.rect,e.buffer||0),r=this.getCellRegionFromRect(a);this.limitRegion(r),0!==this.margin&&this.limitByEdge(r,a);let t=[];return this.forEachCellByRegion(r,(r,n,i)=>{let o=`${n}-${i}`;!r&&(r=this.cells[n][i]={id:o,row:n,col:i,datas:[]}),r.datas.push({rect:a,data:e.data}),t.push(r)}),t}remove(e){this.forEachCell(a=>{let r=a.datas.findIndex(a=>a.data===e);-1!==r&&a.datas.splice(r)})}queryCell(e,a=!0){let r={hitted:!1,queryResult:[]};if(!this.parameterValid)return r;let t=this.getCellRegionFromRect(e);return this.limitRegion(t),a&&this.limitByEdge(t,e),this.forEachCellByRegion(t,e=>{e&&!r.queryResult.includes(e)&&r.queryResult.push(e)}),r.hitted=0!==r.queryResult.length,r}query(e,a=!0){let r=this.queryCell(e,a);fF.clear();let t=Math.min(e.width,e.height)*this.intersectOverlayIgnorePercent;return r.hitted&&r.queryResult.forEach(a=>{a.datas.forEach(a=>{p2.intersect(a.rect,e,t)&&fF.add(a.data)})}),fF}getCellRegionFromRect(e){let{xMin:a,xMax:r,yMin:t,yMax:n}=e,i=this.convertToCellIndex([a,t]);return{leftTop:i,rightBottom:this.convertToCellIndex([r,n])}}convertToCellIndex(e){return function(e,a){let[r,t]=a,[n,i]=e;return[Math.floor(i/t),Math.floor(n/r)]}(e,[this.cellWidth,this.cellHeight])}convertCellToRect(e){let a=new p2,[r,t]=e;return a.xMin=t*this.cellWidth,a.xMax=a.xMin+this.cellWidth,a.yMin=r*this.cellHeight,a.yMax=a.yMin+this.cellHeight,a}forEachCell(e){if(!!this.parameterValid)this.cells.forEach(a=>{a.forEach(a=>{a&&e(a)})})}forEachCellByRegion(e,a){let{leftTop:r,rightBottom:t}=e,[n,i]=r,[o,s]=t;for(let e=n;e<=o;e++)for(let r=i;r<=s;r++)a(this.cells[e][r],e,r)}}let fN=sc.Thing,fJ=sc.Line,fO=sc.Area;class fq{manager;currentExecutor=\"manager\";indexDict={manager:new fL,tsa:new fL,\"editor-or-drawer\":new fL};selectedElements=[];screenRect;elementGroup={active:null,hover:null,normal:[]};constructor(e){this.manager=e;let{clientWidth:a,clientHeight:r}=e.viewer.canvas;this.screenRect=p2.fromDiag([0,0],[a,r])}enable=!0;debugStatEnable=!1;debugStatistics={time:0,elCounts:0};get editor(){return this.manager.editor}get drawer(){return this.manager.drawer}get elements(){return this.manager.elements}get activeEditEl(){return this.editor.activeElement}get activeDrawEl(){return this.drawer.activeShape}get hover(){return this.manager.hover}get currentIndex(){return this.indexDict[this.currentExecutor]}get managerId(){return this.manager.id}onResolutionChange(){this.executePlacement(),this.executePlacement({owner:\"editor-or-drawer\",categories:[]}),this.executePlacement({owner:\"tsa\",categories:[se.tsa]})}staticIfNeed(e){if(!!this.debugStatEnable)\"start\"===e&&(this.debugStatistics.time=performance.now(),this.debugStatistics.elCounts=0),\"end\"===e&&(this.debugStatistics.time=performance.now()-this.debugStatistics.time,this.debugStatistics.elCounts=this.selectedElements.length)}clearElementGroup(){this.elementGroup.active=null,this.elementGroup.hover=null,this.elementGroup.normal=[]}outsideScreen(e){let a=this.screenRect,r=p2.intersect(a,e),t=e.xMax<1||e.yMax<1||a.width-e.xMin<1||a.height-e.yMin<1;return!r||t}executePlacement(e={owner:\"manager\",categories:[se.annotations]}){if(!this.enable)return;let{owner:a,categories:r}=e;this.selectedElements.length=0,this.clearElementGroup();let{clientWidth:t,clientHeight:n}=this.manager.viewer.canvas;this.currentExecutor=a,this.currentIndex.setGrid({colCount:5,rowCount:5,width:t,height:n,margin:10}),\"manager\"===a&&this.selectManagerElements(r),\"editor-or-drawer\"===a&&this.selectEditOrDrawElements(),\"tsa\"===a&&this.selectTSAElements(),this.groupByElementState();let i=this.elementGroup;i.active&&this.executeActivePlacement(i.active),i.hover&&i.hover!==i.active&&this.executeHoverPlacement(i.hover),this.executeNormalPlacement()}sortElements(e,a){let r=e.comparePlaceable?.(a);if(r)return r;if(r=a.comparePlaceable?.(e))return-r;let t=this.manager.is3D,n=this.manager.viewer.camera;if(t){let r=e.anchor,t=a.anchor;return null===r||null===t?0:uf.Cartesian3.distance(r,n.positionWC)-uf.Cartesian3.distance(t,n.positionWC)}{let r=e.getLabelingWindowPosition(this.managerId),t=a.getLabelingWindowPosition(this.managerId);return null===r||null===t?0:uf.Cartesian2.distance(r,uf.Cartesian2.ZERO)-uf.Cartesian2.distance(t,uf.Cartesian2.ZERO)}}executeActivePlacement(e){let a=e.getScreenSpaceBoundingBox(this.managerId);if(null===a)return;if(this.currentIndex.insert({data:{el:e},rect:a}),!(e instanceof hW)&&!(e instanceof h8)&&!(e instanceof mX))e.updateLabeling(this.managerId,{visible:!0})}executeHoverPlacement(e){this.executeElPlacement(e)}scratchElGroupByLevel={[fN]:[],[fJ]:[],[fO]:[]};clearScratchElGroup(){let e=this.scratchElGroupByLevel;e[fN].length=0,e[fJ].length=0,e[fO].length=0}executeNormalPlacement(){let e=this.elementGroup.normal,a=this.scratchElGroupByLevel;this.clearScratchElGroup(),e.forEach(e=>{if(\"interactLevel\"in e)e.interactLevel===fN&&a[fN].push(e),e.interactLevel===fJ&&a[fJ].push(e),e.interactLevel===fO&&a[fO].push(e)}),this.staticIfNeed(\"start\");for(let e=fN;e>=fO;e--)this.executeSingleLevelElGroupPlacement(a[e]);this.staticIfNeed(\"end\")}executeSingleLevelElGroupPlacement(e){e.sort(this.sortElements.bind(this)),e.forEach(e=>{this.executeElPlacement(e)})}executeElPlacement(e){e.resetPlacement(this.managerId);let a=e.getCurrentPlacement(this.managerId);for(;\"UnSet\"!==a;){let r=e.getScreenSpaceBoundingBox(this.managerId,a);if(!r||0!==this.currentIndex.query(r).size){a=e.nextPlacement(this.managerId);continue}this.currentIndex.insert({data:{el:e},rect:r}),e.updateLabeling(this.managerId,{placement:a,visible:!0});return}e.updateLabeling(this.managerId,{visible:!1})}selectManagerElements(e){this.elements.set.forEach(a=>{(a instanceof hW||a instanceof h8||a instanceof hG||a instanceof mX||a instanceof gr||a instanceof hY)&&e.includes(a.category)&&a.canPlaceable(this)&&this.selectedElements.push(a)})}selectEditOrDrawElements(){let e=this.drawer.getDrawingMode(),a=this.editor.getEditing(),r=this.editor.editingMode,t=e===c2.oO.polygon||\"polygon\"===r,n=e===c2.oO.line||\"line\"===r&&a;(t||n)&&this.elements.set.forEach(e=>{e instanceof hm&&e.canPlaceable(this)&&this.selectedElements.push(e)})}tsaPops=new Set;addTsaPop(e){this.tsaPops.add(e),this.executePlacement({owner:\"tsa\",categories:[]})}removeTsaPop(e){this.tsaPops.delete(e),this.executePlacement({owner:\"tsa\",categories:[]})}selectTSAElements(){this.tsaPops.forEach(e=>{let a=e.getScreenSpaceBoundingBox(this.managerId);a&&!this.outsideScreen(a)&&this.selectedElements.push(e)})}groupByElementState(){let e=this.selectedElements;if(e.length<=1)return;let a=this.elementGroup,r=this.activeEditEl,t=this.activeDrawEl;r&&hL(r)&&(a.active=r),t&&hL(t)&&(a.active=t);let n=this.hover.hoveringElement;n&&hL(n)&&(a.hover=n),a.normal=e.filter(e=>e!==a.active&&e!==a.hover)}}let fG=`uniform vec4 color; uniform float repeat; uniform float offset; uniform float thickness; czm_material czm_getMaterial(czm_materialInput materialInput) { czm_material material = czm_getDefaultMaterial(materialInput); float sp = 1.0/repeat; vec2 st = materialInput.st; float dis = distance(st, vec2(0.5)); float m = mod(dis + offset, sp); float a = step(sp*(1.0-thickness), m); material.diffuse = color.rgb; material.alpha = a * color.a; vec3 normalMC = material.normal; if(normalMC.y < 0.0 && normalMC.z < 0.0) { discard; } return material; }`;class fH{manager;constructor(e){this.manager=e,this.collection=e.viewer.scene.primitives.add(new uf.LabelCollection)}collection;add(e){let a=this.collection.add(e);return a._depthFailTranslucency=e.depthFailTranslucency,a}remove(e){return this.collection.remove(e)}}class fB{manager;constructor(e){this.manager=e,this.collection=e.viewer.scene.primitives.add(new uf.BillboardCollection)}collection;add(e){let a=this.collection.add(e);return a._depthFailTranslucency=e.depthFailTranslucency,a}remove(e){return this.collection.remove(e)}}class fV{manager;constructor(e){this.manager=e,this.primitive=null,this.instances=[],this.updating=!1}primitive;instances;async init(){await uf.GroundPrimitive.initializeTerrainHeights(),this.instances.length&&!this.primitive&&(this.primitive=this.manager.viewer.scene.groundPrimitives.add(new uf.GroundPrimitive({geometryInstances:this.instances,appearance:new uf.PerInstanceColorAppearance({translucent:!0}),asynchronous:!1})))}destroy(){this.primitive&&!this.manager.viewer.isDestroyed()&&this.manager.viewer.scene.groundPrimitives.remove(this.primitive),this.primitive=null}updating;requestUpdate(){!this.updating&&(this.updating=!0,window.requestAnimationFrame(()=>{this.updating=!1,this.destroy(),this.init()}))}add(e){let a=new uf.GeometryInstance({id:e.id,geometry:new uf.PolygonGeometry({polygonHierarchy:e.polygonHierarchy}),attributes:{show:new uf.ShowGeometryInstanceAttribute(e.show),color:e.color?uf.ColorGeometryInstanceAttribute.fromColor(e.color):new uf.ColorGeometryInstanceAttribute}});return this.instances.push(a),this.requestUpdate(),a}remove(e){let a=this.instances,r=a.indexOf(e);-1!==r&&a.splice(r,1),this.requestUpdate()}updateAttributes(e,a){let r=this.instances.find(a=>a.id===e);if(r&&(void 0!==a.show&&(r.attributes.show=new uf.ShowGeometryInstanceAttribute(a.show)),a.color&&(r.attributes.color=uf.ColorGeometryInstanceAttribute.fromColor(a.color))),this.primitive){if(!this.primitive.ready)return;let r=this.primitive.getGeometryInstanceAttributes(e);r&&(void 0!==a.show&&(r.show=uf.ShowGeometryInstanceAttribute.toValue(a.show,r.show)),a.color&&(r.color=uf.ColorGeometryInstanceAttribute.toValue(a.color,r.color)))}return r}updateGeometry(e,a){let r=this.instances.find(a=>a.id===e);r&&(r.geometry=new uf.PolygonGeometry({polygonHierarchy:a})),this.requestUpdate()}}uf.Ion.defaultAccessToken=\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJjZjcyZDBjYy1jM2I1LTQ2MGItOWNjZC1iYjk1ZWE3YzRiNWEiLCJpZCI6MzI2NTUsInNjb3BlcyI6WyJhc3IiLCJnYyJdLCJpYXQiOjE1OTczMDI2Njl9._apnc0_OVrjqSl2H8RwQJEVwNhAYyAcueIARFlrS7ew\";let fU=2*window.Math.atan(.5);async function fK(){let e=new uf.Resource({url:`${window.CURRENT_FE_ENV_CONFIG.terrainHost}/dem/api/v2/terrain-tiles/wgs84/`,queryParameters:{ak:window.CURRENT_FE_ENV_CONFIG.terrainKey}});return await uf.CesiumTerrainProvider.fromUrl(e,{forceRequestLayerJson:!0})}function fW(e){console.error(e)}async function fZ(e,a){if(e.viewer.isDestroyed())return{occluded:!1};let r=e.customTerrainProvider.getFallbackTerrainProvider();try{let e=uf.Cartographic.fromCartesian(a),t=e.height,n=await (0,uf.sampleTerrainMostDetailed)(r,[e]);return{occluded:n[0].height>t,surfaceHeight:n[0].height}}catch(e){fW(e)}return{occluded:!1}}async function fY(e,a){let{heading:r,pitch:t,direction:n,position:i}=a.viewer.camera,o=uf.Cartesian3.distance(i,e),s=function(e,a=100,r=1500,t=200){if(e<a)return a;if(e>r)return r;{let r=Math.round(e/t)*t;return 0===r?a:r}}(o,100,1500)-20,l={heading:0,pitch:uf.Math.toRadians(-90),roll:0};o<2e4&&(l.heading=r,l.pitch=t);let d=new uf.Cartesian3;if(o<2e4){let r=uf.Cartesian3.multiplyByScalar(n,-s,new uf.Cartesian3);uf.Cartesian3.add(e,r,d);let t=await fZ(a,d);if(t.occluded){let a=t.surfaceHeight+100,r=uf.Cartographic.fromCartesian(d);uf.Cartesian3.fromRadians(r.longitude,r.latitude,a,void 0,d);let{heading:n,pitch:i}=(0,fr.Il)(d,e);l.heading=n,l.pitch=i}}else{let a=uf.Cartographic.fromCartesian(e);a.height+=1500,uf.Cartesian3.fromRadians(a.longitude,a.latitude,a.height,void 0,d)}return{orientation:l,destination:d}}function fQ(e){return[c2.tT.map,c2.tT.wayline,c2.tT.CustomFlyCircleArea,c2.tT.CustomFlyPolygonArea,c2.tT.CustomLimitPolygonArea,c2.tT.CustomLimitCircleArea,c2.tT.NoLandingZone].includes(e)}class f$ extends ub(){collection;id;type;elements;elementsEditable;viewer;customTerrainProvider;mapEngine;mapConfig;resolve;readyPromise;picker;drawer;editor;piner;measurer;flysafeDrawer;baseMapProvider;interactor;dragger;hover;contextmenu;screenSpaceCameraController;observer;placer;labelVisualizer;billboardVisualizer;groundPolygonColorVisualizer;theme;constructor(e,a,r,t=sa.normal){super(),this.collection=a,this.id=r,this.type=t,this.elementsEditable=!0,this.mapEngine=window.CURRENT_BE_ENV_CONFIG.map_engine,this.mapConfig=function(e=!1){let a=window.CURRENT_BE_ENV_CONFIG,r=window.CURRENT_FE_ENV_CONFIG,t=uF();if(gZ)return{};if(\"g\"===a.map_engine)return{satelliteBase:gX(\"satelliteBase\",t),satelliteMark:gX(\"satelliteMark\",t),street:gX(\"street\",t)};let n=r.tianDiTuKey,i=\"lAsOZvyB3LuDw8scMpR9LRN8DjqXDDaq\";return{satelliteBase:g$(\"satelliteBase\",t,n),satelliteMark:e?g$(\"satelliteMark\",t,n):g2(\"satelliteMark\",i),street:e?g$(\"street\",t,n):g2(\"street\",i),streetMark:e?g$(\"streetMark\",t,n):void 0,fallbackSatelliteBase:g2(\"satelliteBase\",i)}}(),this.readyPromise=new Promise(e=>{this.resolve=e}),this.drawer=new g9(this),this.editor=new hU(this),this.piner=new fu(this),this.measurer=new fc(this),this.baseMapProvider=new fp(this),this.interactor=new fm(this),this.dragger=new fk(this),this.hover=new fv(this),this.contextmenu=new fz(this),this.theme=(0,uh.iH)(\"\"),this.isMapError=(0,uh.iH)(!1),this.customMapErrorMessage=(0,uh.iH)(\"\"),this.partialShow=(0,uh.iH)(!1),this.onElementUpdate=({el:e})=>{var a;if((a=e)instanceof hW||a instanceof h8||a instanceof hG||a instanceof mX||a instanceof hm||a instanceof mv||a instanceof hD||a instanceof hx||a instanceof hM||a instanceof gt||a instanceof hx)this.executePlacementThrottled()},this.executePlacementThrottled=(0,lL.throttle)(()=>{if(!this.viewer.isDestroyed())this.placer.executePlacement(),this.placer.executePlacement({owner:\"tsa\",categories:[se.tsa]})},400),this.executePopPlacementThrottled=(0,lL.throttle)(()=>{if(!this.viewer.isDestroyed())this.placer.executePlacement({owner:\"tsa\",categories:[se.tsa]})},400),this.primitiveContainers={polyline3d:new uf.PrimitiveCollection,polygon3d:new uf.PrimitiveCollection,prism:new"
}