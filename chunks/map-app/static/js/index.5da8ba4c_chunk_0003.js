{
  "metadata": {
    "source_file": "map-app\\static\\js\\index.5da8ba4c.js",
    "chunk_index": 3,
    "total_chunks": 918,
    "chunk_size": 50886,
    "word_count": 800,
    "model_kwargs": {
      "model": "text-embedding-3-large",
      "dimensions": 3072,
      "encoding_format": "float"
    },
    "text_splitter": {
      "split_by": "word",
      "chunk_size": 800,
      "chunk_overlap": 200
    },
    "created_at": "2025-12-17T23:57:50.140Z"
  },
  "content": "color;\\nuniform float repeatFactor;// 重复箭头的次数\\nuniform bool antiClockWise; // 确定箭头的方向\\n\\n// 一个辅助函数，给定两点(p0, p1)和一个x坐标，返回直线上对应的y坐标\\nfloat getPointOnLine(vec2 p0, vec2 p1, float x)\\n{\\n float slope = (p0.y - p1.y) / (p0.x - p1.x);// 计算斜率\\n return slope * (x - p0.x) + p0.y;// 使用斜率公式返回y坐标\\n}\\n\\n// 主材质函数，将被Cesium调用以获得每个片元的材质属性\\nczm_material czm_getMaterial(czm_materialInput materialInput)\\n{\\n czm_material material = czm_getDefaultMaterial(materialInput);// 获取默认材质\\n\\n vec2 st = materialInput.st;// 获取当前片元的纹理坐标\\n\\n if (antiClockWise) { // 根据antiClockWise的值选择性地翻转s坐标\\n st.s = 1.0 - st.s;\\n }\\n\\n float arrowWidth = 1.0 / repeatFactor;// 每个箭头的宽度\\n\\n // 使用mod函数将片元的s坐标映射到[0, arrowWidth]的范围内，从而实现箭头的重复\\n st.s = mod(st.s, arrowWidth) / arrowWidth;\\n\\n // 如果可用，使用fwidth函数来获得箭头的宽度，否则使用固定值\\n #if (__VERSION__ == 300 || defined(GL_OES_standard_derivatives))\\n float base = 1.0 - abs(fwidth(st.s)) * 10.0 * czm_pixelRatio;\\n #else\\n float base = 0.995;\\n #endif\\n\\n vec2 center = vec2(1.0, 0.5);// 箭头的顶点坐标\\n\\n // 增大箭头的尺寸来覆盖空隙\\n center.s += 0.01;\\n\\n // 计算箭头上部和下部直线上的点\\n float ptOnUpperLine = getPointOnLine(vec2(base, 1.0), center, st.s);\\n float ptOnLowerLine = getPointOnLine(vec2(base, 0.0), center, st.s);\\n\\n float halfWidth = 0.15;// 箭头的半宽\\n // 计算箭头主体部分的纹理坐标\\n float s = step(0.5 - halfWidth, st.t);\\n s *= 1.0 - step(0.5 + halfWidth, st.t);\\n s *= 1.0 - step(base, st.s);\\n\\n // 计算箭头顶部部分的纹理坐标\\n float t = step(base, st.s);\\n t *= 1.0 - step(ptOnUpperLine, st.t);\\n t *= step(ptOnLowerLine, st.t);\\n\\n // 计算片元与箭头边界的距离，以便进行抗锯齿处理\\n float dist;\\n if (st.s < base)\\n {\\n float d1 = abs(st.t - (0.5 - halfWidth));\\n float d2 = abs(st.t - (0.5 + halfWidth));\\n dist = min(d1, d2);\\n }\\n else\\n {\\n float d1 = czm_infinity;\\n if (st.t < 0.5 - halfWidth && st.t > 0.5 + halfWidth)\\n {\\n d1 = abs(st.s - base);\\n }\\n float d2 = abs(st.t - ptOnUpperLine);\\n float d3 = abs(st.t - ptOnLowerLine);\\n dist = min(min(d1, d2), d3);\\n }\\n\\n vec4 outsideColor = vec4(0.0);// 外部颜色（非箭头部分）\\n // 根据s和t的值混合颜色，如果片元位于箭头上，则使用箭头颜色，否则使用外部颜色\\n vec4 currentColor = mix(outsideColor, color, clamp(s + t, 0.0, 1.0));\\n // 使用czm_antialias函数进行抗锯齿处理\\n vec4 outColor = czm_antialias(outsideColor, color, currentColor, dist);\\n\\n outColor = czm_gammaCorrect(outColor);\\n material.diffuse = outColor.rgb;// 设置材质的漫反射颜色\\n material.alpha = outColor.a;// 设置材质的透明度\\n\\n return material;// 返回材质\\n}\\n\\n\\n\"},translucent:!0});class mQ{constructor(e=uf.Color.WHITE,a,r){this.color=e,this.repeatFactor=a,this.antiClockWise=r}color;repeatFactor;antiClockWise;definitionChanged=new uf.Event;isConstant=!0;equals(e){return this===e||e instanceof mQ&&uf.Color.equals(this.color,e.color)}getType(e){return mY}getValue(e,a){return!(0,uf.defined)(a)&&(a={}),a.color=this.color,a.repeatFactor=this.repeatFactor,a.antiClockWise=this.antiClockWise,a}}function m$(){return{label:{distanceVisible:!0,alphaVisible:!0,labelingVisible:!0},polygon:{distanceVisible:!0,alphaVisible:!0},all:{visible:!0}}}class mX extends(0,uX.AF)(pv,ph){managers;constructor(e,a,r){super(),this.managers=a,this.entities=py({}),this.interactLevel=sc.Area,this.activeState={selected:!1,recenter:!1,hover:!1},this.dynamic=!1,this.firstDynamic=!0,this.tempCircleEdgePointsPos=[],this.cacheCenterPos=null,this.cacheRadius=0,this.circleEdgePointsPos=[],this.namePosition=null,this.nameClampWatcher=null,this.cacheNamePositionHeight=0,this.fillAreaCanPick=!0,this.cacheAlphaByDistance=-1,this.cacheViewModes={},this.runtimeStates={},this.properties=Object.assign({id:(0,uW.k)(),type:\"circle\",fontSize:16},e),this.options=Object.assign({},r),this.init(),this.setCollectionMap()}properties;options;entities;interactLevel;get firstEntity(){return this.entities._values()[0]}get id(){return this.properties.id}get type(){return\"circle\"}get typedElement(){return{type:this.type,element:this}}get centerPos(){return this.properties.centerPos}set centerPos(e){this.properties.centerPos=e,this.dynamic?(this.generateCircleShapePositions(),this.managers.editor?.updatePositionsFor?.(this)):(this.updatePositions(),this.managers.render?.())}get radius(){return this.properties.radius}set radius(e){if(!e||!(e>this.maxRadius))this.properties.radius=e,this.dynamic?(this.generateCircleShapePositions(),this.managers.editor?.updatePositionsFor?.(this)):(this.updatePositions(),this.managers.render?.())}get height(){return this.properties.height}set height(e){this.properties.height=e,this.dynamic?(this.generateCircleShapePositions(),this.managers.editor?.updatePositionsFor?.(this)):(this.updatePositions(),this.managers.render?.())}get name(){return this.properties.name}set name(e){this.properties.name=e,this.entities.label?.textSetter(new uf.ConstantProperty(e)),this.managers.render?.()}get cssColor(){return this.properties.cssColor||\"#FFFFFF\"}set cssColor(e){this.properties.cssColor!==e&&(this.properties.cssColor=e)}get fill(){return this.properties.fill??pP.Fill}get boundingSphere(){let e=this.firstEntity?.polygon?.hierarchy?.getValue(uf.JulianDate.now()).positions||this.circleEdgePoint;if(e)return uf.BoundingSphere.fromPoints(e)}get eastPointIndex(){return Math.floor(22.5)}get maxRadius(){return this.properties.maxRadius||pP.MaxRadius}get circleEdgePoint(){return this.circleEdgePointsPos[this.eastPointIndex]}get fontSize(){return this.properties.fontSize||16}set fontSize(e){this.properties.fontSize=e,this.entities.label?.fontSetter(new uf.ConstantProperty(this.getFont()))}getFont(){return`600 ${this.fontSize}px ${pC}`}update(e){let a=this.properties;if((0,pg.ri)(e.name)&&(this.name=e.name),(0,pg.ri)(e.centerPos)&&(this.centerPos=e.centerPos,this.entities.positionSetter(new uf.ConstantPositionProperty((0,pg.jL)(e.centerPos)))),(0,pg.ri)(e.show)&&this.entities.showSetter(e.show),e.labelDistanceDisplayCondition&&(a.labelDistanceDisplayCondition=e.labelDistanceDisplayCondition,this.entities.label?.distanceDisplayConditionSetter(new uf.ConstantProperty(new uf.DistanceDisplayCondition(...e.labelDistanceDisplayCondition)))),e.labelScaleByDistance){a.labelScaleByDistance=e.labelScaleByDistance;let r=new uf.ConstantProperty(new uf.NearFarScalar(...e.labelScaleByDistance));this.entities.label?.scaleByDistanceSetter(r),this.entities.label?.pixelOffsetScaleByDistanceSetter(r)}e.placeable&&(a.placeable=e.placeable),(0,pg.ri)(e.maxRadius)&&(a.maxRadius=e.maxRadius),(0,pg.ri)(e.radius)&&e.radius<=this.maxRadius&&(this.properties.radius=e.radius),(0,pg.ri)(e.fontSize)&&(this.fontSize=e.fontSize),pg.Pg.call(this,a,{cssColor:e.cssColor,areaAlpha:e.areaAlpha,zIndex:e.zIndex,removable:e.removable,contextmenu:e.contextmenu,fromDraw:e.fromDraw,show:e.show,height:e.height,antiClockWise:e.antiClockWise,alphaByDistance:e.alphaByDistance}),(0,pg.ri)(e.fill)&&(this.properties.fill=e.fill),this.updateMaterial(),this.updatePositions(),this.updateWidth(),this.managers.render?.()}activeState;active(e=\"\",a){if(!this.properties.fromDraw)return!1;if((0,pg.ri)(a)&&e&&this.activeState[e]!==a&&(this.activeState[e]=a,this.toggleActive()),e)return this.activeState[e];{let{selected:e,recenter:a,hover:r}=this.activeState;return e||a||r}}edit(e){this.managers._get(f3)?.editor?.enterEdit?.(\"circle\",this,e)}getEntityOptions(){let e=this.properties.labelDistanceDisplayCondition?new uf.DistanceDisplayCondition(...this.properties.labelDistanceDisplayCondition):void 0,a=this.properties.labelScaleByDistance?new uf.NearFarScalar(...this.properties.labelScaleByDistance):void 0,r=this.getFont(),t={id:this.id,show:this.properties.show,position:this.getPositionsCartesian3(),polygon:{perPositionHeight:!this.properties.clampToGround},label:Object.assign({text:this.properties.name,disableDepthTestDistance:Number.POSITIVE_INFINITY},px,{distanceDisplayCondition:e,scaleByDistance:a,pixelOffsetScaleByDistance:a,depthFailTranslucency:this.properties.labelOccludedAlpha,verticalOrigin:uf.VerticalOrigin.BOTTOM,pixelOffset:new uf.Cartesian2(0,-5),font:r})};return this.properties.withPolyOutline&&(t.polyline={clampToGround:this.properties.clampToGround,width:3}),t}init(){super.init()}setCollectionMap(){this.managers._options.elements.add(\"circle\",this,[this.id])}dynamic;firstDynamic;stabilize(e){this.dynamic=!1,this.firstDynamic=!0,this.options.drawing&&(this.options.drawing=!1),this.options.positionsCallback=void 0,this.centerPos=e.centerPos,this.radius=e.radius,this.entities.label?.showSetter(new uf.ConstantProperty(!0)),this.toggleNameClampWithoutHeight(),this.managers.render?.()}dynamize(e){this.options=Object.assign(this.options,e),this._dynamize()}tempCircleEdgePointsPos;cacheCenterPos;cacheRadius;circleEdgePointsPos;calcCircleEdgePointsPos(e,a){let r=e&&this.cacheCenterPos&&this.cacheCenterPos.longitude===e.longitude&&this.cacheCenterPos.latitude===e.latitude,t=this.cacheRadius&&a&&this.cacheRadius===a,n=a>this.maxRadius;if(r&&t&&this.tempCircleEdgePointsPos.length&&!this.firstDynamic||n)return this.tempCircleEdgePointsPos;{this.firstDynamic=!1,this.cacheCenterPos=e,this.cacheRadius=a,this.circleEdgePointsPos=mF(e,a,90);let r=this.circleEdgePointsPos.map(e=>(0,pg.jL)(e));return this.tempCircleEdgePointsPos=r,r}}_dynamize(){this.dynamic=!0,this.options.positionsCallback&&(this.entities.polygon?.hierarchySetter(new uf.CallbackProperty(()=>{let e=this.options.positionsCallback?.().centerPos,a=this.options.positionsCallback?.().radius;return new uf.PolygonHierarchy(this.calcCircleEdgePointsPos(e,a))},!1)),this.entities.polyline?.positionsSetter(new uf.CallbackProperty(()=>{let e=this.options.positionsCallback?.().centerPos,a=this.options.positionsCallback?.().radius,r=this.calcCircleEdgePointsPos(e,a);return r.concat(r[0])},!1)),this.entities.label?.showSetter(new uf.ConstantProperty(!1)))}toggleActive(){if(this.active()){let e=new uf.ConstantProperty(uf.Color.fromCssColorString(this.active(\"recenter\")?pI:pD));this.entities.label?.fillColorSetter(new uf.ConstantProperty(uf.Color.fromCssColorString(this.cssColor))),this.entities.label?.outlineColorSetter(e)}else this.entities.label?.fillColorSetter(new uf.ConstantProperty(px.fillColor));this.recomputeDepthStyle(),this.updateMaterial(),this.updateWidth(),this.managers.render?.()}getCesiumColor(){let e=this.properties.cssColor;if(e)return uf.Color.fromCssColorString(e)}getCesiumColorAlpha(e=this.properties.areaAlpha){let a=this.getCesiumColor();if(a)return(0,lL.isNil)(e)?a:a.withAlpha(e)}updatePolygonMaterial(){let e=-1!==this.cacheAlphaByDistance?this.cacheAlphaByDistance:void 0,a=this.getCesiumColorAlpha(e);this.entities.polygon?.materialSetter(new uf.ColorMaterialProperty(a?.withAlpha(this.fill?a.alpha:0))),this.updateShowByRuntimeState()}updateMaterial(){if(this.updatePolygonMaterial(),this.active()){let e=new uf.ConstantProperty(uf.Color.fromCssColorString(this.active(\"recenter\")?pI:pD)),a=new uf.PolylineOutlineMaterialProperty({color:uf.Color.fromCssColorString(this.properties.cssColor||\"#ffffff\"),outlineColor:e,outlineWidth:2});this.properties.outlineStyle===sf.Fence&&(a=new mZ(uf.Color.fromCssColorString(this.properties.cssColor||\"#ffffff\"),uf.Color.fromCssColorString(\"#ffffff\"),6)),this.entities.polyline?.materialSetter(a)}else{let e=this.getCesiumColor(),a=new uf.ColorMaterialProperty(e);this.properties.outlineStyle===sf.Fence?a=new mZ(e):this.properties.outlineStyle===sf.MultiArrow?a=new mQ(e,this.properties.multiArrowNum||4,!!this.properties.antiClockWise):this.properties.outlineStyle===sf.Dash&&(a=new uf.PolylineDashMaterialProperty({color:e,dashLength:9,dashPattern:31})),this.entities.polyline?.materialSetter(a)}}generateCircleShapePositions(){this.circleEdgePointsPos=mF(this.properties.centerPos,this.properties.radius||100,90,this.properties.height)}updatePositions(){if(this.dynamic)this.generateCircleShapePositions(),this.managers.editor?.updatePositionsFor?.(this);else{let e;this.properties.centerPos&&this.properties.radius&&(this.generateCircleShapePositions(),e=this.circleEdgePointsPos.concat(this.circleEdgePointsPos[0]).map(e=>(0,pg.jL)(e)),this.namePosition=this.properties.centerPos||null,this.namePosition?(this.entities.positionSetter(new uf.ConstantPositionProperty(uf.Cartesian3.fromDegrees(this.namePosition.longitude,this.namePosition.latitude,this.namePosition.height))),this.toggleNameClampWithoutHeight()):this.removeNameWatcher(),this.entities.polygon?.hierarchySetter(new uf.ConstantProperty(new uf.PolygonHierarchy(e))),this.entities.polyline?.positionsSetter(new uf.ConstantProperty(e)))}}updateWidth(){if(this.active()){let e=5;this.properties.outlineStyle===sf.Fence?e=10:this.properties.outlineStyle===sf.MultiArrow&&(e=20),this.entities.polyline?.widthSetter(new uf.ConstantProperty(e))}else{let e=3;this.properties.outlineStyle===sf.Fence?e=12:this.properties.outlineStyle===sf.MultiArrow&&(e=20),this.entities.polyline?.widthSetter(new uf.ConstantProperty(e))}}namePosition;nameClampWatcher;cacheNamePositionHeight;updateNamePositionCallback(e){e&&(this.entities.positionSetter(new uf.ConstantPositionProperty(e)),this.cacheNamePositionHeight=uf.Cartographic.fromCartesian(e).height,this.managers.render?.())}toggleNameClampWithoutHeight(){let e=this.namePosition;if(e){let a=uf.Cartographic.fromDegrees(e.longitude,e.latitude);this.nameClampWatcher?this.nameClampWatcher.update(a):this.nameClampWatcher=this.managers._get(f3)?.picker.clampWithWatcher(a,e=>this.updateNamePositionCallback(e))}}removeNameWatcher(){this.nameClampWatcher&&(this.nameClampWatcher?.unclamp(),this.nameClampWatcher=null)}getPositionsCartesian3(){if(this.properties.centerPos)return(0,pg.jL)(this.properties.centerPos)}fillAreaCanPick;canPick(e){return!(e instanceof uf.GroundPrimitive)||this.fillAreaCanPick}cacheAlphaByDistance;updateAlphaByDistance(e,a){let r;let t=this.properties.alphaByDistance;if(!t)return;let[n,i,o,s]=t;if(!(n<=o&&n>=0&&i>=0&&s>=0&&i<=1&&s<=1))return;let l=Number.POSITIVE_INFINITY,{viewportCenterDistance:d,cameraHeight:c}=a;if(!(0,pg.ri)(d)&&(!(0,pg.ri)(c)||c<=0))return;if((0,pg.ri)(d)&&(l=d),(0,pg.ri)(c)&&c<l&&(l=c),l<n)r=i;else if(l>o)r=s;else{let e=(s-i)/(Math.log(o)-Math.log(n)),a=i-e*Math.log(n);r=e*Math.log(l)+a}let u=this.properties.disableHoverAlpha??0;this.fillAreaCanPick=r>u;let p=this.runtimeStates[e.id];if(p&&(p.polygon.alphaVisible=r>u),!(1e-10>=Math.abs(this.cacheAlphaByDistance-r))){if(this.cacheAlphaByDistance=r,r>u){let a=this.entities._get(e.id);if(a&&a.polygon){let e=this.getCesiumColorAlpha(r);a.polygon.material=new uf.ColorMaterialProperty(e)}}}}cacheViewModes;onSceneChange(e,a){this.updateVisibleByDistance(e),this.updateAlphaByDistance(e,a),this.updateShowByRuntimeState(e.id);let{is3D:r,id:t}=e;if(r&&\"3D\"===this.cacheViewModes[t]||!r&&\"2D\"===this.cacheViewModes[t])return;if(this.cacheViewModes[t]=r?\"3D\":\"2D\",!this.active())this.recomputeDepthStyle([e.id])}recomputeDepthStyle(e){let a=this.active(),r=!!this.properties.labelEnableOccludeIn2dView;(!Array.isArray(e)||0===e.length)&&(e=Object.keys(this.cacheViewModes)),e.forEach(e=>{let t=this.cacheViewModes[e];if(void 0===t)return;let{occludedAlpha:n,disableDepthTestDistance:i}=mb(t,a,r,this.properties.labelOccludedAlpha,void 0),o=this.entities._get(e)?.label;if(!o)return;let s=new uf.ConstantProperty(n);o.depthFailTranslucency=s;let l=new uf.ConstantProperty(i);o.disableDepthTestDistance=l})}updateVisibleByDistance(e){let a=this.anchor;if(!a)return;let r=e.viewer.camera.positionWC,t=this.properties.labelDistanceDisplayCondition,n=this.runtimeStates[e.id];if(t){let e=uf.Cartesian3.distance(r,a),i=e<t[1];n&&(n.label.distanceVisible=i||e>t[0],n.polygon.distanceVisible=i,n.all.visible=i)}}runtimeStates;getLabelRuntimeVisible(e=f3){let a=this.runtimeStates[e];!a&&(a=m$());let r=a.label,{hover:t,selected:n}=this.activeState;return!n&&(!1!==this.properties.show&&r.distanceVisible&&r.alphaVisible&&r.labelingVisible||t)}getPolygonRuntimeVisible(e=f3){let a=this.runtimeStates[e];!a&&(a=m$());let r=a.polygon,{selected:t}=this.activeState;return!1!==this.properties.show&&r.distanceVisible&&r.alphaVisible||t}getTotalRuntimeVisible(e=f3){let a=this.runtimeStates[e];return!a&&(a=m$()),a.all.visible}updateShowByRuntimeState(e=f3){let a=this.entities._get(e);if(!!a){if(a.polygon){let r=this.getPolygonRuntimeVisible(e);a.polygon.show=new uf.ConstantProperty(r&&this.fill)}a.label&&(a.label.show=new uf.ConstantProperty(this.getLabelRuntimeVisible(e))),a.show=this.active()||this.getTotalRuntimeVisible(e)&&!1!==this.properties.show}}get placeable(){return!!this.properties.placeable}set placeable(e){this.properties.placeable=e}get anchor(){if(!this.namePosition)return null;let e={longitude:this.namePosition.longitude,latitude:this.namePosition.latitude,height:this.cacheNamePositionHeight};return(0,pg.jL)(e)}getLabelingWindowPosition(e){let a=this.managers._get(e).viewer.scene;if(!this.anchor)return null;let r=uf.SceneTransforms.wgs84ToWindowCoordinates(a,this.anchor);return r?r:null}getScreenSpaceBoundingBox(e,a){let r=this.managers._get(e)?.viewer.scene,t=this.entities._get(e);if(!a&&(a=this.getCurrentPlacement(e)),\"UnSet\"===a||!r||!t)return null;let n=t.label;if(!this.anchor||!n)return null;let i=this.properties.labelScaleByDistance?new uf.NearFarScalar(...this.properties.labelScaleByDistance):void 0,o=String(this.properties.name);return m_({type:\"Label\",text:o,font:String(px.font),scene:r,anchor:this.anchor,pixelOffsetScaleByDistance:i,scaleByDistance:i,hOrigin:uf.HorizontalOrigin.CENTER,vOrigin:uf.VerticalOrigin.BOTTOM})}resetPlacement(e){}getCurrentPlacement(e){return\"Center\"}nextPlacement(e){return\"UnSet\"}updateLabeling(e,{visible:a}){let r=this.runtimeStates[e];void 0!==a&&r&&(r.label.labelingVisible=a,this.updateShowByRuntimeState(e))}getLabelVisible(e=f3){let a=this.entities.label?.show?._get(e);return!!a&&a.getValue(uf.JulianDate.now())}canPlaceable(e){if(!this.placeable)return!1;if(!1===this.properties.show)return this.properties.show;let{screenRect:a,manager:r,managerId:t}=e,n=this.getScreenSpaceBoundingBox(t);if(!n||!p2.intersect(a,n,7))return!1;let i=this.properties.labelDistanceDisplayCondition;if(i&&this.anchor){let e=r.viewer.camera.positionWC,a=uf.Cartesian3.distance(e,this.anchor);return a>i[0]||a<i[1]}return!0}onManagerAdd(e){let a=this.managers._get(e);this.runtimeStates[e]=m$(),a&&(this.entities._add(e,a.viewer.entities.add(this.getEntityOptions())),this.updateWidth(),this.updateMaterial(),this.updatePositions(),this.options.drawing?(this._dynamize(),this.active(\"selected\",!0)):this.updatePositions())}onManagerRemove(e){let a=this.entities._get(e);a?.entityCollection.remove(a),this.entities._remove(e)}onManagerUpdate(e){let a=this.entities._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}destroy(){super.destroy(),this.entities._keys().forEach(e=>{let a=this.entities._get(e);a&&a.entityCollection.remove(a),this.entities._remove(e)})}}let m0=\"#E02020\";(rH=sb||(sb={}))[rH.grow=0]=\"grow\",rH[rH.shrink=1]=\"shrink\",rH[rH.none=2]=\"none\",(rB=sk||(sk={}))[rB.none=0]=\"none\",rB[rB.waypoint=1]=\"waypoint\",rB[rB.area=2]=\"area\",rB[rB.facade=3]=\"facade\",rB[rB.solid=4]=\"solid\",rB[rB.mappingObject=5]=\"mappingObject\",rB[rB.mappingStripe=6]=\"mappingStripe\",rB[rB.aiPatrol=7]=\"aiPatrol\";let m1=r.p+\"3fb11d3106982319.glb\",m2=r.p+\"66cca3ee4dffa8b5.glb\",m3=r.p+\"ddd7555dc62f9f71.glb\",m4=r.p+\"c508b06302a8e13e.glb\",m5=r.p+\"67cb22f41e521e5e.glb\",m6=r.p+\"ed031eec7d388938.glb\",m9=r.p+\"cd50afce7de15b76.glb\",m8={rotateHelper:m6,radiusFat:m9,radiusThin:r.p+\"63c2050772c71ad3.glb\",green_axis_mask:m4,green_axis_color:m1,green_rotate_mask:m5,green_rotate_color:m3,red_axis_mask:m4,red_axis_color:m1,red_rotate_mask:m5,red_rotate_color:m3,blue_axis_mask:m4,blue_axis_color:m1,blue_rotate_mask:m5,blue_rotate_color:m3},m7=Object.keys(m8),he=[\"rotateHelper\",\"radiusFat\",\"radiusThin\"];class ha{}let hr={green:uf.Cartesian3.UNIT_X,blue:uf.Cartesian3.UNIT_Y,red:uf.Cartesian3.UNIT_Z},ht={green:uf.Cartesian3.UNIT_Z,blue:uf.Cartesian3.UNIT_Z,red:uf.Cartesian3.fromElements(0,-1,0)};class hn extends(0,uX.AF)(ph,pz,pv,ha){managers;constructor(e,a){super(),this.managers=a,this.primitives=py({}),this.interactLevel=sc.Thing,this.positionCartesian3=new uf.Cartesian3,this.headingPitchRoll=new uf.HeadingPitchRoll,this.transformMatrix=uf.Matrix4.IDENTITY,this.transformMatrixInverse=uf.Matrix4.IDENTITY,this.partModelReadyPromise=new Promise(e=>this.resolve=e),this.modelMatrix=uf.Matrix4.IDENTITY,this._shiftHotkeyEnable=!1,this.draggingStatus=null,this.properties=Object.assign({id:(0,uW.k)()},e),this.init(),this.setCollectionMap(\"transformer\"),this.managers.render?.()}properties;primitives;interactLevel;positionCartesian3;headingPitchRoll;transformMatrix;transformMatrixInverse;resolve;partModelReadyPromise;static XColor=uf.Color.fromCssColorString(\"#A9F620\");static YColor=uf.Color.fromCssColorString(\"#F3334A\");static ZColor=uf.Color.fromCssColorString(\"#58FCF1\");static XTransformMatrix=uf.Matrix4.fromRotation(uf.Matrix3.fromRotationY(-uf.Math.PI_OVER_TWO));static ZTransformMatrix=uf.Matrix4.fromRotation(uf.Matrix3.fromRotationX(-uf.Math.PI_OVER_TWO));static XTransformMatrixNegative=uf.Matrix4.fromRotation(uf.Matrix3.fromRotationY(uf.Math.PI_OVER_TWO));static ZTransformMatrixNegative=uf.Matrix4.fromRotation(uf.Matrix3.fromRotationX(uf.Math.PI_OVER_TWO));static YTransformMatrixNegative=uf.Matrix4.fromRotation(uf.Matrix3.fromRotationZ(uf.Math.PI));static RadiusSegmentMatrix=uf.Matrix4.fromRotation(uf.Matrix3.fromRotationZ(-uf.Math.PI_OVER_TWO));static EnuOrientationHpr=Object.freeze({heading:180,pitch:0,roll:90});static getTranslateHelperPositions(e,a){let r=hr[a],t=uf.Cartesian3.multiplyByScalar(r,1e6,new uf.Cartesian3);return[t,uf.Cartesian3.multiplyByScalar(r,-1e6,new uf.Cartesian3)].map(a=>uf.Matrix4.multiplyByPoint(e,a,a))}get show(){return!1!==this.properties.show}getColor(e){let a=uf.Color.WHITE,[r,,t]=e.split(\"_\");return\"mask\"===t?a=uf.Color.fromAlpha(uf.Color.BLACK,.01):(\"red\"===r&&(a=hn.YColor.clone()),\"blue\"===r&&(a=hn.ZColor.clone()),\"green\"===r&&(a=hn.XColor.clone())),a}init(){this.calculateProps(),super.init()}calculateProps(){if(this.properties.position&&(this.positionCartesian3=(0,pg.jL)(this.properties.position)),this.properties.headingPitchRoll){let{heading:e,pitch:a,roll:r}=this.properties.headingPitchRoll;this.headingPitchRoll=uf.HeadingPitchRoll.fromDegrees(e,a,r)}this.transformMatrix=uf.Transforms.headingPitchRollToFixedFrame(this.positionCartesian3,this.headingPitchRoll),this.transformMatrixInverse=uf.Matrix4.inverse(this.transformMatrix,new uf.Matrix4),!this.draggingStatus&&this.updateModelMatrix(this.transformMatrix)}modelMatrix;updateModelMatrix(e){this.modelMatrix=e,m7.forEach(e=>{let a=this.primitives[e],r=!!this.properties.doubleSideAxis,t=`${e}_mirror`,n=this.primitives[t],i=this.getBeforeRotateMatrix(e,!0);if(r&&e.includes(\"axis\")&&n&&n.modelMatrixSetter(uf.Matrix4.multiply(this.modelMatrix,i,new uf.Matrix4)),a){let r=this.getBeforeRotateMatrix(e,!1),t=\"rotateHelper\"===e||\"radiusFat\"===e?this.transformMatrix:this.modelMatrix;a.modelMatrixSetter(uf.Matrix4.multiply(t,r,new uf.Matrix4))}}),this.managers.render?.()}getFilteredModelKeys(){return m7.filter(e=>{if(this.properties.disableRotate&&e.includes(\"rotate\")||this.properties.disableTranslate&&e.includes(\"axis\"))return!1;let a=this.properties.directionUsed;return!Array.isArray(a)||0===a.length||a.some(a=>e.includes(a))})}addPrimitives(e){let a=this.primitives._get(e);!a&&(this.primitives._add(e,{}),a=this.primitives._get(e));let r=this.managers._get(e);if(r&&a){let e=this.getFilteredModelKeys(),t=!!this.properties.doubleSideAxis,n=this.properties.directionUsed?.length===1,i=async(e,t=!1,i=!1)=>{let o=t?`${e}_mirror`:e,s=this.getInitModelOptions(e,t,i);n&&!e.endsWith(\"mask\")&&(s.color=hn.YColor);let l=await uf.Model.fromGltfAsync(s);a[o]=r.viewer.scene.primitives.add(l),l&&!he.includes(e)&&(l.show=!!this.properties.show)};Promise.all(e.map(e=>{let a=[i(e,!1,t)];return t&&e.includes(\"axis\")&&a.push(i(e,!0,t)),a}).flat()).then(()=>{this.resolve?.()}).finally(()=>{r.render()})}}getBeforeRotateMatrix(e,a){if(e.startsWith(\"blue\"))return a?hn.ZTransformMatrixNegative:hn.ZTransformMatrix;if(e.startsWith(\"green\"))return a?hn.XTransformMatrixNegative:hn.XTransformMatrix;if(this.draggingStatus&&\"rotate\"===this.draggingStatus.operation){let{direction:a,startRotateAngle:r}=this.draggingStatus;if(he.includes(e)){if(\"red\"===a){let e=uf.Matrix3.IDENTITY,a=uf.Matrix3.fromRotationZ(-r);return uf.Matrix4.fromRotation(uf.Matrix3.multiply(a,e,new uf.Matrix3))}if(\"green\"===a){let a=\"rotateHelper\"===e?uf.Matrix3.fromRotationY(-uf.Math.PI_OVER_TWO):uf.Matrix3.fromRotationX(-uf.Math.PI_OVER_TWO),t=uf.Matrix3.fromRotationX(-r);return uf.Matrix4.fromRotation(uf.Matrix3.multiply(t,a,new uf.Matrix3))}if(\"blue\"===a){let e=uf.Matrix3.fromRotationX(-uf.Math.PI_OVER_TWO),a=uf.Matrix3.fromRotationY(-r);return uf.Matrix4.fromRotation(uf.Matrix3.multiply(a,e,new uf.Matrix3))}}}return a?hn.YTransformMatrixNegative:uf.Matrix4.IDENTITY}static PixelSizeScale=1.2;static PartPixelSizeMap={blue_axis_color:96*hn.PixelSizeScale,green_axis_color:96*hn.PixelSizeScale,red_axis_color:96*hn.PixelSizeScale,blue_rotate_color:160*hn.PixelSizeScale,green_rotate_color:160*hn.PixelSizeScale,red_rotate_color:160*hn.PixelSizeScale,rotateHelper:196*hn.PixelSizeScale,radiusFat:56*hn.PixelSizeScale,radiusThin:56*hn.PixelSizeScale,blue_axis_mask:96*hn.PixelSizeScale,green_axis_mask:96*hn.PixelSizeScale,red_axis_mask:96*hn.PixelSizeScale,blue_rotate_mask:160*hn.PixelSizeScale,green_rotate_mask:160*hn.PixelSizeScale,red_rotate_mask:160*hn.PixelSizeScale};getInitModelOptions(e,a,r=!1){let t=this.getColor(e),n=this.getBeforeRotateMatrix(e,a),i=uf.Matrix4.multiply(this.modelMatrix,n,new uf.Matrix4),o=r&&e.includes(\"axis\")?m2:m8[e],s=r&&e.includes(\"axis\")?.5:1,l=new uf.DistanceDisplayCondition;if(this.properties.distanceDisplayCondition){let[e,a]=this.properties.distanceDisplayCondition;l.near=e,l.far=a}let d={id:a?`${e}_mirror`:e,show:this.properties.show,url:o,minimumPixelSize:hn.PartPixelSizeMap[e]*s,scale:.1,modelMatrix:i,opaquePass:uf.Pass.OVERLAY,shadows:uf.ShadowMode.DISABLED,distanceDisplayCondition:l,color:t};return he.includes(e)&&(d.show=!1),d}_shiftHotkeyEnable;get shiftHotkeyEnable(){return this._shiftHotkeyEnable}set shiftHotkeyEnable(e){this._shiftHotkeyEnable=e}draggingStatus;get onDragging(){return null!==this.draggingStatus}get isOnlyOneAxis(){return this.properties.directionUsed?.length===1}get parallelAxisRenderOptimize(){return this.properties.parallelAxisRenderOptimize}canDrag(e){let a=!(0,pg.ri)(e)&&\"transformer\";return a&&this.managers._get(f3)?.hover.setCursor(\"grabbing\",\"temporary\"),a}startDrag(e,a,r){if(\"transformer\"===a){let a=r?.primitive;if(a){let r=this.primitives._keys().reduce((e,r)=>{if(e)return e;let t=this.primitives._get(r),n=m7.find(e=>{let r=t[e]===a;return this.properties.doubleSideAxis?r||t[`${e}_mirror`]===a:r});return n?n:e},\"\");if(r&&!he.includes(r)){let[a,t]=r.split(\"_\");this.draggingStatus=this.generateDragStatus(e.position,a,t),this.properties.onDragStart?.(t),this.togglePartShowState(!0);let n=this.primitives._get(f3).translate_helper;return(!n||n.isDestroyed())&&this.toggleTranslateHelperLine(!0,a),\"rotate\"===t&&this.managers._get(f3).setHotKeyTips(su.shift,uP(\"web.p_wayline.snap_to_change_degrees\")),!0}}}return!1}generateDragStatus(e,a,r){let t=this.managers._get(f3)?.viewer.camera;if(!t)return null;let n=this.positionCartesian3,i=hr[a],o=uf.Matrix4.multiplyByPointAsVector(this.transformMatrix,i,new uf.Cartesian3);if(\"axis\"===r){let i=uf.Plane.fromPointNormal(n,uf.Cartesian3.normalize(t.directionWC,new uf.Cartesian3)),s=uf.Cartesian3.add(n,o,new uf.Cartesian3),l=uf.Plane.projectPointOntoPlane(i,s),d=uf.Cartesian3.subtract(l,n,new uf.Cartesian3),c=uf.Cartesian3.normalize(d,new uf.Cartesian3),u=1/uf.Cartesian3.magnitude(d),p=t.getPickRay(e);if(!p)return null;let m=uf.IntersectionTests.rayPlane(p,i);if(!m)return null;let h=uf.Cartesian3.subtract(m,n,new uf.Cartesian3),g=uf.Cartesian3.dot(h,c)*u;return{direction:a,operation:r,origin:n,plane:i,directionOnPlane:c,startOffset:g,rate:u}}if(\"rotate\"===r){let i=uf.Plane.fromPointNormal(n,o),s=t.getPickRay(e);if(!s)return null;let l=uf.IntersectionTests.rayPlane(s,i);if(!l)return null;let d=uf.Cartesian3.subtract(l,n,new uf.Cartesian3),c=uf.Cartesian3.cross(o,d,new uf.Cartesian3),u=ht[a],p=uf.Matrix4.multiplyByPoint(this.transformMatrixInverse,l,new uf.Cartesian3),m=Math.sign(uf.Cartesian3.cross(p,u,new uf.Cartesian3)[\"red\"===a?\"z\":\"green\"===a?\"x\":\"y\"])*uf.Cartesian3.angleBetween(u,p);return{direction:a,operation:r,origin:n,plane:i,startVector:d,positiveVector:c,startRotateAngle:m}}return null}checkIfViewDirectionParallel(e,a){let r=hr[e],t=uf.Matrix4.multiplyByPoint(this.modelMatrix,r,new uf.Cartesian3),n=uf.Cartesian3.subtract(t,this.positionCartesian3,new uf.Cartesian3),i=uf.Cartesian3.angleBetween(n,a);return!!((\"green\"===e?i:Math.abs(Math.PI-i))<5*uf.Math.RADIANS_PER_DEGREE)||!1}onDrag(e){if(this.draggingStatus){let a=this.managers._get(f3)?.viewer.camera;if(!a||this.checkIfViewDirectionParallel(this.draggingStatus.direction,a.directionWC))return;let r=a.getPickRay(e.endPosition);if(!r)return;let t=uf.IntersectionTests.rayPlane(r,this.draggingStatus.plane);if(!t)return;let n=uf.Cartesian3.subtract(t,this.draggingStatus.origin,new uf.Cartesian3),i=hr[this.draggingStatus.direction];if(\"axis\"===this.draggingStatus.operation){let e=uf.Cartesian3.dot(n,this.draggingStatus.directionOnPlane)*this.draggingStatus.rate,a=uf.Cartesian3.multiplyByScalar(i,e-this.draggingStatus.startOffset,new uf.Cartesian3);this.translate(a),this.properties.onDragMove?.(uf.Matrix4.fromTranslation(uf.Matrix4.multiplyByPointAsVector(this.transformMatrix,a,new uf.Cartesian3)))}else if(\"rotate\"===this.draggingStatus.operation){let e=this.draggingStatus.startVector,a=this.draggingStatus.positiveVector,r=uf.Cartesian3.dot(n,e)/(uf.Cartesian3.magnitude(n)*uf.Cartesian3.magnitude(e)),t=(uf.Cartesian3.dot(n,a)>0?1:-1)*uf.Math.acosClamped(r);if(this._shiftHotkeyEnable){let e=uf.Math.PI_OVER_SIX/2,a=t/e;t=(a=a-Math.floor(a)>.5?Math.ceil(a):Math.floor(a))*e}this.rotate(uf.Matrix3.fromQuaternion(uf.Quaternion.fromAxisAngle(i,t)));let o=uf.Matrix4.multiplyByPointAsVector(this.transformMatrix,i,new uf.Cartesian3),s=this.draggingStatus.origin,l=uf.Matrix4.fromRotation(uf.Matrix3.fromQuaternion(uf.Quaternion.fromAxisAngle(o,t))),d=uf.Matrix4.fromTranslation(s),c=uf.Matrix4.inverse(d,new uf.Matrix4);this.properties.onDragMove?.(uf.Matrix4.multiply(uf.Matrix4.multiply(d,l,new uf.Matrix4),c,new uf.Matrix4))}}}translate(e){this.updateModelMatrix(uf.Matrix4.multiply(this.transformMatrix,uf.Matrix4.fromTranslation(e),new uf.Matrix4))}rotate(e){this.updateModelMatrix(uf.Matrix4.multiply(this.transformMatrix,uf.Matrix4.fromRotation(e),new uf.Matrix4))}endDrag(){this.togglePartShowState(!1),this.managers._get(f3)?.hover.setCursor(\"\",\"temporary\"),this.draggingStatus=null,this.updateModelMatrix(uf.Transforms.headingPitchRollToFixedFrame(this.positionCartesian3,this.headingPitchRoll)),this.properties.onDragEnd?.(),this.managers._get(f3).setHotKeyTips(su.shift,\"\")}togglePartShowState(e){if(!this.draggingStatus)return;let{direction:a}=this.draggingStatus;\"rotate\"===this.draggingStatus.operation&&this.toggleRotateHelperElements(e,a),!e&&this.toggleTranslateHelperLine(!1,a)}createHelperLinePrimitive(e){let a=hn.getTranslateHelperPositions(this.modelMatrix,e),r=this.getColor(`${e}_axis_color`);this.isOnlyOneAxis&&hn.YColor.clone(r);let t=new uf.GeometryInstance({geometry:new uf.PolylineGeometry({positions:a,vertexFormat:uf.PolylineMaterialAppearance.VERTEX_FORMAT,arcType:uf.ArcType.NONE})}),n=r.clone(),i=new uf.PolylineMaterialAppearance({material:uf.Material.fromType(\"Color\",{color:n.brighten(.5,n)})}),o=r.clone(),s=new uf.PolylineMaterialAppearance({material:uf.Material.fromType(\"PolylineDash\",{color:o.brighten(.5,o)})});return new uf.Primitive({geometryInstances:t,appearance:i,depthFailAppearance:s,asynchronous:!1})}toggleTranslateHelperLine(e,a){this.managers._keys().forEach(r=>{let t=this.managers._get(r).viewer.scene.primitives,n=this.primitives._get(r).translate_helper;if(e){n&&n instanceof uf.Primitive&&t.contains(n)&&t.remove(n);let e=this.createHelperLinePrimitive(a);t.add(e),this.primitives._get(r).translate_helper=e}else t.remove(n)})}toggleRotateHelperElements(e,a){m7.forEach(r=>{let t=this.primitives[r];if(t){if(he.includes(r)){t.showSetter(e);let n=this.getBeforeRotateMatrix(r,!1);if(t.modelMatrixSetter(uf.Matrix4.multiply(this.modelMatrix,n,new uf.Matrix4)),\"radiusFat\"===r||\"radiusThin\"===r){let e=`${a}_axis_color`;t.colorSetter(this.getColor(e))}}else!r.includes(a)&&t.showSetter(!e&&!!this.properties.show)}})}setHoverStyle(e,a){let r=e.id;if(he.includes(r))return;let[t,n]=r.split(\"_\"),i=`${t}_${n}_color`,o=this.getColor(i);this.isOnlyOneAxis&&hn.YColor.clone(o);let s=!!this.properties.doubleSideAxis&&\"axis\"===n,l=o.brighten(.4,new uf.Color),d=this.primitives[i];if(a?(d.silhouetteColorSetter(l),d.silhouetteSizeSetter(2)):(d.silhouetteColorSetter(o),d.silhouetteSizeSetter(0)),s){let e=`${i}_mirror`,r=this.primitives[e];a?(r.silhouetteColorSetter(l),r.silhouetteSizeSetter(2)):(r.silhouetteColorSetter(o),r.silhouetteSizeSetter(0))}\"axis\"===n&&this.toggleTranslateHelperLine(a,t),this.managers.render?.()}update(e){let a=this.properties;if((0,pg.ri)(e.show)){a.show=e.show,m7.forEach(r=>{if(he.includes(r)&&!0===e.show)return;let t=this.primitives[r];if(t&&t.showSetter(e.show),a.doubleSideAxis&&r.includes(\"axis\")){let a=this.primitives[`${r}_mirror`];a&&a.showSetter(e.show)}});let r=this.primitives._get(f3)?.translate_helper;r&&!1===e.show&&this.managers._get(f3).viewer.scene.primitives.remove(r)}let r=!1;if((0,pg.ri)(e.position)&&(a.position=e.position,r=!0),(0,pg.ri)(e.headingPitchRoll)&&(a.headingPitchRoll=e.headingPitchRoll,r=!0),(0,pg.ri)(e.distanceDisplayCondition)){a.distanceDisplayCondition=e.distanceDisplayCondition;let[r,t]=e.distanceDisplayCondition;this.primitives._values().forEach(e=>{Object.values(e).forEach(e=>{e instanceof uf.Model&&(e.distanceDisplayCondition=new uf.DistanceDisplayCondition(r,t))})})}r&&this.partModelReadyPromise.then(()=>{this.calculateProps(),this.managers.render?.()})}hasElementEditing(){let e=this.managers._get(f3).editor.activeElement;return e?.active()}onCameraChanged(e){if(!1===this.parallelAxisRenderOptimize||!this.hasElementEditing()||!this.show)return;let a=this.properties.directionUsed;!a&&(a=[\"green\",\"red\",\"blue\"]);let r=this.primitives._get(f3);if(!!r)a.forEach(a=>{let t=this.checkIfViewDirectionParallel(a,e.directionWC);[`${a}_axis_color`,`${a}_axis_color_mirror`,`${a}_axis_mask`,`${a}_axis_mask_mirror`].forEach(e=>{let a=r[e];a&&(a.show=!t)})}),this.managers.render?.()}onManagerAdd(e){this.addPrimitives(e),this.managers._get(e).addListener(\"cameraChanged\",this.onCameraChanged.bind(this))}onManagerRemove(e){this.removePrimitives(e),this.managers._get(e)?.removeListener(\"cameraChanged\",this.onCameraChanged.bind(this))}onManagerUpdate(e){let a=this.primitives._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}hasPrimitive(e){return this.primitives._keys().some(a=>{let r=this.primitives._get(a);return m7.some(a=>{let t=r[a]===e;return a.includes(\"axis\")?t||r[`${a}_mirror`]===e:t})})}removePrimitives(e){let a=this.primitives._get(e),r=this.managers._get(e);if(r&&a){let e=r.viewer.scene.primitives;m7.forEach(r=>{if(a[r]&&e.remove(a[r]),r.includes(\"axis\")&&this.properties.doubleSideAxis){let t=a[`${r}_mirror`];e.remove(t)}}),a.translate_helper&&e.remove(a.translate_helper)}this.primitives._remove(e)}onMouseEnter(e){!this.properties.hoverCursor&&this.managers._get(f3)?.hover.setCursor(\"grab\",\"hover\"),this.setHoverStyle(e,!0),super.onMouseEnter(e)}onMouseLeave(e){this.setHoverStyle(e,!1)}destroy(){this.managers._get(f3)?.removeListener(\"cameraChanged\",this.onCameraChanged.bind(this)),this.togglePartShowState(!1),this.primitives._keys().forEach(e=>{this.removePrimitives(e)}),this.removeCollectionMap()}}let hi={bottom:\"bottom\",top:\"top\",side:\"side\"};function ho(e,a,r,t){let n=`${e}_${a}_${hi[r]}`;return\"number\"==typeof t&&(n+=`_${t}`),n}function hs(e,a){let[r,t,n,i]=e.split(\"_\");if(t===a){let e=\"\";if(Object.keys(hi).forEach(a=>{hi[a]===n&&(e=a)}),e)return[e,Number(i)]}return!1}class hl{dragStatus=null;edgeDraggable=!1;canDrag(e,a){if(this.edgeDraggable&&!(0,pg.ri)(e)&&\"string\"==typeof a?.id){let e=hs(a?.id,this.id);if(e){let[a,r]=e;switch(a){case\"bottom\":case\"top\":return\"vertical\";case\"side\":return\"horizontal\"}}}return!1}startDrag(e,a,r){let t=hs(r?.id,this.id),n=this.managers._get(f3).viewer;if(t&&n){let r=n.scene.camera.getPickRay(e.position),[i,o]=t;if(\"vertical\"===a){let e;if(\"bottom\"===i?e=p8(this.height||0):\"top\"===i&&(e=p8(this.absoluteHeight)),e&&r){let a=uf.IntersectionTests.rayEllipsoid(r,e);if(a){let e=uf.Ray.getPoint(r,a.start||a.stop);return this.dragStatus={type:i},{position:e,clampToGround:!1}}}}else if(\"horizontal\"===a&&\"side\"===i&&\"number\"==typeof o){let e=this.startDragSide?.(o,r);if(e)return e}}return!1}onDrag(e,a){if(this.dragStatus){let e=(0,pg.KO)(a,!0);if(\"bottom\"===this.dragStatus.type&&(0,pg.ri)(e.height)&&e.height<this.absoluteHeight-.5){this.update({height:e.height,extrudedHeight:this.absoluteHeight-e.height});return}if(\"top\"===this.dragStatus.type&&(0,pg.ri)(e.height)){let a=this.height||0;e.height>a+.5&&this.update({extrudedHeight:e.height-a})}\"side\"===this.dragStatus.type&&\"number\"==typeof this.dragStatus.index&&this.updateSide?.(e)}}}function hd(e){let a=(0,pg.ri)(e.outColorCssString)?e.outColorCssString:\"#FF0000\",r=(0,pg.ri)(e.innerColorCssString)?e.innerColorCssString:\"#00FF00\",t=(0,pg.ri)(e.outAlpha)&&e.outAlpha>=0&&e.outAlpha<=1?e.outAlpha:.3,n=(0,pg.ri)(e.innerAlpha)&&e.innerAlpha>=0&&e.innerAlpha<=1?e.innerAlpha:.2;return new uf.Material({fabric:{type:\"DoubleSideSolidColor\",uniforms:{outColor:uf.Color.fromCssColorString(a),innerColor:uf.Color.fromCssColorString(r),outAlpha:t,innerAlpha:n},source:\"czm_material czm_getMaterial(czm_materialInput materialInput) {\\n czm_material m = czm_getDefaultMaterial(materialInput);\\n float side = dot(materialInput.positionToEyeEC, materialInput.normalEC);\\n m.alpha = side < 0.0 ? innerAlpha : outAlpha;\\n m.diffuse = side < 0.0 ? vec3(innerColor) : vec3(outColor);\\n return m;\\n}\"},translucent:e=>1!==e.uniforms.outAlpha&&1!==e.uniforms.innerAlpha})}let hc=uf.Math.DEGREES_PER_RADIAN;class hu{static fromLngLat(e,a,r=0){return{longitude:e,latitude:a,height:r}}static from(e,a){let r=hu.fromLngLat(e.longitude,e.latitude,e.height);return a.longitude&&(r.longitude=a.longitude),a.latitude&&(r.latitude=a.latitude),a.height&&(r.height=a.height),r}static clone(e){return hu.fromLngLat(e.longitude,e.latitude,e.height)}static zero(){return hu.fromLngLat(0,0)}static fromCartesian(e){let a=uf.Cartographic.fromCartesian(e);return{longitude:a.longitude*hc,latitude:a.latitude*hc,height:a.height}}}class hp extends(0,uX.AF)(pv,ph,pz,hl,pw){managers;properties;interactLevel;primitives;transformer;localMatrix;isAreaExceed;dragging;beforeDraggingRadius;beforeDraggingExtrudedHeight;beforeDraggingArea;constructor(e,a){super(),this.managers=a,this.interactLevel=sc.Area,this.primitives=py({}),this.localMatrix=uf.Matrix4.IDENTITY,this.isAreaExceed=!1,this.dragging=!1,this.beforeDraggingRadius=0,this.beforeDraggingExtrudedHeight=0,this.beforeDraggingArea=0,this.helperRadiusLine=void 0,this.helperSideLine=void 0,this.activeState={selected:!1,recenter:!1,hover:!1},this.properties=Object.assign({id:(0,uW.k)(),show:!0,type:\"cylinder\"},e),this.transformer=new hn({show:!1,headingPitchRoll:hn.EnuOrientationHpr,doubleSideAxis:!0,disableRotate:!0,directionUsed:[\"blue\"],onDragStart:this.onTransformerDragStart.bind(this),onDragMove:this.onTransformerDragMove.bind(this),onDragEnd:this.onTransformerDragEnd.bind(this)},a),this.init(),this.setCollectionMap()}get id(){return this.properties.id}get type(){return\"cylinder\"}get typedElement(){return{type:this.type,element:this}}get center(){return this.properties.center}get height(){return Number(this.properties.height)}get extrudedHeight(){return Number(this.properties.extrudedHeight)}get absoluteHeight(){return Number(this.height)+Number(this.extrudedHeight)}get cssColor(){return this.properties.cssColor}get outlineWidth(){return this.properties.outlineWidth}get modelMatrix(){return this.localMatrix}get circlePoints(){return mF(this.properties.center,this.properties.radius)}get averageCenter(){let e={longitude:0,latitude:0,height:this.height+this.extrudedHeight/2};return this.center&&(e.longitude=this.center.longitude,e.latitude=this.center.latitude),e}get radius(){return this.properties.radius}setCollectionMap(){this.managers._options.elements.add(\"cylinder\",this,[this.id])}get errorCssColor(){return this.properties.errorCssColor||\"#FFFFFF\"}update(e){let a=!1;Object.keys(e).forEach(r=>{let t=e[r];(0,pg.ri)(t)&&(this.properties[r]=t,[\"center\",\"radius\",\"height\",\"extrudedHeight\"].includes(r)&&(a=!0))}),this.render(),a&&(this.emitAreaExceed(),this.active()&&(this.managers.editor?.updatePositionsFor?.(this),this.updateEditingHelperLine(f3))),this.managers.render?.()}render(){this.primitives._keys().forEach(e=>{this.center&&this.radius&&(this.updateTransformer(),this.updatePolygonPrimitive(e),this.updatePolylinePrimitive(e))})}getTopArea(){let e=this.radius||0;return Math.PI*e*e}getAllArea(){let e=Math.PI*(this.radius||0)*2;return this.getTopArea()+e*this.extrudedHeight}checkAreaExceed(){let e={isAreaExceed:!1,areaChangeMode:sb.none},a=this.getTopArea(),r=this.getAllArea();if(this.properties.maxTopArea&&this.properties.maxAllArea){let t=a>this.properties.maxTopArea||r>this.properties.maxAllArea;e.isAreaExceed=t;let n=r>this.beforeDraggingArea?sb.grow:sb.shrink;e.areaChangeMode=n}return e}emitAreaExceed(){let{isAreaExceed:e,areaChangeMode:a}=this.checkAreaExceed();this.isAreaExceed!==e&&this.properties.needCheckArea&&(this.isAreaExceed=e,this.managers._get(f3).emit(\"elementAreaOversize\",this,{exceed:e,changeMode:a,origin:this.origin}))}onManagerAdd(e){this.addPrimitives(e),this.emitAreaExceed()}onManagerRemove(e){this.removePrimitives(e)}onManagerUpdate(e){let a=this.primitives._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}hasPrimitive(e){return this.primitives._keys().some(a=>{let r=this.primitives._get(a);return r.polygon===e||r.polyline===e})}addPrimitives(e){!this.primitives._get(e)&&this.primitives._add(e,{}),this.center&&this.radius&&(this.updatePolygonPrimitive(e),this.updatePolylinePrimitive(e))}updateModelMatrix(e){this.localMatrix=e,this.render()}updatePolygonPrimitive(e){let a=this.primitives._get(e),r=this.managers._get(e),t=r.viewer.scene.primitives;r&&a&&(a.polygon&&t.remove(a.polygon),a.polygon=void 0,this.properties.show&&(a.polygon=t.add(function(e){let a=new uf.PolygonGeometry(e.getPolygonGeometryOptions()),r=new uf.GeometryInstance({geometry:a,id:e.id}),t=hd(e.getPolygonMaterialOptions()),n=new uf.MaterialAppearance({material:t,faceForward:!1});return new uf.Primitive({geometryInstances:[r],appearance:n,asynchronous:!1,modelMatrix:e.modelMatrix})}(this))))}updatePolylinePrimitive(e){let a=this.primitives._get(e),r=this.managers._get(e),t=r.viewer.scene.primitives;r&&a&&(a.polyline&&t.remove(a.polyline),a.polyline=void 0,this.properties.show&&this.properties.outlined&&(a.polyline=t.add(function(e){let a=e.active(),r=e.circlePoints,t=[...r,r[0]],n=new uf.PolylineGeometry({positions:t.map(a=>(a.height=Number(e.height)+Number(e.extrudedHeight),(0,pg.jL)(a))),width:a?2*(e.outlineWidth||3):e.outlineWidth||2,vertexFormat:uf.PolylineMaterialAppearance.VERTEX_FORMAT}),i=new uf.GeometryInstance({geometry:n,id:ho(\"cylinder\",e.id,\"top\")}),o=new uf.PolylineGeometry({positions:t.map(a=>(a.height=e.height,(0,pg.jL)(a))),width:a?2*(e.outlineWidth||3):e.outlineWidth||2,vertexFormat:uf.PolylineMaterialAppearance.VERTEX_FORMAT}),s=new uf.GeometryInstance({geometry:o,id:ho(\"cylinder\",e.id,\"bottom\")}),l=e.isAreaExceed?e.errorCssColor:e.cssColor,d=new uf.PolylineMaterialAppearance({material:new uf.Material({fabric:{type:uf.Material.PolylineOutlineType,uniforms:{color:uf.Color.fromCssColorString(l||\"#fff\"),outlineColor:uf.Color.fromCssColorString(a?pI:l||\"#fff\"),outlineWidth:a?e.outlineWidth||3:0}}})}),c=new uf.PolylineMaterialAppearance({material:new uf.Material({fabric:{type:uf.Material.PolylineDashType,uniforms:{color:uf.Color.fromCssColorString(l||\"#fff\"),gapColor:new uf.Color(0,0,0,0),dashLength:16,dashPattern:255}}})});return new uf.Primitive({geometryInstances:[i,s],asynchronous:!1,appearance:d,depthFailAppearance:c,modelMatrix:e.modelMatrix})}(this))))}updateEditingHelperLine(e){let a=this.managers._get(e),r=a.viewer.scene.primitives;if(a){if(this.removeEditingHelperLinePrimitive(),(this.activeState.hover||this.activeState.selected)&&this.properties.show){let e=this.createHelperRadiusLinePrimitive();e&&(e.forEach(e=>r.add(e)),this.helperRadiusLine=e[0],this.helperSideLine=e[1])}a.render()}}removePrimitives(e){let a=this.primitives._get(e),r=this.managers._get(e);if(r&&a){let e=r.viewer.scene.primitives,t=a.polygon,n=a.polyline;t&&e.remove(t),n&&e.remove(n)}this.primitives._remove(e),this.removeEditingHelperLinePrimitive(e)}onTransformerDragStart(e){this.transformType=e,this.transformState=\"changing\"}onTransformerDragMove(e){this.updateModelMatrix(e),this.helperRadiusLine&&(this.helperRadiusLine.modelMatrix=this.localMatrix),this.helperSideLine&&(this.helperSideLine.modelMatrix=this.localMatrix),this.managers.render?.()}onTransformerDragEnd(){if(!this.center)return;let e=(0,pg.KO)(uf.Matrix4.multiplyByPoint(this.localMatrix,(0,pg.jL)(this.center),new uf.Cartesian3),!0);this.localMatrix=uf.Matrix4.IDENTITY,this.update({center:e,height:e.height});let a=\"rotate\"===this.transformType?\"rotate\":\"translate\";this.managers.editor?.updatePositionsFor?.(this,!0,a),this.transformType=\"\",this.updateEditingHelperLine(f3),this.transformState=\"static\"}updateTransformer(){this.transformer.update({position:this.averageCenter})}stabilize(){}destroy(){this.transformer.destroy(),this.primitives._keys().forEach(e=>{this.removePrimitives(e)}),this.removeCollectionMap()}getPolygonMaterialOptions(){let e=this.isAreaExceed;return{outColorCssString:e?this.properties.errorCssColor:this.properties.cssColor,innerColorCssString:e?this.properties.errorCssColor:this.properties.innerCssColor,outAlpha:(0,pg.ri)(this.properties.areaAlpha)?this.properties.areaAlpha:.3,innerAlpha:.4}}getPolygonGeometryOptions(){return this.properties.center&&this.properties.radius?{closeBottom:!!this.properties.closeBottom,closeTop:!!this.properties.closeTop,height:Number(this.properties.height),extrudedHeight:Number(this.properties.height)+Number(this.properties.extrudedHeight),polygonHierarchy:new uf.PolygonHierarchy(this.circlePoints.map(e=>(0,pg.jL)(e,!0)))}:{polygonHierarchy:new uf.PolygonHierarchy}}getEditActivePoints(){let e=this.center,a=this.circlePoints;if(!e||!Array.isArray(a)||0===a.length||!1===this.properties.show)return;let r=Number(this.height)+Number(this.extrudedHeight),t=hu.from(e,{height:r}),n=hu.from(a[0],{height:this.height}),i=hu.from(n,{height:r});return[[hu.from(e,{height:this.height}),n],[t,i]]}helperRadiusLine;helperSideLine;createHelperRadiusLinePrimitive(){let e=this.getEditActivePoints();if(!e)return;let[[a,r],[t,n]]=e,i=(0,pg.jL)(a),o=(0,pg.jL)(t),s=(0,pg.jL)(r),l=(0,pg.jL)(n),d=new uf.PolylineMaterialAppearance({material:uf.Material.fromType(uf.Material.PolylineDashType,{color:uf.Color.fromCssColorString(\"#2D8CF0\").brighten(.6,new uf.Color)})}),c=new uf.GeometryInstance({geometry:new uf.PolylineGeometry({positions:[o,l],width:2})}),u=new uf.GeometryInstance({geometry:new uf.PolylineGeometry({positions:[i,s],width:2})}),p=new uf.Primitive({geometryInstances:[c,u],allowPicking:!1,appearance:d,modelMatrix:this.localMatrix,asynchronous:!1}),m=this.isAreaExceed,h=new uf.PolylineMaterialAppearance({material:uf.Material.fromType(uf.Material.PolylineOutlineType,{color:uf.Color.fromCssColorString((m?this.properties.errorCssColor:this.cssColor)||\"#fff\"),outlineColor:uf.Color.fromCssColorString(\"#fff\"),outlineWidth:3})}),g=new uf.GeometryInstance({geometry:new uf.PolylineGeometry({positions:[s.clone(),l.clone()],width:6})});return[p,new uf.Primitive({geometryInstances:[g],allowPicking:!1,appearance:h,modelMatrix:this.localMatrix,asynchronous:!1})]}removeEditingHelperLinePrimitive(e=f3){let a=this.managers._get(e).viewer.scene.primitives;this.helperRadiusLine&&a.remove(this.helperRadiusLine),this.helperSideLine&&a.remove(this.helperSideLine)}activeState;toggleActive(){this.updateEditingHelperLine(f3),this.primitives._keys().forEach(e=>{this.updatePolylinePrimitive(e)})}cleanDragging(){this.beforeDraggingRadius=0,this.beforeDraggingExtrudedHeight=0,this.beforeDraggingArea=0}resetPositions(){this.update({radius:this.beforeDraggingRadius,extrudedHeight:this.beforeDraggingExtrudedHeight}),this.managers.editor?.updatePositionsFor?.(this)}startDrag(e,a,r){return this.setDragging(!0),super.startDrag(e,a,r)}setDragging(e){if(this.dragging!==e){if(this.dragging=e,e)this.beforeDraggingRadius=this.radius||0,this.beforeDraggingExtrudedHeight=this.extrudedHeight,this.beforeDraggingArea=this.getAllArea();else{let{isAreaExceed:e,areaChangeMode:a}=this.checkAreaExceed();e&&a===sb.grow&&this.beforeDraggingRadius&&this.beforeDraggingArea&&this.resetPositions(),this.cleanDragging()}}}active(e=\"\",a){if(!this.properties.fromDraw)return!1;if((0,pg.ri)(a)&&e&&this.activeState[e]!==a&&(this.activeState[e]=a,this.toggleActive()),e)return this.activeState[e];{let{selected:e,recenter:a,hover:r}=this.activeState;return e||a||r}}static EditingCursor=\"default\";edit(e){this.managers._get(f3)?.editor?.enterEdit?.(\"cylinder\",this,e),this.managers._get(f3).hover.setCursor(hp.EditingCursor,\"hover\"),this.transformer.update({show:!0,position:this.averageCenter});let a=this.managers._get(f3).viewer.camera;this.transformer.onCameraChanged(a),this.edgeDraggable=!0}exitEdit(){this.removeEditingHelperLinePrimitive(),this.transformer.update({show:!1}),this.transformer.onDragging&&(this.localMatrix=uf.Matrix4.IDENTITY,this.transformer.endDrag()),this.edgeDraggable=!1}getPickingPlane(e){if(!this.center)return null;let a=\"bottom\"===e?hu.from(this.center,{height:this.height}):hu.from(this.center,{height:this.extrudedHeight+this.height}),r=(0,pg.jL)(a),t=uf.Cartesian3.normalize(r,new uf.Cartesian3);return uf.Plane.fromPointNormal(r,t)}endDrag(){this.setDragging(!1);let e=this.getEditActivePoints()?.flat();return e&&this.managers._get(f3).emit(\"finishEdit\",{type:\"cylinder\",origin:this,changeType:\"edge\",shape:e}),null}onMouseEnter(e){let a=hs(String(e.id),this.id);if(!1===a)return;let r=this.managers._get(f3).hover;this.activeState.selected&&[\"bottom\",\"top\"].includes(a[0])&&(r.setCursor(\"ns-resize\",\"hover\"),r.isCylinderHovering.value=!0)}onMouseLeave(e){if(!1!==hs(String(e.id),this.id))this.managers._get(f3).hover.setCursor(\"\",\"hover\"),this.managers._get(f3).hover.isCylinderHovering.value=!1}}class hm"
}