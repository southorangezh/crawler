{
  "metadata": {
    "source_file": "map-app\\static\\js\\index.5da8ba4c.js",
    "chunk_index": 12,
    "total_chunks": 918,
    "chunk_size": 69021,
    "word_count": 800,
    "model_kwargs": {
      "model": "text-embedding-3-large",
      "dimensions": 3072,
      "encoding_format": "float"
    },
    "text_splitter": {
      "split_by": "word",
      "chunk_size": 800,
      "chunk_overlap": 200
    },
    "created_at": "2025-12-17T23:57:50.146Z"
  },
  "content": "a=g?(t=o,n=l,gP[t]||n):l;e.fillColor=uf.Color.fromCssColorString(a)}e.showBackground=i,e.style=uf.LabelStyle.FILL,e.verticalOrigin=uf.VerticalOrigin.BOTTOM,e.horizontalOrigin=uf.HorizontalOrigin.CENTER,e.font=_,e.distanceDisplayCondition=b,e.scaleByDistance=k,e.backgroundPadding=new uf.Cartesian2(5,5),e.disableDepthTestDistance=Number.POSITIVE_INFINITY,e.depthFailTranslucency=.5,f.add(e)};return r.forEach(v),t.forEach(v),n.forEach(v),f}(this,n);t.labels=e,r.add(e)}}addPrimitives(e){this.updateAllPrimitives(e),this.managers._get(e).render()}onManagerAdd(e){this.addPrimitives(e)}onManagerRemove(e){this.removePrimitives(e)}onManagerUpdate(e){let a=this.primitives._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}setCollectionMap(){this.managers._options.elements.add(\"polyline-triangle\",this,[this.id])}removePrimitives(e){let a=this.primitives._get(e),r=this.managers._get(e);if(!r||!a)return;let t=r.primitiveContainers[\"polyline-triangle\"];for(let e in a){let r=a[e];r&&(t.remove(r),a[e]=void 0)}}destroy(){this.primitives._keys().forEach(e=>{this.removePrimitives(e)}),this.removeCollectionMap()}}function gF(e,a){let r=e.flat(),t=Math.min(...r),n=Math.max(...r),i=(n-t)*(a-1)/2;return n+=i,{min:t-=i,max:n}}function gL(e){return new uf.PolylineMaterialAppearance({material:uf.Material.fromType(uf.Material.PolylineDashType,{color:uf.Color.fromCssColorString(e)}),translucent:!1,renderState:{depthTest:!1}})}class gN extends(0,uX.AF)(pv,ph,pz){managers;properties;interactLevel;members;_minHeight;_maxHeight;constructor(e,a){super(),this.managers=a,this.interactLevel=sc.Area,this.members=py({}),this.properties=Object.assign({id:(0,uW.k)(),show:!0,type:\"polyline-profile\"},e),this.init(),this.setCollectionMap()}get id(){return this.properties.id||(0,uW.k)()}get show(){return!1!==this.properties.show}get positions(){return this.properties.positions||[]}get heights(){return this.properties.heights?.map(e=>e.data)||[]}get heightExtendFactor(){return pB.HeightScaleFactor}get lineCssColors(){return this.properties.heights?.map(e=>e.cssColor||pB.LineColor)||[]}get lineStyles(){return this.properties.heights?.map(e=>e.style||pB.LineStyle)||[]}get lineCssColorDefault(){return pB.LineColor}get solidLineIndexList(){return this.properties.heights?.reduce((e,a,r)=>(a?.style===\"solid\"&&e.push(r),e),[])??[]}get dashLineIndexList(){return this.properties.heights?.reduce((e,a,r)=>(a?.style===\"dash\"&&e.push(r),e),[])??[]}get polygonAlpha(){return pB.PolygonAlpha}get primaryLineWidth(){return pB.PrimaryLineWidth}get historyLineWidth(){return pB.HistoryLineWidth}get abovegroundCssColor(){return pB.AbovegroundColor}get undergroundCssColor(){return pB.UndergroundColor}get abovegroundPolygonInstanceId(){return`${this.id}-abovegroundPolygonInstance`}get undergroundPolygonInstanceId(){return`${this.id}-undergroundPolygonInstance`}get lineInstanceIdPrefix(){return`${this.id}-lineInstance`}get points(){return this.properties.pins||[]}get pointSize(){return pB.PointSize}get pointColor(){return pB.PointColor}get pointOutlineColor(){return pB.PointOutlineColor}get pointOutlineWidth(){return pB.PointOutlineWidth}get verticalLineColor(){return pB.VerticalLineColor}get verticalLineWidth(){return pB.VerticalLineWidth}get heightRange(){return this._minHeight&&this._maxHeight?{min:this._minHeight,max:this._maxHeight}:void 0}get boundingSphere(){let e=[];if(this.members._keys().forEach(a=>{let r=this.members._get(a);if(r&&r.polygons){let a=r.polygons.getGeometryInstanceAttributes(this.abovegroundPolygonInstanceId),t=r.polygons.getGeometryInstanceAttributes(this.undergroundPolygonInstanceId);a&&t&&(e.push(a.boundingSphere),e.push(t.boundingSphere))}}),2===e.length)return uf.BoundingSphere.union(e[0],e[1],new uf.BoundingSphere)}updateShow(){let e=this.show,a=this.members;a.polygons&&a.polygons.showSetter(e),a.lines&&a.lines.showSetter(e),a.points&&a.points.showSetter(e),a.verticalLine&&a.verticalLine.showSetter(e)}updatePrimitivesAllManager(){this.members._keys().forEach(e=>{this.updateAllPrimitives(e)})}updateAuxiliaryPrimitivesAllManager(){this.members._keys().forEach(e=>{this.updateAuxiliaryPrimitives(e)})}updatePolygonStyleAllManager(){this.members._keys().forEach(e=>{this.updatePolygonStyle(e)})}updateLineStyleAllManager(){this.members._keys().forEach(e=>{this.updateLineStyle(e)})}updatePolygonStyle(e){let a=this.members._get(e);if(!a)return;let{polygons:r}=a;if(!!r)[[this.abovegroundPolygonInstanceId,this.abovegroundCssColor],[this.undergroundPolygonInstanceId,this.undergroundCssColor]].forEach(([e,a])=>{let t=r.getGeometryInstanceAttributes(e);t&&(t.color=uf.ColorGeometryInstanceAttribute.toValue(uf.Color.fromCssColorString(a),t.color))})}updateLineStyle(e){let a=this.members._get(e);if(!a)return;let{lines:r}=a;if(!r)return;let t=r.get(0);for(let e of this.solidLineIndexList){let a=`${this.lineInstanceIdPrefix}-${e}`,r=this.lineCssColors[e],n=t.getGeometryInstanceAttributes(a);n&&(n.color=uf.ColorGeometryInstanceAttribute.toValue(uf.Color.fromCssColorString(r),n.color))}for(let e=0;e<this.dashLineIndexList.length;e++){let a=this.dashLineIndexList[e],t=gL(this.lineCssColors[a]);r.get(e+1).appearance=t}}update(e){let a=this.properties;(0,uf.defined)(e.show)&&(a.show=e.show,this.updateShow(),this.managers.render?.());let r=!1,t=!1;(0,uf.defined)(e.positions)&&(a.positions=e.positions,r=!0),(0,uf.defined)(e.heights)&&(a.heights=e.heights,r=!0),(0,uf.defined)(e.pins)&&(a.pins=e.pins,t=!0),r&&(this.updatePrimitivesAllManager(),this.managers.render?.(),r=!1),!r&&t&&(this.updateAuxiliaryPrimitivesAllManager(),this.managers.render?.(),t=!1)}updateAuxiliaryPrimitives(e){let a=this.managers._get(e);if(!a)return;let r=a.primitiveContainers[\"polyline-profile\"],t=this.members._get(e);if(!t)return;let{points:n,verticalLine:i}=t;if(i&&r.contains(i)&&r.remove(i),t.verticalLine=void 0,0===this.points.length){n&&r.contains(n)&&r.remove(n),t.points=void 0;return}let o=this.heightRange??gF(this.heights,this.heightExtendFactor),s=function(e,a){if(0===e.length)throw Error(`点数量必须大于0`);let r=e.map(e=>uf.Cartesian3.fromDegrees(e.longitude,e.latitude,e.height||0));return{pointsPositions:r,verticalLinePositions:[uf.Cartesian3.fromDegrees(e[0].longitude,e[0].latitude,a.min),uf.Cartesian3.fromDegrees(e[0].longitude,e[0].latitude,a.max)]}}(this.points,o),l=function(e,a){let{pointsPositions:r,verticalLinePositions:t}=a,n=[];for(let a=0;a<r.length;a++){let t=r[a],i=e.lineCssColors[a]||e.pointColor;n.push({position:t,pixelSize:e.pointSize,outlineWidth:e.pointOutlineWidth,color:uf.Color.fromCssColorString(i),outlineColor:uf.Color.fromCssColorString(e.pointOutlineColor),disableDepthTestDistance:Number.POSITIVE_INFINITY})}return{pointOptions:n,verticalLine:[new uf.GeometryInstance({geometry:new uf.PolylineGeometry({positions:t,width:e.verticalLineWidth})})]}}(this,s);if(!1!==this.properties.show){var d,c;let e=(d=this,c=l.verticalLine,new uf.Primitive({geometryInstances:c,appearance:new uf.PolylineMaterialAppearance({material:uf.Material.fromType(uf.Material.ColorType,{color:uf.Color.fromCssColorString(d.verticalLineColor)}),translucent:!0,renderState:{depthTest:!1}}),asynchronous:!1}));t.verticalLine=e,r.add(e)}if(n&&r.contains(n)){let{pointsPositions:e}=s;for(let a=0;a<n.length;a++){let r=n.get(a);r&&e[a]&&(r.position=e[a])}}else if(!1!==this.properties.show){let e=function(e){let a=new uf.PointPrimitiveCollection({blendOption:uf.BlendOption.OPAQUE});return e.forEach(e=>{a.add(e)}),a}(l.pointOptions);t.points=e,r.add(e)}}updateAllPrimitives(e){let a=this.managers._get(e);if(!a)return;let r=a.primitiveContainers[\"polyline-profile\"],t=this.members._get(e);!t&&(t={},this.members._add(e,t));let n=gF(this.heights,this.heightExtendFactor);this._minHeight=n.min,this._maxHeight=n.max;let i=function(e,a){let{undergroundPolygonPositionsArray:r,abovegroundPolygonPositionsArray:t,polygonIndices:n,linesPositions:i}=a,o=new uf.GeometryInstance({id:e.abovegroundPolygonInstanceId,geometry:new uf.Geometry({attributes:{position:new uf.GeometryAttribute({componentDatatype:uf.ComponentDatatype.DOUBLE,componentsPerAttribute:3,values:new Float64Array(t)})},indices:new Uint32Array(n),primitiveType:uf.PrimitiveType.TRIANGLES,boundingSphere:uf.BoundingSphere.fromVertices(t)}),attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(uf.Color.fromCssColorString(e.abovegroundCssColor).withAlpha(e.polygonAlpha))}}),s=new uf.GeometryInstance({id:e.undergroundPolygonInstanceId,geometry:new uf.Geometry({attributes:{position:new uf.GeometryAttribute({componentDatatype:uf.ComponentDatatype.DOUBLE,componentsPerAttribute:3,values:new Float64Array(r)})},indices:new Uint32Array(n),primitiveType:uf.PrimitiveType.TRIANGLES,boundingSphere:uf.BoundingSphere.fromVertices(r)}),attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(uf.Color.fromCssColorString(e.undergroundCssColor).withAlpha(e.polygonAlpha))}}),l=[];for(let a=0;a<i.length;a++){let r;let t=0===a?e.primaryLineWidth:e.historyLineWidth,n=e.lineCssColors[a]||e.lineCssColorDefault;r=\"solid\"===e.lineStyles[a]?new uf.GeometryInstance({id:`${e.lineInstanceIdPrefix}-${a}`,geometry:new uf.PolylineGeometry({positions:i[a],width:t,vertexFormat:uf.PolylineColorAppearance.VERTEX_FORMAT}),attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(uf.Color.fromCssColorString(n))}}):new uf.GeometryInstance({geometry:new uf.PolylineGeometry({positions:i[a],width:t})}),l.push(r)}return{polygons:[o,s],lines:l}}(this,function(e,a,r){let t=e.length;if(t<2)throw Error(`采样点数量必须大于2`);for(let e of a)if(e.length!==t)throw Error(`采样点坐标与高程点数量不匹配`);if(a.length<1)throw Error(`模型高度线数量必须大于0`);let n=a[0],i=[];for(let a=0;a<t;a++)i.push({longitude:e[a].longitude,latitude:e[a].latitude,height:n[a]});let{undergroundPolygonPositionsArray:o,abovegroundPolygonPositionsArray:s,polygonIndices:l}=function(e,a){let r=e.length,t=[],n=[],i=[];for(let o=0;o<r;o++){let s=e[o],l=uf.Cartesian3.fromDegrees(s.longitude,s.latitude,s.height||0),d=uf.Cartesian3.fromDegrees(s.longitude,s.latitude,a.min),c=uf.Cartesian3.fromDegrees(s.longitude,s.latitude,a.max);n.push(l.x,l.y,l.z),n.push(c.x,c.y,c.z),i.push(d.x,d.y,d.z),i.push(l.x,l.y,l.z);let u=2*o,p=2*o+1,m=2*o+2,h=2*o+3;o!==r-1&&(t.push(u,p,m),t.push(p,h,m))}return{undergroundPolygonPositionsArray:i,abovegroundPolygonPositionsArray:n,polygonIndices:t}}(i,r);return{undergroundPolygonPositionsArray:o,abovegroundPolygonPositionsArray:s,polygonIndices:l,linesPositions:function(e,a){let r=[];for(let t=0;t<a.length;t++){let n=[];for(let r=0;r<a[t].length;r++)n.push(uf.Cartesian3.fromDegrees(e[r].longitude,e[r].latitude,a[t][r]));r.push(n)}return r}(e,a)}}(this.positions,this.heights,n)),{polygons:o,lines:s}=t;if(o&&r.contains(o)&&r.remove(o),t.polygons=void 0,s&&r.contains(s)&&r.remove(s),t.lines=void 0,!1!==this.properties.show){var l,d;let e=(l=0,d=i.polygons,new uf.Primitive({geometryInstances:d,appearance:new uf.PerInstanceColorAppearance({translucent:!0,flat:!0,renderState:{depthTest:!1}}),asynchronous:!1}));t.polygons=e,r.add(e);let a=function(e,a){let r=new uf.PrimitiveCollection,t=a.filter(e=>void 0!==e.attributes.color),n=new uf.Primitive({geometryInstances:t,appearance:new uf.PolylineColorAppearance({translucent:!1,renderState:{depthTest:!1}}),asynchronous:!1});r.add(n);for(let t=0;t<a.length;t++){if(void 0!==a[t].attributes.color)continue;let n=e.lineCssColors[t]||e.lineCssColorDefault,i=new uf.Primitive({geometryInstances:a[t],appearance:gL(n),asynchronous:!1});r.add(i)}return r}(this,i.lines);t.lines=a,r.add(a)}this.updateAuxiliaryPrimitives(e)}addPrimitives(e){this.updateAllPrimitives(e),this.managers._get(e).render()}setCollectionMap(){this.managers._options.elements.add(\"polyline-profile\",this,[this.id])}onManagerAdd(e){this.addPrimitives(e)}onManagerRemove(e){this.removePrimitives(e)}onManagerUpdate(e){let a=this.members._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}removePrimitives(e){let a=this.members._get(e),r=this.managers._get(e);if(!r||!a)return;let t=r.primitiveContainers[\"polyline-profile\"];a.polygons&&(t.remove(a.polygons),a.polygons=void 0),a.lines&&(t.remove(a.lines),a.lines=void 0),a.points&&(t.remove(a.points),a.points=void 0),a.verticalLine&&(t.remove(a.verticalLine),a.verticalLine=void 0),this._minHeight=void 0,this._maxHeight=void 0}destroy(){this.members._keys().forEach(e=>{this.removePrimitives(e)}),this.removeCollectionMap()}}function gJ(e){var a,r;return new uf.Appearance({renderState:{blending:uf.BlendingState.PRE_MULTIPLIED_ALPHA_BLEND,depthTest:{enabled:!0},depthMask:!0,lineWidth:1},translucent:!1,vertexShaderSource:(a=0,`in vec3 position3DHigh; in vec3 position3DLow; in vec4 color; in float batchId; out vec4 v_color; void main() { vec4 p = czm_computePosition(); v_color = color; gl_Position = czm_modelViewProjectionRelativeToEye * p; vec4 positionEC = czm_modelViewRelativeToEye * p; float distance = sqrt(dot(positionEC.xyz, positionEC.xyz)); float farDistance = 1400.0; float pointSize = farDistance / distance; pointSize = clamp(pointSize, 1.0, 12.0); gl_PointSize = pointSize; }`),fragmentShaderSource:(r=0,`in vec4 v_color; void main() { float innerPercent = 0.8; float outerPercent = 0.95; vec4 outlineColor = vec4(0.5, 0.5, 0.5, 1.0); float distanceToCenter = length(gl_PointCoord - vec2(0.5)); if (distanceToCenter > 0.5) discard; float innerAlpha = 1.0 - smoothstep(0.5 * innerPercent, 0.5 * outerPercent, distanceToCenter); // float wholeAlpha = 1.0 - smoothstep(0.5 * innerPercent, 0.5 * outerPercent, distanceToCenter); vec4 color = mix(outlineColor, v_color, innerAlpha); color.a *= innerAlpha; out_FragColor = color; }`)})}function gO(e,a){return new uf.Geometry({attributes:{position:new uf.GeometryAttribute({values:e,componentDatatype:uf.ComponentDatatype.DOUBLE,componentsPerAttribute:3}),color:new uf.GeometryAttribute({values:a,componentDatatype:uf.ComponentDatatype.FLOAT,componentsPerAttribute:4})},primitiveType:uf.PrimitiveType.POINTS,boundingSphere:uf.BoundingSphere.fromVertices(e)})}let gq=\"point-collection\";class gG extends(0,uX.AF)(pv,ph,pz){managers;interactLevel;properties;members;_boundingSphere;_center;constructor(e,a){super(),this.managers=a,this.interactLevel=sc.Thing,this.members=py({}),this.properties=Object.assign({id:(0,uW.k)(),type:gq},e),this.init(),this.setCollectionMap()}get id(){return this.properties.id??(0,uW.k)()}get colors(){return this.properties.colors?this.properties.colors:pV.DefaultColor}get positions(){return this.properties.positions}get pointCount(){return this.positions?.positions.length??0}get boundingSphere(){if(this._boundingSphere)return this._boundingSphere;let e=this.getPositionsWC();if(e)return this._boundingSphere=uf.BoundingSphere.fromPoints(e),this._boundingSphere}getColorNumArray(){if(\"string\"==typeof this.colors){let e=this.colors,a=[],r=uf.Color.fromCssColorString(e);return this.positions?.positions.forEach(()=>{a.push([r.red,r.green,r.blue,r.alpha])}),new Float32Array(a.flat())}return\"csshex\"===this.colors.format?new Float32Array(this.colors.colors.map(e=>{let a=uf.Color.fromCssColorString(e);return[a.red,a.green,a.blue,a.alpha]}).flat()):new Float32Array(this.colors.colors)}getPositionsWC(){if(!!this.positions){if(\"ENU\"===this.positions.mode){let{origin:e,positions:a}=this.positions,r=(0,pg.jL)(e),t=uf.Transforms.eastNorthUpToFixedFrame(r);return a.map(e=>uf.Matrix4.multiplyByPoint(t,uf.Cartesian3.fromArray(e),new uf.Cartesian3))}{let{positions:e}=this.positions;return e.map(e=>(0,pg.jL)(e))}}}getCenter(){return this._center?this._center:(this._center=this.boundingSphere?.center,this._center)}updateShow(){let e=!1!==this.properties.show,a=this.members;a.points&&a.points.showSetter(e)}updateStyle(e){let a=this.members._get(e).points;if(!a)return;let r=gJ(this);a.appearance=r}updateStyleAllManagers(){this.managers._keys().forEach(e=>{this.updateStyle(e)})}updatePoints(e){let a=this.managers._get(e);if(!a)return;let r=a.primitiveContainers[\"point-collection\"],t=this.members._get(e);!t&&(this.members._add(e,{}),t=this.members._get(e));let n=t.points;if(n&&r.contains(n)&&r.remove(n),t.points=void 0,!1===this.properties.show)return;let i=function(e){let a=e.positions,r=[],t=e.getColorNumArray();if(a){if(\"ENU\"===a.mode){let{origin:n,positions:i}=a,o=(0,pg.jL)(n),s=uf.Transforms.eastNorthUpToFixedFrame(o),l=gO(i.flat(),t);r.push(new uf.GeometryInstance({geometry:l,modelMatrix:s,id:`point-collection-${e.id}`}))}else{let{positions:n}=a,i=n.map(e=>(0,pg.jL)(e)),o=gO(uf.Cartesian3.packArray(i),t);r.push(new uf.GeometryInstance({geometry:o,id:`point-collection-${e.id}`}))}}let n=gJ(e);return new uf.Primitive({geometryInstances:r,appearance:n,allowPicking:!e.disableInteractive,asynchronous:!1})}(this);t.points=i,r.add(i)}updateAllManagers(){this.managers._keys().forEach(e=>{this.updatePoints(e),this.managers._get(e).render()})}update(e){let a=this.properties,r=!1,t=!1;(0,pg.ri)(e.show)&&a.show!==e.show&&(a.show=e.show,this.updateShow()),(0,pg.ri)(e.colors)&&(a.colors=e.colors,r=!0),(0,pg.ri)(e.positions)&&(t=!0),t&&(this.updateAllManagers(),r=!1),r&&this.updateStyleAllManagers()}addPointPrimitve(e){this.updatePoints(e)}removePointPrimitive(e){let a=this.members._get(e),r=this.managers._get(e);if(!a||!r)return;let t=r.primitiveContainers[\"point-collection\"],n=a.points;n&&(t.remove(n),a.points=void 0)}onManagerAdd(e){this.addPointPrimitve(e)}onManagerRemove(e){this.removePointPrimitive(e)}onManagerUpdate(e){let a=this.members._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}hasPrimitive(e){return this.members._keys().some(a=>{let r=this.members._get(a);return r&&r.points===e})}setCollectionMap(){this.managers._options.elements.add(gq,this,[this.id])}destroy(){this.members._keys().forEach(e=>{this.removePointPrimitive(e)}),this.removeCollectionMap()}}function gH(e){let a=e.drawer.drawingMode,r=e.drawingElementProps;return a===c2.oO.circle||a===c2.oO.line&&r[c2.oO.line]?.clampToGround||a===c2.oO.polygon&&r[c2.oO.polygon]?.clampToGround}function gB(e,a){var r,t;return(r=e)>=-180&&r<=180&&(t=a)>=-90&&t<=90}function gV(e,a,r,t){return gB(e,r)&&gB(a,t)&&e<=a&&r<=t}class gU{options;managers;_show;_parentShow;_grounded;groups;loader;groupElStat;groupElementTable;constructor(e,a){this.options=e,this.managers=a,this._show=!0,this._parentShow=!0,this._grounded=!1,this.groups=new Set,this.groupElStat={polyline:0,polygon:0,text:0},this.groupElementTable=[],this.loader=e.loader,(0,pg.ri)(this.options.show)&&(this._show=this.options.show),this._grounded=!!e.grounded,this.init()}addPolylineGroup_Deprecated(e,a){let r=[];a.forEach((e,a)=>{let t=e.map(e=>({longitude:e[0],latitude:e[1],height:Number.isNaN(e[2])?0:e[2]}));(\"CIRCLE\"===a.entityType||\"ELLIPSE\"===a.entityType)&&t.push(t[0]),r.push({positions:t})});let t=new pZ({category:this.options.dataset.category,id:e.groupKey,cssColor:e.color,positionsArray:r,show:this.computedShow,ground:this.grounded,occludedAlpha:.5,enableOccludedStyle:!0},this.managers);this.groups.add(t)}addPolylineGroup(e,a,r=!1){let{color:t}=e,n=[];a.forEach(({vertexDataArray:e,type:a})=>{e.forEach((e,r)=>{let t=[],i=!0;if(e.forEach(e=>{i=i&&function(e){if(e.length<2)return!1;let[a,r,t]=e,n=gB(a,r),i=\"number\"==typeof t&&!Number.isNaN(t)&&t>=-1e5&&t<=2e5;return n&&i}(e),t.push(hu.fromLngLat(e[0],e[1],Number.isNaN(e[2])?0:e[2]))}),!i){console.warn(`Dxf 图层: ${this.options.layer.name}, 该段 (${r}) 线数据不合法，无法绘制`);return}(\"CIRCLE\"===a||\"ELLIPSE\"===a)&&t.push(t[0]),n.push({id:a,positions:t})})});let i=new pZ({category:this.options.dataset.category,id:e.groupKey,cssColor:t,ground:this.grounded,show:this.computedShow,positionsArray:n,occludedAlpha:.5,enableOccludedStyle:!0,isLineSegments:r,contextmenu:this.options.dataset.contextMenu},this.managers);this.groups.add(i),this.groupElementTable.push({element:i,entityGroup:e,isLineSegmentGroup:r})}addTriangleMesh(e,a){let{color:r}=e,t=new gA({category:this.options.dataset.category,cssColor:r,show:this.computedShow,data:{vertices:uf.Cartesian3.packArray(a.vertexData.map(e=>uf.Cartesian3.fromDegrees(e[0],e[1],e[2]))),indices:a.indexData},enableOccludedStyle:!0,occludedAlpha:.6,alpha:.8,useOutline:!0},this.managers);this.groups.add(t)}addText(e,a){if(a.indices.reduce((e,a)=>Math.max(e,a),-1/0)>=a.vertices.length)return;let r=new gA({category:this.options.dataset.category,cssColor:e,show:this.computedShow,data:{vertices:uf.Cartesian3.packArray(a.vertices.map(e=>uf.Cartesian3.fromDegrees(e[0],e[1],e[2]))),indices:a.indices},enableOccludedStyle:!0,occludedAlpha:.4},this.managers);this.groups.add(r)}onRenderGroupLoaded(e,a,r){if(this.options.layer===a){let{renderPrimitiveType:a}=e;\"Line\"===a&&(this.addPolylineGroup_Deprecated(e,r),this.groupElStat.polyline+=1)}}onEntityGroupLoaded(e){let{type:a,layer:r}=e;if(this.options.layer===r)if(\"GeomGroup\"===a){let{entityGroup:a,data:r}=e;this.addPolylineGroup(a,r)}else\"LineSegmentGroup\"===a?this.addPolylineGroup(e.entityGroup,[{type:\"LINE\",vertexDataArray:[e.data]}],!0):this.addTriangleMesh(e.entityGroup,e.data)}onTextLoaded(e,a){this.options.layer===e&&a.forEach((e,a)=>{this.addText(a,e),this.groupElStat.text+=1})}init(){this.loader.addListener(\"render-group-loaded\",this.onRenderGroupLoaded.bind(this)),this.loader.addListener(\"entity-group-loaded\",this.onEntityGroupLoaded.bind(this)),this.loader.addListener(\"text-loaded\",this.onTextLoaded.bind(this))}get show(){return this._show}set show(e){this._show!==e&&(this._show=e,this.groups.forEach(e=>{e.update({show:this.computedShow})}))}get index(){return this.options.layerIndex}get parentShow(){return this._parentShow}set parentShow(e){this._parentShow!==e&&(this._parentShow=e,this.groups.forEach(e=>{e.update({show:this.computedShow})}))}get grounded(){return this._grounded}set grounded(e){if(e!==this._grounded)this._grounded=e,this.groups.forEach(a=>{a.update({ground:e})})}get computedShow(){return!!this.parentShow&&this.show}get name(){return this.options.layer.name}hasElement(e){return this.groups.has(e)}onManagerAdd(e){this.groups.forEach(a=>{a.onManagerAdd(e)})}onManagerRemove(e){this.groups.forEach(a=>{a.onManagerRemove(e)})}onManagerUpdate(e){this.groups.forEach(a=>{a.onManagerUpdate(e)})}destroy(){this.groups.forEach(e=>{e.destroy()})}}class gK extends(0,uX.AF)(pv,ph){managers;properties;interactLevel;layers;loader;readyPromise;resolveReadyPromise;rejectReadyPromise;constructor(e,a){super(),this.managers=a,this.interactLevel=sc.Composite,this.layers=new Map,this.loader=new pc(\"lazy\"),this.properties=Object.assign({id:(0,uW.k)(),type:\"Dxf\"},e),this.setCollectionMap(),this.readyPromise=new Promise((e,a)=>{this.resolveReadyPromise=e,this.rejectReadyPromise=a}),this.init()}get id(){return this.properties.id||(0,uW.k)()}get authToken(){return this.properties.authToken||\"\"}set authToken(e){this.loader.authToken=e}get shareToken(){return this.properties.shareToken||\"\"}set shareToken(e){this.loader.shareToken=e}get uri(){return this.properties.uri||\"\"}get show(){return void 0===this.properties.show}get rectangle(){return this.properties.rectangle}get layerConfigs(){return this.properties.layerConfigs||[]}get isValid(){return!1===this.properties.isValid}get contextMenu(){return this.properties.contextmenu}onContentLoaded(){let e=this.loader.content;if(e){let a=e.meta.bounding,{xMin:r,xMax:t,yMin:n,yMax:i}=a.value;!this.properties.rectangle&&(this.properties.rectangle={north:1,south:0,east:1,west:0});let o=this.rectangle;if(\"bounding-box-3d\"===a.type&&o){o.east=t,o.west=r,o.north=i,o.south=n;let e=this.managers._get(f3);!gV(r,t,n,i)&&e&&e.emit(\"datasetLoading\",{datasetType:\"Dxf\",eventName:\"error\",dataset:this})}}let a=[];this.loader.content?.layers.forEach((e,r)=>{a.push(this.loader.loadLayerLazy(r))}),Promise.allSettled(a).then(()=>{this.resolveReadyPromise?.()})}addLayer(e){let a=new gU(e,this.managers);this.layers.set(e.layerIndex,a)}onLayerLoaded({layer:e,layerIndex:a}){let r=this.layerConfigs.length>0,t=this.layerConfigs.find(e=>e.index===a);this.addLayer({loader:this.loader,dataset:this,layer:e,layerIndex:a,show:t?t.show:!r,grounded:!!t&&t.grounded})}init(){super.init(),this.loader.shareToken=this.shareToken,this.loader.setEntryResource(this.uri),this.loader.addListener(\"content-loaded\",this.onContentLoaded.bind(this)),this.loader.addListener(\"layer-loaded\",this.onLayerLoaded.bind(this)),this.loader.start().then(()=>{this.properties.isValid=!0}).catch(e=>{this.rejectReadyPromise?.(e)})}getLayer(e){return this.layers.get(e)}setLayerDimension(e,a){let r=this.getLayer(e);if(!!r)r.grounded=a}setLayerShow(e,a){let r=this.getLayer(e);if(!r)return;let t=this.layerConfigs.find(a=>a.index===e);t&&(t.show=a),r.show=a}cancelLoad(){this.loader.cancel(),this.properties.isValid=!1,this.properties.layerConfigs=[],this.layers.forEach(e=>{e.destroy()}),this.layers.clear()}getLayerByElement(e){let a;return this.layers.forEach(r=>{r.hasElement(e)&&(a=r)}),a}updateAllLayers(){let e=this.layerConfigs.length>0;this.layers.forEach(a=>{a.parentShow=this.show;let r=this.layerConfigs.find(e=>e.index===a.index);r?(a.show=r.show,a.grounded=r.grounded):e&&(a.show=!1)})}update(e){if((0,pg.ri)(e.show)&&(this.properties.show=e.show),e.layerConfigs){let a=e.layerConfigs,r=this.layerConfigs;a.forEach(e=>{let a=r.findIndex(a=>a.index===e.index);if(-1!==a){let t=r[a];t.grounded=e.grounded,t.show=e.show}else r.push(e)})}this.updateAllLayers()}onManagerAdd(e){this.layers.forEach(a=>{a.onManagerAdd(e)})}onManagerRemove(e){this.layers.forEach(a=>{a.onManagerRemove(e)})}onManagerUpdate(e){this.layers.forEach(a=>{a.onManagerUpdate(e)})}setCollectionMap(){this.managers._options.datasets.add(this,[this.id])}removeCollectionMap(){this.managers._options.datasets.remove(this)}destroy(){this.loader.removeAllListeners(),this.removeCollectionMap(),this.layers.forEach(e=>{e.destroy()})}}class gW extends(0,uX.AF)(pv,ph){managers;properties;interactLevel;readyPromise;loader;resolveReadyPromise;shapes;constructor(e,a){super(),this.managers=a,this.interactLevel=sc.Composite,this.loader=new pp,this.shapes=null,this.properties=Object.assign({id:(0,uW.k)(),type:\"Shp\"},e),this.init(),this.setCollectionMap(),this.readyPromise=new Promise((e,a)=>{this.resolveReadyPromise=e})}get id(){return this.properties.id||(0,uW.k)()}get authToken(){return this.properties.authToken||\"\"}set authToken(e){this.loader.authToken=e}get uri(){return this.properties.uri||\"\"}get show(){return void 0===this.properties.show}get rectangle(){return this.properties.rectangle}get shapeType(){return this.shapes?this.shapes.type:null}get fillColor(){let e=this.properties.style,a=pJ.PolygonStyle.Color;return e&&\"Polygon\"===e.styleType&&e.fillColor||a}get fillAlpha(){let e=this.properties.style,a=pJ.PolygonStyle.Alpha;return e&&\"Polygon\"===e.styleType&&e.fillAlpha||a}get lineColor(){let e=this.properties.style,a=pJ.LineStyle.Color;return e&&\"Polyline\"===e.styleType&&e.lineColor||a}get lineWidth(){let e=this.properties.style,a=pJ.LineStyle.Width;return e&&\"Polyline\"===e.styleType&&e.lineWidth||a}get lineAlpha(){let e=this.properties.style,a=pJ.LineStyle.Alpha;return e&&\"Polyline\"===e.styleType&&e.lineAlpha||a}get is2D(){return this.properties.ground||pJ.Ground}init(){super.init(),this.loader.setEntryResource(this.uri),this.loader.addListener(\"content-loaded\",this.onContentLoaded.bind(this)),this.loader.addListener(\"feature-geometries-loaded\",this.onFeatureGeometriesLoaded.bind(this)),this.loader.start()}onContentLoaded(){let e=this.loader.content;if(!e)return;let{meta:{bounding:a}}=e;this.properties.rectangle={south:a.value.yMin,north:a.value.yMax,west:a.value.xMin,east:a.value.xMax},this.resolveReadyPromise?.()}onFeatureGeometriesLoaded(e){let{type:a,geometries:r}=e;if(\"Point\"===a);else if(\"MultiPoint\"===a);else if(\"Polyline\"===a){let e=new pZ({positionsArray:r.map((e,a)=>({id:a.toString(),positions:e.map(e=>hu.fromLngLat(...e))})),occludedAlpha:.4,enableOccludedStyle:!0,cssColor:this.lineColor,ground:this.is2D},this.managers);this.shapes={type:a,geometries:e}}else{let t=new gS({datas:((e,a)=>{let r=[];return e.forEach((e,t)=>{let n=[],i=[];e.forEach((e,o)=>{if(!(a&&function(e,a,r,t,n){let i=n.find(e=>e.featureIndex===a);return!!i&&!!i.outsideIslandIndices.includes(t)&&(e.push({id:`shp-${a}-${t}`,positions:r.map(e=>hu.fromLngLat(...e))}),!0)}(r,t,e,o,a)))if(0===o)e.forEach(e=>n.push(hu.fromLngLat(...e)));else{let a=[];e.forEach(e=>a.push(hu.fromLngLat(...e))),i.push(a)}}),r.push({id:`shp-${t}`,positions:n,holes:i})}),r})(r,e.outsideIslandPolygons),occludedAlpha:.4,enableOccludedStyle:!0,cssColor:this.fillColor,alpha:this.fillAlpha,ground:this.is2D},this.managers);this.shapes={type:a,geometries:t,outsideIslandPolygons:e.outsideIslandPolygons}}}update(e){if((0,pg.ri)(e.show)&&(this.properties.show=e.show),!!this.shapes)(\"Polygon\"===this.shapes.type||\"Polyline\"===this.shapes.type)&&this.shapes.geometries.update({show:e.show})}onManagerAdd(e){if(!!this.shapes)(\"Polygon\"===this.shapes.type||\"Polyline\"===this.shapes.type)&&this.shapes.geometries.onManagerAdd(e)}onManagerRemove(e){if(!!this.shapes)(\"Polygon\"===this.shapes.type||\"Polyline\"===this.shapes.type)&&this.shapes.geometries.onManagerRemove(e)}onManagerUpdate(e){if(!!this.shapes)(\"Polygon\"===this.shapes.type||\"Polyline\"===this.shapes.type)&&this.shapes.geometries.onManagerUpdate(e)}setCollectionMap(){this.managers._options.datasets.add(this,[this.id])}removeCollectionMap(){this.managers._options.datasets.remove(this)}destroy(){this.shapes&&((\"Polygon\"===this.shapes.type||\"Polyline\"===this.shapes.type)&&this.shapes.geometries.destroy(),this.shapes=null,this.readyPromise=new Promise((e,a)=>{this.resolveReadyPromise=e}))}}let gZ=false;var gY=r(\"28879\"),gQ=r.n(gY);function g$(e,a,r){let t;return t=\"satelliteBase\"===e?\"img_w\":\"street\"===e?\"vec_w\":\"zh\"===a?({satelliteMark:\"cia_w\",streetMark:\"cva_w\"})[e]:({satelliteMark:\"eia_w\",streetMark:\"eva_w\"})[e],{resource:{type:\"url\",value:`https://t{s}.tianditu.gov.cn/DataServer?T=${t}&x={x}&y={y}&l={z}&tk=${r}`},subdomains:[\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\"],maximumLevel:18}}function gX(e,a){let r={zh:\"zh-CN\",en:\"en\"},t=a===n8.ZH?r.zh:r.en;return{resource:{type:\"url\",value:`https://mt{s}.google.com/vt/lyrs=${({satelliteMark:\"h\",satelliteBase:\"s\",street:\"m\"})[e]}&x={x}&y={y}&z={z}&hl=${t}`},subdomains:[\"0\",\"1\",\"2\",\"3\"],maximumLevel:22}}let g0=gQ()().day(0).format(\"YYYYMMDD\"),g1={street:`//mapimg.djicdn.com/api_tile/v1/png?qt=vtile&x={x}&y={y}&z={z}&styles=pl&scaler=2&udt=${g0}&showtext=1&manufacturer=didi`,satelliteMark:`//mapimg.djicdn.com/api_tile/v1/png?qt=vtile&x={x}&y={y}&z={z}&styles=sl&scaler=2&udt=${g0}&showtext=1&manufacturer=didi`,satelliteBase:`//mapimg.djicdn.com/api_tile/v1/sate?manufacturer=dji&x={x}&y={y}&z={z}&scaler=2&udt=${g0}`};function g2(e,a){let r=g1[e];return r&&(r+=`&ak=${a}`),{resource:{type:\"style\",value:\"satelliteMark\"===e?\"marks\":\"satelliteBase\"===e?\"satellite\":\"street\",url:r},maximumLevel:\"satelliteMark\"===e?21:19,subdomains:[\"0\",\"1\",\"2\",\"3\"]}}function g3(e){if(\"g\"===window.CURRENT_BE_ENV_CONFIG.map_engine)return{tiles_source:\"google\",tiles_type:e};switch(e){case\"fallbackSatelliteBase\":return{tiles_source:\"baidu\",tiles_type:\"satelliteBase\"};case\"street\":case\"satelliteMark\":return{tiles_source:\"baidu\",tiles_type:e};default:return{tiles_source:\"tianditu\",tiles_type:e}}}function g4(e){return!(window.$featureGateway||[]).includes(e)}(r$=sI||(sI={})).AEC=\"AEC\",r$.AEC_NPS=\"AEC_NPS\",r$.DEVICE_MANAGE_UNLOCKING_LICENSE=\"DEVICE_MANAGE_UNLOCKING_LICENSE\",r$.DEVICE_MANAGE_FLY_SAFE_DATABASE_UPGRADE=\"DEVICE_MANAGE_FLY_SAFE_DATABASE_UPGRADE\",r$.DEVICE_MANAGE_LOG_AUTO_ANALYZE=\"DEVICE_MANAGE_LOG_AUTO_ANALYZE\",r$.TASK_SAFETY_ONLINE_WEATHER=\"TASK_SAFETY_ONLINE_WEATHER\",r$.DEVICE_MANAGE_MAINTENANCE=\"DEVICE_MANAGE_MAINTENANCE\",r$.DEVICE_MANAGE_WHOLE_MACHINE_SN=\"DEVICE_MANAGE_WHOLE_MACHINE_SN\",r$.DEVICE_MANAGE_CARE=\"DEVICE_MANAGE_CARE\",r$.DEVICE_MANAGE_ISSUE_REPORT=\"DEVICE_MANAGE_ISSUE_REPORT\",r$.DEVICE_MANAGE_ISSUE_REPORT_PRIVATIZATION=\"DEVICE_MANAGE_ISSUE_REPORT_PRIVATIZATION\",r$.DEVICE_MANAGE_NOTIFICATION_SUBSCRIPTION=\"DEVICE_MANAGE_NOTIFICATION_SUBSCRIPTION\",r$.DEVICE_MANAGE_DAMAGE_ASSESSMENT=\"DEVICE_MANAGE_DAMAGE_ASSESSMENT\",r$.DEVICE_MANAGE_FTS=\"DEVICE_MANAGE_FTS\",r$.DEVICE_MANAGE_AI_INSIDE=\"DEVICE_MANAGE_AI_INSIDE\",r$.DEVICE_MANAGE_USER_EXPERIENCE_IMPROVEMENT_PROGRAM=\"DEVICE_MANAGE_USER_EXPERIENCE_IMPROVEMENT_PROGRAM\",r$.DEVICE_MANAGE_FIRMWARE_MANAGEMENT=\"DEVICE_MANAGE_FIRMWARE_MANAGEMENT\",r$.USER_CENTER_CHANGE_PASSWORD=\"USER_CENTER_CHANGE_PASSWORD\",r$.FLY_SAFE_HOST=\"FLY_SAFE_HOST\",r$.UOM=\"UOM\",r$.MAP_TERRAIN_PRIVATE=\"MAP_TERRAIN_PRIVATE\",r$.MAP_CONFIG_PRIVATE=\"MAP_CONFIG_PRIVATE\",r$.MAP_SEARCH_PRIVATE=\"MAP_SEARCH_PRIVATE\",r$.FEEDBACK_PUBLIC=\"FEEDBACK_PUBLIC\",r$.BEGINNER_S_GUIDE=\"BEGINNER_S_GUIDE\",r$.USER_FEEDBACK=\"USER_FEEDBACK\",r$.PUBLIC_SSO=\"PUBLIC_SSO\",r$.PRIVATIZATION_LICENSE=\"PRIVATIZATION_LICENSE\",r$.PAID_LISTS=\"PAID_LISTS\",r$.MODEL_CHANGE_DETECTION=\"MODEL_CHANGE_DETECTION\",r$.MEDIA_CHANGE_DETECTION=\"MEDIA_CHANGE_DETECTION\",r$.PAID_PAGE_RELATED=\"PAID_PAGE_RELATED\",r$.PRIV_Login=\"PRIV_Login\",r$.SENTRY_DATA_REPORTING=\"SENTRY_DATA_REPORTING\",r$.BI_DATA_REPORTING=\"BI_DATA_REPORTING\",r$.PublicCopyright=\"PublicCopyright\",r$.FORWARDING_STREAM_PUBLIC=\"FORWARDING_STREAM_PUBLIC\",r$.PUBLIC_URGENT_LOG=\"PUBLIC_URGENT_LOG\",r$.MFA=\"MFA\",r$.PRIV_PrivacyAgreementAndUserGuide=\"PrivacyAgreementAndUserGuide\",r$.PRIV_MemberManager=\"PRIV_MemberManager\",r$.REAL_TIME_SPEAKER=\"REAL_TIME_SPEAKER\",r$.AUTO_RECORD=\"AUTO_RECORD\",r$.AI_LINK=\"AI_LINK\",r$.AR_STREET=\"AR_STREET\",r$.TELEMETRY_DATA=\"TELEMETRY_DATA\",r$.CLOUD_RECONSTRUCTION_LICENSE_PRIVATE=\"CLOUD_RECONSTRUCTION_LICENSE_PRIVATE\",r$.FORWARDING_STREAM_PRIVATIZATION=\"FORWARDING_STREAM_PRIVATIZATION\",r$.FH_SYNC_PUBLIC_ENTER=\"FH_SYNC_PUBLIC_ENTER\",r$.FH_SYNC_MQTT=\"FH_SYNC_MQTT\",r$.FH_SYNC_OAUTH=\"FH_SYNC_OAUTH\",r$.FH_SYNC_FORWARDING_STREAM_GB_PROTOCOL=\"FH_SYNC_FORWARDING_STREAM_GB_PROTOCOL\",r$.FH_SYNC_FORWARDING_STREAM_LIMIT_FROME_SERVER=\"FH_SYNC_FORWARDING_STREAM_LIMIT_FROME_SERVER\",r$.AI_WAYLINE_USER_MESSAGE_ICON=\"AI_WAYLINE_USER_MESSAGE_ICON\",r$.MODEL_CANCEL_QUESTIONER=\"MODEL_CANCEL_QUESTIONER\",r$.QUICK_MODELING=\"QUICK_MODELING\",r$.AEC_GCP=\"AEC_GCP\",r$.MODEL_REPORT_IN_KITE_PLATFORM=\"MODEL_REPORT_IN_KITE_PLATFORM\",r$.WORKFLOW_REVERSE_GEOCODING=\"WORKFLOW_REVERSE_GEOCODING\",r$.ORG_GRAY_VERSION=\"ORG_GRAY_VERSION\";let g5=r.p+\"29187d0ebca83825.glb\",g6={heading:-90,pitch:-90,roll:0};(rX=sA||(sA={}))[rX.surface=0]=\"surface\",rX[rX.height=1]=\"height\";class g9{manager;drawingMode=c2.oO.line;activeShapePoints=(0,uh.iH)([]);activeCirclePosParams=(0,uh.qj)({centerPos:void 0,radius:0,centerPosCartesian3:void 0,circleEdgePoint:void 0,maxRadius:pP.MaxRadius});verticalPlane=uf.Plane.ORIGIN_XY_PLANE;activeShape=null;floatingPoint=(0,uh.iH)(null);polygon3DLine=null;polygon3DAngleModel=null;polygon3DAngle=null;withShift=!1;activeSolidStatus=0;prismBaseLine=null;prismHeightPlane=uf.Plane.ORIGIN_XY_PLANE;prismSurfaceHeight=-9999;prismExtrudedHeight=.5;cylinderPlane=uf.Plane.ORIGIN_XY_PLANE;cylinderBaseLine=null;cylinderSurfaceHeight=-9999;cylinderExtrudedHeight=.5;drawingOptions={enableIntersectFinish:!0,enableOverAreaFinish:!0,useNearestPick:!1,useOnlyNearestPick:!1};resetDrawingOptions(){this.drawingOptions.enableIntersectFinish=!0,this.drawingOptions.enableOverAreaFinish=!0,this.drawingOptions.useNearestPick=!1,this.drawingOptions.useOnlyNearestPick=!1,this.drawingOptions.onAbortFinishDrawing=void 0}origin=c2.tT.map;drawingState={checkDrawingPermission:null,checkCircleFinishPermission:null};constructor(e){this.manager=e}positionsCallback(){let e=this.activeShapePoints.value.map(e=>uf.Cartesian3.clone(e));return this.floatingPoint.value&&(e=e.concat([this.floatingPoint.value])),this.activeShape instanceof hW&&(this.activeShape.drawingPositions=e.map(e=>(0,pg.KO)(e)),this.activeShape.origin=this.origin),e}createClosedLine(){return new h8(Object.assign({},{category:se.annotations,positions:this.activeShapePoints.value.concat(this.floatingPoint.value||[]).map(e=>(0,pg.KO)(e,!0)),clampToGround:!1,width:6,cssColor:sv.Blue,needCheckIntersect:!0,needCheckArea:!0,maxArea:c2.vL.includes(this.origin)?169e4:void 0,fromDraw:!0,origin:this.origin},this.manager.drawingElementProps[c2.oO.closedLine]),this.manager.collection,{drawing:!0,positionsCallback:this.positionsCallback.bind(this)})}createPolyline(){let e=this.manager.drawingElementProps.line,a=e?.clampToGround??!0;return new h8(Object.assign({},{category:se.annotations,positions:this.activeShapePoints.value.concat(this.floatingPoint.value||[]).map(e=>(0,pg.KO)(e,!0)),clampToGround:a,width:a?3:6,cssColor:this.manager.doodleWidget.color.polyline,fromDraw:!0,labelDistanceDisplayCondition:hQ,labelScaleByDistance:hX,placeable:!0,labelOccludedAlpha:.4},this.manager.drawingElementProps.line),this.manager.collection,{drawing:!0,positionsCallback:a?this.positionsCallback.bind(this):void 0})}createPolygon(){let e;e=this.manager.drawingElementProps.polygon.outlineStyle===sf.Fence?this.manager.drawingElementProps.polygon.cssColor:this.manager.doodleWidget.color.polygon;let a=this.origin,r=Object.assign({},{category:se.annotations,withPolyOutline:!0,cssColor:e,fromDraw:!0,needCheckIntersect:c2.Fd.includes(a),needCheckArea:c2.vL.includes(a),maxArea:c2.vL.includes(a)?1e8:void 0,labelOccludedAlpha:.4});return!(0,c2.SG)(a)&&!(0,c2.P3)(a)&&(r.labelDistanceDisplayCondition=hQ,r.labelScaleByDistance=hX,r.alphaByDistance=h0,r.disableHoverAlpha=.125,r.placeable=!0,r.areaAlpha=.2),(0,c2.P3)(a)&&(r.alphaByDistance=h1),(0,c2.SG)(a)&&(r.areaAlpha=0),new hW(r=Object.assign(r,this.manager.drawingElementProps.polygon),this.manager.collection,{drawing:!0,positionsCallback:this.positionsCallback.bind(this)})}createCircle(){let e=this.origin,a=this.manager.doodleWidget.color.circle;e===c2.tT.CustomLimitCircleArea&&(a=mJ),e===c2.tT.CustomFlyCircleArea&&(a=mN);let r=e!==c2.tT.map?se.none:se.annotations,t=this.manager.drawingElementProps.circle.maxRadius||void 0;this.activeCirclePosParams.maxRadius=t||pP.MaxRadius;let n=Object.assign({},{show:!0,category:r,cssColor:a,fromDraw:!0,withPolyOutline:!0,clampToGround:!0,outlineStyle:e===c2.tT.CustomLimitCircleArea||e===c2.tT.CustomFlyCircleArea?sf.Fence:sf.Normal,labelOccludedAlpha:.4,maxRadius:t},this.manager.drawingElementProps.circle);return!(0,c2.SG)(e)&&!(0,c2.P3)(e)&&(n.labelDistanceDisplayCondition=hQ,n.labelScaleByDistance=hX,n.alphaByDistance=h0,n.disableHoverAlpha=.1,n.placeable=!0,n.areaAlpha=.2),(0,c2.P3)(e)&&(n.alphaByDistance=h1),(0,c2.SG)(e)&&(n.areaAlpha=0),new mX(n,this.manager.collection,{drawing:!0,positionsCallback:()=>this.activeCirclePosParams})}createPrismBaseLine(){let e=this.manager.drawingElementProps.prism,a=(0,pg.LS)(e.cssColor,sv.Blue),r=(0,pg.LS)(e.outlineWidth,6);return new h8(Object.assign({},{category:se.annotations,positions:this.activeShapePoints.value.concat(this.floatingPoint.value||[]).map(e=>(0,pg.KO)(e,!0)),clampToGround:!1,width:r,cssColor:a,needCheckIntersect:!0,needCheckArea:!0,maxArea:c2.vL.includes(this.origin)?169e4:void 0,fromDraw:!0,origin:this.origin},this.manager.drawingElementProps.line),this.manager.collection,{drawing:!0})}createCylinderBaseLine(){let{centerPos:e,radius:a}=this.activeCirclePosParams;return mF(e,a,void 0,e?.height).length<2?null:new h8(Object.assign({},{category:se.annotations,clampToGround:!1,width:6,cssColor:sv.Blue,needCheckIntersect:!0,needCheckArea:!0,maxArea:c2.vL.includes(this.origin)?169e4:void 0,errorCssColor:m0,show:!0,fromDraw:!0},this.manager.drawingElementProps.line),this.manager.collection,{drawing:!0})}createPolygon3DLine(){return new h8(Object.assign({},{category:se.annotations,positions:this.activeShapePoints.value.concat(this.floatingPoint.value||[]).map(e=>(0,pg.KO)(e,!0)),clampToGround:!1,width:4,cssColor:sv.Blue,fromDraw:!0},this.manager.drawingElementProps.line),this.manager.collection,{drawing:!0,positionsCallback:this.positionsCallback.bind(this)})}createPolygon3DAngleModel(){if(this.activeShapePoints.value.length<2)return;let e=this.activeShapePoints.value[0],a=this.activeShapePoints.value[1],{heading:r=0,pitch:t=0}=(0,pg.WP)(e,a);this.polygon3DAngleModel=new hM({category:se.annotations,scale:3e-4,modelURI:g5,cssColor:\"#A9F620\",colorBlendMode:2,minimumPixelSize:256,lightIntensity:1.7,position:(0,pg.KO)(a,!0),headingPitchRoll:{heading:g6.heading+uf.Math.toDegrees(r),pitch:g6.pitch+uf.Math.toDegrees(t),roll:g6.roll},displayOnTop:!0},this.manager.collection)}getPolygon3DPositions(){let e=this.floatingPoint.value||uf.Cartesian3.ZERO,a=uf.Cartesian3.subtract(this.activeShapePoints.value[0],this.activeShapePoints.value[1],new uf.Cartesian3),r=uf.Cartesian3.add(e,a,new uf.Cartesian3);return this.activeShapePoints.value.concat([e,r]).map(e=>(0,pg.KO)(e,!0))}createPolygon3D(){let e=this.getPolygon3DPositions();return new hY({show:!0,cssColor:sv.Blue,positions:e,areaAlpha:.2,outlined:!0,removable:!0,fromDraw:!0,maxArea:c2.vL.includes(this.origin)?1e8:1e6},this.manager.collection)}createPrism(){let e=this.manager.drawingElementProps.prism,a=(0,pg.LS)(e.cssColor,sv.Blue),r=(0,pg.LS)(e.innerCssColor,\"#2DE3F0\"),t=(0,pg.LS)(e.areaAlpha,.3),n=e.enableHeightControl,i=e.translateAxisUsed,o=e.enableRotate;return new gs({show:!0,fromDraw:!0,positions:this.activeShapePoints.value.map(e=>(0,pg.KO)(e)),height:0,extrudedHeight:0,closeTop:(0,pg.LS)(e.closeTop,!1),closeBottom:(0,pg.LS)(e.closeBottom,!1),cssColor:a,innerCssColor:r,areaAlpha:t,enableHeightControl:n,enableRotate:o,translateAxisUsed:i,outlined:!0,needCheckArea:!0,needCheckIntersect:!0,errorCssColor:m0,maxTopArea:c2.vL.includes(this.origin)?169e4:1e6,maxAllArea:c2.vL.includes(this.origin)?182e4:1e6},this.manager.collection)}createCylinder(){return new hp({show:!0,fromDraw:!0,center:this.activeCirclePosParams.centerPos,radius:this.activeCirclePosParams.radius,height:0,extrudedHeight:0,closeTop:!1,closeBottom:!1,cssColor:sv.Blue,outlined:!0,needCheckArea:!0,innerCssColor:\"#2DE3F0\",errorCssColor:m0,maxTopArea:c2.vL.includes(this.origin)?169e4:1e6,maxAllArea:c2.vL.includes(this.origin)?182e4:1e6},this.manager.collection)}createFuncList={[c2.oO.polygon]:this.createPolygon.bind(this),[c2.oO.circle]:this.createCircle.bind(this),[c2.oO.line]:this.createPolyline.bind(this),[c2.oO.polygon3d]:this.createPolygon3D.bind(this),[c2.oO.prism]:this.createPrism.bind(this),[c2.oO.cylinder]:this.createCylinder.bind(this),[c2.oO.closedLine]:this.createClosedLine.bind(this)};drawShape(){return this.createFuncList[this.drawingMode]?.()}enterDrawing(e,a=c2.tT.map,r,t){this.clearDrawing(!0),this.drawingMode=e,this.origin=a,this.manager.setMode(\"draw\",a),r&&this.manager.setDrawingElementProps(e,r),t&&((0,pg.ri)(t.enableIntersectFinish)&&(this.drawingOptions.enableIntersectFinish=t.enableIntersectFinish),(0,pg.ri)(t.enableOverAreaFinish)&&(this.drawingOptions.enableOverAreaFinish=t.enableOverAreaFinish),t.useOnlyNearestPick&&(this.manager.picker.pickPositionMode=\"only-nearest\"),t.useNearestPick&&(this.manager.picker.pickPositionMode=\"nearest\"),t.onAbortFinishDrawing&&(this.drawingOptions.onAbortFinishDrawing=t.onAbortFinishDrawing))}drawCircle(e){if(this.manager.isDrawingLayerLocked&&this.origin===c2.tT.map){this.manager.emit(\"statusLimit\",\"limit-create\");return}let a=this.activeShape;if(this.activeCirclePosParams.centerPos){if(this.activeCirclePosParams.radius<.1||a&&this.activeCirclePosParams.radius>a.maxRadius)return;this.finishDrawing()}else e&&(this.activeCirclePosParams.centerPos=(0,pg.KO)(e),this.activeShape=this.drawShape())}drawPolygon3D(e){if(e){let a=this.activeShapePoints.value,r=hV(e);this.polygon3DLine?this.polygon3DLine&&this.activeShapePoints.value.length<3&&(this.activeShapePoints.value=a.concat([r]),!this.polygon3DAngleModel&&this.createPolygon3DAngleModel(),this.polygon3DLine.drawingPositions=this.activeShapePoints.value.map(e=>(0,pg.KO)(e,!0)),this.verticalPlane=function(e,a){let r=uf.Cartesian3.subtract(a,e,new uf.Cartesian3);return uf.Plane.fromPointNormal(a,uf.Cartesian3.normalize(r,new uf.Cartesian3))}(a[0],r)):this.activeShapePoints.value=a.concat([r]);let t=this.activeShapePoints.value.length;t<3&&t>0&&(this.manager.emit(\"onDrawStateChange\",{type:this.drawingMode,state:2===t?c2.hY.height:c2.hY.ground,origin:this.origin}),2===t&&this.manager.hover.setCursor(\"confirm\",\"temporary\")),t>=3&&this.polygon3DLine&&(this.finishDrawing(),this.manager.hover.setCursor(\"\",\"temporary\"))}}drawClosedLine(e){if(e){let a=this.activeShapePoints.value,r=hV(e);0===a.length&&this.manager.emit(\"onDrawStart\",{type:this.drawingMode,origin:this.origin}),this.activeShapePoints.value=a.concat([r])}}drawPrism(e){if(e){let a=this.activeShapePoints.value,r=hV(e);if(0===a.length&&this.manager.emit(\"onDrawStart\",{type:this.drawingMode,origin:this.origin}),0===this.activeSolidStatus)this.activeShapePoints.value=a.concat([r]);else if(1===this.activeSolidStatus){if(Math.abs(mu(this.manager.viewer))>80){hB.Z.warning(uP(\"web.p_wayline.change_view_tips\"));return}this.finishDrawing()}}}drawCylinder(e){if(e){let a=this.activeShapePoints.value,r=hV(e);if(0===this.activeSolidStatus)0===a.length?(this.manager.emit(\"onDrawStart\",{type:this.drawingMode,origin:this.origin}),this.activeCirclePosParams.centerPos=(0,pg.KO)(e,!0)):1===a.length&&this.finishDrawing(),this.activeShapePoints.value=a.concat([r]);else if(1===this.activeSolidStatus){if(Math.abs(mu(this.manager.viewer))>80){hB.Z.warning(uP(\"web.p_wayline.change_view_tips\"));return}this.finishDrawing(),this.manager.hover.setCursor(\"\",\"temporary\")}}}drawPolylineAndPolygon(e){if(e){if(this.manager.isDrawingLayerLocked&&this.origin===c2.tT.map){this.manager.emit(\"statusLimit\",\"limit-create\");return}let a=this.activeShapePoints.value,r=hV(e);0===a.length?(this.activeShapePoints.value=a.concat([r]),this.activeShape=this.drawShape(),this.manager.emit(\"onDrawStart\",{type:this.drawingMode,origin:this.origin})):this.activeShapePoints.value=a.concat([r])}}pickMousePosition(e){let a=this.manager.picker.pickPosition(e.position);return this.drawingMode===c2.oO.polygon3d&&this.activeShapePoints.value.length>=2&&(a=this.withShift?this.floatingPoint.value||void 0:mt(e.position,this.verticalPlane,this.manager)),this.drawingMode===c2.oO.cylinder&&1===this.activeShapePoints.value.length&&(this.getCylinderPlane(),a=this.pickPlanePosition(e.position,this.cylinderPlane)),a}leftClick(e){if(this.drawingState.checkDrawingPermission&&!this.drawingState.checkDrawingPermission())return;let a=this.pickMousePosition(e);switch(this.drawingMode){case c2.oO.circle:this.drawCircle(a);break;case c2.oO.polygon3d:this.drawPolygon3D(a);break;case c2.oO.line:case c2.oO.polygon:this.drawPolylineAndPolygon(a);break;case c2.oO.prism:this.drawPrism(a);break;case c2.oO.cylinder:this.drawCylinder(a);break;case c2.oO.closedLine:this.drawClosedLine(a)}this.manager.viewer.selectedEntity=void 0,this.manager.mode.edit&&this.manager.editor.exitEdit()}mouseMoveCircle(e){let a=this.manager.picker.pickPosition(e.endPosition);if(!a||!(this.activeShape instanceof mX))return;let r=(0,pg.KO)(a),t=this.activeCirclePosParams.maxRadius,n=mE([r,this.activeCirclePosParams.centerPos]).horizontalCumulativeDistance;if(!(n>=t))this.activeCirclePosParams.circleEdgePoint=r,this.activeCirclePosParams.radius=n}emitMouseMovePolygonPolyline(e){let a=this.activeShapePoints.value,r=(0,pg.KO)(e),t=(0,pg.KO)(a[a.length-1]);\"line\"===this.drawingMode&&this.manager.emit(\"onDrawingMouseMove\",{element:this.activeShape,elementType:\"line\",pointIndex:a.length+1,curPoint:r,prePoint:t}),\"polygon\"===this.drawingMode&&this.manager.emit(\"onDrawingMouseMove\",{element:this.activeShape,elementType:\"polygon\",pointIndex:a.length+1,curPoint:r,prePoint:t})}mouseMovePolylineAndPolygon(e){if(this.activeShapePoints.value.length>0){let a=this.manager.picker.pickPosition(e.endPosition);if(a){this.emitMouseMovePolygonPolyline(a);let e=!this.floatingPoint.value;if(this.floatingPoint.value=a,this.activeShape instanceof h8&&!this.activeShape.clampToGround){this.activeShape.drawingPositions=[...this.activeShapePoints.value,a].map(e=>(0,pg.KO)(e,!0)),this.activeShape.updatePrimitive(),hV(a),this.manager.render();return}e&&this.manager.render()}}}pickPlanePosition(e,a){let r=this.manager.viewer.scene.camera.getPickRay(e);if(!!r)return uf.IntersectionTests.rayPlane(r,a)}getPolygon3DAngle(e){let a=this.activeShapePoints.value;if(a.length>=2){let r=a[0],t=a[1],n=uf.Cartesian3.normalize(t,new uf.Cartesian3),i=uf.Cartesian3.normalize(uf.Cartesian3.subtract(t,r,new uf.Cartesian3),new uf.Cartesian3),o=uf.Cartesian3.normalize(uf.Cartesian3.cross(n,i,new uf.Cartesian3),new uf.Cartesian3),s=uf.Cartesian3.normalize(uf.Cartesian3.cross(i,o,new uf.Cartesian3),new uf.Cartesian3),l=uf.Cartesian3.normalize(uf.Cartesian3.subtract(e,t,new uf.Cartesian3),new uf.Cartesian3),d=uf.Cartesian3.dot(l,o),c=uf.Cartesian3.dot(l,s),u=uf.Math.toDegrees(uf.Math.acosClamped(d));return c<0&&(u=360-u),u}return 0}computePositionFromAngle(e,a){let r=this.activeShapePoints.value;if(r.length>=2){let t=r[0],n=r[1],i=uf.Cartesian3.normalize(n,new uf.Cartesian3),o=uf.Cartesian3.normalize(uf.Cartesian3.subtract(n,t,new uf.Cartesian3),new uf.Cartesian3),s=uf.Cartesian3.normalize(uf.Cartesian3.cross(i,o,new uf.Cartesian3),new uf.Cartesian3),l=(0,pg.ir)(s,o,uf.Math.toRadians(a)),d=uf.Cartesian3.distance(e,n),c=uf.Cartesian3.multiplyByScalar(l,d,new uf.Cartesian3);return uf.Cartesian3.add(n,c,new uf.Cartesian3)}return e}mouseMovePolygon3D(e){let a;let r=this.activeShapePoints.value,t=r.length;if(1===t)a=this.manager.picker.pickPosition(e.endPosition);else if(2===t&&(this.manager.hover.setCursor(\"confirm\",\"temporary\"),a=this.pickPlanePosition(e.endPosition,this.verticalPlane),this.withShift&&a)){let e=15*Math.round(this.getPolygon3DAngle(a)/15);a=this.computePositionFromAngle(a,e)}if(a){if(this.floatingPoint.value=a,this.polygon3DAngle=2===t?this.getPolygon3DAngle(a):null,this.polygon3DLine?this.polygon3DLine.drawingPositions=r.concat([a]).map(e=>(0,pg.KO)(e,!0)):this.polygon3DLine=this.createPolygon3DLine(),2!==t||this.activeShape){if(this.activeShape){let e=this.getPolygon3DPositions();this.activeShape?.update({positions:e})}}else this.activeShape=this.drawShape()}this.manager.render()}mouseMoveClosedLine(e){let a=this.activeShapePoints.value,r=a.length;if(!r)return;let t=this.manager.picker.pickPosition(e.endPosition);if(t){this.floatingPoint.value=t,!this.activeShape&&(this.activeShape=this.drawShape());let e=a.concat([t]),n=r>1?e.concat([a[0]]):e;this.activeShape instanceof h8&&(this.activeShape.drawingPositions=n.map(e=>(0,pg.KO)(e,!0)))}this.manager.render()}mouseMovePrism(e){let a,r;let t=this.activeShapePoints.value,n=t.length;if(n){if(0===this.activeSolidStatus)a=this.manager.picker.pickPosition(e.endPosition);else{this.manager.hover.setCursor(\"confirm\",\"temporary\"),this.getPrismHeightPlane(e);let n=-9999,i=mu(this.manager.viewer);(a=Math.abs(i)>=80?t[0].clone():this.pickPlanePosition(e.endPosition,this.prismHeightPlane))&&(n=(0,pg.KO)(a,!0).height||-9999);let o=(0,pg.KO)(t[0]);o.height=n,a=(0,pg.jL)(o);let s=n>this.prismSurfaceHeight;r=s?this.prismSurfaceHeight:n,this.prismExtrudedHeight=Math.abs(n-this.prismSurfaceHeight),Math.abs(i)>=80?this.prismExtrudedHeight=0:this.prismExtrudedHeight<.5&&(this.prismExtrudedHeight=.5,o.height=s?this.prismSurfaceHeight+.5:this.prismSurfaceHeight-.5,a=(0,pg.jL)(o),r=s?this.prismSurfaceHeight:this.prismSurfaceHeight-this.prismExtrudedHeight)}if(a){if(this.floatingPoint.value=a,!this.prismBaseLine&&(this.prismBaseLine=this.createPrismBaseLine()),0===this.activeSolidStatus){let e=t.concat([a]),r=n>1?e.concat([t[0]]):e;this.prismBaseLine.drawingPositions=r.map(e=>(0,pg.KO)(e,!0))}else 1===this.activeSolidStatus&&(this.activeShape?this.activeShape.update({height:r||0,extrudedHeight:this.prismExtrudedHeight||0}):this.activeShape=this.drawShape())}this.manager.render()}}mouseMoveCylinder(e){let a,r;if(this.activeShapePoints.value.length){if(this.getCylinderPlane(e),0===this.activeSolidStatus)a=this.pickPlanePosition(e.endPosition,this.cylinderPlane);else{this.manager.hover.setCursor(\"confirm\",\"temporary\");let t=-9999;(a=this.pickPlanePosition(e.endPosition,this.cylinderPlane))&&(t=(0,pg.KO)(a,!0).height||-9999);let{centerPos:n,radius:i}=this.activeCirclePosParams,o=mF(n,i,void 0,n?.height)[0];o.height=t,a=(0,pg.jL)(o);let s=t>this.cylinderSurfaceHeight;r=s?this.cylinderSurfaceHeight:t,this.cylinderExtrudedHeight=Math.abs(t-this.cylinderSurfaceHeight),Math.abs(mu(this.manager.viewer))>=80?this.cylinderExtrudedHeight=0:this.cylinderExtrudedHeight<.5&&(this.cylinderExtrudedHeight=.5,o.height=s?this.cylinderSurfaceHeight+.5:this.cylinderSurfaceHeight-.5,a=(0,pg.jL)(o),r=s?this.cylinderSurfaceHeight:this.cylinderSurfaceHeight-this.cylinderExtrudedHeight)}if(a){if(this.floatingPoint.value=a,0===this.activeSolidStatus){this.activeCirclePosParams.circleEdgePoint=(0,pg.KO)(a,!0),this.activeCirclePosParams.radius=mE([this.activeCirclePosParams.circleEdgePoint,this.activeCirclePosParams.centerPos]).horizontalCumulativeDistance;let{centerPos:e,radius:r}=this.activeCirclePosParams,t=mF(e,r,void 0,e?.height);this.cylinderBaseLine?this.cylinderBaseLine.drawingPositions=t.concat([t[0]]):this.cylinderBaseLine=this.createCylinderBaseLine()}else this.activeShape?this.activeShape.update({height:r||0,extrudedHeight:this.cylinderExtrudedHeight||0}):this.activeShape=this.drawShape()}}}mouseMove(e){switch(this.drawingMode){case c2.oO.circle:this.mouseMoveCircle(e);break;case c2.oO.polygon3d:this.mouseMovePolygon3D(e);break;case c2.oO.line:case c2.oO.polygon:this.mouseMovePolylineAndPolygon(e);break;case c2.oO.prism:this.mouseMovePrism(e);break;case c2.oO.cylinder:this.mouseMoveCylinder(e);break;case c2.oO.closedLine:this.mouseMoveClosedLine(e)}return!(this.activeShapePoints.value.length>0)&&!this.activeCirclePosParams.centerPos&&!0}exitDrawing(){this.clearDrawing(!0),this.manager.picker.pickPositionMode=\"single\",this.manager.clearMode(\"draw\"),this.manager.clearDrawingElementProps(),this.manager.emit(\"onExitDrawing\"),this.manager.hover.setCursor(\"\",\"temporary\")}checkElementShapeCanFinish(e){if(!e)return!0;let{enableIntersectFinish:a,enableOverAreaFinish:r}=this.drawingOptions,t=!0;return e.isIntersect&&(t=t&&a),e.isAreaExceed&&(t=t&&r),t}canFinish(){switch(this.drawingMode){case c2.oO.prism:return this.activeShapePoints.value.length>2&&0===this.activeSolidStatus;case c2.oO.cylinder:return this.activeShapePoints.value.length>=1&&0===this.activeSolidStatus;case c2.oO.polygon:case c2.oO.closedLine:{let e=this.checkElementShapeCanFinish(this.activeShape);return this.activeShapePoints.value.length>2&&e}case c2.oO.circle:return void 0!==this.activeCirclePosParams.centerPos;default:{let e=this.checkElementShapeCanFinish(this.activeShape);return this.activeShapePoints.value.length>1&&e}}}finishCylinderSurface(){this.manager.emit(\"onDrawStateChange\",{type:this.drawingMode,state:c2.hY.height,origin:this.origin}),this.activeSolidStatus=1,this.manager.hover.setCursor(\"confirm\",\"temporary\"),this.cylinderSurfaceHeight=this.activeCirclePosParams.centerPos?.height||0}finishPrismSurface(){this.manager.emit(\"onDrawStateChange\",{type:this.drawingMode,state:c2.hY.height,origin:this.origin}),this.activeSolidStatus=1,this.manager.hover.setCursor(\"confirm\",\"temporary\");let e=this.activeShapePoints.value.reduce((e,a)=>{let r=(0,pg.KO)(a,!0).height||-9999;return r>e?r:e},-9999);if(this.prismSurfaceHeight=e,this.activeShapePoints.value=this.activeShapePoints.value.map(a=>{let r=(0,pg.KO)(a);r.height=e;let t=(0,pg.jL)(r);return t.id=(0,uW.k)(),t}),this.prismBaseLine){let e=this.activeShapePoints.value,a=e.concat([e[0]]);this.prismBaseLine.drawingPositions=a.map(e=>(0,pg.KO)(e,!0))}}getPrismHeightPlane(e){let a=this.activeShapePoints.value,r=a.length,t=this.manager.viewer.scene,n=!1;for(let i=0;i<r;i++){let o=a[i],s=a[(i+1)%r],l=t.cartesianToCanvasCoordinates(o),d=t.cartesianToCanvasCoordinates(s);if(l.x<e.endPosition.x&&d.x>e.endPosition.x){let e=uf.Cartesian3.cross(o,s,new uf.Cartesian3),a=uf.Plane.fromPointNormal(o,uf.Cartesian3.normalize(e,new uf.Cartesian3));this.prismHeightPlane=a,n=!0}}if(!1===n){let n=9999;for(let i=0;i<r;i++){let r=a[i],o=Math.abs(t.cartesianToCanvasCoordinates(r).x-e.endPosition.x);if(o<n){let e=this.manager.viewer.camera.directionWC,a=uf.Transforms.eastNorthUpToFixedFrame(r),t=uf.Matrix4.multiplyByPointAsVector(uf.Matrix4.inverse(a,new uf.Matrix4),e,new uf.Cartesian3);t.z=0;let i=uf.Matrix4.multiplyByPointAsVector(a,t,new uf.Cartesian3),s=uf.Plane.fromPointNormal(r,uf.Cartesian3.normalize(i,new uf.Cartesian3));this.prismHeightPlane=s,n=o}}}}getCylinderPlane(e){let a=this.activeShapePoints.value;if(0===a.length)return;let r=this.manager.viewer.scene;if(0===this.activeSolidStatus){let e=a[0],r=uf.Transforms.eastNorthUpToFixedFrame(e),t=new uf.Cartesian3(0,0,1),n=uf.Matrix4.multiplyByPointAsVector(r,t,new uf.Cartesian3);this.cylinderPlane=uf.Plane.fromPointNormal(e,uf.Cartesian3.normalize(n,new uf.Cartesian3))}else{let a=!1,{centerPos:t,radius:n}=this.activeCirclePosParams,i=mF(t,n,void 0,t?.height),o=i.length;if(!e)return;let s=Number.MAX_VALUE;for(let t=0;t<o;t++){let n=(0,pg.jL)(i[t]),l=(0,pg.jL)(i[(t+1)%o]),d=r.cartesianToCanvasCoordinates(n),c=r.cartesianToCanvasCoordinates(l),u=d.x,p=c.x,m=e.endPosition.x;if(u<m&&m<p||u>m&&m>p){let e=uf.Cartesian3.cross(n,l,new uf.Cartesian3),r=uf.Plane.fromPointNormal(n,uf.Cartesian3.normalize(e,new uf.Cartesian3)),t=this.manager.viewer.camera.positionWC,i=uf.Cartesian3.distance(t,n);s>=i&&(this.cylinderPlane=r,a=!0,s=i)}}if(!1===a){let a=9999;for(let t=0;t<o;t++){let n=(0,pg.jL)(i[t]),o=Math.abs(r.cartesianToCanvasCoordinates(n).x-e.endPosition.x);if(o<a){let e=this.manager.viewer.camera.directionWC,r=uf.Transforms.eastNorthUpToFixedFrame(n),t=uf.Matrix4.multiplyByPointAsVector(uf.Matrix4.inverse(r,new uf.Matrix4),e,new uf.Cartesian3);t.z=0;let i=uf.Matrix4.multiplyByPointAsVector(r,t,new uf.Cartesian3),s=uf.Plane.fromPointNormal(n,uf.Cartesian3.normalize(i,new uf.Cartesian3));this.cylinderPlane=s,a=o}}}}}finishDrawing(){if(this.drawingMode===c2.oO.prism&&0===this.activeSolidStatus){this.checkElementShapeCanFinish(this.prismBaseLine)?this.finishPrismSurface():this.drawingOptions.onAbortFinishDrawing?.(this.drawingMode,\"baseline\",h2.PrismBaselineIntersect);return}if(this.drawingMode===c2.oO.cylinder&&0===this.activeSolidStatus){this.finishCylinderSurface();return}if(this.activeShape){if(this.activeShape instanceof mX){if(this.drawingState.checkCircleFinishPermission&&!this.drawingState.checkCircleFinishPermission(this.activeShape.radius,this.activeShape.centerPos))return;this.manager.emit(\"finishDraw\",{type:this.drawingMode,element:this.activeShape,shape:(0,lL.cloneDeep)(this.activeCirclePosParams),origin:this.origin})}else if(this.drawingMode===c2.oO.polygon3d&&this.activeShape instanceof hY)this.manager.emit(\"finishDraw\",{type:this.drawingMode,element:this.activeShape,shape:{positions:this.getPolygon3DPositions(),color:this.activeShape.cssColor},origin:this.origin});else if(this.drawingMode===c2.oO.prism&&this.activeShape instanceof gs)this.manager.emit(\"finishDraw\",{type:this.drawingMode,element:this.activeShape,shape:{positions:this.activeShapePoints.value.map(e=>(0,pg.KO)(e)),height:this.prismSurfaceHeight,extrudedHeight:this.prismExtrudedHeight,color:this.activeShape.cssColor},origin:this.origin});else if(this.drawingMode===c2.oO.cylinder&&this.activeShape instanceof hp)this.manager.emit(\"finishDraw\",{type:this.drawingMode,element:this.activeShape,shape:{positions:[],center:this.activeCirclePosParams.centerPos,radius:this.activeCirclePosParams.radius,height:this.prismSurfaceHeight,extrudedHeight:this.prismExtrudedHeight,color:this.activeShape.cssColor||\"#fff\"},origin:this.origin});else{if(this.manager.isDrawingLayerLocked&&this.origin===c2.tT.map){this.manager.emit(\"statusLimit\",\"limit-create\");return}if(this.origin===c2.tT.map&&this.activeShape instanceof hW&&(this.activeShape.properties.alphaByDistance=h0),!this.canFinish())return;this.manager.emit(\"finishDraw\",{type:this.drawingMode,element:this.activeShape,shape:{positions:this.activeShapePoints.value.map(e=>(0,pg.KO)(e,!this.activeShape.clampToGround)),color:this.activeShape.cssColor||\"#fff\"},origin:this.origin})}if(this.drawingMode===c2.oO.polygon){let e=this.activeShape;e.measureType&&\"aec\"===e.measureType?this.clearDrawing(!0):this.clearDrawing(!1)}else this.clearDrawing(!1)}}clearDrawing(e=!1){this.activeShape&&(e||this.drawingMode===c2.oO.closedLine?this.activeShape.destroy():this.activeShape instanceof hY||this.activeShape instanceof gs?this.manager.hover.setCursor(\"\",\"temporary\"):(this.activeShape instanceof mX?(this.activeShape.active(\"selected\",!1),this.activeShape.stabilize(this.activeCirclePosParams)):(this.activeShape.active(\"selected\",!1),this.activeShape.stabilize(this.activeShapePoints.value)),this.activeShape.edit())),this.polygon3DLine&&this.polygon3DLine.destroy(),this.polygon3DAngleModel&&this.polygon3DAngleModel.destroy(),this.prismBaseLine&&this.prismBaseLine.destroy(),this.cylinderBaseLine&&this.cylinderBaseLine.destroy(),this.resetDrawingOptions(),this.activeShape=null,this.activeShapePoints.value=[],this.floatingPoint.value=null,this.polygon3DLine=null,this.polygon3DAngleModel=null,this.polygon3DAngle=0,this.manager.editor.activeCirclePosParams.circleEdgePoint=(0,lL.cloneDeep)(this.activeCirclePosParams.circleEdgePoint),this.activeCirclePosParams.radius=0,this.activeCirclePosParams.centerPos=void 0,this.activeCirclePosParams.centerPosCartesian3=void 0,this.activeCirclePosParams.circleEdgePoint=void 0,this.activeCirclePosParams.maxRadius=pP.MaxRadius,this.activeSolidStatus=0,this.prismExtrudedHeight=0,this.prismHeightPlane=uf.Plane.ORIGIN_XY_PLANE,this.prismSurfaceHeight=-9999,this.prismBaseLine=null,this.cylinderPlane=uf.Plane.ORIGIN_XY_PLANE,this.cylinderBaseLine=null,this.cylinderSurfaceHeight=-9999,this.manager.render()}getDrawingMode(){return this.drawingMode}}let g8=g4(sI.FLY_SAFE_HOST)?window.CURRENT_FE_ENV_CONFIG.flySafeHost:`${window.CURRENT_FE_ENV_CONFIG.configHost}/flysafe`,g7=`${g8}/api/geo/v3/areas/in_rectangle`;(r0=sC||(sC={}))[r0.Circle=0]=\"Circle\",r0[r0.Polygon=1]=\"Polygon\",r0[r0.Container=2]=\"Container\";async function fe(e,a){return e={...e,level_type:0,zones_mode:\"total\",signature:\"\",drone:\"mavic-mini\"},(await pi.get(`${g7}`,{params:e,...a})).data}class fa{manager;cameraMoveTimer;showFlysafeArea=!1;flysafeAreaRadius=50;coordinate=[22.522,113.94,0];flySafeAreaData=[];flySafePrimitives=[];requestStr=\"\";currentRequestId=\"\";levelObj={2:!0};unlockLicenseFilter={countries:[],areaIds:[]};oldUnlockLicenseFilter={countries:[],areaIds:[]};constructor(e){this.manager=e,this.initialize()}destroy(){this.manager.viewer.scene.camera.moveEnd.removeEventListener(this.drawHandlerThrottled)}initialize(){this.manager.viewer.scene.camera.moveEnd.addEventListener(this.drawHandlerThrottled)}setVisible(e){this.showFlysafeArea=e,this.showFlysafeArea?this.flySafeAreaData.length?(this.requestStr=\"\",this.createShapeFromFlySafeData()):this.drawHandlerThrottled():(this.flySafePrimitives.forEach(e=>{this.manager.viewer.scene.groundPrimitives.remove(e)}),this.flySafePrimitives=[],this.currentRequestId=\"\"),this.manager.render()}setLevel(e){this.levelObj=e,this.requestStr=\"\",this.drawHandlerThrottled()}setFlySafeFilter(e){this.oldUnlockLicenseFilter=(0,lL.cloneDeep)(this.unlockLicenseFilter),this.unlockLicenseFilter=(0,lL.cloneDeep)(e),this.drawHandlerThrottled()}drawHandlerThrottled=(function(e){let a;let r=-1,t=async function(...n){if(a=[...n],r>-1){r++;return}r=0;try{await e(...a)}catch(e){}if(r>0){r=-1,t(...a);return}r=-1};return t})(()=>{!this.manager.viewer.isDestroyed()&&this.drawHandler()}).bind(this);drawHandler(){this.showFlysafeArea&&(this.coordinate=this.cartesianToGraphic(this.manager.viewer.camera.position),this.getFlysafeAreaData())}getLevel(){let e=[],a={...this.levelObj};for(let r in a[6]&&(a[6]=!1,a[2]=!0),a)a[r]&&e.push(r);return e.join(\",\")}async getFlysafeAreaData(){let e=this.getCoordinateRect(),a=this.getLevel();if(!a){this.flySafePrimitives.forEach(e=>{this.manager.viewer.scene.groundPrimitives.remove(e)}),this.flySafePrimitives=[],this.manager.render(),this.requestStr=\"\";return}let r={ltlat:e.leftTop[0],ltlng:e.leftTop[1],rblat:e.rightBottom[0],rblng:e.rightBottom[1],level:a};try{let e=JSON.stringify(r);if(this.requestStr&&this.requestStr===e&&(0,lL.isEqual)(this.oldUnlockLicenseFilter,this.unlockLicenseFilter))return;this.requestStr=e}catch(e){}let t=(0,uW.k)();this.currentRequestId=t;try{let e=await fe(r);if(t!==this.currentRequestId)return;let a=e.data.areas;a=(a=a.filter(e=>!!(0,lL.isEmpty)(this.unlockLicenseFilter.countries)||!this.unlockLicenseFilter.countries.includes(e.country))).filter(e=>!!(0,lL.isEmpty)(this.unlockLicenseFilter.areaIds)||!this.unlockLicenseFilter.areaIds.includes(e.area_id)),this.flySafeAreaData=a,this.createShapeFromFlySafeData(),this.manager.render()}catch(e){throw this.requestStr=\"\",e}}generatePolygonAttribute(e){let a={};if(e.positions){let r=e.positions.map(e=>uf.Cartesian3.fromDegrees(e.longitude,e.latitude,e.height||0));a.polygonPositions=new uf.PolygonHierarchy(r),!r[r.length-1].equals(r[0])&&(a.outlinePositions=r.concat(r[0]))}if(e.cssColor){let r=uf.Color.fromCssColorString(e.cssColor);a.polygonMaterial=e.areaAlpha?r.withAlpha(e.areaAlpha):r,a.outlineMaterial=r}return a}addPrimitivePolygon(e){let{polygonPositions:a,outlinePositions:r,polygonMaterial:t,outlineMaterial:n}=this.generatePolygonAttribute(e);if(e.withPolyOutline&&r?.length&&r.length>=2){let e=new uf.PolylineGeometry({positions:r,width:2}),a=new uf.GeometryInstance({geometry:e,attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(n)}}),t=new uf.GroundPolylinePrimitive({geometryInstances:a,appearance:new uf.PolylineMaterialAppearance({material:uf.Material.fromType(\"Color\",{color:n})}),releaseGeometryInstances:!1,allowPicking:!1,asynchronous:!1});this.manager.viewer.scene.groundPrimitives.add(t),this.manager.viewer.scene.groundPrimitives.lowerToBottom(t),this.flySafePrimitives.push(t)}if(a){let e=new uf.PolygonGeometry({polygonHierarchy:a}),r=new uf.GeometryInstance({geometry:e,attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(t)}}),n=new uf.GroundPrimitive({geometryInstances:[r],appearance:new uf.MaterialAppearance({material:uf.Material.fromType(\"Color\",{color:t}),translucent:!0,closed:!0}),releaseGeometryInstances:!1,allowPicking:!1,asynchronous:!1});return this.manager.viewer.scene.groundPrimitives.add(n),this.manager.viewer.scene.groundPrimitives.lowerToBottom(n),n}}addPrimitiveCircle(e){let a,r;if(e.cssColor&&(a=uf.Color.fromCssColorString(e.cssColor)),e.position&&(r=uf.Cartesian3.fromDegrees(e.position.longitude,e.position.latitude,e.position.height||0)),r){let t=new uf.EllipseGeometry({center:r,semiMajorAxis:e.radius,semiMinorAxis:e.radius}),n=new uf.GeometryInstance({geometry:t,attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(a.withAlpha(.4))}}),i=new uf.GroundPrimitive({geometryInstances:[n],appearance:new uf.MaterialAppearance({material:uf.Material.fromType(\"Color\",{color:a.withAlpha(.4)}),translucent:!0,closed:!0}),releaseGeometryInstances:!1,allowPicking:!1,asynchronous:!1});return this.manager.viewer.scene.groundPrimitives.add(i),this.manager.viewer.scene.groundPrimitives.lowerToBottom(i),i}}checkPushShape(e,a,r,t){if(2===e){let e=3;if(\"number\"==typeof a.begin_at&&\"number\"==typeof a.end_at&&a.begin_at&&a.end_at?e=1:a.height&&(e=2),3===e&&!this.levelObj[2]||2===e&&!this.levelObj[6])return}let n=t();n&&r.push(n)}createShapeFromFlySafeData(){let e=this.flySafeAreaData||[],a=e.length;this.flySafePrimitives.forEach(e=>{this.manager.viewer.scene.groundPrimitives.remove(e)}),this.flySafePrimitives=[];for(let r=0;r<a;r++){let a=e[r],t=a.level;switch(a.shape){case sC.Container:a.sub_areas.forEach(e=>{switch(e.shape){case sC.Polygon:this.checkPushShape(t,e,this.flySafePrimitives,()=>this.addPrimitivePolygon({show:!0,positions:e.polygon_points[0].map(e=>({longitude:e[0],latitude:e[1]})),withPolyOutline:!0,cssColor:e.color,areaAlpha:.2}));break;case sC.Circle:this.checkPushShape(t,e,this.flySafePrimitives,()=>{if(void 0!==e.lat&&void 0!==e.lng&&void 0!==e.radius)return this.addPrimitiveCircle({show:!0,position:{longitude:e.lng,latitude:e.lat},radius:e.radius,cssColor:e.color,clampToGround:!0})})}});break;case sC.Polygon:this.checkPushShape(t,a,this.flySafePrimitives,()=>{if(a.polygon_points)return this.addPrimitivePolygon({show:!0,positions:a.polygon_points[0].map(e=>({longitude:e[0],latitude:e[1]})),withPolyOutline:!0,cssColor:a.color,areaAlpha:.2})});break;case sC.Circle:this.checkPushShape(t,a,this.flySafePrimitives,()=>this.addPrimitiveCircle({show:!0,position:{longitude:a.lng,latitude:a.lat},radius:a.radius,cssColor:a.color,clampToGround:!0}))}}}cartesianToGraphic(e){let a=this.manager.viewer.scene.globe.ellipsoid.cartesianToCartographic(e),r=uf.Math.toDegrees(a.latitude),t=uf.Math.toDegrees(a.longitude);return[r,t,a.height]}getCoordinateRect(){let e=this.flysafeAreaRadius/111;return{leftTop:[this.coordinate[0]-e,this.coordinate[1]-e],rightBottom:[this.coordinate[0]+e,this.coordinate[1]+e]}}}var"
}