{
  "metadata": {
    "source_file": "map-app\\static\\js\\index.5da8ba4c.js",
    "chunk_index": 11,
    "total_chunks": 918,
    "chunk_size": 43604,
    "word_count": 800,
    "model_kwargs": {
      "model": "text-embedding-3-large",
      "dimensions": 3072,
      "encoding_format": "float"
    },
    "text_splitter": {
      "split_by": "word",
      "chunk_size": 800,
      "chunk_overlap": 200
    },
    "created_at": "2025-12-17T23:57:50.146Z"
  },
  "content": "createVolume3d(e,a){let r=new uf.PrimitiveCollection;return r.show=this.showVolume3d,this.createPrimitive(a,r),this.createEdgeLines(e.referLines,r,e.transform),this.createEdgeLines(e.targetLines,r,e.transform),this.createLinePrimitive(e.lineVerticesUp,r,e.transform,pO.CssLineBlue),this.createLinePrimitive(e.lineVerticesDown,r,e.transform,pO.CssLineRed),this.createColumnPrimitive(e.polygon,e.polygonUpper,r),r}createEdgeLines(e,a,r){if(e&&e.length>0){let r=new uf.PolylineGeometry({positions:uf.Cartesian3.fromDegreesArrayHeights(e),width:2,vertexFormat:uf.PolylineMaterialAppearance.VERTEX_FORMAT}),t=new uf.GeometryInstance({geometry:r}),n=new uf.Primitive({geometryInstances:t,appearance:new uf.PolylineMaterialAppearance({material:uf.Material.fromType(\"Color\",{color:uf.Color.WHITE})}),asynchronous:!1});a.add(n)}}createPrimitive(e,a){if(this.canvas){let r=this.canvas.getContext(\"2d\");if(r){let t=new Uint8Array(r.getImageData(0,0,this.canvas.width,this.canvas.height).data.buffer),n=new uf.CustomShader({mode:uf.CustomShaderMode.MODIFY_MATERIAL,lightingModel:uf.LightingModel.UNLIT,uniforms:{myTexture:{type:uf.UniformType.SAMPLER_2D,value:{typedArray:t,width:this.canvas.width,height:this.canvas.height,sampler:{minificationFilter:uf.TextureMinificationFilter.LINEAR,magnificationFilter:uf.TextureMagnificationFilter.LINEAR,pixelFormat:uf.PixelFormat.RGBA,pixelDatatype:uf.PixelDatatype.UNSIGNED_BYTE}}}},translucencyMode:uf.CustomShaderTranslucencyMode.TRANSLUCENT,fragmentShaderText:\"void fragmentMain(FragmentInput fsInput, inout czm_modelMaterial material)\\n {\\n // material.diffuse = vec3(img);\\n vec2 uv = fsInput.attributes.texCoord_0;\\n \\n vec4 texColor = texture(myTexture, uv);\\n vec3 img = texture(myTexture, vec2(uv.x, uv.y)).rgb;\\n material.diffuse = vec3(img);\\n material.alpha = texColor.a;\\n // vec4 texColor = vec4(1.0,0.,0.,1.0);\\n if(material.diffuse.r>0.8&&material.diffuse.g>0.8&&material.diffuse.b>0.8){\\n float brightness = max(material.diffuse.r, max(material.diffuse.g, material.diffuse.b));\\n \\n // 白色部分（brightness >= 0.95）逐渐透明消失\\n material.alpha = clamp(1.0 - smoothstep(0.72, 0.98, brightness), 0.1, 0.8);\\n }\\n else {\\n material.alpha = 0.8; \\n }\\n \\n \\n vec3 positionToEyeEC = - fsInput.attributes.positionEC; // 从片段指向眼睛的向量\\n vec3 normalEC = normalize(fsInput.attributes.normalEC); // 归一化的法向量（眼睛坐标系）\\n \\n // faceforward使法向量始终朝向摄像机，防止背面法向异常\\n normalEC = faceforward(normalEC, vec3(0.0, 0.0, 1.0), -normalEC);\\n \\n // 计算视线和法向夹角的余弦值，决定泛光程度\\n float d = dot(normalEC, normalize(positionToEyeEC));\\n \\n // smoothstep使边缘平滑，增强泛光效果\\n float s = smoothstep(0.0, 1.0, abs(d));\\n \\n // 泛光颜色 (白色)\\n vec4 rimColor = vec4(1.0, 1.0, 1.0, 1.0);\\n // vec4 meshVertexColor =vec4(1.0, 0.0, 0.0, 1.0);\\n vec4 meshVertexColor =texColor;\\n \\n // 根据s值混合泛光颜色和顶点颜色（meshVertexColor）\\n vec4 blendedColor = mix(rimColor, meshVertexColor, pow(s, 0.5));\\n \\n // 输出到材质的漫反射颜色（最终颜色）\\n material.diffuse = vec3(blendedColor);\\n // material.alpha =0.6;\\n \\n \\n \\n \\n }\"});e.customShader=n,a.add(e)}}}showType(e){switch(e){case sy.Volume2D:this.showVolume3d=!1,this.showVolume2d=!0;break;case sy.Volume3D:this.showVolume3d=!0,this.showVolume2d=!1;break;case sy.VolumeAll:this.showVolume3d=!0,this.showVolume2d=!0;break;case sy.VolumeAllHidden:this.showVolume3d=!1,this.showVolume2d=!1}this.volume3d&&this.volume2d&&this.primitives._keys().forEach(a=>{this.updatePrimitive(a,{showType:e})})}toggleShow(e){switch(e){case sy.Volume2D:this.volume3d&&(this.volume3d.show=!1),this.volume2d&&(this.volume2d.show=!0);break;case sy.Volume3D:this.volume3d&&(this.volume3d.show=!0),this.volume2d&&(this.volume2d.show=!1);break;case sy.VolumeAll:this.volume3d&&(this.volume3d.show=!0),this.volume2d&&(this.volume2d.show=!0);break;case sy.VolumeAllHidden:this.volume3d&&(this.volume3d.show=!1),this.volume2d&&(this.volume2d.show=!1)}}update(e){Object.keys(e).forEach(a=>{let r=e[a];(0,pg.ri)(r)&&(this.properties[a]=r)}),this.render()}createLinePrimitive(e,a,r,t){if(this.isDestroyed||!e.length)return;let n=uf.BoundingSphere.fromVertices(Array.from(e));if(0===n.radius)return;let i=new Float64Array(e),o=new uf.Geometry({attributes:{position:new uf.GeometryAttribute({componentDatatype:uf.ComponentDatatype.DOUBLE,componentsPerAttribute:3,values:i})},primitiveType:uf.PrimitiveType.LINES,boundingSphere:n,vertexFormat:uf.VertexFormat.POSITION_AND_COLOR}),s=new uf.GeometryInstance({geometry:o,modelMatrix:r,attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(uf.Color.fromCssColorString(t).withAlpha(1))}}),l=new uf.Primitive({geometryInstances:s,appearance:new uf.PerInstanceColorAppearance({flat:!0,translucent:!1}),compressVertices:!0,asynchronous:!1,releaseGeometryInstances:!0,cull:!0});a.add(l)}creatingId;async createVolume(){let e;let a=(0,uW.k)();this.creatingId=a;let r=this.properties.url;if(r)try{let a=await this.loadCustomModel(r),t=a._loader._gltfJsonLoader._bufferLoaders[0]._typedArray,n=t.buffer,i=t.byteLength,o=t.byteOffset,s=a._loader._gltfJsonLoader.gltf.extensions.CESIUM_RTC.center,l=new uf.Cartesian3,d=uf.Cartesian3.fromArray(s,0,l),c=uf.Matrix4.fromTranslation(d,new uf.Matrix4),u=n.slice(o,o+i),p=a._loader.gltfJson.scenes[0].extras,m=p.pixelDataLength,h=p.pixelDataOffset,g=p.imageSize,f=p.lineData.colorsLength,_=p.lineData.colorsOffset,b=p.lineData.verticesLength,k=p.lineData.verticesOffset,v=p.maxAltitude,z=p.minAltitude,w=p.polygon,y=p.offsetUp,S=p.referLines,j=p.targetLines,D=new Float32Array(u,h,m/Float32Array.BYTES_PER_ELEMENT),I=new Float32Array(u,k,b/Float32Array.BYTES_PER_ELEMENT),A=new Float32Array(u,_,f/Float32Array.BYTES_PER_ELEMENT);D&&await this.preCreateTexture(D,v,z,g);let C=[];for(let e=0;e<w.length;e++){let a=w[e],r=a.Height+y;C.push([a.Longitude,a.Latitude,r])}let[x,M]=await Promise.all([this.createVolume3d({lineVerticesUp:I,lineVerticesDown:A,polygon:w,polygonUpper:C,transform:c,referLines:S,targetLines:j},a),this.createVolume2d(w)]);e={volume3dResult:x,volume2dResult:M}}catch(e){}return e}async loadCustomModel(e){return await uf.Model.fromGltfAsync({url:e,modelMatrix:uf.Matrix4.IDENTITY,upAxis:uf.Axis.X})}createColumnPrimitive(e,a,r){if(this.isDestroyed||!e)return;let t=[],n=[];if(e&&e.length===a.length){for(let r=0;r<e.length;r++){let i=e[r],o=[],s=uf.Cartesian3.fromDegrees(a[r][0],a[r][1],a[r][2]),l=uf.Cartesian3.fromDegrees(i.Longitude,i.Latitude,i.Height);n.push(s),o.push(s),o.push(l),t.push(o)}let i=[];for(let e=0;e<n.length;e++)i.push(n[e]),i.push(n[(e+1)%n.length]);let o=new uf.PolylineGeometry({positions:i,width:2,vertexFormat:uf.PolylineColorAppearance.VERTEX_FORMAT}),s=new uf.GeometryInstance({geometry:o,attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(uf.Color.fromCssColorString(\"#7D80FF\"))}}),l=new uf.Primitive({geometryInstances:s,appearance:new uf.PolylineColorAppearance({translucent:!1}),compressVertices:!0,asynchronous:!1,releaseGeometryInstances:!0,cull:!0});r.add(l),t.forEach(e=>{let a=new uf.PolylineGeometry({positions:e,vertexFormat:uf.PolylineColorAppearance.VERTEX_FORMAT}),t=new uf.GeometryInstance({geometry:a,attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(uf.Color.fromCssColorString(\"#FFFFFF\"))}}),n=new uf.Primitive({geometryInstances:t,appearance:new uf.PolylineColorAppearance({translucent:!1}),compressVertices:!0,asynchronous:!1,releaseGeometryInstances:!0,cull:!0,interleave:!0,allowPicking:!1});r.add(l),n&&r.add(n)})}}onManagerUpdate(e){let a=this.primitives._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}onManagerRemove(e){this.removePrimitives(e)}hasPrimitive(e){return this.primitives._keys().some(a=>this.primitives._get(a).volume3d===e)}render(){this.primitives._keys().forEach(e=>{this.updatePrimitive(e)})}removePrimitives(e){let a=this.primitives._get(e),r=this.managers._get(e);r&&a&&a.volume3d&&r.viewer.scene.primitives.remove(a.volume3d),a.volume2d&&r.viewer.scene.primitives.remove(a.volume2d),this.primitives._remove(e)}async createVolume2d(e){let a=new uf.PrimitiveCollection;return await this.createPrimitve2D(e,a),a.show=this.showVolume2d,a}async createPrimitve2D(e,a){if(!this.isDestroyed){if(e){let r=[];for(let a=0;a<e.length;a++){let t=e[a],n=uf.Cartesian3.fromDegrees(t.Longitude,t.Latitude,0);r.push(n)}let t=new uf.GeometryInstance({geometry:new uf.PolygonGeometry({polygonHierarchy:new uf.PolygonHierarchy(r)})}),n=this.canvas;if(n){let e=new uf.Material({fabric:{type:\"canvas\",uniforms:{u_image:n},source:\" uniform sampler2D u_image;\\n\\n czm_material czm_getMaterial(czm_materialInput materialInput){\\n czm_material material = czm_getDefaultMaterial(materialInput);\\n vec2 st = materialInput.st; \\n vec4 img = texture(u_image, st); \\n \\n material.diffuse = vec3(img);\\n if(material.diffuse.r>0.8&&material.diffuse.g>0.8&&material.diffuse.b>0.8){\\n float brightness = max(material.diffuse.r, max(material.diffuse.g, material.diffuse.b));\\n \\n // 白色部分（brightness >= 0.95）逐渐透明消失\\n material.alpha = 1.0 - smoothstep(0.82, 0.98, brightness);\\n // material.alpha =0.2; \\n }\\n else{\\n material.alpha =0.68; \\n }\\n \\n\\n \\n return material; \\n }\"}}),r=new uf.MaterialAppearance({renderState:{depthTest:!1},material:e,flat:!0,faceForward:!1,closed:!1}),i=new uf.GroundPrimitive({geometryInstances:t,appearance:r,asynchronous:!1});a.add(i)}}return a}}async preCreateTexture(e,a,r,t){this.canvas=await this.createTexure(e,a,r,t)}async createTexure(e,a,r,t){let n=t[0],i=t[1],o=document.createElement(\"canvas\"),s=o.getContext(\"2d\");o.width=n,o.height=i;let l=[];if(void 0===r||void 0===a)return o;for(let a=0;a<i;a++)for(let r=0;r<n;r++){let t=e[a*n+r],i={x:r,y:a,value:t};l.push(i)}let d=pO.delta,c=gj._K_().x(e=>e.x).y(e=>e.y).weight(e=>e.value).size([n+1,i+1]).thresholds(gj.w6H(r,a,.01)).bandwidth(.6)(l);this.contours=c;let u=gj.BYU().domain([-d,.3*r,.7*r,r]).range([\"#80f5fd\",\"#3EACFA\",\"#0c2dff\",\"#000dff\"]),p=gj.BYU().domain([d,.3*a,.7*a,a]).range([\"#ffea80\",\"#FF8025\",\"#ff0f0f\",\"#e8000f\"]),m=e=>e>r&&e<-d?u(e):e<a&&e>d?p(e):\"rgba(255, 255, 255, 1.0)\";c.sort((e,a)=>e.value-a.value);let h=gj.l49(null,s);return s&&(s.fillStyle=\"rgba(255, 255, 255, 1.0)\",s.fillRect(0,0,o.width,o.height),c.forEach(e=>{let a={type:\"Feature\",geometry:{type:\"MultiPolygon\",coordinates:e.coordinates}};s.beginPath(),h(a,s),s.closePath(),0===e.value&&(s.strokeStyle=\"rgba(255, 255, 255, 1.0)\",s.lineWidth=1),s.fillStyle=m(e.value),s.fill()})),o}parseToGeoJson(e,a,r,t,n,i,o){let s=[];return e.length&&e.length>0&&e.forEach(e=>{e.forEach(e=>{let l=[],d=[];for(let s=0;s<e.length;s++){let[c,u]=e[s],[p,m]=this.canvasToLatLng(c,r-u,a,r,t,n,i,o);l.push(uf.Cartesian3.fromDegrees(p,m)),d.push([p,m])}s.push(d)})}),s}canvasToLatLng(e,a,r,t,n,i,o,s){return[n+e/r*(i-n),o+a/t*(s-o)]}destroy(){this.isDestroyed=!0,this.primitives._keys().forEach(e=>{this.removePrimitives(e)}),this.removeCollectionMap(),this.volume2d=void 0,this.volume3d=void 0,this.maxHeight=0,this.minHeight=0,this.counterPrimitiveCollection=void 0,this.contours=void 0,this.canvas=void 0}}function gI(e,a=!1){return uf.ColorGeometryInstanceAttribute.fromColor(uf.Color.fromCssColorString(e.cssColor).withAlpha(a?e.occludedAlpha:e.alpha))}class gA extends(0,uX.AF)(pv,ph,pz){managers;interactLevel;properties;members;constructor(e,a){super(),this.managers=a,this.interactLevel=sc.Area,this.members=py({}),this.properties=Object.assign({id:(0,uW.k)(),type:\"mesh\"},e),this.init(),this.setCollectionMap()}get id(){return this.properties.id}get cssColor(){return this.properties.cssColor||\"#ffffff\"}get alpha(){return this.properties.alpha||1}get occludedAlpha(){return this.properties.occludedAlpha||1}get enableOccludedStyle(){return!0===this.properties.enableOccludedStyle}get data(){return this.properties.data||{vertices:[],indices:[]}}get useOutline(){return this.properties.useOutline||!1}toggleDimension(){this.updatePrimitiveAllManagers()}update(e){let a=this.properties,r=!1,t=!1;(0,pg.ri)(e.show)&&a.show!==e.show&&(a.show=e.show,this.updateShow()),(0,pg.ri)(e.cssColor)&&(a.cssColor=e.cssColor,t=!0),(0,pg.ri)(e.alpha)&&(a.alpha=e.alpha,t=!0),(0,pg.ri)(e.useOutline)&&(a.useOutline=e.useOutline,r=!0),r&&this.updatePrimitiveAllManagers(),t&&this.updateStyleAllManagers()}updateMeshPrimitive(e){let a=this.managers._get(e);if(!a)return;let r=a.viewer.scene.primitives,t=this.members._get(e);!t&&(this.members._add(e,{}),t=this.members._get(e)),t.mesh&&r.contains(t.mesh)&&r.remove(t.mesh),t.edge&&r.contains(t.edge)&&r.remove(t.edge),t.mesh=void 0,t.edge=void 0;let n=function(e){let a=e.data;if(!a.vertices||0===a.vertices.length)throw Error(\"Invalid vertices data.\");if(!a.indices||0===a.indices.length)throw Error(\"Invalid indices data.\");let r=uf.BoundingSphere.fromVertices(a.vertices);if(!r||Number.isNaN(r.radius))throw Error(\"BoundingSphere creation failed.\");let t=new uf.Geometry({attributes:{position:new uf.GeometryAttribute({componentDatatype:uf.ComponentDatatype.DOUBLE,componentsPerAttribute:3,values:a.vertices})},indices:new Uint32Array(a.indices),primitiveType:uf.PrimitiveType.TRIANGLES,boundingSphere:r}),n=new uf.GeometryInstance({geometry:t,attributes:{color:gI(e),depthFailColor:gI(e,!0)}}),i=new uf.PerInstanceColorAppearance({flat:!0});return new uf.Primitive({geometryInstances:n,appearance:i,depthFailAppearance:e.enableOccludedStyle?i:void 0,compressVertices:!0,asynchronous:!1,releaseGeometryInstances:!0,cull:!0})}(this);if(n.show=!1!==this.properties.show,t.mesh=n,r.add(n),this.useOutline){let e=function(e){let{indices:a,vertices:r}=e.data,t=function(e){let a=[];for(let r=0;r<e.length;r+=3){let t=e[r],n=e[r+1],i=e[r+2];a.push(t,n),a.push(n,i),a.push(i,t)}return a}(a);if(!r||0===r.length)throw Error(\"Invalid vertices data.\");if(!t||0===t.length)throw Error(\"Invalid indices data.\");let n=uf.BoundingSphere.fromVertices(r);if(!n||Number.isNaN(n.radius))throw Error(\"BoundingSphere creation failed.\");let i=uf.Color.fromCssColorString(e.cssColor),o=uf.ColorGeometryInstanceAttribute.fromColor(i.brighten(.4,i)),s=new uf.Geometry({attributes:{position:new uf.GeometryAttribute({componentDatatype:uf.ComponentDatatype.DOUBLE,componentsPerAttribute:3,values:r})},indices:new Uint32Array(t),primitiveType:uf.PrimitiveType.LINES,boundingSphere:n}),l=new uf.GeometryInstance({geometry:s,attributes:{color:o,depthFailColor:o}}),d=new uf.PerInstanceColorAppearance({flat:!0});return new uf.Primitive({geometryInstances:[l],appearance:d,depthFailAppearance:e.enableOccludedStyle?d:void 0,asynchronous:!1,cull:!0})}(this);e.show=!1!==this.properties.show,t.edge=e,r.add(e)}}updateMeshStyle(e){let a=this.members._get(e);if(!a.mesh)return;let r=a.mesh.geometryInstances;r.attributes.color=gI(this),r.attributes.depthFailColor=gI(this,!0)}updateShow(){let e=!1!==this.properties.show,a=this.members;a.mesh&&a.mesh.showSetter(e)}addPrimitives(e){this.updateMeshPrimitive(e),this.managers._get(e).render()}removePrimitives(e){let a=this.members._get(e),r=this.managers._get(e);if(!r||!a)return;let t=r.viewer.scene.primitives;a.mesh&&(t.remove(a.mesh),a.mesh=void 0),a.edge&&(t.remove(a.edge),a.edge=void 0)}updateStyleAllManagers(){this.managers._keys().forEach(e=>{this.updateMeshStyle(e)})}updatePrimitiveAllManagers(){this.managers._keys().forEach(e=>{this.updateMeshPrimitive(e)})}onManagerAdd(e){this.addPrimitives(e)}onManagerRemove(e){this.removePrimitives(e)}setCollectionMap(){this.managers._options.elements.add(\"mesh\",this,[this.id])}onManagerUpdate(e){let a=this.members._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}destroy(){this.removeCollectionMap(),this.members._keys().forEach(e=>{this.removePrimitives(e)})}}function gC(e,a,r){var t,n,i,o;let s,l;let d=mC(e),c=mC(a),u=Math.abs((e?.height??0)-(a?.height??0));let p=(t=d,n=c,mS((i=t,o=n,{x:i.x-o.x,y:i.y-o.y,z:i.z-o.z}))),m=Math.sqrt(p**2-u**2),h=Math.round(10*my(Math.asin(u/p)))/10;if(h>85?(s=Number.NaN,l=Math.round(m/u*10)/10):h<5?(l=Number.NaN,s=Math.round(u/m*100)):(s=Math.round(u/m*100),l=Math.round(m/u*10)/10),\"degree\"===r)return h;if(\"percentage\"===r)return s;if(\"ratio\"===r)return l;else return{degree:h,percentage:s,ratio:l}}(rZ=sS||(sS={}))[rZ.MaxAngel=85]=\"MaxAngel\",rZ[rZ.MinAngel=5]=\"MinAngel\";(rY=sj||(sj={}))[rY.Up=3]=\"Up\",rY[rY.ConeLength=.3]=\"ConeLength\",rY[rY.ConeBottomRadius=.1]=\"ConeBottomRadius\",rY[rY.UpRate=.5]=\"UpRate\",rY[rY.ConeLengthRate=.08]=\"ConeLengthRate\",rY[rY.ConeBottomRadiusRate=.3]=\"ConeBottomRadiusRate\",(rQ=sD||(sD={}))[rQ.LabelOffset=.1]=\"LabelOffset\",rQ[rQ.MaxDistance=2e3]=\"MaxDistance\",rQ[rQ.MinDistance=0]=\"MinDistance\",rQ[rQ.lableOffsetRate=1.5]=\"lableOffsetRate\";class gx extends(0,uX.AF)(pv,ph,pz){managers;interactLevel;properties;slope;up;coneLength;coneBottomRadius;lableOffset;constructor(e,a){super(),this.managers=a,this.interactLevel=sc.Line,this.up=3,this.coneLength=.3,this.coneBottomRadius=.1,this.lableOffset=.1,this.primitives=py({}),this.properties=Object.assign({id:(0,uW.k)(),show:!0,type:\"polyline-slope\",cssColor:pG.Color},e),this.init(),this.setCollectionMap()}primitives;get id(){return String(this.properties.id)}get cssColor(){return this.properties.cssColor||pG.Color}get slopeMode(){return this.properties.slopeMode||pG.SlopeMode}get positions(){return this.properties.positions||[]}get enableLabelBackground(){return!1!==this.properties.enableLabelBackground}get labelBackgroundCssColor(){return this.properties.labelBackgroundCssColor||pG.Color}get labelTextColor(){return this.properties.labelTextColor||pG.LabelTextColor}get lineWidth(){return this.properties.lineWidth||pG.LineWidth}get labelTextSize(){return this.properties.labelTextSize||pG.LabelTextSize}get lineColor(){return this.properties.lineColor||pG.LineColor}update(e){Object.keys(e).forEach(a=>{let r=e[a];(0,pg.ri)(r)&&(this.properties[a]=r)}),this.render(e)}render(e){this.primitives._keys().forEach(a=>{this.updatePrimitive(a,e)})}onManagerAdd(e){this.addPrimitives(e)}addPrimitives(e){!this.primitives._get(e)&&this.primitives._add(e,{}),this.updatePrimitive(e,this.properties)}updatePrimitive(e,a){let r=this.primitives._get(e),t=this.managers._get(e);if(a){if(t&&r){if(r.slope){t.viewer.scene.primitives.remove(r.slope);let e=this.createSlope();if(this.isDestroyed)return;e&&(this.slope=e,r.slope=t.viewer.scene.primitives.add(e))}else{let e=this.createSlope();if(this.isDestroyed)return;e&&(this.slope=e,r.slope=t.viewer.scene.primitives.add(e))}}t.render()}}computeParms(e){let a=.1;if(e&&e.length>1){for(let r=0;r<e.length-1;r++){let t=e[r],n=e[r+1],i=uf.Cartesian3.fromDegrees(t.longitude,t.latitude,t?.height??0),o=uf.Cartesian3.fromDegrees(n.longitude,n.latitude,n?.height??0),s=uf.Cartesian3.distance(i,o);s>a&&(a=s)}this.up=.5*a,this.coneLength=.08*a,this.coneBottomRadius=.3*this.coneLength,this.lableOffset=1.5*this.coneBottomRadius}}createSlope(){let e=new uf.PrimitiveCollection,a=this.properties.positions,r=new uf.LabelCollection,t=[],n=[];if(a&&a.length>1){this.computeParms(a);for(let i=0;i<a.length-1;i++){let o=a[i],s=a[i+1],l=[],d=uf.Cartesian3.fromDegrees(o.longitude,o.latitude,(o?.height??0)+this.up),c=uf.Cartesian3.fromDegrees(o.longitude,o.latitude,o?.height??0);l.push(d,c),t.push(d);let u=uf.Cartesian3.fromDegrees(s.longitude,s.latitude,(s?.height??0)+this.up),p=uf.Cartesian3.subtract(d,u,new uf.Cartesian3),m=gC(o,s);!p.equals(uf.Cartesian3.ZERO)&&uf.Cartesian3.normalize(p,p);let h=this.addLinePrimitive(l,this.lineColor);e.add(h);let g=uf.Cartesian3.lerp(d,u,.5,new uf.Cartesian3),f=this.addConeGeometry(d,u,g);n.push(f);let _=uf.Cartographic.fromCartesian(g),b=uf.Cartesian3.fromRadians(_.longitude,_.latitude,_.height+this.lableOffset),k=this.getText(m,this.properties.slopeMode),v=this.addLableGeometry(k,b);r.add(v)}let i=a[a.length-1],o=uf.Cartesian3.fromDegrees(i.longitude,i.latitude,(i?.height??0)+this.up),s=uf.Cartesian3.fromDegrees(i.longitude,i.latitude,i?.height??0),l=this.addLinePrimitive([o,s],this.lineColor);e.add(l),t.push(o);let d=this.addLinePrimitive(t,this.cssColor),c=this.addConePrimitive(n);e.add(r),e.add(d),e.add(c)}return e}addConePrimitive(e){return new uf.Primitive({geometryInstances:e,appearance:new uf.PerInstanceColorAppearance({flat:!0,translucent:!1}),releaseGeometryInstances:!1})}getText(e,a){if(\"degree\"===(a=a||\"degree\"))return`${e.degree}\\xb0`;if(\"percentage\"===a)return Number.isNaN(e.percentage)?\"NA\":`${e.percentage}%`;if(\"ratio\"!==a)return\"\";else return Number.isNaN(e.ratio)?\"1:NA\":`1:${e.ratio}`}addLinePrimitive(e,a){if(!e.length)return;let r=new uf.PolylineGeometry({positions:e,width:this.lineWidth,vertexFormat:uf.PolylineColorAppearance.VERTEX_FORMAT});return new uf.Primitive({geometryInstances:new uf.GeometryInstance({geometry:r,attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(uf.Color.fromCssColorString(a))}}),appearance:new uf.PolylineColorAppearance})}addLableGeometry(e,a){return{position:a,text:e,font:`600 ${this.labelTextSize} ${pC}`,fillColor:uf.Color.fromCssColorString(this.labelTextColor),backgroundColor:uf.Color.fromCssColorString(this.cssColor),style:uf.LabelStyle.FILL,verticalOrigin:uf.VerticalOrigin.BOTTOM,showBackground:!0,horizontalOrigin:uf.HorizontalOrigin.CENTER,disableDepthTestDistance:Number.POSITIVE_INFINITY,distanceDisplayCondition:new uf.DistanceDisplayCondition(0,2e3)}}addConeGeometry(e,a,r){let t=new uf.Cartesian3(0,0,1),n=uf.Cartographic.fromCartesian(e),i=uf.Cartographic.fromCartesian(a),o=new uf.Cartesian3;if(i.height<n.height){let r=uf.Cartesian3.subtract(a,e,new uf.Cartesian3);!r.equals(uf.Cartesian3.ZERO)&&uf.Cartesian3.normalize(r,r),uf.Cartesian3.clone(r,o)}else{let r=uf.Cartesian3.subtract(e,a,new uf.Cartesian3);!r.equals(uf.Cartesian3.ZERO)&&uf.Cartesian3.normalize(r,r),uf.Cartesian3.clone(r,o)}let s=this.rotationBetween(t,o),l=uf.Matrix3.fromQuaternion(s),d=uf.Matrix4.fromRotationTranslation(l,r),c=new uf.CylinderGeometry({length:this.coneLength,topRadius:0,bottomRadius:this.coneBottomRadius});return new uf.GeometryInstance({geometry:c,modelMatrix:d,attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(uf.Color.fromCssColorString(this.cssColor))}})}rotationBetween(e,a){if(uf.Cartesian3.equalsEpsilon(a,uf.Cartesian3.ZERO,1e-6))return uf.Quaternion.IDENTITY;let r=uf.Cartesian3.normalize(e,new uf.Cartesian3),t=uf.Cartesian3.normalize(a,new uf.Cartesian3),n=uf.Cartesian3.cross(r,t,new uf.Cartesian3);if(1e-6>uf.Cartesian3.magnitude(n))return uf.Quaternion.IDENTITY;uf.Cartesian3.normalize(n,n);let i=Math.acos(Math.min(Math.max(uf.Cartesian3.dot(r,t),-1),1));return uf.Quaternion.fromAxisAngle(n,i)}onManagerRemove(e){this.removePrimitives(e)}onManagerUpdate(e){let a=this.primitives._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}setCollectionMap(){this.managers._options.elements.add(\"polyline-slope\",this,[this.id])}removePrimitives(e){let a=this.primitives._get(e),r=this.managers._get(e);r&&a&&a.slope&&r.viewer.scene.primitives.remove(a.slope),this.primitives._remove(e)}destroy(){this.primitives._keys().forEach(e=>{this.removePrimitives(e)}),this.removeCollectionMap()}}function gM(e){let{cssColor:a}=e;return new uf.PolylineMaterialAppearance({material:uf.Material.fromType(\"Color\",{color:uf.Color.fromCssColorString(a)})})}function gE(e){let a=uf.Color.fromCssColorString(e.lineOccludedColor);return 1!==e.lineOccludedAlpha&&(a.alpha=e.lineOccludedAlpha),new uf.PolylineMaterialAppearance({material:uf.Material.fromType(uf.Material.PolylineDashType,{color:a})})}let gP={\"#2D8CF0\":\"#FFFFFF\",\"#19BE6B\":\"#FFFFFF\",\"#FFBB00\":\"#000000\",\"#E23C39\":\"#FFFFFF\",\"#B620E0\":\"#FFFFFF\"};function gT(e,a){return gP[e]||a}class gR extends(0,uX.AF)(pv,ph,pz){managers;interactLevel;properties;primitives;constructor(e,a){super(),this.managers=a,this.interactLevel=sc.Line,this.primitives=py({}),this.properties=Object.assign({id:(0,uW.k)(),show:!0,type:\"polyline-triangle\",cssColor:pH.Color},e),this.init(),this.setCollectionMap()}get id(){return String(this.properties.id)}get show(){return!1!==this.properties.show}get cssColor(){return this.properties.cssColor||pH.Color}get positions(){return this.properties.positions||[]}get enableLabelBackground(){return!1!==this.properties.enableLabelBackground}get labelBackgroundCssColor(){return this.properties.labelBackgroundCssColor||pH.Color}get labelTextColor(){return this.properties.labelTextColor||pH.LabelTextColor}get lineWidth(){return this.properties.lineWidth||pH.LineWidth}get unit(){return this.properties.unit||pH.Uint}get labelTextSize(){return this.properties.labelTextSize||pH.LabelTextSize}get lineOccludedColor(){return this.properties.lineOccludedColor||this.cssColor}get lineOccludedAlpha(){return this.properties.lineOccludedAlpha||pH.LineOccludedAlpha}get labelDisplayCondition(){return this.properties.labelDisplayCondition||pH.LabelDisplayCondition}get labelScaleByDistance(){return this.properties.labelScaleByDistance||pH.LabelScaleByDistance}get valuePrecision(){return this.properties.valuePrecision||pH.ValuePrecision}get line3dLabelBackgroundCssColor(){return this.properties.line3dLabelBackgroundCssColor||this.labelBackgroundCssColor}get autoLabelTextColor(){return!1!==this.properties.autoLabelTextColor}hasPrimitive(e){return this.primitives._keys().some(a=>{let r=this.primitives._get(a);return r.lines===e||e instanceof uf.Label&&r.labels?.contains(e)})}updateShow(){let e=this.show,a=this.primitives;a.lines&&a.lines.showSetter(e),a.labels&&a.labels.showSetter(e)}updatePrimitivesAllManager(){this.primitives._keys().forEach(e=>{this.updateAllPrimitives(e)})}updateLabelStyleAllManager(){this.primitives._keys().forEach(e=>{this.updateLabelStyle(e)})}updateLabelStyle(e){let a=this.primitives._get(e);if(!a)return;let{labels:r}=a;if(!r)return;let t=r.length;for(let e=0;e<t;e++){let a=r.get(e);if(!!a)a.id.startsWith(\"line3d\")?a.backgroundColor=uf.Color.fromCssColorString(this.line3dLabelBackgroundCssColor):a.backgroundColor=uf.Color.fromCssColorString(this.labelBackgroundCssColor),a.fillColor=uf.Color.fromCssColorString(this.labelTextColor),a.font=`600 ${this.labelTextSize} ${pC}`,a.showBackground=this.enableLabelBackground}}updateLineStyleAllManager(){this.primitives._keys().forEach(e=>{this.updateLineStyle(e)})}updateLineStyle(e){let a=this.primitives._get(e);if(!a)return;let{lines:r}=a;if(!r)return;let t=gM(this),n=gE(this);r.appearance=t,r.depthFailAppearance=n}update(e){let a=this.properties;(0,pg.ri)(e.show)&&(a.show=e.show,this.updateShow(),this.managers.render?.());let r=!1,t=!1,n=!1;(0,pg.ri)(e.positions)&&(a.positions=e.positions,r=!0),(0,pg.ri)(e.labelTextSize)&&(a.labelTextSize=e.labelTextSize,r=!0),(0,pg.ri)(e.cssColor)&&(a.cssColor=e.cssColor,t=!0,n=!0),(0,pg.ri)(e.lineOccludedColor)&&(a.lineOccludedColor=e.lineOccludedColor,t=!0),(0,pg.ri)(e.lineOccludedAlpha)&&(a.lineOccludedAlpha=e.lineOccludedAlpha,t=!0),(0,pg.ri)(e.lineWidth)&&(a.lineWidth=e.lineWidth,r=!0),(0,pg.ri)(e.valuePrecision)&&(a.valuePrecision=e.valuePrecision,r=!0),(0,pg.ri)(e.enableLabelBackground)&&(a.enableLabelBackground=e.enableLabelBackground,n=!0),(0,pg.ri)(e.labelBackgroundCssColor)&&(a.labelBackgroundCssColor=e.labelBackgroundCssColor,n=!0),(0,pg.ri)(e.labelTextColor)&&(a.labelTextColor=e.labelTextColor,n=!0),(0,pg.ri)(e.labelDisplayCondition)&&(a.labelDisplayCondition=e.labelDisplayCondition,n=!0),(0,pg.ri)(e.labelScaleByDistance)&&(a.labelScaleByDistance=e.labelScaleByDistance,n=!0),(0,pg.ri)(e.line3dLabelBackgroundCssColor)&&(a.line3dLabelBackgroundCssColor=e.line3dLabelBackgroundCssColor,n=!0),r&&(this.updatePrimitivesAllManager(),this.managers.render?.(),n=!1,t=!1,r=!1),n&&(this.updateLabelStyleAllManager(),n=!1),t&&(this.updateLineStyleAllManager(),t=!1)}updateAllPrimitives(e){let a=this.managers._get(e);if(!a)return;let r=a.primitiveContainers[\"polyline-triangle\"],t=this.primitives._get(e);!t&&(t={},this.primitives._add(e,t));let n=function(e,a){let r=e.map((e,r)=>(function(e,a,r){let{spaceLength:t,heightDifference:n,horizontalLength:i,horizontalPointsWC:o,originPointsWC:s}=e,{unit:l,lineWidth:d,valuePrecision:c}=a,u=t5.Metric;\"feet\"===l&&(u=t5.Imperial);let p=new uf.GeometryInstance({geometry:new uf.PolylineGeometry({positions:o,width:d})}),m=n>0?s[1]:s[0],h=n>0?o[1]:o[0],g=new uf.GeometryInstance({geometry:new uf.PolylineGeometry({positions:[m,h],width:d})}),f=new uf.GeometryInstance({geometry:new uf.PolylineGeometry({positions:s.slice(),width:d})}),_={position:uf.Cartesian3.midpoint(o[0],o[1],new uf.Cartesian3),text:uw(i,t8.Length,u,!0,t9.round,c).text},b={id:`line3d-${r}`,position:uf.Cartesian3.midpoint(s[0],s[1],new uf.Cartesian3),text:uw(t,t8.Length,u,!0,t9.round,c).text};return{heightDiffGeometryInstance:g,horizontalGeometryInstance:p,spatialLineGeometryInstance:f,horizontalLabel:_,spaceLabel:b,heightDiffLabelOption:{position:uf.Cartesian3.midpoint(m,h,new uf.Cartesian3),text:uw(Math.abs(n),t8.Length,u,!0,t9.round,c).text}}})(e,a,r));return{heightDiffGeometryInstances:r.map(({heightDiffGeometryInstance:e})=>e),horizontalGeometryInstances:r.map(({horizontalGeometryInstance:e})=>e),spatialLineGeometryInstances:r.map(({spatialLineGeometryInstance:e})=>e),heightDiffLabelOptions:r.map(({heightDiffLabelOption:e})=>e),horizontalLabels:r.map(({horizontalLabel:e})=>e),spaceLabels:r.map(({spaceLabel:e})=>e)}}(function(e){let a=e.length;if(a<2)throw Error(`计算量测的点数必须大于2`);let r=[];for(let t=0;t<a-1;t++){let a=e[t],n=e[t+1];r.push(function(e,a){var r,t;let n=(r=e,t=a,Math.max(r.height??0,t.height??0)),i=hu.from(e,{height:n}),o=hu.from(a,{height:n}),s=(0,pg.jL)(i,!1),l=(0,pg.jL)(o,!1),d=uf.Cartesian3.distance(s,l),c=(0,pg.jL)(e,!1),u=(0,pg.jL)(a,!1),p=uf.Cartesian3.distance(c,u);return{spaceLength:p,horizontalLength:d,heightDifference:(e.height||0)-(a.height||0),originPointsWC:[c,u],horizontalPointsWC:[s,l]}}(a,n))}if(r.length!==a-1)throw Error(`量测计算失败，应获得 positionLength - 1 = ${a-1} 个测量结果，但实际获得 triangleMeasures.length = ${r.length} 个`);return r}(this.positions),this),{lines:i,labels:o}=t;if(i&&r.contains(i)&&r.remove(i),t.lines=void 0,!1!==this.properties.show){let e=function(e,a){let{heightDiffGeometryInstances:r,horizontalGeometryInstances:t,spatialLineGeometryInstances:n}=a,i=gM(e),o=gE(e);return new uf.Primitive({geometryInstances:[...r,...t,...n],appearance:i,depthFailAppearance:o,asynchronous:!1})}(this,n);t.lines=e,r.add(e)}if(o&&r.contains(o)&&r.remove(o),t.labels=void 0,!1!==this.properties.show){let e=function(e,a){let{heightDiffLabelOptions:r,horizontalLabels:t,spaceLabels:n}=a,{enableLabelBackground:i,labelBackgroundCssColor:o,labelTextSize:s,labelTextColor:l,labelDisplayCondition:d,labelScaleByDistance:[c,u,p,m],line3dLabelBackgroundCssColor:h,autoLabelTextColor:g}=e,f=new uf.LabelCollection,_=`800 ${s} ${pC}`,b=new uf.DistanceDisplayCondition(d[0],d[1]),k=new uf.NearFarScalar(c,u,p,m),v=e=>{var a,r,t,n;if(e.id?.startsWith(\"line3d\")){;e.backgroundColor=uf.Color.fromCssColorString(h);let t=g?(a=h,r=l,gP[a]||r):l;e.fillColor=uf.Color.fromCssColorString(t)}else{;e.backgroundColor=uf.Color.fromCssColorString(o);let a=g?(t=o,n=l,gP[t]||n):l;e.fillColor=uf.Color.fromCssColorString(a)}e.showBackground=i,e.style=uf.LabelStyle.FILL,e.verticalOrigin=uf.VerticalOrigin.BOTTOM,e.horizontalOrigin=uf.HorizontalOrigin.CENTER,e.font=_,e.distanceDisplayCondition=b,e.scaleByDistance=k,e.backgroundPadding=new uf.Cartesian2(5,5),e.disableDepthTestDistance=Number.POSITIVE_INFINITY,e.depthFailTranslucency=.5,f.add(e)};return r.forEach(v),t.forEach(v),n.forEach(v),f}(this,n);t.labels=e,r.add(e)}}addPrimitives(e){this.updateAllPrimitives(e),this.managers._get(e).render()}onManagerAdd(e){this.addPrimitives(e)}onManagerRemove(e){this.removePrimitives(e)}onManagerUpdate(e){let a=this.primitives._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}setCollectionMap(){this.managers._options.elements.add(\"polyline-triangle\",this,[this.id])}removePrimitives(e){let a=this.primitives._get(e),r=this.managers._get(e);if(!r||!a)return;let t=r.primitiveContainers[\"polyline-triangle\"];for(let e in a){let r=a[e];r&&(t.remove(r),a[e]=void 0)}}destroy(){this.primitives._keys().forEach(e=>{this.removePrimitives(e)}),this.removeCollectionMap()}}function gF(e,a){let r=e.flat(),t=Math.min(...r),n=Math.max(...r),i=(n-t)*(a-1)/2;return n+=i,{min:t-=i,max:n}}function gL(e){return new uf.PolylineMaterialAppearance({material:uf.Material.fromType(uf.Material.PolylineDashType,{color:uf.Color.fromCssColorString(e)}),translucent:!1,renderState:{depthTest:!1}})}class gN extends(0,uX.AF)(pv,ph,pz){managers;properties;interactLevel;members;_minHeight;_maxHeight;constructor(e,a){super(),this.managers=a,this.interactLevel=sc.Area,this.members=py({}),this.properties=Object.assign({id:(0,uW.k)(),show:!0,type:\"polyline-profile\"},e),this.init(),this.setCollectionMap()}get id(){return this.properties.id||(0,uW.k)()}get show(){return!1!==this.properties.show}get positions(){return this.properties.positions||[]}get heights(){return this.properties.heights?.map(e=>e.data)||[]}get heightExtendFactor(){return pB.HeightScaleFactor}get lineCssColors(){return this.properties.heights?.map(e=>e.cssColor||pB.LineColor)||[]}get lineStyles(){return this.properties.heights?.map(e=>e.style||pB.LineStyle)||[]}get lineCssColorDefault(){return pB.LineColor}get solidLineIndexList(){return this.properties.heights?.reduce((e,a,r)=>(a?.style===\"solid\"&&e.push(r),e),[])??[]}get dashLineIndexList(){return this.properties.heights?.reduce((e,a,r)=>(a?.style===\"dash\"&&e.push(r),e),[])??[]}get polygonAlpha(){return pB.PolygonAlpha}get primaryLineWidth(){return pB.PrimaryLineWidth}get historyLineWidth(){return pB.HistoryLineWidth}get abovegroundCssColor(){return pB.AbovegroundColor}get undergroundCssColor(){return pB.UndergroundColor}get abovegroundPolygonInstanceId(){return`${this.id}-abovegroundPolygonInstance`}get undergroundPolygonInstanceId(){return`${this.id}-undergroundPolygonInstance`}get lineInstanceIdPrefix(){return`${this.id}-lineInstance`}get points(){return this.properties.pins||[]}get pointSize(){return pB.PointSize}get pointColor(){return pB.PointColor}get pointOutlineColor(){return pB.PointOutlineColor}get pointOutlineWidth(){return pB.PointOutlineWidth}get verticalLineColor(){return pB.VerticalLineColor}get verticalLineWidth(){return pB.VerticalLineWidth}get heightRange(){return this._minHeight&&this._maxHeight?{min:this._minHeight,max:this._maxHeight}:void 0}get boundingSphere(){let e=[];if(this.members._keys().forEach(a=>{let r=this.members._get(a);if(r&&r.polygons){let a=r.polygons.getGeometryInstanceAttributes(this.abovegroundPolygonInstanceId),t=r.polygons.getGeometryInstanceAttributes(this.undergroundPolygonInstanceId);a&&t&&(e.push(a.boundingSphere),e.push(t.boundingSphere))}}),2===e.length)return uf.BoundingSphere.union(e[0],e[1],new uf.BoundingSphere)}updateShow(){let e=this.show,a=this.members;a.polygons&&a.polygons.showSetter(e),a.lines&&a.lines.showSetter(e),a.points&&a.points.showSetter(e),a.verticalLine&&a.verticalLine.showSetter(e)}updatePrimitivesAllManager(){this.members._keys().forEach(e=>{this.updateAllPrimitives(e)})}updateAuxiliaryPrimitivesAllManager(){this.members._keys().forEach(e=>{this.updateAuxiliaryPrimitives(e)})}updatePolygonStyleAllManager(){this.members._keys().forEach(e=>{this.updatePolygonStyle(e)})}updateLineStyleAllManager(){this.members._keys().forEach(e=>{this.updateLineStyle(e)})}updatePolygonStyle(e){let a=this.members._get(e);if(!a)return;let{polygons:r}=a;if(!!r)[[this.abovegroundPolygonInstanceId,this.abovegroundCssColor],[this.undergroundPolygonInstanceId,this.undergroundCssColor]].forEach(([e,a])=>{let t=r.getGeometryInstanceAttributes(e);t&&(t.color=uf.ColorGeometryInstanceAttribute.toValue(uf.Color.fromCssColorString(a),t.color))})}updateLineStyle(e){let a=this.members._get(e);if(!a)return;let{lines:r}=a;if(!r)return;let t=r.get(0);for(let e of this.solidLineIndexList){let a=`${this.lineInstanceIdPrefix}-${e}`,r=this.lineCssColors[e],n=t.getGeometryInstanceAttributes(a);n&&(n.color=uf.ColorGeometryInstanceAttribute.toValue(uf.Color.fromCssColorString(r),n.color))}for(let e=0;e<this.dashLineIndexList.length;e++){let a=this.dashLineIndexList[e],t=gL(this.lineCssColors[a]);r.get(e+1).appearance=t}}update(e){let a=this.properties;(0,uf.defined)(e.show)&&(a.show=e.show,this.updateShow(),this.managers.render?.());let r=!1,t=!1;(0,uf.defined)(e.positions)&&(a.positions=e.positions,r=!0),(0,uf.defined)(e.heights)&&(a.heights=e.heights,r=!0),(0,uf.defined)(e.pins)&&(a.pins=e.pins,t=!0),r&&(this.updatePrimitivesAllManager(),this.managers.render?.(),r=!1),!r&&t&&(this.updateAuxiliaryPrimitivesAllManager(),this.managers.render?.(),t=!1)}updateAuxiliaryPrimitives(e){let a=this.managers._get(e);if(!a)return;let r=a.primitiveContainers[\"polyline-profile\"],t=this.members._get(e);if(!t)return;let{points:n,verticalLine:i}=t;if(i&&r.contains(i)&&r.remove(i),t.verticalLine=void 0,0===this.points.length){n&&r.contains(n)&&r.remove(n),t.points=void 0;return}let o=this.heightRange??gF(this.heights,this.heightExtendFactor),s=function(e,a){if(0===e.length)throw Error(`点数量必须大于0`);let r=e.map(e=>uf.Cartesian3.fromDegrees(e.longitude,e.latitude,e.height||0));return{pointsPositions:r,verticalLinePositions:[uf.Cartesian3.fromDegrees(e[0].longitude,e[0].latitude,a.min),uf.Cartesian3.fromDegrees(e[0].longitude,e[0].latitude,a.max)]}}(this.points,o),l=function(e,a){let{pointsPositions:r,verticalLinePositions:t}=a,n=[];for(let a=0;a<r.length;a++){let t=r[a],i=e.lineCssColors[a]||e.pointColor;n.push({position:t,pixelSize:e.pointSize,outlineWidth:e.pointOutlineWidth,color:uf.Color.fromCssColorString(i),outlineColor:uf.Color.fromCssColorString(e.pointOutlineColor),disableDepthTestDistance:Number.POSITIVE_INFINITY})}return{pointOptions:n,verticalLine:[new uf.GeometryInstance({geometry:new uf.PolylineGeometry({positions:t,width:e.verticalLineWidth})})]}}(this,s);if(!1!==this.properties.show){var d,c;let e=(d=this,c=l.verticalLine,new uf.Primitive({geometryInstances:c,appearance:new uf.PolylineMaterialAppearance({material:uf.Material.fromType(uf.Material.ColorType,{color:uf.Color.fromCssColorString(d.verticalLineColor)}),translucent:!0,renderState:{depthTest:!1}}),asynchronous:!1}));t.verticalLine=e,r.add(e)}if(n&&r.contains(n)){let{pointsPositions:e}=s;for(let a=0;a<n.length;a++){let r=n.get(a);r&&e[a]&&(r.position=e[a])}}else if(!1!==this.properties.show){let e=function(e){let a=new uf.PointPrimitiveCollection({blendOption:uf.BlendOption.OPAQUE});return e.forEach(e=>{a.add(e)}),a}(l.pointOptions);t.points=e,r.add(e)}}updateAllPrimitives(e){let a=this.managers._get(e);if(!a)return;let r=a.primitiveContainers[\"polyline-profile\"],t=this.members._get(e);!t&&(t={},this.members._add(e,t));let n=gF(this.heights,this.heightExtendFactor);this._minHeight=n.min,this._maxHeight=n.max;let i=function(e,a){let{undergroundPolygonPositionsArray:r,abovegroundPolygonPositionsArray:t,polygonIndices:n,linesPositions:i}=a,o=new uf.GeometryInstance({id:e.abovegroundPolygonInstanceId,geometry:new uf.Geometry({attributes:{position:new uf.GeometryAttribute({componentDatatype:uf.ComponentDatatype.DOUBLE,componentsPerAttribute:3,values:new Float64Array(t)})},indices:new Uint32Array(n),primitiveType:uf.PrimitiveType.TRIANGLES,boundingSphere:uf.BoundingSphere.fromVertices(t)}),attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(uf.Color.fromCssColorString(e.abovegroundCssColor).withAlpha(e.polygonAlpha))}}),s=new uf.GeometryInstance({id:e.undergroundPolygonInstanceId,geometry:new uf.Geometry({attributes:{position:new uf.GeometryAttribute({componentDatatype:uf.ComponentDatatype.DOUBLE,componentsPerAttribute:3,values:new Float64Array(r)})},indices:new Uint32Array(n),primitiveType:uf.PrimitiveType.TRIANGLES,boundingSphere:uf.BoundingSphere.fromVertices(r)}),attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(uf.Color.fromCssColorString(e.undergroundCssColor).withAlpha(e.polygonAlpha))}}),l=[];for(let a=0;a<i.length;a++){let r;let t=0===a?e.primaryLineWidth:e.historyLineWidth,n=e.lineCssColors[a]||e.lineCssColorDefault;r=\"solid\"===e.lineStyles[a]?new uf.GeometryInstance({id:`${e.lineInstanceIdPrefix}-${a}`,geometry:new uf.PolylineGeometry({positions:i[a],width:t,vertexFormat:uf.PolylineColorAppearance.VERTEX_FORMAT}),attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(uf.Color.fromCssColorString(n))}}):new uf.GeometryInstance({geometry:new uf.PolylineGeometry({positions:i[a],width:t})}),l.push(r)}return{polygons:[o,s],lines:l}}(this,function(e,a,r){let t=e.length;if(t<2)throw Error(`采样点数量必须大于2`);for(let e of a)if(e.length!==t)throw Error(`采样点坐标与高程点数量不匹配`);if(a.length<1)throw Error(`模型高度线数量必须大于0`);let n=a[0],i=[];for(let a=0;a<t;a++)i.push({longitude:e[a].longitude,latitude:e[a].latitude,height:n[a]});let{undergroundPolygonPositionsArray:o,abovegroundPolygonPositionsArray:s,polygonIndices:l}=function(e,a){let r=e.length,t=[],n=[],i=[];for(let o=0;o<r;o++){let s=e[o],l=uf.Cartesian3.fromDegrees(s.longitude,s.latitude,s.height||0),d=uf.Cartesian3.fromDegrees(s.longitude,s.latitude,a.min),c=uf.Cartesian3.fromDegrees(s.longitude,s.latitude,a.max);n.push(l.x,l.y,l.z),n.push(c.x,c.y,c.z),i.push(d.x,d.y,d.z),i.push(l.x,l.y,l.z);let u=2*o,p=2*o+1,m=2*o+2,h=2*o+3;o!==r-1&&(t.push(u,p,m),t.push(p,h,m))}return{undergroundPolygonPositionsArray:i,abovegroundPolygonPositionsArray:n,polygonIndices:t}}(i,r);return{undergroundPolygonPositionsArray:o,abovegroundPolygonPositionsArray:s,polygonIndices:l,linesPositions:function(e,a){let r=[];for(let t=0;t<a.length;t++){let n=[];for(let r=0;r<a[t].length;r++)n.push(uf.Cartesian3.fromDegrees(e[r].longitude,e[r].latitude,a[t][r]));r.push(n)}return r}(e,a)}}(this.positions,this.heights,n)),{polygons:o,lines:s}=t;if(o&&r.contains(o)&&r.remove(o),t.polygons=void 0,s&&r.contains(s)&&r.remove(s),t.lines=void 0,!1!==this.properties.show){var l,d;let e=(l=0,d=i.polygons,new uf.Primitive({geometryInstances:d,appearance:new uf.PerInstanceColorAppearance({translucent:!0,flat:!0,renderState:{depthTest:!1}}),asynchronous:!1}));t.polygons=e,r.add(e);let a=function(e,a){let r=new uf.PrimitiveCollection,t=a.filter(e=>void 0!==e.attributes.color),n=new uf.Primitive({geometryInstances:t,appearance:new uf.PolylineColorAppearance({translucent:!1,renderState:{depthTest:!1}}),asynchronous:!1});r.add(n);for(let t=0;t<a.length;t++){if(void 0!==a[t].attributes.color)continue;let n=e.lineCssColors[t]||e.lineCssColorDefault,i=new uf.Primitive({geometryInstances:a[t],appearance:gL(n),asynchronous:!1});r.add(i)}return r}(this,i.lines);t.lines=a,r.add(a)}this.updateAuxiliaryPrimitives(e)}addPrimitives(e){this.updateAllPrimitives(e),this.managers._get(e).render()}setCollectionMap(){this.managers._options.elements.add(\"polyline-profile\",this,[this.id])}onManagerAdd(e){this.addPrimitives(e)}onManagerRemove(e){this.removePrimitives(e)}onManagerUpdate(e){let a=this.members._get(e),r=this.isShowIn(e);a&&!r&&this.onManagerRemove(e),!a&&r&&this.onManagerAdd(e)}removePrimitives(e){let a=this.members._get(e),r=this.managers._get(e);if(!r||!a)return;let t=r.primitiveContainers[\"polyline-profile\"];a.polygons&&(t.remove(a.polygons),a.polygons=void 0),a.lines&&(t.remove(a.lines),a.lines=void 0),a.points&&(t.remove(a.points),a.points=void 0),a.verticalLine&&(t.remove(a.verticalLine),a.verticalLine=void 0),this._minHeight=void 0,this._maxHeight=void 0}destroy(){this.members._keys().forEach(e=>{this.removePrimitives(e)}),this.removeCollectionMap()}}function gJ(e){var a,r;return new uf.Appearance({renderState:{blending:uf.BlendingState.PRE_MULTIPLIED_ALPHA_BLEND,depthTest:{enabled:!0},depthMask:!0,lineWidth:1},translucent:!1,vertexShaderSource:(a=0,`in vec3 position3DHigh; in vec3 position3DLow; in vec4 color; in float batchId; out vec4 v_color; void main() { vec4 p = czm_computePosition(); v_color"
}