{
  "metadata": {
    "source_file": "map-app\\static\\js\\index.5da8ba4c.js",
    "chunk_index": 13,
    "total_chunks": 918,
    "chunk_size": 81633,
    "word_count": 800,
    "model_kwargs": {
      "model": "text-embedding-3-large",
      "dimensions": 3072,
      "encoding_format": "float"
    },
    "text_splitter": {
      "split_by": "word",
      "chunk_size": 800,
      "chunk_overlap": 200
    },
    "created_at": "2025-12-17T23:57:50.147Z"
  },
  "content": "uf.Cartesian3),s=uf.Cartesian3.normalize(uf.Cartesian3.cross(i,o,new uf.Cartesian3),new uf.Cartesian3),l=uf.Cartesian3.normalize(uf.Cartesian3.subtract(e,t,new uf.Cartesian3),new uf.Cartesian3),d=uf.Cartesian3.dot(l,o),c=uf.Cartesian3.dot(l,s),u=uf.Math.toDegrees(uf.Math.acosClamped(d));return c<0&&(u=360-u),u}return 0}computePositionFromAngle(e,a){let r=this.activeShapePoints.value;if(r.length>=2){let t=r[0],n=r[1],i=uf.Cartesian3.normalize(n,new uf.Cartesian3),o=uf.Cartesian3.normalize(uf.Cartesian3.subtract(n,t,new uf.Cartesian3),new uf.Cartesian3),s=uf.Cartesian3.normalize(uf.Cartesian3.cross(i,o,new uf.Cartesian3),new uf.Cartesian3),l=(0,pg.ir)(s,o,uf.Math.toRadians(a)),d=uf.Cartesian3.distance(e,n),c=uf.Cartesian3.multiplyByScalar(l,d,new uf.Cartesian3);return uf.Cartesian3.add(n,c,new uf.Cartesian3)}return e}mouseMovePolygon3D(e){let a;let r=this.activeShapePoints.value,t=r.length;if(1===t)a=this.manager.picker.pickPosition(e.endPosition);else if(2===t&&(this.manager.hover.setCursor(\"confirm\",\"temporary\"),a=this.pickPlanePosition(e.endPosition,this.verticalPlane),this.withShift&&a)){let e=15*Math.round(this.getPolygon3DAngle(a)/15);a=this.computePositionFromAngle(a,e)}if(a){if(this.floatingPoint.value=a,this.polygon3DAngle=2===t?this.getPolygon3DAngle(a):null,this.polygon3DLine?this.polygon3DLine.drawingPositions=r.concat([a]).map(e=>(0,pg.KO)(e,!0)):this.polygon3DLine=this.createPolygon3DLine(),2!==t||this.activeShape){if(this.activeShape){let e=this.getPolygon3DPositions();this.activeShape?.update({positions:e})}}else this.activeShape=this.drawShape()}this.manager.render()}mouseMoveClosedLine(e){let a=this.activeShapePoints.value,r=a.length;if(!r)return;let t=this.manager.picker.pickPosition(e.endPosition);if(t){this.floatingPoint.value=t,!this.activeShape&&(this.activeShape=this.drawShape());let e=a.concat([t]),n=r>1?e.concat([a[0]]):e;this.activeShape instanceof h8&&(this.activeShape.drawingPositions=n.map(e=>(0,pg.KO)(e,!0)))}this.manager.render()}mouseMovePrism(e){let a,r;let t=this.activeShapePoints.value,n=t.length;if(n){if(0===this.activeSolidStatus)a=this.manager.picker.pickPosition(e.endPosition);else{this.manager.hover.setCursor(\"confirm\",\"temporary\"),this.getPrismHeightPlane(e);let n=-9999,i=mu(this.manager.viewer);(a=Math.abs(i)>=80?t[0].clone():this.pickPlanePosition(e.endPosition,this.prismHeightPlane))&&(n=(0,pg.KO)(a,!0).height||-9999);let o=(0,pg.KO)(t[0]);o.height=n,a=(0,pg.jL)(o);let s=n>this.prismSurfaceHeight;r=s?this.prismSurfaceHeight:n,this.prismExtrudedHeight=Math.abs(n-this.prismSurfaceHeight),Math.abs(i)>=80?this.prismExtrudedHeight=0:this.prismExtrudedHeight<.5&&(this.prismExtrudedHeight=.5,o.height=s?this.prismSurfaceHeight+.5:this.prismSurfaceHeight-.5,a=(0,pg.jL)(o),r=s?this.prismSurfaceHeight:this.prismSurfaceHeight-this.prismExtrudedHeight)}if(a){if(this.floatingPoint.value=a,!this.prismBaseLine&&(this.prismBaseLine=this.createPrismBaseLine()),0===this.activeSolidStatus){let e=t.concat([a]),r=n>1?e.concat([t[0]]):e;this.prismBaseLine.drawingPositions=r.map(e=>(0,pg.KO)(e,!0))}else 1===this.activeSolidStatus&&(this.activeShape?this.activeShape.update({height:r||0,extrudedHeight:this.prismExtrudedHeight||0}):this.activeShape=this.drawShape())}this.manager.render()}}mouseMoveCylinder(e){let a,r;if(this.activeShapePoints.value.length){if(this.getCylinderPlane(e),0===this.activeSolidStatus)a=this.pickPlanePosition(e.endPosition,this.cylinderPlane);else{this.manager.hover.setCursor(\"confirm\",\"temporary\");let t=-9999;(a=this.pickPlanePosition(e.endPosition,this.cylinderPlane))&&(t=(0,pg.KO)(a,!0).height||-9999);let{centerPos:n,radius:i}=this.activeCirclePosParams,o=mF(n,i,void 0,n?.height)[0];o.height=t,a=(0,pg.jL)(o);let s=t>this.cylinderSurfaceHeight;r=s?this.cylinderSurfaceHeight:t,this.cylinderExtrudedHeight=Math.abs(t-this.cylinderSurfaceHeight),Math.abs(mu(this.manager.viewer))>=80?this.cylinderExtrudedHeight=0:this.cylinderExtrudedHeight<.5&&(this.cylinderExtrudedHeight=.5,o.height=s?this.cylinderSurfaceHeight+.5:this.cylinderSurfaceHeight-.5,a=(0,pg.jL)(o),r=s?this.cylinderSurfaceHeight:this.cylinderSurfaceHeight-this.cylinderExtrudedHeight)}if(a){if(this.floatingPoint.value=a,0===this.activeSolidStatus){this.activeCirclePosParams.circleEdgePoint=(0,pg.KO)(a,!0),this.activeCirclePosParams.radius=mE([this.activeCirclePosParams.circleEdgePoint,this.activeCirclePosParams.centerPos]).horizontalCumulativeDistance;let{centerPos:e,radius:r}=this.activeCirclePosParams,t=mF(e,r,void 0,e?.height);this.cylinderBaseLine?this.cylinderBaseLine.drawingPositions=t.concat([t[0]]):this.cylinderBaseLine=this.createCylinderBaseLine()}else this.activeShape?this.activeShape.update({height:r||0,extrudedHeight:this.cylinderExtrudedHeight||0}):this.activeShape=this.drawShape()}}}mouseMove(e){switch(this.drawingMode){case c2.oO.circle:this.mouseMoveCircle(e);break;case c2.oO.polygon3d:this.mouseMovePolygon3D(e);break;case c2.oO.line:case c2.oO.polygon:this.mouseMovePolylineAndPolygon(e);break;case c2.oO.prism:this.mouseMovePrism(e);break;case c2.oO.cylinder:this.mouseMoveCylinder(e);break;case c2.oO.closedLine:this.mouseMoveClosedLine(e)}return!(this.activeShapePoints.value.length>0)&&!this.activeCirclePosParams.centerPos&&!0}exitDrawing(){this.clearDrawing(!0),this.manager.picker.pickPositionMode=\"single\",this.manager.clearMode(\"draw\"),this.manager.clearDrawingElementProps(),this.manager.emit(\"onExitDrawing\"),this.manager.hover.setCursor(\"\",\"temporary\")}checkElementShapeCanFinish(e){if(!e)return!0;let{enableIntersectFinish:a,enableOverAreaFinish:r}=this.drawingOptions,t=!0;return e.isIntersect&&(t=t&&a),e.isAreaExceed&&(t=t&&r),t}canFinish(){switch(this.drawingMode){case c2.oO.prism:return this.activeShapePoints.value.length>2&&0===this.activeSolidStatus;case c2.oO.cylinder:return this.activeShapePoints.value.length>=1&&0===this.activeSolidStatus;case c2.oO.polygon:case c2.oO.closedLine:{let e=this.checkElementShapeCanFinish(this.activeShape);return this.activeShapePoints.value.length>2&&e}case c2.oO.circle:return void 0!==this.activeCirclePosParams.centerPos;default:{let e=this.checkElementShapeCanFinish(this.activeShape);return this.activeShapePoints.value.length>1&&e}}}finishCylinderSurface(){this.manager.emit(\"onDrawStateChange\",{type:this.drawingMode,state:c2.hY.height,origin:this.origin}),this.activeSolidStatus=1,this.manager.hover.setCursor(\"confirm\",\"temporary\"),this.cylinderSurfaceHeight=this.activeCirclePosParams.centerPos?.height||0}finishPrismSurface(){this.manager.emit(\"onDrawStateChange\",{type:this.drawingMode,state:c2.hY.height,origin:this.origin}),this.activeSolidStatus=1,this.manager.hover.setCursor(\"confirm\",\"temporary\");let e=this.activeShapePoints.value.reduce((e,a)=>{let r=(0,pg.KO)(a,!0).height||-9999;return r>e?r:e},-9999);if(this.prismSurfaceHeight=e,this.activeShapePoints.value=this.activeShapePoints.value.map(a=>{let r=(0,pg.KO)(a);r.height=e;let t=(0,pg.jL)(r);return t.id=(0,uW.k)(),t}),this.prismBaseLine){let e=this.activeShapePoints.value,a=e.concat([e[0]]);this.prismBaseLine.drawingPositions=a.map(e=>(0,pg.KO)(e,!0))}}getPrismHeightPlane(e){let a=this.activeShapePoints.value,r=a.length,t=this.manager.viewer.scene,n=!1;for(let i=0;i<r;i++){let o=a[i],s=a[(i+1)%r],l=t.cartesianToCanvasCoordinates(o),d=t.cartesianToCanvasCoordinates(s);if(l.x<e.endPosition.x&&d.x>e.endPosition.x){let e=uf.Cartesian3.cross(o,s,new uf.Cartesian3),a=uf.Plane.fromPointNormal(o,uf.Cartesian3.normalize(e,new uf.Cartesian3));this.prismHeightPlane=a,n=!0}}if(!1===n){let n=9999;for(let i=0;i<r;i++){let r=a[i],o=Math.abs(t.cartesianToCanvasCoordinates(r).x-e.endPosition.x);if(o<n){let e=this.manager.viewer.camera.directionWC,a=uf.Transforms.eastNorthUpToFixedFrame(r),t=uf.Matrix4.multiplyByPointAsVector(uf.Matrix4.inverse(a,new uf.Matrix4),e,new uf.Cartesian3);t.z=0;let i=uf.Matrix4.multiplyByPointAsVector(a,t,new uf.Cartesian3),s=uf.Plane.fromPointNormal(r,uf.Cartesian3.normalize(i,new uf.Cartesian3));this.prismHeightPlane=s,n=o}}}}getCylinderPlane(e){let a=this.activeShapePoints.value;if(0===a.length)return;let r=this.manager.viewer.scene;if(0===this.activeSolidStatus){let e=a[0],r=uf.Transforms.eastNorthUpToFixedFrame(e),t=new uf.Cartesian3(0,0,1),n=uf.Matrix4.multiplyByPointAsVector(r,t,new uf.Cartesian3);this.cylinderPlane=uf.Plane.fromPointNormal(e,uf.Cartesian3.normalize(n,new uf.Cartesian3))}else{let a=!1,{centerPos:t,radius:n}=this.activeCirclePosParams,i=mF(t,n,void 0,t?.height),o=i.length;if(!e)return;let s=Number.MAX_VALUE;for(let t=0;t<o;t++){let n=(0,pg.jL)(i[t]),l=(0,pg.jL)(i[(t+1)%o]),d=r.cartesianToCanvasCoordinates(n),c=r.cartesianToCanvasCoordinates(l),u=d.x,p=c.x,m=e.endPosition.x;if(u<m&&m<p||u>m&&m>p){let e=uf.Cartesian3.cross(n,l,new uf.Cartesian3),r=uf.Plane.fromPointNormal(n,uf.Cartesian3.normalize(e,new uf.Cartesian3)),t=this.manager.viewer.camera.positionWC,i=uf.Cartesian3.distance(t,n);s>=i&&(this.cylinderPlane=r,a=!0,s=i)}}if(!1===a){let a=9999;for(let t=0;t<o;t++){let n=(0,pg.jL)(i[t]),o=Math.abs(r.cartesianToCanvasCoordinates(n).x-e.endPosition.x);if(o<a){let e=this.manager.viewer.camera.directionWC,r=uf.Transforms.eastNorthUpToFixedFrame(n),t=uf.Matrix4.multiplyByPointAsVector(uf.Matrix4.inverse(r,new uf.Matrix4),e,new uf.Cartesian3);t.z=0;let i=uf.Matrix4.multiplyByPointAsVector(r,t,new uf.Cartesian3),s=uf.Plane.fromPointNormal(n,uf.Cartesian3.normalize(i,new uf.Cartesian3));this.cylinderPlane=s,a=o}}}}}finishDrawing(){if(this.drawingMode===c2.oO.prism&&0===this.activeSolidStatus){this.checkElementShapeCanFinish(this.prismBaseLine)?this.finishPrismSurface():this.drawingOptions.onAbortFinishDrawing?.(this.drawingMode,\"baseline\",h2.PrismBaselineIntersect);return}if(this.drawingMode===c2.oO.cylinder&&0===this.activeSolidStatus){this.finishCylinderSurface();return}if(this.activeShape){if(this.activeShape instanceof mX){if(this.drawingState.checkCircleFinishPermission&&!this.drawingState.checkCircleFinishPermission(this.activeShape.radius,this.activeShape.centerPos))return;this.manager.emit(\"finishDraw\",{type:this.drawingMode,element:this.activeShape,shape:(0,lL.cloneDeep)(this.activeCirclePosParams),origin:this.origin})}else if(this.drawingMode===c2.oO.polygon3d&&this.activeShape instanceof hY)this.manager.emit(\"finishDraw\",{type:this.drawingMode,element:this.activeShape,shape:{positions:this.getPolygon3DPositions(),color:this.activeShape.cssColor},origin:this.origin});else if(this.drawingMode===c2.oO.prism&&this.activeShape instanceof gs)this.manager.emit(\"finishDraw\",{type:this.drawingMode,element:this.activeShape,shape:{positions:this.activeShapePoints.value.map(e=>(0,pg.KO)(e)),height:this.prismSurfaceHeight,extrudedHeight:this.prismExtrudedHeight,color:this.activeShape.cssColor},origin:this.origin});else if(this.drawingMode===c2.oO.cylinder&&this.activeShape instanceof hp)this.manager.emit(\"finishDraw\",{type:this.drawingMode,element:this.activeShape,shape:{positions:[],center:this.activeCirclePosParams.centerPos,radius:this.activeCirclePosParams.radius,height:this.prismSurfaceHeight,extrudedHeight:this.prismExtrudedHeight,color:this.activeShape.cssColor||\"#fff\"},origin:this.origin});else{if(this.manager.isDrawingLayerLocked&&this.origin===c2.tT.map){this.manager.emit(\"statusLimit\",\"limit-create\");return}if(this.origin===c2.tT.map&&this.activeShape instanceof hW&&(this.activeShape.properties.alphaByDistance=h0),!this.canFinish())return;this.manager.emit(\"finishDraw\",{type:this.drawingMode,element:this.activeShape,shape:{positions:this.activeShapePoints.value.map(e=>(0,pg.KO)(e,!this.activeShape.clampToGround)),color:this.activeShape.cssColor||\"#fff\"},origin:this.origin})}if(this.drawingMode===c2.oO.polygon){let e=this.activeShape;e.measureType&&\"aec\"===e.measureType?this.clearDrawing(!0):this.clearDrawing(!1)}else this.clearDrawing(!1)}}clearDrawing(e=!1){this.activeShape&&(e||this.drawingMode===c2.oO.closedLine?this.activeShape.destroy():this.activeShape instanceof hY||this.activeShape instanceof gs?this.manager.hover.setCursor(\"\",\"temporary\"):(this.activeShape instanceof mX?(this.activeShape.active(\"selected\",!1),this.activeShape.stabilize(this.activeCirclePosParams)):(this.activeShape.active(\"selected\",!1),this.activeShape.stabilize(this.activeShapePoints.value)),this.activeShape.edit())),this.polygon3DLine&&this.polygon3DLine.destroy(),this.polygon3DAngleModel&&this.polygon3DAngleModel.destroy(),this.prismBaseLine&&this.prismBaseLine.destroy(),this.cylinderBaseLine&&this.cylinderBaseLine.destroy(),this.resetDrawingOptions(),this.activeShape=null,this.activeShapePoints.value=[],this.floatingPoint.value=null,this.polygon3DLine=null,this.polygon3DAngleModel=null,this.polygon3DAngle=0,this.manager.editor.activeCirclePosParams.circleEdgePoint=(0,lL.cloneDeep)(this.activeCirclePosParams.circleEdgePoint),this.activeCirclePosParams.radius=0,this.activeCirclePosParams.centerPos=void 0,this.activeCirclePosParams.centerPosCartesian3=void 0,this.activeCirclePosParams.circleEdgePoint=void 0,this.activeCirclePosParams.maxRadius=pP.MaxRadius,this.activeSolidStatus=0,this.prismExtrudedHeight=0,this.prismHeightPlane=uf.Plane.ORIGIN_XY_PLANE,this.prismSurfaceHeight=-9999,this.prismBaseLine=null,this.cylinderPlane=uf.Plane.ORIGIN_XY_PLANE,this.cylinderBaseLine=null,this.cylinderSurfaceHeight=-9999,this.manager.render()}getDrawingMode(){return this.drawingMode}}let g8=g4(sI.FLY_SAFE_HOST)?window.CURRENT_FE_ENV_CONFIG.flySafeHost:`${window.CURRENT_FE_ENV_CONFIG.configHost}/flysafe`,g7=`${g8}/api/geo/v3/areas/in_rectangle`;(r0=sC||(sC={}))[r0.Circle=0]=\"Circle\",r0[r0.Polygon=1]=\"Polygon\",r0[r0.Container=2]=\"Container\";async function fe(e,a){return e={...e,level_type:0,zones_mode:\"total\",signature:\"\",drone:\"mavic-mini\"},(await pi.get(`${g7}`,{params:e,...a})).data}class fa{manager;cameraMoveTimer;showFlysafeArea=!1;flysafeAreaRadius=50;coordinate=[22.522,113.94,0];flySafeAreaData=[];flySafePrimitives=[];requestStr=\"\";currentRequestId=\"\";levelObj={2:!0};unlockLicenseFilter={countries:[],areaIds:[]};oldUnlockLicenseFilter={countries:[],areaIds:[]};constructor(e){this.manager=e,this.initialize()}destroy(){this.manager.viewer.scene.camera.moveEnd.removeEventListener(this.drawHandlerThrottled)}initialize(){this.manager.viewer.scene.camera.moveEnd.addEventListener(this.drawHandlerThrottled)}setVisible(e){this.showFlysafeArea=e,this.showFlysafeArea?this.flySafeAreaData.length?(this.requestStr=\"\",this.createShapeFromFlySafeData()):this.drawHandlerThrottled():(this.flySafePrimitives.forEach(e=>{this.manager.viewer.scene.groundPrimitives.remove(e)}),this.flySafePrimitives=[],this.currentRequestId=\"\"),this.manager.render()}setLevel(e){this.levelObj=e,this.requestStr=\"\",this.drawHandlerThrottled()}setFlySafeFilter(e){this.oldUnlockLicenseFilter=(0,lL.cloneDeep)(this.unlockLicenseFilter),this.unlockLicenseFilter=(0,lL.cloneDeep)(e),this.drawHandlerThrottled()}drawHandlerThrottled=(function(e){let a;let r=-1,t=async function(...n){if(a=[...n],r>-1){r++;return}r=0;try{await e(...a)}catch(e){}if(r>0){r=-1,t(...a);return}r=-1};return t})(()=>{!this.manager.viewer.isDestroyed()&&this.drawHandler()}).bind(this);drawHandler(){this.showFlysafeArea&&(this.coordinate=this.cartesianToGraphic(this.manager.viewer.camera.position),this.getFlysafeAreaData())}getLevel(){let e=[],a={...this.levelObj};for(let r in a[6]&&(a[6]=!1,a[2]=!0),a)a[r]&&e.push(r);return e.join(\",\")}async getFlysafeAreaData(){let e=this.getCoordinateRect(),a=this.getLevel();if(!a){this.flySafePrimitives.forEach(e=>{this.manager.viewer.scene.groundPrimitives.remove(e)}),this.flySafePrimitives=[],this.manager.render(),this.requestStr=\"\";return}let r={ltlat:e.leftTop[0],ltlng:e.leftTop[1],rblat:e.rightBottom[0],rblng:e.rightBottom[1],level:a};try{let e=JSON.stringify(r);if(this.requestStr&&this.requestStr===e&&(0,lL.isEqual)(this.oldUnlockLicenseFilter,this.unlockLicenseFilter))return;this.requestStr=e}catch(e){}let t=(0,uW.k)();this.currentRequestId=t;try{let e=await fe(r);if(t!==this.currentRequestId)return;let a=e.data.areas;a=(a=a.filter(e=>!!(0,lL.isEmpty)(this.unlockLicenseFilter.countries)||!this.unlockLicenseFilter.countries.includes(e.country))).filter(e=>!!(0,lL.isEmpty)(this.unlockLicenseFilter.areaIds)||!this.unlockLicenseFilter.areaIds.includes(e.area_id)),this.flySafeAreaData=a,this.createShapeFromFlySafeData(),this.manager.render()}catch(e){throw this.requestStr=\"\",e}}generatePolygonAttribute(e){let a={};if(e.positions){let r=e.positions.map(e=>uf.Cartesian3.fromDegrees(e.longitude,e.latitude,e.height||0));a.polygonPositions=new uf.PolygonHierarchy(r),!r[r.length-1].equals(r[0])&&(a.outlinePositions=r.concat(r[0]))}if(e.cssColor){let r=uf.Color.fromCssColorString(e.cssColor);a.polygonMaterial=e.areaAlpha?r.withAlpha(e.areaAlpha):r,a.outlineMaterial=r}return a}addPrimitivePolygon(e){let{polygonPositions:a,outlinePositions:r,polygonMaterial:t,outlineMaterial:n}=this.generatePolygonAttribute(e);if(e.withPolyOutline&&r?.length&&r.length>=2){let e=new uf.PolylineGeometry({positions:r,width:2}),a=new uf.GeometryInstance({geometry:e,attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(n)}}),t=new uf.GroundPolylinePrimitive({geometryInstances:a,appearance:new uf.PolylineMaterialAppearance({material:uf.Material.fromType(\"Color\",{color:n})}),releaseGeometryInstances:!1,allowPicking:!1,asynchronous:!1});this.manager.viewer.scene.groundPrimitives.add(t),this.manager.viewer.scene.groundPrimitives.lowerToBottom(t),this.flySafePrimitives.push(t)}if(a){let e=new uf.PolygonGeometry({polygonHierarchy:a}),r=new uf.GeometryInstance({geometry:e,attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(t)}}),n=new uf.GroundPrimitive({geometryInstances:[r],appearance:new uf.MaterialAppearance({material:uf.Material.fromType(\"Color\",{color:t}),translucent:!0,closed:!0}),releaseGeometryInstances:!1,allowPicking:!1,asynchronous:!1});return this.manager.viewer.scene.groundPrimitives.add(n),this.manager.viewer.scene.groundPrimitives.lowerToBottom(n),n}}addPrimitiveCircle(e){let a,r;if(e.cssColor&&(a=uf.Color.fromCssColorString(e.cssColor)),e.position&&(r=uf.Cartesian3.fromDegrees(e.position.longitude,e.position.latitude,e.position.height||0)),r){let t=new uf.EllipseGeometry({center:r,semiMajorAxis:e.radius,semiMinorAxis:e.radius}),n=new uf.GeometryInstance({geometry:t,attributes:{color:uf.ColorGeometryInstanceAttribute.fromColor(a.withAlpha(.4))}}),i=new uf.GroundPrimitive({geometryInstances:[n],appearance:new uf.MaterialAppearance({material:uf.Material.fromType(\"Color\",{color:a.withAlpha(.4)}),translucent:!0,closed:!0}),releaseGeometryInstances:!1,allowPicking:!1,asynchronous:!1});return this.manager.viewer.scene.groundPrimitives.add(i),this.manager.viewer.scene.groundPrimitives.lowerToBottom(i),i}}checkPushShape(e,a,r,t){if(2===e){let e=3;if(\"number\"==typeof a.begin_at&&\"number\"==typeof a.end_at&&a.begin_at&&a.end_at?e=1:a.height&&(e=2),3===e&&!this.levelObj[2]||2===e&&!this.levelObj[6])return}let n=t();n&&r.push(n)}createShapeFromFlySafeData(){let e=this.flySafeAreaData||[],a=e.length;this.flySafePrimitives.forEach(e=>{this.manager.viewer.scene.groundPrimitives.remove(e)}),this.flySafePrimitives=[];for(let r=0;r<a;r++){let a=e[r],t=a.level;switch(a.shape){case sC.Container:a.sub_areas.forEach(e=>{switch(e.shape){case sC.Polygon:this.checkPushShape(t,e,this.flySafePrimitives,()=>this.addPrimitivePolygon({show:!0,positions:e.polygon_points[0].map(e=>({longitude:e[0],latitude:e[1]})),withPolyOutline:!0,cssColor:e.color,areaAlpha:.2}));break;case sC.Circle:this.checkPushShape(t,e,this.flySafePrimitives,()=>{if(void 0!==e.lat&&void 0!==e.lng&&void 0!==e.radius)return this.addPrimitiveCircle({show:!0,position:{longitude:e.lng,latitude:e.lat},radius:e.radius,cssColor:e.color,clampToGround:!0})})}});break;case sC.Polygon:this.checkPushShape(t,a,this.flySafePrimitives,()=>{if(a.polygon_points)return this.addPrimitivePolygon({show:!0,positions:a.polygon_points[0].map(e=>({longitude:e[0],latitude:e[1]})),withPolyOutline:!0,cssColor:a.color,areaAlpha:.2})});break;case sC.Circle:this.checkPushShape(t,a,this.flySafePrimitives,()=>this.addPrimitiveCircle({show:!0,position:{longitude:a.lng,latitude:a.lat},radius:a.radius,cssColor:a.color,clampToGround:!0}))}}}cartesianToGraphic(e){let a=this.manager.viewer.scene.globe.ellipsoid.cartesianToCartographic(e),r=uf.Math.toDegrees(a.latitude),t=uf.Math.toDegrees(a.longitude);return[r,t,a.height]}getCoordinateRect(){let e=this.flysafeAreaRadius/111;return{leftTop:[this.coordinate[0]-e,this.coordinate[1]-e],rightBottom:[this.coordinate[0]+e,this.coordinate[1]+e]}}}var fr=r(\"69211\");let ft=`${window.CURRENT_FE_ENV_CONFIG.terrainHost}/dem/api/v1`;async function fn(e){return(await pi.get(`${ft}/elevations`,{params:e})).data}let fi=new uf.Cartesian3,fo=new uf.Cartesian3,fs=new uf.Cartesian3,fl=new uf.Cartesian3,fd=new uf.Cartesian3;class fc{manager;constructor(e){this.manager=e}async clampHeight(e){return(await p9(this.manager,[e]))[0]}clampHeights(e){return p9(this.manager,e)}getHorizontalDistance(e,a){return new uf.EllipsoidGeodesic(e,a).surfaceDistance}getHorizontalDistances(e,a=!1){return mo(e,this.getHorizontalDistance.bind(this),a)}async getClampDirectDistances(e,a=!1){return mo((await this.clampHeights(e)).map(e=>uf.Cartesian3.fromRadians(e.longitude,e.latitude,e.height)),(e,a)=>uf.Cartesian3.distance(e,a),a)}getHorizontalArea(e){if(e.length<3)return 0;let{radii:a}=this.manager.viewer.scene.globe.ellipsoid,r=a.x;return Math.abs(mo(e,(e,a,r)=>(r.longitude-e.longitude)*Math.sin(a.latitude),!0).reduce((e,a)=>e+a,0)*r*r/2)}getTriangulateArea(e){if(e.length<3)return 0;let a=e.map(e=>uf.Cartesian3.fromRadians(e.longitude,e.latitude,e.height)),r=fi,t=fs;if(!uf.CoplanarPolygonGeometryLibrary.computeProjectTo2DArguments(a,fo,t,fl))return 0;if(r=uf.Cartesian3.cross(t,fl,r),r=uf.Cartesian3.normalize(r,r),!uf.Cartesian3.equalsEpsilon(fo,uf.Cartesian3.ZERO,uf.Math.EPSILON6)){let e=this.manager.viewer.scene.globe.ellipsoid.geodeticSurfaceNormal(fo,fd);0>uf.Cartesian3.dot(r,e)&&(r=uf.Cartesian3.negate(r,r),t=uf.Cartesian3.negate(t,t))}let n=uf.PolygonGeometryLibrary.polygonsFromHierarchy(new uf.PolygonHierarchy(a),!1,uf.CoplanarPolygonGeometryLibrary.createProjectPointsTo2DFunction(fo,t,fl),!1).polygons,i=0;for(let e=0;e<n.length;e++){let a=this.triangulate(n[e]);if(a.length%3!=0)continue;let r=n[e].positions;if(r.length)for(let e=0;e<a.length;e+=3){let t=r[a[e]],n=r[a[e+1]],o=r[a[e+2]];t&&n&&o&&(i+=this.triangleArea(t,n,o))}}return i}triangulate(e){let a=uf.PolygonPipeline.triangulate(e.positions2D,e.holes);return a.length<3&&(a=[0,1,2]),a}triangleArea(e,a,r){let t=uf.Cartesian3.subtract(a,e,new uf.Cartesian3),n=uf.Cartesian3.subtract(r,e,new uf.Cartesian3),i=uf.Cartesian3.cross(t,n,new uf.Cartesian3);return .5*uf.Cartesian3.magnitude(i)}getSlopeValue(e){return function(e,a){let r=[],t=[],n=[];for(let a=0;a<e.length-1;a++){let i=e[a],o=gC(i,e[a+1]);o instanceof Object&&(r.push(o.degree),t.push(o.percentage),n.push(o.ratio))}!1;if(\"percentage\"===a)return t;if(\"ratio\"===a)return n;else return{degrees:r,percentages:t,ratios:n}}(e)}}class fu{manager;activeShape;activePlane;constructor(e){this.manager=e}createGroundPin(e){return new hG({category:se.annotations,clampToGround:!0,cssColor:this.manager.doodleWidget.color.pin,position:(0,pg.KO)(e,!0),occludedAlpha:.4,distanceDisplayCondition:hQ,scaleByDistance:hX,placeable:!0},this.manager.collection)}createAirPin(e){let a=new hG({category:se.annotations,clampToGround:!1,cssColor:this.manager.doodleWidget.color.pin,occludedAlpha:.4,distanceDisplayCondition:hQ,scaleByDistance:hX,placeable:!0,position:e},this.manager.collection);return a.dynamize((0,pg.jL)(e)),a}enterPinning(){this.manager.setMode(\"pin\")}leftClick(e){if(this.manager.isDrawingLayerLocked){this.manager.emit(\"statusLimit\",\"limit-create\");return}let a=this.manager.picker.pickPosition(e.position);a&&this.pinAt(a,this.createGroundPin(a))}leftDown(e){let a=this.manager.viewer,r=this.manager.picker.pickPosition(e.position);r&&(this.activeShape=this.createAirPin((0,pg.KO)(r,!0)),this.activePlane=me(r,a),this.manager.screenSpaceCameraController.stopMouse())}mouseMove(e){if(this.activePlane){let a=this.manager.viewer.scene.camera.getPickRay(e.endPosition);if(!a)return!1;let r=uf.IntersectionTests.rayPlane(a,this.activePlane);if(r&&this.activeShape){let{height:e}=uf.Cartographic.fromCartesian(r);this.activeShape.updateHeight(e),this.manager.render()}return!0}return!1}leftUp(){this.activeShape?.position&&this.pinAt((0,pg.jL)(this.activeShape.position),this.activeShape,!1),this.cleanPinning(),this.manager.screenSpaceCameraController.startMouse()}pinAt(e,a,r=!0){this.manager.emit(\"pinAt\",{position:(0,pg.KO)(e,!0),color:a.cssColor,clampToGround:r},a),a.edit()}cleanPinning(){this.activeShape&&this.activeShape.stabilize(),this.activeShape=void 0}exitPinning(){this.cleanPinning(),this.manager.clearMode(\"pin\")}}class fp{manager;mode=(0,uh.iH)(uM.baseMapMode);baseMaps={satelliteBase:void 0,satelliteMark:void 0,street:void 0,streetMark:void 0,fallbackSatelliteBase:void 0};constructor(e){this.manager=e}initialize(){if(g4(sI.MAP_CONFIG_PRIVATE)){let e=this.manager.viewer.imageryLayers.get(0);if(!!e)e.show=!1}else{let e={};\"street\"===this.mode.value?e.street=this.manager.viewer.imageryLayers.get(0):e.satelliteBase=this.manager.viewer.imageryLayers.get(0),this.updateBaseMaps(e),this.setBaseMap()}}updateBaseMaps(e){for(let a in this.baseMaps=Object.assign({},{satelliteBase:e?.satelliteBase||this.getLayer(\"satelliteBase\"),satelliteMark:e?.satelliteMark||this.getLayer(\"satelliteMark\"),street:e?.street||this.getLayer(\"street\"),streetMark:e?.streetMark||this.getLayer(\"streetMark\"),fallbackSatelliteBase:e?.fallbackSatelliteBase||this.getLayer(\"fallbackSatelliteBase\")}),this.baseMaps){let e=this.baseMaps[a];e&&(\"satelliteBase\"===a?\"t\"===this.manager.mapEngine&&(e.brightness=1.05,e.contrast=1.15):(e.brightness=.9,e.saturation=.95))}}updateStorageByEnv(){if(\"g\"===window.CURRENT_BE_ENV_CONFIG.map_engine)(\"fallbackSatellite\"===this.mode.value||\"fallbackSatelliteStreet\"===this.mode.value)&&(this.mode.value=\"satelliteStreet\",uM.baseMapMode=\"satelliteStreet\")}getInitialProvider(){return g4(sI.MAP_CONFIG_PRIVATE)?new uf.SingleTileImageryProvider({url:\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=\",rectangle:uf.Rectangle.MAX_VALUE,tileHeight:1,tileWidth:1}):(this.updateStorageByEnv(),\"street\"===this.mode.value)?this.getProvider(\"street\"):this.getProvider(\"satelliteBase\")}getProvider(e){let a=this.manager.mapConfig[e];if(a)return\"url\"===a.resource.type?new uf.UrlTemplateImageryProvider({maximumLevel:a.maximumLevel,url:a.resource.value,subdomains:a.subdomains,credit:e}):new uf.BaiduImageryProvider({maximumLevel:a.maximumLevel,style:a.resource.value,url:a.resource.url,tileWidth:128,tileHeight:128,udt:gQ()().format(\"YYYYMMDD\"),credit:e})}imageryCounter={success:{},failure:{}};imageryCounterTiming=0;startReportCount(){if(!this.imageryCounterTiming)this.imageryCounterTiming=window.setTimeout(()=>{this.imageryCounterTiming=0;let e=this.imageryCounter.success,a=this.imageryCounter.failure;Object.keys(e).forEach(a=>{e[a]&&window.$reportEventValueCache.push({type:\"fh2_map_tiles_usage_permin\",eventValue:{...g3(a),tiles_count:e[a],status:\"success\"}})}),Object.keys(a).forEach(e=>{a[e]&&window.$reportEventValueCache.push({type:\"fh2_map_tiles_usage_permin\",eventValue:{...g3(e),tiles_count:a[e],status:\"failure\"}})})},6e4)}getLayerForProvider(e){if(e instanceof uf.SingleTileImageryProvider)return new uf.ImageryLayer(e);let a=new uf.ImageryLayer(e,{}),r=e.credit?._html;return r&&a.requestEvent?.addEventListener(e=>{let a=this.imageryCounter[e];a[r]?a[r]++:a[r]=1,this.startReportCount()}),a}getLayer(e){let a=this.getProvider(e);if(a)return this.getLayerForProvider(a)}updateBaseMapColor(e=this.mode.value){this.manager.viewer.scene.globe.baseColor=uf.Color.fromCssColorString(\"street\"===e?\"#DCDBD8\":\"#42543E\")}setBaseMap(e){e&&(this.mode.value=e,uM.baseMapMode=e),this.updateBaseMapColor(e);let a=this.mode.value,r=[];switch(a){case\"satellite\":r.push(\"satelliteBase\");break;case\"fallbackSatellite\":r.push(\"fallbackSatelliteBase\");break;case\"fallbackSatelliteStreet\":r.push(\"fallbackSatelliteBase\",\"satelliteMark\");break;case\"satelliteStreet\":r.push(\"satelliteBase\",\"satelliteMark\");break;case\"street\":r.push(\"street\")}this.changeBaseMap(r)}changeBaseMap(e){let a=this.manager.viewer.imageryLayers;for(let r in e.map(e=>this.baseMaps[e]).reverse().forEach(e=>{e&&(!a.contains(e)&&a.add(e),a.lowerToBottom(e))}),this.raiseMapMark(),this.baseMaps){let t=this.baseMaps[r];t&&!e.includes(r)&&a.remove(t,!1)}}raiseMapMark(){let e=this.manager.viewer.imageryLayers,{streetMark:a,satelliteMark:r}=this.baseMaps;a&&e.contains(a)&&e.raiseToTop(a),r&&e.contains(r)&&e.raiseToTop(r),this.coordinates?.show&&e.contains(this.coordinates)&&e.raiseToTop(this.coordinates)}coordinates;setCoordinates(e){(e||this.coordinates)&&(!this.coordinates&&(this.coordinates=new uf.ImageryLayer(new uf.TileCoordinatesImageryProvider({color:uf.Color.fromCssColorString(\"#FFFFFFA0\"),tilingScheme:new uf.WebMercatorTilingScheme}),{}),this.manager.viewer.imageryLayers.add(this.coordinates)),this.coordinates.show=e,this.raiseMapMark())}getBasemapInfo(){let e=this.mode.value;return{type:({street:\"street\",satellite:\"satellite\",satelliteStreet:\"satelliteStreet\",fallbackSatellite:\"satellite\",fallbackSatelliteStreet:\"satelliteStreet\"})[e],source:\"g\"===window.CURRENT_BE_ENV_CONFIG.map_engine?\"google\":\"tianditu\"}}}class fm{manager;constructor(e){this.manager=e}eventHandler;initEvents(){this.eventHandler?.destroy();let e=this.manager.viewer.canvas;e.disableRootEvents=!0,this.eventHandler=new uf.ScreenSpaceEventHandler(e),this.bindEvents(),this.bindEvents(uf.KeyboardEventModifier.CTRL),this.bindEvents(uf.KeyboardEventModifier.ALT),this.bindEvents(uf.KeyboardEventModifier.SHIFT),this.bindEvents(uf.KeyboardEventModifier.META)}bindEvents(e){this.eventHandler&&(this.eventHandler.setInputAction(this.mouseMove(e),uf.ScreenSpaceEventType.MOUSE_MOVE,e),this.eventHandler.setInputAction(this.leftDown(e),uf.ScreenSpaceEventType.LEFT_DOWN,e),this.eventHandler.setInputAction(this.leftUp(e),uf.ScreenSpaceEventType.LEFT_UP,e),this.eventHandler.setInputAction(this.leftClick(e),uf.ScreenSpaceEventType.LEFT_CLICK,e),this.eventHandler.setInputAction(this.leftDoubleClick(e),uf.ScreenSpaceEventType.LEFT_DOUBLE_CLICK,e),this.eventHandler.setInputAction(this.rightClick(e),uf.ScreenSpaceEventType.RIGHT_CLICK,e))}mouseMove(e){let a=a=>{if(!this.manager.dragger.mouseMove(a)){if(e!==uf.KeyboardEventModifier.CTRL){if(this.manager.mode.edit&&!this.manager.editor.disable){if(\"pin\"===this.manager.editor.editingMode){if(e===uf.KeyboardEventModifier.ALT&&this.manager.editor.pinMouseMove(a))return}else if(this.manager.editor.dragging.value){this.manager.editor.dragMouseMove(a);return}}if(this.manager.mode.draw)return this.manager.drawer.mouseMove(a);if(this.manager.mode.pin){e===uf.KeyboardEventModifier.ALT&&this.manager.piner.mouseMove(a);return}}return!0}};return r=>{this.clearLongPress(),this.manager.hover.mouseMove(r,!a(r),e)}}leftDown(e){return a=>{if(this.startLongPress(a,e),!this.manager.dragger.leftDown(a,e)&&e===uf.KeyboardEventModifier.ALT){if(this.manager.mode.edit&&!this.manager.editor.disable&&\"pin\"===this.manager.editor.editingMode&&this.manager.editor.pinLeftDown(a)){this.manager.screenSpaceCameraController.stopMouse(e);return}if(this.manager.mode.pin){this.manager.piner.leftDown(a),this.manager.screenSpaceCameraController.stopMouse(e);return}}let r=p5(this.manager.viewer,a.position);this.manager.emit(\"leftDown\",r,a,(0,pg.ri)(e)?pE[e]:e)}}leftUp(e){return a=>{this.clearLongPress(),!this.manager.dragger.leftUp(a)&&e!==uf.KeyboardEventModifier.CTRL&&(this.manager.mode.pin&&this.manager.piner.leftUp(),this.manager.mode.edit&&!this.manager.editor.disable&&\"pin\"===this.manager.editor.editingMode&&this.manager.editor.pinLeftUp()),window.dispatchEvent(new MouseEvent(\"mouseup\"))}}leftClick(e){return a=>{if(this.longPressState.disableNextClick){this.longPressState.disableNextClick=!1;return}let r=p5(this.manager.viewer,a.position),t=this.manager.getElements(r).map(([,e])=>e).filter(e=>{let a=e instanceof hG,r=e instanceof h8,t=e instanceof hW,n=e instanceof mX;return this.manager.elementsEditable||!a&&!t&&!r&&!n||e?.origin!==c2.tT.map});if(!(0!==t.length&&!0===t[0].preventClickEvent)&&e!==uf.KeyboardEventModifier.CTRL){if(this.manager.mode.draw){this.manager.drawer.leftClick(a);return}if(this.manager.mode.pin&&e!==uf.KeyboardEventModifier.ALT){this.manager.piner.leftClick(a);return}}let n=0===r.length?void 0:r[0].id;this.manager.emit(\"click\",t,a,(0,pg.ri)(e)?pE[e]:e,n)}}leftDoubleClick(e){return a=>{if(this.longPressState.disableNextClick){this.longPressState.disableNextClick=!1;return}let r=p5(this.manager.viewer,a.position),t=this.manager.getElements(r).map(([,e])=>e);this.manager.emit(\"doubleClick\",t,a,(0,pg.ri)(e)?pE[e]:e)}}rightClick(e){return e=>{let a=p5(this.manager.viewer,e.position);this.manager.contextmenu.open(a,e)}}longPressState={pressing:!1,modifier:void 0,mouse:void 0,timeout:0,disableNextClick:!1};startLongPress(e,a){pS()&&(this.longPressState.pressing=!0,this.longPressState.mouse=e,this.longPressState.modifier=a,this.longPressState.timeout=window.setTimeout(()=>{if(this.longPressState.pressing&&this.longPressState.mouse){let e=this.longPressState.mouse;this.clearLongPress(!1),this.longPressState.disableNextClick=!0,this.longPress(e)}},1500))}clearLongPress(e=!0){e&&this.longPressState.timeout&&window.clearTimeout(this.longPressState.timeout),this.longPressState.pressing=!1,this.longPressState.mouse=void 0,this.longPressState.modifier=void 0,this.longPressState.timeout=0}longPress(e){let a=p5(this.manager.viewer,e.position);this.manager.contextmenu.open(a,e)}}class fh{constructor(e,a){this.allProviders=a.concat([e]),this.terrainProviders=a,this.fallbackProvider=e,this.errorEvent=this.fallbackProvider.errorEvent,this.readyPromise=Promise.all(this.allProviders.map(e=>(0,pg.ri)(e))).then(e=>(this.availability=function(e,a){let r=0,t=[];for(let a=0;a<e.length;a++){let n=e[a];if(n.availability){let e=n.availability._maximumLevel;r<e&&(r=e);let a=n._overallAvailability,i=n.extras,o=a.length;if(i&&i.loadable_layer&&(o=i.loadable_layer.end),a&&a.length>0){let e=Math.min(o,a.length);for(let r=0;r<e;r++)!t[r]&&(t[r]=[]),t[r].push(...a[r])}}}let n=new uf.TileAvailability(a,r);for(let e=0;e<t.length;++e){let a=t[e];for(let r=0;r<a.length;++r){let t=a[r];n.addAvailableTileRange(e,t[0],t[1],t[2],t[3])}}return n}(this.allProviders,this.fallbackProvider.tilingScheme),this.ready=!0,e.reduce((e,a)=>e&&a)))}errorEvent;ready=!1;readyPromise;availability=void 0;allProviders;terrainProviders;fallbackProvider;get tilingScheme(){return this.fallbackProvider.tilingScheme}get credit(){return this.fallbackProvider.credit}get hasVertexNormals(){return this.allProviders.every(e=>e.hasVertexNormals)}get hasWaterMask(){return this.allProviders.every(e=>e.hasWaterMask)}getLevelMaximumGeometricError(e){return this.fallbackProvider.getLevelMaximumGeometricError(e)}getTileDataAvailable(e,a,r){return(0,pg.ri)(this.availability)?!(r>this.availability._maximumLevel)&&this.availability.isTileAvailable(r,e,a):void 0}loadTileDataAvailability(e,a,r){}checkLevel(e,a){let r=e._extras?.loadable_layer;return(!r||!(a<r.begin))&&!0}requestTileGeometry(e,a,r,t){let n=this.fallbackProvider;if(r>0){let t=this.terrainProviders.find(t=>(0,pg.ri)(t)&&this.checkLevel(t,r)&&t.getTileDataAvailable(e,a,r));t&&(n=t)}return n.requestTileGeometry(e,a,r,t)}}class fg{viewer;manager;noTerrainProvider=new uf.EllipsoidTerrainProvider({});globalTerrainProvider=null;terrainReady=!1;terrainShow=!0;customTerrains=[];constructor(e,a){this.manager=e,this.viewer=a}setTerrain(e=this.terrainShow){let a=this.viewer.scene;e?this.customTerrains.length>0?a.terrainProvider=new fh(this.getFallbackTerrainProvider(e),this.customTerrains):this.globalTerrainProvider&&(a.terrainProvider=this.globalTerrainProvider):a.terrainProvider=this.noTerrainProvider,this.terrainShow!==e&&(this.terrainShow=e)}getFallbackTerrainProvider(e=this.terrainShow){return e&&this.globalTerrainProvider?this.globalTerrainProvider:this.noTerrainProvider}getInitialTerrainProvider(){return this.getFallbackTerrainProvider()}addCustomTerrain(e){this.customTerrains.push(e),this.setTerrain()}removeCustomTerrain(e){let a=this.customTerrains.indexOf(e);a>-1&&(this.customTerrains.splice(a,1),this.setTerrain())}}function ff(){return navigator.platform.indexOf(\"Mac\")>-1}let f_=[\"no\",uf.KeyboardEventModifier.CTRL,uf.KeyboardEventModifier.ALT,uf.KeyboardEventModifier.SHIFT,uf.KeyboardEventModifier.META];class fb{constructor(e){this.manager=e;let a=e.viewer;this.viewer=a,this.camera=a.camera,this.controller=a.scene.screenSpaceCameraController,this.handler=new uf.ScreenSpaceEventHandler(a.canvas),this.bindInteractive(),this.isTilting=!1,this.isOrbiting=!1,this.isZooming=!1,this.isTranslating=!1,this.isLooking=!1,this.isFirstViewMoving=!1,this.zoomFactor=8,this.enableOrbit=!0,this.enableLook=!0}refreshHandler(){this.clearActions(),this.handler=new uf.ScreenSpaceEventHandler(this.viewer.canvas),this.clearState(),this.isTilting=!1,this.isOrbiting=!1,this.isTranslating=!1,this.isLooking=!1,this.isFirstViewMoving=!1,this.controller.enableTranslate=!0,this.controller.enableZoom=!0,this.controller.enableRotate=!0,this.controller.enableTilt=!0,this.controller.enableLook=!0}_mode=\"default\";get mode(){return this._mode}set mode(e){this._mode!==e&&(this._mode=e,this.bindInteractive(!1))}pickPositionMode=\"single\";manager;viewer;camera;controller;handler;isTilting;isOrbiting;isZooming;zoomFactor;enableOrbit;minimumFirstViewFov=uf.Math.toRadians(5);maximumFirstViewFov=uf.Math.toRadians(120);get onMotion(){return this.isTilting||this.isOrbiting||this.isZooming||this.isTranslating||this.isLooking}zoom3D(e,a,r){let t,n,i;let o=this.viewer.scene,s=o.camera,l=o.canvas,d=e._cameraUnderground;d?t=a:((t=new uf.Cartesian2).x=l.clientWidth/2,t.y=l.clientHeight/2);let c=s.getPickRay(t,new uf.Ray);if(!c)return;let u=s.positionCartographic.height;if(u<e._minimumPickingTerrainHeight&&(n=this.manager.picker.pickPosition({windowPosition:t,pickMode:this.pickPositionMode})),(0,pg.ri)(n)&&(i=uf.Cartesian3.distance(c.origin,n)),d){let e=this.getZoomDistanceUnderground(c);i=(0,pg.ri)(i)?Math.min(i,e):e}(!(0,pg.ri)(i)||i>u)&&(i=u);let p=r.endPosition.y>0;if(this.noZoomIn(o,p))return;let m=uf.Cartesian3.normalize(s.position,new uf.Cartesian3);this.handleZoom(e,a,r,this.zoomFactor,i,uf.Cartesian3.dot(m,s.direction))}noZoomIn(e,a){let r=e.screenSpaceCameraController,t=e.camera.positionCartographic,n=e.globe.getHeight(t),i=t.height;return a&&n&&i-n<=r.minimumZoomDistance}getZoomDistanceUnderground(e){let a=e.origin,r=e.direction,t=this.getDistanceFromSurface(),n=uf.Cartesian3.normalize(a,new uf.Cartesian3),i=Math.abs(uf.Cartesian3.dot(n,r));return t*(i=2*Math.max(i,.5))}getDistanceFromSurface(){let e=this.viewer.scene,a=e.globe.ellipsoid,r=e.camera,t=e.mode,n=0;if(t===uf.SceneMode.SCENE3D){let e=a.cartesianToCartographic(r.position,new uf.Cartographic);(0,pg.ri)(e)&&(n=e.height)}else n=r.position.z;return Math.abs((0,pg.LS)(e.globeHeight,0)-n)}handleZoom(e,a,r,t,n,i){let o,s;let l=new uf.Cartesian2,d=new uf.Ray,c=new uf.Cartesian3,u=new uf.Cartesian3,p=new uf.Cartesian3,m=new uf.Cartesian3,h=new uf.Cartesian3,g={orientation:new uf.HeadingPitchRoll},f=1;(0,pg.ri)(i)&&(f=uf.Math.clamp(Math.abs(i),.25,1));let _=e.minimumZoomDistance*f,b=e.maximumZoomDistance,k=t*(n-_);k=uf.Math.clamp(k,e._minimumZoomRate,e._maximumZoomRate);let v=(r.endPosition.y-r.startPosition.y)/e._scene.canvas.clientHeight,z=k*(v=Math.min(v,e.maximumMovementRatio));if(z>0&&1>Math.abs(n-_)||z<0&&1>Math.abs(n-b))return;n-z<_?z=n-_-1:n-z>b&&(z=n-b);let w=e._scene,y=w.camera,S=w.mode,j=g.orientation;if(j.heading=y.heading,j.pitch=y.pitch,j.roll=y.roll,e.enableOrthographicFrustumZoomAdjustment&&y.frustum instanceof uf.OrthographicFrustum){Math.abs(z)>0&&(y.zoomIn(z),y._adjustOrthographicFrustum());return}let D=uf.Cartesian2.equals(a,e._zoomMouseStart),I=e._zoomingOnVector,A=e._rotatingZoom;if(e._zoomMouseStart=uf.Cartesian2.clone(a,e._zoomMouseStart),(0,pg.ri)(e._globe)&&(S===uf.SceneMode.SCENE2D?(o=y.getPickRay(a,d).origin,o=uf.Cartesian3.fromElements(o.y,o.z,o.x)):o=this.pickGlobe(e,a,new uf.Cartesian3)),(0,pg.ri)(o)?(e._useZoomWorldPosition=!0,e._zoomWorldPosition=uf.Cartesian3.clone(o,e._zoomWorldPosition)):e._useZoomWorldPosition=!1,e._zoomingOnVector=!1,A=e._rotatingZoom=!1,e._zoomingUnderground=e._cameraUnderground,!this.pickGlobe(e,a,new uf.Cartesian3)||!e._useZoomWorldPosition){y.zoomIn(z);return}let C=S===uf.SceneMode.COLUMBUS_VIEW;if(A=!0,!D||A){if(S===uf.SceneMode.SCENE2D){let r=e._zoomWorldPosition,t=y.position;if(!uf.Cartesian3.equals(r,t)&&y.positionCartographic.height<2*e._maxCoord.x){let n=y.position.x,i=uf.Cartesian3.subtract(r,t,new uf.Cartesian3);uf.Cartesian3.normalize(i,i);let s=uf.Cartesian3.distance(r,t)*z/(.5*y.getMagnitude());y.move(i,.5*s),(y.position.x<0&&n>0||y.position.x>0&&n<0)&&(o=y.getPickRay(a,d).origin,o=uf.Cartesian3.fromElements(o.y,o.z,o.x),e._zoomWorldPosition=uf.Cartesian3.clone(o,e._zoomWorldPosition))}}else if(S===uf.SceneMode.SCENE3D){let a=uf.Cartesian3.normalize(y.position,new uf.Cartesian3);if(e._cameraUnderground||e._zoomingUnderground||y.positionCartographic.height<3e3&&.6>Math.abs(uf.Cartesian3.dot(y.direction,a)))C=!0;else{let r=w.canvas,t=new uf.Cartesian2;t.x=r.clientWidth/2,t.y=r.clientHeight/2;let n=this.pickGlobe(e,t,new uf.Cartesian3);if((0,pg.ri)(n)){if(uf.Cartesian3.dot(y.direction,a)>=-.5)C=!0;else{let r=new uf.Cartesian3;uf.Cartesian3.clone(y.position,r);let t=e._zoomWorldPosition,n=new uf.Cartesian3;if(n=uf.Cartesian3.normalize(t,n),0>uf.Cartesian3.dot(n,a))return;let i=new uf.Cartesian3,o=new uf.Cartesian3;uf.Cartesian3.clone(y.direction,o),uf.Cartesian3.add(r,uf.Cartesian3.multiplyByScalar(o,1e3,c),i);let s=new uf.Cartesian3,l=new uf.Cartesian3;uf.Cartesian3.subtract(t,r,s),uf.Cartesian3.normalize(s,l);let d=uf.Cartesian3.dot(a,l);if(d>=0){e._zoomMouseStart.x=-1;return}let f=Math.acos(-d),_=uf.Cartesian3.magnitude(r),b=uf.Cartesian3.magnitude(t),k=_-z,v=uf.Cartesian3.magnitude(s),w=Math.asin(uf.Math.clamp(v/b*Math.sin(f),-1,1)),S=w-Math.asin(uf.Math.clamp(k/b*Math.sin(f),-1,1))+f,j=new uf.Cartesian3;uf.Cartesian3.normalize(r,j);let D=new uf.Cartesian3;D=uf.Cartesian3.cross(l,j,D),D=uf.Cartesian3.normalize(D,D),uf.Cartesian3.normalize(uf.Cartesian3.cross(j,D,c),o),uf.Cartesian3.multiplyByScalar(uf.Cartesian3.normalize(i,c),uf.Cartesian3.magnitude(i)-z,i),uf.Cartesian3.normalize(r,r),uf.Cartesian3.multiplyByScalar(r,k,r);uf.Cartesian3.multiplyByScalar(uf.Cartesian3.add(uf.Cartesian3.multiplyByScalar(j,Math.cos(S)-1,p),uf.Cartesian3.multiplyByScalar(o,Math.sin(S),m),c),k,u),uf.Cartesian3.add(r,u,r),uf.Cartesian3.normalize(i,j),uf.Cartesian3.normalize(uf.Cartesian3.cross(j,D,c),o);uf.Cartesian3.multiplyByScalar(uf.Cartesian3.add(uf.Cartesian3.multiplyByScalar(j,Math.cos(S)-1,p),uf.Cartesian3.multiplyByScalar(o,Math.sin(S),m),c),uf.Cartesian3.magnitude(i),h),uf.Cartesian3.add(i,h,i),uf.Cartesian3.clone(r,y.position),uf.Cartesian3.normalize(uf.Cartesian3.subtract(i,r,c),y.direction),uf.Cartesian3.clone(y.direction,y.direction),uf.Cartesian3.cross(y.direction,y.up,y.right),uf.Cartesian3.cross(y.right,y.direction,y.up),y.setView(g);return}}else C=!0}}e._rotatingZoom=!C}let x=uf.SceneTransforms.wgs84ToWindowCoordinates(w,e._zoomWorldPosition,l),M=(s=S!==uf.SceneMode.COLUMBUS_VIEW&&uf.Cartesian2.equals(a,e._zoomMouseStart)&&(0,pg.ri)(x)?y.getPickRay(x,d):y.getPickRay(a,d)).direction;(S===uf.SceneMode.COLUMBUS_VIEW||S===uf.SceneMode.SCENE2D)&&uf.Cartesian3.fromElements(M.y,M.z,M.x,M),y.move(M,z),e._zoomingOnVector=!0,!e._cameraUnderground&&y.setView(g)}pickGlobe(e,a,r){let t;let n=new uf.Ray,i=new uf.Cartesian3,o=new uf.Cartesian3,s=e._scene,l=e._globe,d=s.camera;if(!(0,pg.ri)(l))return;let c=!e._cameraUnderground;s.pickPositionSupported&&(t=s.pickPositionWorldCoordinates(a,i));let u=d.getPickRay(a,n),p=l.pickWorldCoordinates(u,s,c,o),m=(0,pg.ri)(t)?uf.Cartesian3.distance(t,d.positionWC):Number.POSITIVE_INFINITY;return m<((0,pg.ri)(p)?uf.Cartesian3.distance(p,d.positionWC):Number.POSITIVE_INFINITY)?uf.Cartesian3.clone(t,r):uf.Cartesian3.clone(p,r)}rotate3D(e,a){let r=this.viewer.scene,t=r.camera,n=r.canvas,i=t.constrainedAxis;t.constrainedAxis=uf.Cartesian3.UNIT_Z;let o=(e.x-a.x)/n.clientWidth,s=(e.y-a.y)/n.clientHeight,l=1.77*(o=Math.min(o,.1))*Math.PI*2,d=1.77*(s=Math.min(s,.1))*Math.PI/2;t.rotateRight(l),this.rotateVertical(-d),t.constrainedAxis=i}pan3D(e,a){let r=this.viewer.scene.camera;if(!this.state.center)return;let t=uf.Cartesian2.clone(e,new uf.Cartesian2),n=uf.Cartesian2.clone(a,new uf.Cartesian2),i=this.state.center,o=p8(uf.Cartographic.fromCartesian(i).height),s=r.pickEllipsoid(t,o,uf.Cartesian4.clone(uf.Cartesian4.UNIT_W)),l=r.pickEllipsoid(n,o,uf.Cartesian4.clone(uf.Cartesian4.UNIT_W));if(!!(0,pg.ri)(s)&&!!(0,pg.ri)(l)){if(s=r.worldToCameraCoordinates(s,s),l=r.worldToCameraCoordinates(l,l),(0,pg.ri)(r.constrainedAxis)){let e,a;let t=r.constrainedAxis,n=uf.Cartesian3.mostOrthogonalAxis(t,new uf.Cartesian3);uf.Cartesian3.cross(n,t,n),uf.Cartesian3.normalize(n,n);let o=uf.Cartesian3.cross(t,n,new uf.Cartesian3),d=uf.Cartesian3.magnitude(s),c=uf.Cartesian3.dot(t,s),u=Math.acos(c/d),p=uf.Cartesian3.multiplyByScalar(t,c,new uf.Cartesian3);uf.Cartesian3.subtract(s,p,p),uf.Cartesian3.normalize(p,p);let m=uf.Cartesian3.magnitude(l),h=uf.Cartesian3.dot(t,l),g=Math.acos(h/m),f=uf.Cartesian3.multiplyByScalar(t,h,new uf.Cartesian3);uf.Cartesian3.subtract(l,f,f),uf.Cartesian3.normalize(f,f);let _=Math.acos(uf.Cartesian3.dot(p,n));0>uf.Cartesian3.dot(p,o)&&(_=uf.Math.TWO_PI-_);let b=Math.acos(uf.Cartesian3.dot(f,n));0>uf.Cartesian3.dot(f,o)&&(b=uf.Math.TWO_PI-b);let k=_-b;e=uf.Cartesian3.equalsEpsilon(t,r.position,uf.Math.EPSILON2)?r.right:uf.Cartesian3.cross(t,r.position,new uf.Cartesian3);let v=uf.Cartesian3.cross(t,e,new uf.Cartesian3),z=uf.Cartesian3.dot(v,uf.Cartesian3.subtract(s,t,new uf.Cartesian3)),w=uf.Cartesian3.dot(v,uf.Cartesian3.subtract(l,t,new uf.Cartesian3));a=z>0&&w>0?g-u:z>0&&w<=0?uf.Cartesian3.dot(r.position,t)>0?-u-g:u+g:u-g;let y=this.getSpeed(i);r.rotateRight(k*y),r.rotateUp(a*y)}else{uf.Cartesian3.normalize(s,s),uf.Cartesian3.normalize(l,l);let e=uf.Cartesian3.dot(s,l),a=uf.Cartesian3.cross(s,l,new uf.Cartesian3);if(e<1&&!uf.Cartesian3.equalsEpsilon(a,uf.Cartesian3.ZERO,uf.Math.EPSILON14)){let t=Math.acos(e);r.rotate(a,t)}}this.adjustHeightForTerrain()}}getSpeed(e){let a=this.viewer.scene,r=a.camera,t=1;if(uf.Math.equalsEpsilon(r.pitch,-1.57,.01))return t;let n=r.positionCartographic.height,i=a.globeHeight||0;if(n-i>1e4)return t;let o=uf.Cartesian3.distance(r.position,e),s=180*this.camera.pitch/Math.PI,l=uf.Cartographic.fromCartesian(e).height;return l>=n&&!this.keyboardMoving?(t=0,this.isOrbiting=!1):s>-15&&(t=(t=(n-l)/o*4)>1?1:t),t}look3D(e,a,r=!1){let t=this.camera,n=this.viewer.scene.globe.ellipsoid,i=r?-1:2,o=n.geodeticSurfaceNormal(t.position);t.look(o,this.getLookAngle(e,a,\"x\")*i),this.lookVertical(-this.getLookAngle(e,a,\"y\")*i,o)}rotateVertical(e){let a=this.camera,r=this.judgeOrRecalculateAngle(e);r&&a.rotate(a.right,r)}lookVertical(e,a){let r=this.camera,t=this.judgeParallelAndRecalculateAngle(-e,r.direction,a);t&&r.look(r.right,t)}getLookAngle(e,a,r){let t,n;let i=e[r],o=a[r],s=new uf.Cartesian2(\"x\"===r?i:0,\"y\"===r?i:0),l=new uf.Cartesian2(\"x\"===r?o:0,\"y\"===r?o:0),d=this.camera.getPickRay(s),c=this.camera.getPickRay(l);if(!d||!c)return 0;this.camera.frustum instanceof uf.OrthographicFrustum?(t=d.origin,n=c.origin,uf.Cartesian3.add(this.camera.direction,t,t),uf.Cartesian3.add(this.camera.direction,n,n),uf.Cartesian3.subtract(t,this.camera.position,t),uf.Cartesian3.subtract(n,this.camera.position,n),uf.Cartesian3.normalize(t,t),uf.Cartesian3.normalize(n,n)):(t=d.direction,n=c.direction);let u=uf.Cartesian3.dot(t,n),p=0;return u<1&&(p=Math.acos(u)),i>o?-p:p}translate3D(e,a){let r=this.viewer.scene.camera;if(!this.state.center)return;let t=uf.Cartesian2.clone(e,new uf.Cartesian2),n=uf.Cartesian2.clone(a,new uf.Cartesian2),i=r.getPickRay(t),o=r.getPickRay(n);if(!i||!o)return;let s=this.state.center,l=uf.Plane.fromPointNormal(s,r.directionWC),d=uf.IntersectionTests.rayPlane(i,l),c=uf.IntersectionTests.rayPlane(o,l);if(!(0,pg.ri)(d)||!(0,pg.ri)(c))return;let u=uf.Cartesian3.subtract(d,c,new uf.Cartesian3),p=uf.Cartesian3.magnitude(u);if(!uf.Math.equalsEpsilon(p,0,uf.Math.EPSILON3))uf.Cartesian3.normalize(u,u),r.move(u,p)}judgeOrRecalculateAngle(e){let a=this.camera,r=e;if((r=this.judgeParallelAndRecalculateAngle(r,a.directionWC,uf.Cartesian3.normalize(a.positionWC,new uf.Cartesian3)))<0){let e=this.camera.position,a=Math.sin(uf.Math.toRadians(3)),t=uf.Cartesian3.normalize(e,new uf.Cartesian3);if(uf.Math.lessThanOrEquals(t.z,a,uf.Math.EPSILON3))r=0;else{let t;let n=uf.Cartesian3.normalize(this.camera.right,new uf.Cartesian3),i=uf.Cartesian3.magnitude(e),o=new uf.BoundingSphere(uf.Cartesian3.ZERO,i),s=uf.Plane.clone(uf.Plane.ORIGIN_XY_PLANE);s.distance=a*i;let l=uf.Plane.fromPointNormal(e,n);t=l.normal.y>uf.Math.EPSILON6?new uf.Cartesian3(0,-(l.distance+s.distance)/l.normal.y,s.distance):new uf.Cartesian3(-(l.distance+s.distance)/l.normal.x,0,s.distance);let d=this.getNearIntersectPointByPlanesAndSphere(s.normal,l.normal,t,o,e);if(d){let a=uf.Plane.clone(l);a.distance=0;let t=this.projectAndNormalizePositionOnPlane(a,e),n=this.projectAndNormalizePositionOnPlane(a,d),i=uf.Cartesian3.dot(n,t),o=uf.Math.acosClamped(i),s=uf.Cartesian3.cross(n,t,new uf.Cartesian3);0>uf.Cartesian3.dot(s,this.camera.right)&&-r>o&&(r=-o+uf.Math.EPSILON4)}}}if(r){let e=this.rotateVerticalAngleToHeight(r),a=this.getCameraUndergroundOffsetHeight(e);(0,pg.ri)(a)&&(r=this.rotateVerticalHeightToAngle(e+a),uf.Math.equalsEpsilon(r,0,uf.Math.EPSILON2)&&(r=0))}return r}judgeParallelAndRecalculateAngle(e,a,r){let t=mr(a,r),n=e;if(1===t&&n<0)n=0;else if(-1===t&&n>0)n=0;else if(0===t){let e=uf.Cartesian3.dot(a,r),t=uf.Math.acosClamped(-e);n>0&&n>t&&(n=t-uf.Math.EPSILON4),t=uf.Math.acosClamped(e),n<0&&-n>t&&(n=-t+uf.Math.EPSILON4)}return n}projectAndNormalizePositionOnPlane(e,a){return uf.Cartesian3.normalize(uf.Plane.projectPointOntoPlane(e,a),new uf.Cartesian3)}getNearIntersectPointByPlanesAndSphere(e,a,r,t,n){let i;let o=uf.Cartesian3.cross(e,a,new uf.Cartesian3),s=uf.Cartesian3.cross(a,e,new uf.Cartesian3),l=this.getIntersectPointByRayAndSphere(r,o,t);l.length<2&&l.push(...this.getIntersectPointByRayAndSphere(r,s,t));let d=Number.POSITIVE_INFINITY;for(let e of l)if(i){let a=uf.Cartesian3.distance(e,n);a<d&&(i=e,d=a)}else i=e,d=uf.Cartesian3.distance(e,n);return i}getIntersectPointByRayAndSphere(e,a,r){let t=[],n=new uf.Ray(e,a),i=uf.IntersectionTests.raySphere(n,r);return i&&(0!==i.start&&t.push(uf.Ray.getPoint(n,i.start)),t.push(uf.Ray.getPoint(n,i.stop))),t}getCameraUndergroundOffsetHeight(e=0){let a;let r=this.viewer.scene,t=r.globe;if((0,pg.ri)(t)){let t=r.camera.positionCartographic,n=t.height+e;if(n<this.controller.minimumCollisionTerrainHeight){let e=r.globe.getHeight(t);if((0,pg.ri)(e)){let r=e+this.controller.minimumZoomDistance;n<r&&(a=r-n)}}}return a}rotateVerticalAngleToHeight(e,a){return uf.Cartesian3.distance(this.camera.position,a||uf.Cartesian3.ZERO)*Math.tan(e/2)}rotateVerticalHeightToAngle(e,a){let r=uf.Cartesian3.distance(this.camera.position,a||uf.Cartesian3.ZERO);return 2*uf.Math.fastApproximateAtan(e/r)}adjustHeightForTerrain(e=\"pan\"){let a=this.camera.positionCartographic,r=this.getCameraUndergroundOffsetHeight();if((0,pg.ri)(r)){if(\"rotate\"===e){let e=this.rotateVerticalHeightToAngle(r);!uf.Math.equalsEpsilon(e,0,uf.Math.EPSILON2)&&this.camera.rotate(this.camera.right,e)}else this.camera.position=uf.Cartesian3.fromRadians(a.longitude,a.latitude,a.height+r)}}state={startPosition:null,center:null,marker:null,transform:null,createMarker:!1,grab:!1,moved:!1};initState(e,a=!1,r=!0,t=!0){this.clearState();let n=this.viewer.scene.globe.ellipsoid,i=this.manager.picker.pickPosition({windowPosition:e,pickMode:this.pickPositionMode});if(i)uf.Cartographic.fromCartesian(i).height<-1e3&&(i=this.manager.viewer.camera.pickEllipsoid(e)),i&&(this.state.center=i);else{let a=this.camera.getPickRay(e);if(!a)return;let r=uf.IntersectionTests.rayEllipsoid(a,n);(0,pg.ri)(r)&&(this.state.center=uf.Ray.getPoint(a,r.start))}if(!this.state.center&&a){let a=this.manager.getSceneInstantState().cameraHeight,t=this.camera.getPickRay(e);t&&(0,pg.ri)(a)&&(this.state.center=uf.Ray.getPoint(t,a),r=!1)}this.state.center&&(this.state.startPosition=e,this.state.createMarker=r,this.state.grab=t,this.state.transform=uf.Transforms.eastNorthUpToFixedFrame(this.state.center,p8(uf.Cartographic.fromCartesian(this.state.center).height)))}firstMove(){!this.state.moved&&(this.state.moved=!0,this.state.createMarker&&this.state.center&&(this.clearMarker(),this.state.marker=this.viewer.entities.add({position:this.state.center,billboard:{image:\"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMzJweCIgaGVpZ2h0PSIzMnB4IiB2aWV3Qm94PSIwIDAgMzIgMzIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDYxLjIgKDg5NjUzKSAtIGh0dHBzOi8vc2tldGNoLmNvbSAtLT4KICAgIDx0aXRsZT4y5Zu+5qCHLzMycHgvbWFwX2NlbnRlcuWkh+S7vTwvdGl0bGU+CiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4KICAgIDxnIGlkPSIy5Zu+5qCHLzMycHgvbWFwX2NlbnRlcuWkh+S7vSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPHBhdGggZD0iTTE3LjUsMSBMMTcuNTAwMTU2OSwzLjA4NTYyMTYxIEMyMy40ODEzNTYxLDMuNzcyODcyNDkgMjguMjI3NjkyLDguNTE5NTAyMDUgMjguOTE0NDkyNywxNC41MDA4MzgyIEwzMSwxNC41IEwzMSwxNy41IEwyOC45MTQzNzg0LDE3LjUwMDE1NjkgQzI4LjIyNzE2NTYsMjMuNDgxMDI0NCAyMy40ODEwMjQ0LDI4LjIyNzE2NTYgMTcuNTAwMTU2OSwyOC45MTQzNzg0IEwxNy41LDMxIEwxNC41LDMxIEwxNC41MDA4MzgyLDI4LjkxNDQ5MjcgQzguNTE5NTAyMDUsMjguMjI3NjkyIDMuNzcyODcyNDksMjMuNDgxMzU2MSAzLjA4NTYyMTYxLDE3LjUwMDE1NjkgTDEsMTcuNSBMMSwxNC41IEwzLjA4NTUwNzMxLDE0LjUwMDgzODIgQzMuNzcyMzQ2MDYsOC41MTkxNzAzNiA4LjUxOTE3MDM2LDMuNzcyMzQ2MDYgMTQuNTAwODM4MiwzLjA4NTUwNzMxIEwxNC41LDEgTDE3LjUsMSBaIE0xNiwxMSBDMTMuMjM4NTc2MywxMSAxMSwxMy4yMzg1NzYzIDExLDE2IEMxMSwxOC43NjE0MjM3IDEzLjIzODU3NjMsMjEgMTYsMjEgQzE4Ljc2MTQyMzcsMjEgMjEsMTguNzYxNDIzNyAyMSwxNiBDMjEsMTMuMjM4NTc2MyAxOC43NjE0MjM3LDExIDE2LDExIFoiIGlkPSLlvaLnirbnu5PlkIgiIGZpbGwtb3BhY2l0eT0iMC4yNSIgZmlsbD0iIzAwMDAwMCI+PC9wYXRoPgogICAgICAgIDxwYXRoIGQ9Ik0xNi41LDIgTDE2LjUwMDg2MzYsNy4wMTM3MDE1MiBDMjEuMDcyOTg1Nyw3LjI2NDQ5NTYyIDI0LjczNjA1NjEsMTAuOTI3ODgwOCAyNC45ODYzNTMyLDE1LjUwMDEzNTIgTDMwLDE1LjUgTDMwLDE2LjUgTDI0Ljk4NjI5ODUsMTYuNTAwODYzNiBDMjQuNzM1NTIyNiwyMS4wNzI2NTI3IDIxLjA3MjY1MjcsMjQuNzM1NTIyNiAxNi41MDA4NjM2LDI0Ljk4NjI5ODUgTDE2LjUsMzAgTDE1LjUsMzAgTDE1LjUwMDEzNTIsMjQuOTg2MzUzMiBDMTAuOTI3ODgwOCwyNC43MzYwNTYxIDcuMjY0NDk1NjIsMjEuMDcyOTg1NyA3LjAxMzcwMTUyLDE2LjUwMDg2MzYgTDIsMTYuNSBMMiwxNS41IEw3LjAxMzY0Njc5LDE1LjUwMDEzNTIgQzcuMjYzOTYyMTEsMTAuOTI3NTQ3OCAxMC45Mjc1NDc4LDcuMjYzOTYyMTEgMTUuNTAwMTM1Miw3LjAxMzY0Njc5IEwxNS41LDIgTDE2LjUsMiBaIE01LjI4NTM5Nzk2LDE4LjUwMDI3NCBDNi4yMzA3NzA2MSwyMi41Njc2MTA5IDkuNDMyMzg5MTQsMjUuNzY5MjI5NCAxMy40OTk3MjYsMjYuNzE0NjAyIEwxMy41MDAxNTIzLDI3LjczOTI0NCBDOC44NzkxNDMwNSwyNi43NjAwNDA3IDUuMjQwMzExNzUsMjMuMTIxMzY0OCA0LjI2MDg4MTQ1LDE4LjUwMDQzOTUgTDUuMjg1Mzk3OTYsMTguNTAwMjc0IFogTTI3LjczOTExODUsMTguNTAwNDM5NSBDMjYuNzU5NzMwMSwyMy4xMjExNjc2IDIzLjEyMTE2NzYsMjYuNzU5NzMwMSAxOC41MDA0Mzk1LDI3LjczOTExODUgTDE4LjUwMDI3NCwyNi43MTQ2MDIgQzIyLjU2NzYxMDksMjUuNzY5MjI5NCAyNS43NjkyMjk0LDIyLjU2NzYxMDkgMjYuNzE0NjAyLDE4LjUwMDI3NCBMMjcuNzM5MTE4NSwxOC41MDA0Mzk1IFogTTE2LDguOTg5IEwxNS42MDk0NTY3LDkuMDEwNjU2NzYgQzEyLjEzNjE5NTMsOS4yMDA3OTIxMiA5LjMzNTEzMjMyLDExLjkyNzIzODYgOS4wMjgwMTQyNiwxNS4zNjgyNDk3IEw5LjAxMDY1Njc2LDE1LjYwOTQ1NjcgTDguOTg5LDE2IEw5LjAxMDY5OTQ2LDE2LjM5MTMyMjUgQzkuMjAxMTk5NzQsMTkuODY0MjUzNCAxMS45Mjc1MzAzLDIyLjY2NDkwMjYgMTUuMzY4MjY4OSwyMi45NzE5ODc0IEwxNS42MDk0NTY3LDIyLjk4OTM0MzIgTDE2LDIzLjAxIEwxNi4zOTEzMjI1LDIyLjk4OTMwMDUgQzE5Ljg2Mzk3MzgsMjIuNzk4ODE1NiAyMi42NjQ0OTI1LDIwLjA3Mjg5MTYgMjIuOTcxOTIwMSwxNi42MzI0ODcxIEwyMi45ODkzMDA1LDE2LjM5MTMyMjUgTDIzLjAxLDE2IEwyMi45ODkzNDMyLDE1LjYwOTQ1NjcgQzIyLjc5OTIyMzIsMTIuMTM2NDc0OCAyMC4wNzMxODMzLDkuMzM1NTQyNDQgMTYuNjMyNTA2NCw5LjAyODA4MTY1IEwxNi4zOTEzMjI1LDkuMDEwNjk5NDYgTDE2LDguOTg5IFogTTE4LjUwMDQzOTUsNC4yNjA4ODE0NSBDMjMuMTIxMzY0OCw1LjI0MDMxMTc1IDI2Ljc2MDA0MDcsOC44NzkxNDMwNSAyNy43MzkyNDQsMTMuNTAwMTUyMyBMMjYuNzE0NjAyLDEzLjQ5OTcyNiBDMjUuNzY5MjI5NCw5LjQzMjM4OTE0IDIyLjU2NzYxMDksNi4yMzA3NzA2MSAxOC41MDAyNzQsNS4yODUzOTc5NiBMMTguNTAwNDM5NSw0LjI2MDg4MTQ1IFogTTEzLjUwMDE1MjMsNC4yNjA3NTYwNSBMMTMuNDk5NzI2LDUuMjg1Mzk3OTYgQzkuNDMyMzg5MTQsNi4yMzA3NzA2MSA2LjIzMDc3MDYxLDkuNDMyMzg5MTQgNS4yODUzOTc5NiwxMy40OTk3MjYgTDQuMjYwNzU2MDUsMTMuNTAwMTUyMyBDNS4yNDAwMDEwOSw4Ljg3ODk0NTggOC44Nzg5NDU4LDUuMjQwMDAxMDkgMTMuNTAwMTUyMyw0LjI2MDc1NjA1IFoiIGlkPSLlvaLnirbnu5PlkIgiIGZpbGw9IiNGRkZGRkYiIGZpbGwtcnVsZT0ibm9uemVybyI+PC9wYXRoPgogICAgPC9nPgo8L3N2Zz4=\",disableDepthTestDistance:Number.POSITIVE_INFINITY}}),this.viewer.scene.requestRender()),this.state.grab&&this.manager.hover.setCursor(\"grabbing\",\"temporary\"))}clearState(){this.state.startPosition&&(this.state.startPosition=null),this.state.center&&(this.state.center=null),this.state.transform&&(this.state.transform=null),this.state.createMarker=!1,this.state.grab=!1,this.state.moved=!1,this.inertiaState.enableMovement=\"\",this.clearMarker(),this.manager.hover.setCursor(\"\",\"temporary\")}clearMarker(){this.state.marker&&(this.viewer.entities.remove(this.state.marker),this.state.marker=null,this.viewer.scene.requestRender())}inertiaState={lastMovement:{startPosition:new uf.Cartesian2,endPosition:new uf.Cartesian2},action:()=>void 0,enableMovement:\"\",endTime:0,decayCoef:0,finish:()=>void 0};inertiaLoopFunc=()=>{if(this.inertiaState.enableMovement){let e=new Date().getTime(),a=this.inertiaState.endTime&&(e-this.inertiaState.endTime)/1e3;(function(e,a,r,t){var n,i,o;let s=(n=r,i=e,n<0?0:Math.exp(-((1-i)*25)*n));if(o=t,uf.Cartesian2.equalsEpsilon(o.startPosition,o.endPosition,uf.Math.EPSILON14))return!1;let l=new uf.Cartesian2((t.endPosition.x-t.startPosition.x)*.5,(t.endPosition.y-t.startPosition.y)*.5),d=uf.Cartesian2.clone(t.startPosition),c=uf.Cartesian2.multiplyByScalar(l,s,new uf.Cartesian2);return uf.Cartesian2.add(d,c,c),!(isNaN(c.x)||isNaN(c.y)||.5>uf.Cartesian2.distance(d,c))&&(a(d,c),!0)})(this.inertiaState.decayCoef,this.inertiaState.action,a,this.inertiaState.lastMovement)?window.requestAnimationFrame(this.inertiaLoopFunc):(this.inertiaState.enableMovement=\"\",this.inertiaState.finish())}};startInertiaLoop(e,a,r,t,n,i,o){if(r&&t&&.4>(r&&t&&(t-r)/1e3)){let r=1;i.end>i.start&&(r=(i.end-i.start)/30),this.inertiaState.lastMovement={startPosition:new uf.Cartesian2(n.endPosition.x-(n.endPosition.x-n.startPosition.x)/r,n.endPosition.y-(n.endPosition.y-n.startPosition.y)/r),endPosition:n.endPosition},this.inertiaState.enableMovement=\"orbit\",this.inertiaState.action=a,this.inertiaState.endTime=t,this.inertiaState.decayCoef=e,this.inertiaState.finish=o,window.requestAnimationFrame(this.inertiaLoopFunc)}}onTiltStart(e,a=!1){return!!uf.Matrix4.equals(this.camera.transform,uf.Matrix4.IDENTITY)&&(this.initState(e,!1,!0,!a),!0)}onTiltMove(e,a){if(!this.state.transform)return!1;this.firstMove();let r=uf.Matrix4.clone(this.camera.transform);this.camera.lookAtTransform(this.state.transform),this.rotate3D(e,a),this.adjustHeightForTerrain(\"rotate\"),this.camera.lookAtTransform(r);let t=uf.Cartesian3.normalize(this.camera.directionWC,new uf.Cartesian3),n=uf.Cartesian3.normalize(this.camera.positionWC,new uf.Cartesian3);if(0===mr(t,n)){let e=uf.Cartesian3.cross(t,n,new uf.Cartesian3);!uf.Cartesian3.equalsEpsilon(e,uf.Cartesian3.ZERO,uf.Math.EPSILON6)&&(0>uf.Cartesian3.dot(e,this.camera.right)&&uf.Cartesian3.negate(e,e),uf.Cartesian3.cross(e,this.camera.direction,this.camera.up),uf.Cartesian3.cross(this.camera.direction,this.camera.up,this.camera.right),uf.Cartesian3.normalize(this.camera.up,this.camera.up),uf.Cartesian3.normalize(this.camera.right,this.camera.right))}return!0}bindTilt(){this.controller.enableTilt=!1;let e=e=>{this.isTilting=this.onTiltStart(e.position)},a=e=>{this.isTilting&&this.state.center&&this.state.startPosition&&this.state.transform&&this.onTiltMove(e.startPosition,e.endPosition)},r=()=>{this.isTilting&&(this.clearState(),this.isTilting=!1)};this.setInputAction(e,uf.ScreenSpaceEventType.LEFT_DOWN,uf.KeyboardEventModifier.CTRL),this.setInputAction(r,uf.ScreenSpaceEventType.LEFT_UP,\"all\"),ff()&&this.setInputAction(e,uf.ScreenSpaceEventType.LEFT_DOWN,uf.KeyboardEventModifier.META),this.setInputAction(e,uf.ScreenSpaceEventType.RIGHT_DOWN,uf.KeyboardEventModifier.CTRL),this.setInputAction(r,uf.ScreenSpaceEventType.RIGHT_UP,\"all\"),this.setInputAction(e,uf.ScreenSpaceEventType.MIDDLE_DOWN),this.setInputAction(r,uf.ScreenSpaceEventType.MIDDLE_UP,\"all\"),this.setInputAction(a,uf.ScreenSpaceEventType.MOUSE_MOVE,\"all\"),this.setInputAction(({position1:a,position2:r})=>e({position:uf.Cartesian2.lerp(a,r,.5,new uf.Cartesian2)}),uf.ScreenSpaceEventType.PINCH_START,void 0),this.setInputAction(r,uf.ScreenSpaceEventType.PINCH_END,void 0),this.setInputAction(e=>{let r=e.angleAndHeight.startPosition.x,t=e.angleAndHeight.endPosition.x,n=2*Math.PI;for(;t>=r+Math.PI;)t-=n;for(;t<r-Math.PI;)t+=n;let i=this.viewer.scene.canvas.clientWidth;return a({startPosition:new uf.Cartesian2(-r*i/12,4*e.angleAndHeight.startPosition.y),endPosition:new uf.Cartesian2(-t*i/12,4*e.angleAndHeight.endPosition.y)})},uf.ScreenSpaceEventType.PINCH_MOVE,\"all\")}onZoomStart(e,a=!1){return this.initState(e,a,!0,!a),!0}onZoomMove(e,a){return this.state.startPosition&&(this.firstMove(),this.zoom3D(this.controller,this.state.startPosition,{startPosition:e,endPosition:a})),!0}bindZoom(){this.controller.enableZoom=!1;this.setInputAction(e=>{this.isZooming=this.onZoomStart(e.position)},uf.ScreenSpaceEventType.RIGHT_DOWN),this.setInputAction(()=>{this.isZooming&&(this.isZooming=!1,this.clearState())},uf.ScreenSpaceEventType.RIGHT_UP),this.setInputAction(e=>{this.isZooming&&this.onZoomMove(e.startPosition,e.endPosition)},uf.ScreenSpaceEventType.MOUSE_MOVE),this.setInputAction((e,a)=>{let r={startPosition:new uf.Cartesian2,endPosition:new uf.Cartesian2(0,e/4)};this.zoom3D(this.controller,a,r)},uf.ScreenSpaceEventType.WHEEL),this.controller.zoomEventTypes=[uf.CameraEventType.RIGHT_DRAG,uf.CameraEventType.WHEEL];let e=e=>{if(this.state.center){let a=uf.Cartesian3.subtract(this.state.center,this.camera.position,new uf.Cartesian3),r=uf.Cartesian3.magnitude(a),t=uf.Cartesian3.normalize(a,new uf.Cartesian3),n=this.controller.minimumZoomDistance,i=this.controller.maximumZoomDistance,o=7*(r-n);o=uf.Math.clamp(o,20,5906376272e3);let s=e/this.viewer.canvas.clientHeight,l=o*(s=Math.min(s,.1));if(!(l>0&&1>Math.abs(r-n)||l<0&&1>Math.abs(r-i)))r-l<n?l=r-n-1:r-l>i&&(l=r-i),this.camera.move(t,l)}};this.setInputAction(({position1:e,position2:a})=>{this.initState(uf.Cartesian2.lerp(e,a,.5,new uf.Cartesian2))},uf.ScreenSpaceEventType.PINCH_START),this.setInputAction(()=>{this.clearState()},uf.ScreenSpaceEventType.PINCH_END),this.setInputAction(a=>{let r=a.distance.endPosition.y-a.distance.startPosition.y;this.firstMove(),e(r)},uf.ScreenSpaceEventType.PINCH_MOVE,\"all\")}onOrbitStart(e,a=!1){return!!uf.Matrix4.equals(this.camera.transform,uf.Matrix4.IDENTITY)&&(this.initState(e,a,!1,!a),!0)}onOrbitMove(e,a){return!!this.canOrbit()&&(this.firstMove(),this.pan3D(e,a),!0)}bindOrbit(){this.controller.enableRotate=!1;let e=0,a=0,r={startPosition:new uf.Cartesian2,endPosition:new uf.Cartesian2},t={start:0,end:0};this.setInputAction(a=>{!this.keyboardLooping&&(this.isOrbiting=this.onOrbitStart(a.position),this.isOrbiting&&(e=new Date().getTime(),t.start=e,t.end=e,this.state.center&&uf.Cartographic.fromCartesian(this.state.center).height>this.camera.positionCartographic.height&&(this.isOrbiting=!1,this.isTranslating=!0)))},uf.ScreenSpaceEventType.LEFT_DOWN),this.setInputAction(()=>{this.isOrbiting=!1,this.manager.hover.setCursor(\"\",\"temporary\"),a=new Date().getTime(),this.startInertiaLoop(.9,this.pan3D.bind(this),e,a,{startPosition:uf.Cartesian2.clone(r.startPosition),endPosition:uf.Cartesian2.clone(r.endPosition)},t,this.clearState.bind(this)),r.startPosition=new uf.Cartesian2,r.endPosition=new uf.Cartesian2},uf.ScreenSpaceEventType.LEFT_UP,\"all\"),this.setInputAction(e=>{if(!!this.isOrbiting)this.onOrbitMove(e.startPosition,e.endPosition)&&(t.start=t.end,t.end=new Date().getTime(),t.end-t.start>1500&&(t.start=t.end),uf.Cartesian2.clone(e.startPosition,r.startPosition),uf.Cartesian2.clone(e.endPosition,r.endPosition))},uf.ScreenSpaceEventType.MOUSE_MOVE,\"all\")}canOrbit(){if(!this.state.center)return!1;let e=this.enableOrbit,a=this.state.center&&this.state.startPosition&&this.state.transform,r=180*this.camera.pitch/Math.PI,t=this.camera.positionCartographic.height,n=15*t;n=n>9e3?n:9e3;let i=r<-10||t>1e4||uf.Cartesian3.distance(this.state.center,this.camera.position)<n;return e&&!!a&&i}enableTranslate=!0;isTranslating=!1;onTranslateStart(e,a=!1){return!!uf.Matrix4.equals(this.camera.transform,uf.Matrix4.IDENTITY)&&(this.firstMove(),this.initState(e,a,!1,!a),!0)}bindTranslate(){this.controller.enableLook=!1;let e=0,a=0,r={startPosition:new uf.Cartesian2,endPosition:new uf.Cartesian2},t={start:0,end:0};this.setInputAction(a=>{!this.keyboardLooping&&(this.isTranslating=this.onTranslateStart(a.position),this.isTranslating&&(e=new Date().getTime(),t.start=e,t.end=e))},uf.ScreenSpaceEventType.LEFT_DOWN,uf.KeyboardEventModifier.SHIFT),this.setInputAction(()=>{this.isTranslating&&(this.isTranslating=!1,a=new Date().getTime(),this.startInertiaLoop(.9,this.translate3D.bind(this),e,a,{startPosition:uf.Cartesian2.clone(r.startPosition),endPosition:uf.Cartesian2.clone(r.endPosition)},t,this.clearState.bind(this)),r.startPosition=new uf.Cartesian2,r.endPosition=new uf.Cartesian2)},uf.ScreenSpaceEventType.LEFT_UP,\"all\"),this.setInputAction(e=>{if(!this.keyboardLooping&&!!this.isTranslating&&!!this.enableTranslate)this.firstMove(),this.translate3D(e.startPosition,e.endPosition),t.start=t.end,t.end=new Date().getTime(),t.end-t.start>1500&&(t.start=t.end),uf.Cartesian2.clone(e.startPosition,r.startPosition),uf.Cartesian2.clone(e.endPosition,r.endPosition)},uf.ScreenSpaceEventType.MOUSE_MOVE,\"all\")}enableLook;isLooking=!1;bindLook(){let e=0,a=0,r={startPosition:new uf.Cartesian2,endPosition:new uf.Cartesian2},t={start:0,end:0};this.setInputAction(a=>{this.enableLook&&!this.keyboardLooping&&(this.inertiaState.enableMovement=\"\",this.isLooking=!0,e=new Date().getTime(),t.start=e,t.end=e)},uf.ScreenSpaceEventType.LEFT_DOWN,uf.KeyboardEventModifier.ALT),this.setInputAction(()=>{this.isLooking&&(this.isLooking=!1,a=new Date().getTime(),this.startInertiaLoop(.9,(e,a)=>this.look3D(e,a,!0),e,a,{startPosition:uf.Cartesian2.clone(r.startPosition),endPosition:uf.Cartesian2.clone(r.endPosition)},t,()=>void 0),r.startPosition=new uf.Cartesian2,r.endPosition=new uf.Cartesian2)},uf.ScreenSpaceEventType.LEFT_UP,\"all\"),this.setInputAction(e=>{this.enableLook&&this.isLooking&&(this.look3D(e.startPosition,e.endPosition,!0),t.start=t.end,t.end=new Date().getTime(),t.end-t.start>1500&&(t.start=t.end),uf.Cartesian2.clone(e.startPosition,r.startPosition),uf.Cartesian2.clone(e.endPosition,r.endPosition))},uf.ScreenSpaceEventType.MOUSE_MOVE,\"all\")}stopMouse(e){e?e===uf.KeyboardEventModifier.ALT&&(this.enableLook=!1):(this.enableOrbit=!1,this.enableTranslate=!1)}startMouse(){this.enableOrbit=!0,this.enableTranslate=!0,this.enableLook=!0}keyboardEnable=!1;keyboardMoving={};keyboardMoveStep=10;keyboardLooping=\"\";bindKeyboard(){this.keyboardEnable=!0,this.clearActionSideEffect.push(()=>{this.keyboardEnable=!1,this.keyboardLooping=\"\"})}handleKeyDown(e,a){this.keyboardEnable&&(e===su.up||e===su.down||e===su.left||e===su.right?(this.keyboardMoving[e]=!0,!this.keyboardLooping&&(a.shiftKey?this.keyboardLooping=\"translate\":a.ctrlKey?this.keyboardLooping=\"tilt\":a.altKey?this.keyboardLooping=\"look\":a.metaKey&&ff()?this.keyboardLooping=\"tilt\":this.keyboardLooping=\"orbit\",this.startKeyboardMoveLoop())):(e===su.minus||e===su.equal)&&(this.keyboardMoving[e]=!0,!this.keyboardLooping&&(this.keyboardLooping=\"zoom\",this.startKeyboardMoveLoop())))}handleKeyUp(e){if(this.keyboardEnable)switch(e){case su.up:case su.down:case su.left:case su.right:case su.minus:case su.equal:this.keyboardMoving[e]=!1}}startKeyboardMoveLoop(){let e;let a=r=>{let t=1;void 0!==e&&(t=(r-e)/33.33333),e=r,this.keyboardLooping&&(this.moveCamera(this.keyboardMoveStep*t),window.requestAnimationFrame(a))},r=new uf.Cartesian2(this.viewer.canvas.clientWidth/2,this.viewer.canvas.clientHeight/2);switch(this.keyboardLooping){case\"translate\":this.onTranslateStart(r,!0);break;case\"orbit\":this.onOrbitStart(r,!0);break;case\"tilt\":this.onTiltStart(r,!0);break;case\"zoom\":this.onZoomStart(r,!0)}window.requestAnimationFrame(a)}moveCamera(e){let a=new uf.Cartesian2(0,0),r=!1;if(\"zoom\"===this.keyboardLooping?(this.keyboardMoving[su.equal]&&(a.y+=e,r=!0),this.keyboardMoving[su.minus]&&(a.y+=-e,r=!0)):(this.keyboardMoving[su.up]&&(a.y+=e,r=!0),this.keyboardMoving[su.down]&&(a.y+=-e,r=!0),this.keyboardMoving[su.left]&&(a.x+=e,r=!0),this.keyboardMoving[su.right]&&(a.x+=-e,r=!0)),!r){this.keyboardLooping=\"\",this.clearState();return}let t=new uf.Cartesian2(this.viewer.canvas.clientWidth/2,this.viewer.canvas.clientHeight/2),n=uf.Cartesian2.add(t,a,new uf.Cartesian2);switch(this.keyboardLooping){case\"translate\":this.translate3D(t,n);break;case\"orbit\":this.onOrbitMove(t,n);break;case\"look\":this.look3D(t,n,!0);break;case\"tilt\":this.onTiltMove(t,n);break;case\"zoom\":this.onZoomMove(t,n)}}bindMobile(){let e,a,r;let t=\"\",n=(t,n,i)=>{if(void 0!==e&&void 0!==a&&void 0!==r){if(Math.abs(i-r)>12)return\"zoom\";if(Math.abs(n-a)>10)return\"tilt\";let o=uf.Math.toDegrees(t-e)%360;if(o>180&&(o-=360),o<-180&&(o+=360),(o=Math.abs(o))>10&&r>20&&i>30)return\"tilt\"}return\"\"},i=0;this.setInputAction(()=>{i&&window.clearTimeout(i),this.controller.enableTilt=!1},uf.ScreenSpaceEventType.PINCH_START),this.setInputAction(i=>{void 0===e&&(e=i.angleAndHeight.startPosition.x),void 0===a&&(a=i.angleAndHeight.startPosition.y),void 0===r&&(r=i.distance.startPosition.y),!t&&\"tilt\"===(t=n(i.angleAndHeight.endPosition.x,i.angleAndHeight.endPosition.y,i.distance.endPosition.y))&&(this.controller.enableTilt=!0)},uf.ScreenSpaceEventType.PINCH_MOVE,\"all\"),this.setInputAction(()=>{e=void 0,a=void 0,r=void 0,t=\"\",i=window.setTimeout(()=>{this.controller.enableTilt=!0},300)},uf.ScreenSpaceEventType.PINCH_END)}isFirstViewMoving=!1;bindFirstView(){this.controller.enableRotate=!1,this.controller.enableTilt=!1,this.controller.enableZoom=!1,this.controller.enableLook=!1,this.controller.enableTranslate=!1;let e=e=>{this.isFirstViewMoving&&this.look3D(e.startPosition,e.endPosition)};this.setInputAction(e=>{this.isFirstViewMoving=!0},uf.ScreenSpaceEventType.LEFT_DOWN),this.setInputAction(()=>{this.isFirstViewMoving=!1},uf.ScreenSpaceEventType.LEFT_UP),this.setInputAction(e,uf.ScreenSpaceEventType.MOUSE_MOVE),this.addDocumentAction(\"mousemove\",a=>{if(this.ignoreFpsFirstMove){this.ignoreFpsFirstMove=!1;return}if(this.isFps){let r=new uf.Cartesian2(this.viewer.canvas.clientWidth/2,this.viewer.canvas.clientHeight/2),t=new uf.Cartesian2(r.x+a.movementX/2,r.y+a.movementY/2);this.isFirstViewMoving=!0,e({startPosition:r,endPosition:t}),this.isFirstViewMoving=!1}},!1),this.addDocumentAction(\"pointerlockchange\",()=>{document.pointerLockElement!==this.manager.viewer.canvas&&\"first-view\"===this.mode&&this.isFps&&(this.isFps=!1,this.ignoreFpsFirstMove=!1)}),this.clearActionSideEffect.push(()=>{document.pointerLockElement===this.manager.viewer.canvas&&(document.exitPointerLock(),this.isFps=!1,this.ignoreFpsFirstMove=!0)}),this.setInputAction(e=>{this.manager.emit(\"zoomDelta\",e/this.viewer.canvas.clientHeight)},uf.ScreenSpaceEventType.WHEEL,\"all\")}_isFps=!1;get isFps(){return this._isFps}set isFps(e){this._isFps!==e&&(this._isFps=e,this.manager.emit(\"fpsChange\",e))}ignoreFpsFirstMove=!1;toggleFpsMode(e=!this.isFps){let a=this.manager.viewer.canvas;\"first-view\"===this.mode&&this.isFps!==e&&a&&(e?(a.requestPointerLock(),this.isFps=!0):(document.exitPointerLock(),this.isFps=!1,this.ignoreFpsFirstMove=!0))}bindInteractive(e=!0){!e&&this.refreshHandler(),\"first-view\"===this._mode?this.bindFirstView():pS()?(this.controller._zoomFactor=10,this.bindMobile()):(this.bindTilt(),this.bindZoom(),this.bindOrbit(),this.bindTranslate(),this.bindLook(),this.bindKeyboard()),this.applyInputActions()}inputActionMap={};setInputAction(e,a,r=\"no\"){let t=this.inputActionMap[a];!t&&(t=this.inputActionMap[a]={});let n=t[r];!n&&(n=t[r]=[]),n.push(e)}applyInputActions(){Object.keys(this.inputActionMap).forEach(e=>{let a=this.inputActionMap[e];a&&f_.forEach(r=>{let t=this.getActions(a,r);t&&this.handler.setInputAction((...e)=>{t.forEach(a=>a(...e))},e,\"no\"===r?void 0:r)})})}getActions(e,a=\"no\"){let r=e[a]||[];if(e.all&&(r=r.concat(e.all)),r.length>0)return r}clearActionSideEffect=[];removeDocumentActions=[];addDocumentAction(e,a,r){window.document.addEventListener(e,a,r);let t=()=>{window.document.removeEventListener(e,a,r)};return this.removeDocumentActions.push(t),t}clearActions(){this.inputActionMap={},this.handler.destroy(),this.removeDocumentActions.forEach(e=>e()),this.removeDocumentActions=[],this.clearActionSideEffect.forEach(e=>e()),this.clearActionSideEffect=[]}destroy(){this.clearActions()}}class fk{constructor(e){this.manager=e}mode=\"\";manager;verticalStatus={start:uf.Cartesian3.ZERO,plane:uf.Plane.ORIGIN_XY_PLANE};cleanVertical(){this.verticalStatus.start=uf.Cartesian3.ZERO,this.verticalStatus.plane=uf.Plane.ORIGIN_XY_PLANE}horizontalStatus={clampToGround:!1,ellipsoid:uf.Ellipsoid.WGS84};cleanHorizontal(){this.horizontalStatus.clampToGround=!1,this.horizontalStatus.ellipsoid=uf.Ellipsoid.WGS84}dragStartStatus={moved:!1};cleanDragStart(){this.dragStartStatus={moved:!1}}draggingPosition=uf.Cartesian3.ZERO;draggingElement=null;leftDown(e,a){let r=p5(this.manager.viewer,e.position);if(0===r.length)return!1;let t=this.manager.getElements(r);if(0===t.length)return!1;let[n,i]=t[0];if(i){let r=i.canDrag?.(a,n);if(r)return this.mode=r,this.draggingElement=i,this.dragStartStatus.mouse=e,this.dragStartStatus.moved=!1,this.dragStartStatus.primitive=n,this.manager.screenSpaceCameraController.stopMouse(a),!0}return!1}firstMove(){let e=this.manager.viewer;if(this.dragStartStatus.moved=!0,this.draggingElement&&this.dragStartStatus.mouse&&this.mode){let a=this.draggingElement.startDrag?.(this.dragStartStatus.mouse,this.mode,this.dragStartStatus.primitive);if(\"boolean\"!=typeof a&&a.position){let r=a.position;if(\"vertical\"===this.mode)this.verticalStatus.start=r,this.verticalStatus.plane=me(r,e);else if(\"horizontal\"===this.mode){if(!a.clampToGround){let e=uf.Cartographic.fromCartesian(r);this.horizontalStatus.ellipsoid=p8(e.height)}this.horizontalStatus.clampToGround=!!a.clampToGround}this.draggingPosition=r,this.draggingElement.dynamicDrag?.(()=>this.draggingPosition)}}}mouseMove(e){if(this.mode){let a;if(!this.dragStartStatus.moved){if(this.dragStartStatus.mouse?.position){let{x:a,y:r}=this.dragStartStatus.mouse.position,{x:t,y:n}=e.endPosition;if(1>Math.abs(a-t)&&1>Math.abs(r-n))return}this.firstMove()}if(this.draggingElement&&\"transformer\"===this.mode)return this.draggingElement.onDrag(e,new uf.Cartesian3),this.manager.editor.activeShapePoints.value=[],!0;let r=this.manager.viewer.scene.camera.getPickRay(e.endPosition);if(!!r){if(\"vertical\"===this.mode){let e=uf.IntersectionTests.rayPlane(r,this.verticalStatus.plane);if(e){let{height:r}=uf.Cartographic.fromCartesian(e),{longitude:t,latitude:n}=uf.Cartographic.fromCartesian(this.verticalStatus.start);a=uf.Cartesian3.fromRadians(t,n,r)}}else if(\"horizontal\"===this.mode){let{clampToGround:t,ellipsoid:n}=this.horizontalStatus;if(t)a=this.manager.picker.pickPosition(e.endPosition);else{let e=uf.IntersectionTests.rayEllipsoid(r,n);e&&(a=uf.Ray.getPoint(r,e.start))}}return a&&(this.draggingPosition=a,this.draggingElement?.onDrag(e,a),this.manager.render()),!0}}}leftUp(e){if(this.mode){let e=this.dragStartStatus.moved;return this.cleanDragStart(),\"vertical\"===this.mode?this.cleanVertical():\"horizontal\"===this.mode?this.cleanHorizontal():\"transformer\"===this.mode&&this.draggingElement?.endDrag(),this.manager.screenSpaceCameraController.startMouse(),e&&this.draggingElement?.endDrag?.(),this.draggingElement=null,this.draggingPosition=uf.Cartesian3.ZERO,this.mode=\"\",!0}return!1}}class fv{constructor(e){this.manager=e}manager;isPrismHovering=(0,uh.iH)(!1);isCylinderHovering=(0,uh.iH)(!1);_cursor={origin:{modifiers:{ctrl:`rotate:${uP(\"web.map.mouse_tips_rotate_map\")}`,meta:`rotate:${uP(\"web.map.mouse_tips_rotate_map\")}`,shift:`move:${uP(\"web.map.mouse_tips_translate_map\")}`,alt:`look:${uP(\"web.map.mouse_tips_look_map\")}`}},default:\"\",hover:\"\",temporary:\"\"};getCursorWithModifier(e=\"default\"){let a=this._cursor[e],r=\"\";return\"string\"==typeof a?r=a:(a.normal&&(r=a.normal),(0,pg.ri)(this.modifier)&&(r=a.modifiers?.[this.modifier]??r)),r}get cursor(){return this.getCursorWithModifier(\"temporary\")||this.getCursorWithModifier(\"hover\")||this.getCursorWithModifier(\"default\")||this.getCursorWithModifier(\"origin\")}setCursor(e,a=\"default\"){this._cursor[a]=e,this.manager.emit(\"cursorChange\")}mousePosition;get currentMousePosition(){return this.mousePosition}_modifier;disabled=!1;get modifier(){return this._modifier}set modifier(e){this._modifier!==e&&(this._modifier=e,this.manager.emit(\"cursorChange\"))}_hoverElementTuples=[];get hoverElements(){return this._hoverElementTuples.map(([,e])=>e)}clearHoverElements(){this._hoverElementTuples.forEach(e=>this.changeHovering(e,!1)),this._hoverElementTuples.length=0,this.hoveringElementMapping=void 0}pick=(0,lL.throttle)(()=>{if(this.manager.viewer.isDestroyed()||this.manager.screenSpaceCameraController.onMotion||!this.mousePosition)return;let e=p5(this.manager.viewer,this.mousePosition),a=this.manager.getElements(e),r=this.manager.operationActive.value;this.manager.operationActive.value&&(a=a.filter(([,e])=>!(e instanceof hW||e instanceof h8||e instanceof mX||e instanceof hY||e instanceof gr||e instanceof pZ)),![\"prism\",\"cylinder\"].includes(r)&&(a=a.filter(([,e])=>!(e instanceof gs||e instanceof hp)))),this.manager.mode.draw&&(a=a.filter(([,e])=>!(e instanceof hW||e instanceof h8))),this._hoverElementTuples=a},100);handle(){if(this.disabled)return;let e=this._hoverElementTuples[0],a=e?e[0].id:void 0;this.mousePosition&&this.manager.emit(\"hover\",this.hoverElements,{mousePosition:{position:this.mousePosition},partId:a}),this.hoveringElementMapping=e}mouseMove(e,a,r){this.mousePosition=e.endPosition,this.modifier=(0,pg.ri)(r)?pE[r]:r,this.disabled=a,!pS()&&(!this.disabled&&this.pick(),this.handle())}getCesiumPickResultId(e){return e.id instanceof uf.Entity?e.id.id:e.id}isSameElement(e){let a=this._hoveringElementMapping;if(e&&a){let r=this.getCesiumPickResultId(e[0]),t=this.getCesiumPickResultId(a[0]);return e[1]===a[1]&&r&&t&&r===t}return!1}_hoveringElementMapping;get hoveringElementMapping(){return this._hoveringElementMapping}set hoveringElementMapping(e){if(this.isSameElement(e))return;if(this.setCursor(e?\"pointer\":\"\",\"hover\"),!this.manager.contextmenu.state.show||!this.hoveringElement)this.changeHovering(this._hoveringElementMapping,!1),this.changeHovering(e,!0),this._hoveringElementMapping=e,this.manager.render()}get hoveringElement(){return this._hoveringElementMapping?.[1]}changeHovering(e,a){if(!e)return;let[r,t]=e;if(t instanceof hG||t instanceof h8||t instanceof hW||t instanceof mX||t instanceof hY||t instanceof gs||t instanceof hp||t instanceof gr||t instanceof g_){if(this.manager.screenSpaceCameraController.onMotion)return;t.active(\"hover\",a)}if(\"string\"==typeof r.id&&t instanceof pZ){if(this.manager.screenSpaceCameraController.onMotion)return;t.hover(r.id,a)}a?t.onMouseEnter?.(r):t.onMouseLeave?.(r)}}class fz{constructor(e){this.manager=e}manager;state=(0,uh.qj)({show:!1,left:0,top:0});commonGroups=[];groups=(0,uh.iH)([]);element=null;mouse={position:uf.Cartesian2.ZERO};setCommonGroup(e,a){let r=this.commonGroups,t=!1,n=r.reduce((r,n)=>(n.key===e?(t=!0,a&&r.push(a)):r.push(n),r),[]);!t&&a&&n.push(a),this.commonGroups=n}open(e,a){let r;let t=this.manager.getElements(e).map(([,e])=>e);this.element=t[0]||null,this.mouse=a;let n=this.element;e.forEach(({id:e,primitive:a})=>{n instanceof pZ&&(a instanceof uf.Primitive||a instanceof uf.GroundPrimitive)&&n.hasPrimitive(a),r=e});let i=this.commonGroups.slice();if(n){let e=this.element;!(this.manager.operationActive.value&&(e instanceof hW||e instanceof h8||e instanceof mX))&&e?.getContextmenu&&\"function\"==typeof e.getContextmenu&&(i=e.getContextmenu(i))}this.manager.emit(\"rightClick\",t,a,i,r),this.groups.value=i,this.groups.value.length>0&&(this.state.left=a.position.x,this.state.top=a.position.y,window.setTimeout(()=>{this.state.show=!0}))}onItemClick(e,a){this.manager.emit(\"contextmenuClick\",a,e,this.element,this.mouse)}}async function fw(e,a,r,t,n,i,o){var s,l,d;let c=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);return e.flush(),await (s=e,l=c,d=0,new Promise((e,a)=>{!function r(){let t=s.clientWaitSync(l,0,0);if(t===s.WAIT_FAILED){a(Error(\"gl-error\"));return}if(t===s.TIMEOUT_EXPIRED){setTimeout(r,10);return}e()}()})),e.deleteSync(c),e.bindBuffer(a,r),e.getBufferSubData(a,t,n,i,o),e.bindBuffer(a,null),n}async function fy(e,a,r,t,n,i,o,s){let l=e.createBuffer();return"
}